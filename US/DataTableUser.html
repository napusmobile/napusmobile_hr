<div class="py-4"> 
<ul class="box-info">
  <li>
    <i class="fa-solid fa-users"></i>
    <span class="text">
      <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      <h3 id="countingUserA">0 <span style="font-size: 12px">(‡∏Ñ‡∏ô)</span></h3>                
    </span>
  </li>
  <li>
    <i class="fa-solid fa-user-secret"></i>
    <span class="text">
      <p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
      <h3 id="countingUserB">0 <span style="font-size: 12px">(‡∏Ñ‡∏ô)</span></h3>                
    </span>
  </li>
  <li>
    <i class="fa-solid fa-user-nurse"></i>
    <span class="text">
      <p>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</p>
      <h3 id="countingUserC">0 <span style="font-size: 12px">(‡∏Ñ‡∏ô)</span></h3>        
    </span>
  </li>
  <li>
    <i class="fa-solid fa-user"></i>
    <span class="text">
      <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
      <h3 id="countingUserD">0 <span style="font-size: 12px">(‡∏Ñ‡∏ô)</span></h3>               
    </span>
  </li>
</ul>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-12 col-xl-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-4 mb-2 mb-md-0">üë¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <select class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" onchange="updateItemsUsers(this.value)">
              <option value="10">‚úÖ 10</option>
              <option value="20">‚úÖ 25</option>
              <option value="50">‚úÖ 50</option>
              <option value="100">‚úÖ 100</option>
              <option value="all">‚úÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
          <select id="searchUsers2" class="form-select me-2 mb-2 mb-md-0" style="width: 150px;" oninput="filterUserss()"></select>
          <select id="searchUsers3" class="form-select me-2 mb-2 mb-md-0" style="width: 150px;" oninput="filterUserss()">
            <option selected value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="SuperAdmin">SuperAdmin</option>
            <option value="Admin">Admin</option>
            <option value="SuperUser">SuperUser</option>
            <option value="User">User</option>
          </select>
            <input type="search" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" id="searchUsers1" placeholder="üîç‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..." oninput="filterUserss()">
            <button type="button" class="btn set-button me-2 mb-2 mb-md-0" data-bs-target="#RegisterModal" data-bs-toggle="modal">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">#</th>
                <th scope="col" class="text-center">UID</th>
                <th scope="col" class="text-center">Username</th>
                <th scope="col" class="text-center">Password</th>
                <th scope="col" class="text-center">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                <th scope="col" class="text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                <th scope="col" class="text-center">‡∏ù‡πà‡∏≤‡∏¢</th>
                <th scope="col" class="text-center">Status</th>
                <th scope="col" class="text-center">ProFile</th>
                <th scope="col" class="text-center">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</th>
                <th scope="col" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody id="tableUsers-table"></tbody>       
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationUsersInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationUsers" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let filteredUsers = [];
let currentUsers = 1;
let itemsPerUsers = 10;

const renderUsers = (res) => {
  const table = document.getElementById('tableUsers-table');
  table.innerHTML = '';

  res.sort((a, b) => {
    const numA = parseInt(a[0].replace('USER-', ''));
    const numB = parseInt(b[0].replace('USER-', ''));
    return numB - numA;
  });

  const startIndex = (currentUsers - 1) * itemsPerUsers;
  const endIndex = startIndex + itemsPerUsers;
  const emp = res.slice(startIndex, endIndex);

  const startRow = startIndex + 1;
  const endRow = startIndex + emp.length;
  const totalRows = res.length;

  document.getElementById('paginationUsersInfo').innerText = `‡πÅ‡∏™‡∏î‡∏á ${startRow} ‡∏ñ‡∏∂‡∏á ${endRow} ‡∏à‡∏≤‡∏Å ${totalRows} ‡πÅ‡∏ñ‡∏ß`;

  if (emp.length === 0) {
    const row = table.insertRow();
    row.innerHTML = `<td colspan='9' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! üòì</td>`;
    return;
  }

  emp.forEach((rowIndex, index) => {
    let dpmUserscolor = rowIndex[4];
    let statusUserscolor = rowIndex[6];
    let isActive = rowIndex[10] === "TRUE";
    switch (statusUserscolor) {
      case "SuperAdmin":
        statusUserscolor = '<span style="color: var(--box3);font-size: 14px;"><i class="fa-solid fa-star fa-lg"></i> SuperAdmin</span>';
        break;
      case "Admin":
        statusUserscolor = '<span style="color: var(--box2);font-size: 14px;"><i class="fa-solid fa-star fa-lg"></i> Admin</span>';
        break;
      case "SuperUser":
        statusUserscolor = '<span style="color: var(--box1);font-size: 14px;"><i class="fa-solid fa-star fa-lg"></i> SuperUser</span>';
        break;
      case "User":
        statusUserscolor = '<span style="color: var(--box4);font-size: 14px;"><i class="fa-solid fa-star fa-lg"></i> User</span>';
        break;
      default:
        statusUserscolor = '<span style="color: var(--box4);font-size: 14px;"><i class="fa-solid fa-star fa-lg"></i> User</span>';
    }
    switch (dpmUserscolor) {
      case "IT Management":
        dpmUserscolor = '<span style="color: var(--box3);font-size: 14px;"><i class="fa-solid fa-circle-user fa-lg"></i> IT Management</span>';
        break;
      case "IT Support":
        dpmUserscolor = '<span style="color: var(--box2);font-size: 14px;"><i class="fa-solid fa-circle-user fa-lg"></i> IT Support</span>';
        break;
      default:
        dpmUserscolor = '<span style="color: var(--box4);font-size: 14px;"><i class="fa-solid fa-circle-user fa-lg"></i> ' + rowIndex[4] + '</span>';
    }
    var row = table.insertRow();
    row.innerHTML = `
      <td class="text-center">${startIndex + index + 1}</td>
      <td class="text-center"><span style="font-size: 14px;">${rowIndex[0]}</span></td>
      <td><span style="font-size: 14px;">${rowIndex[1]}</span></td>
      <td><span style="font-size: 14px;">${rowIndex[2]}</span></td>
      <td><span style="font-size: 14px;">${rowIndex[3]}</span></td>
      <td><span style="font-size: 14px;">${dpmUserscolor}</span></td>
      <td><span style="font-size: 14px;">${rowIndex[5]}</span></td>
      <td><span style="font-size: 14px;">${statusUserscolor}</span></td>
      <td class="text-center"><img class="rounded-circle" src="${rowIndex[7]}" alt="ImageUsers" width="25"></td>
      <td class="text-center">
        <div class="custom-switch">
          <input type="checkbox" ${isActive ? 'checked' : ''} id="switch-${rowIndex[0]}" class="custom-switch-input" onchange="toggleUserStatus('${rowIndex[0]}', this.checked)">
          <label for="switch-${rowIndex[0]}" class="custom-switch-label"></label>
        </div>
      </td>
      <td class="text-center"><button type='button' class='btn btn-sm me-2 edit-button' onclick='editData("${rowIndex[0]}");'><i class='fa-solid fa-pen-to-square'></i></button><button type='button' class='btn btn-sm me-2 del-button' onclick='delDataUser("${rowIndex[0]}");'><i class='fa-solid fa-trash-can'></i></button></td>
    `;
  });
}

const renderPageUsers = (totalItems) => {
  const totalPages = Math.ceil(totalItems / itemsPerUsers);
  const paginationContainer = document.getElementById('paginationUsers');
  paginationContainer.innerHTML = '';
  if (totalPages > 1) {
    const createPageButton = (text, page, isDisabled = false, isActive = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
      const button = document.createElement('button');
      button.className = 'page-link';
      button.innerText = text;
      button.onclick = () => {
        if (!isDisabled) {
        currentUsers = page;
        renderUsers(dataUsers);
        renderPageUsers(dataUsers.length);
        }
      };
      li.appendChild(button);
      return li;
    };
    paginationContainer.appendChild(createPageButton('‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö', currentUsers - 1, currentUsers === 1));

    if (currentUsers > 2) {
      paginationContainer.appendChild(createPageButton(1, 1, false, currentUsers === 1));
      if (currentUsers > 3) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
    }
    paginationContainer.appendChild(createPageButton(currentUsers, currentUsers, false, true));

    if (currentUsers < totalPages - 1) {
      if (currentUsers < totalPages - 2) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
      paginationContainer.appendChild(createPageButton(totalPages, totalPages, false, currentUsers === totalPages));
    }
    paginationContainer.appendChild(createPageButton('‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', currentUsers + 1, currentUsers === totalPages));
  }
}

const filterUserss = () => {
  const query = document.getElementById('searchUsers1').value.toLowerCase();
  const department = document.getElementById('searchUsers2').value.toLowerCase();
  const status = document.getElementById('searchUsers3').value;

  filteredUsers = dataUsers.filter(row => {
    const rowDepartment = row[4] ? row[4].toLowerCase() : '';
    const rowStatus = row[6] ? row[6].toLowerCase() : '';
    const matchesQuery = query === '' || row.some(column => column.toLowerCase().includes(query));
    const matchesDepartment = department === '' || rowDepartment.includes(department);
    const matchesStatus = status === '' || rowStatus.includes(status.toLowerCase());

    return matchesQuery && matchesDepartment && matchesStatus;
  });

  currentUsers = 1;
  renderUsers(filteredUsers);
  renderPageUsers(filteredUsers.length);
}

const updateItemsUsers = (value) => {
  if (value === "all") {
    itemsPerUsers = filteredUsers.length;
  } else {
    itemsPerUsers = parseInt(value, 10);
  }

  currentUsers = 1;
  renderUsers(filteredUsers);
  renderPageUsers(filteredUsers.length);
}

const updateCountsUsers = (data) => {
  const countingUserA = data.length;
  const countingUserB = data.filter(user => user[6] === "SuperAdmin").length;
  const countingUserC = data.filter(user => user[6] === "Admin").length;
  const countingUserD = data.filter(user => user[6] !== "SuperAdmin" && user[6] !== "Admin").length;

  document.getElementById('countingUserA').innerText = countingUserA;
  document.getElementById('countingUserB').innerText = countingUserB;
  document.getElementById('countingUserC').innerText = countingUserC;
  document.getElementById('countingUserD').innerText = countingUserD;
}

const toggleUserStatus = (userId, isActive) => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  google.script.run.withSuccessHandler(async (res) => {
    $.LoadingOverlay("hide");
    createToast(`‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${isActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 1);
    await updateSpecificDataUsers();
  }).setUserStatus(userId, isActive);
}

function password_showAdd_hide() {
  var x = document.getElementById("registerData5");
  var showadd_eye = document.getElementById("showadd_eye");
  var hideadd_eye = document.getElementById("hideadd_eye");
  hideadd_eye.classList.remove("d-none");
  if (x.type === "password") {
    x.type = "text";
    showadd_eye.style.display = "none";
    hideadd_eye.style.display = "block";
  } else {
    x.type = "password";
    showadd_eye.style.display = "block";
    hideadd_eye.style.display = "none";
  }
}

document.addEventListener('DOMContentLoaded', (ev) => {
  let input = document.querySelector('input[id="regictorImg"]');
  input.addEventListener('change', (ev) => {
      if (input.files[0].type.indexOf("image/") > -1) {
        let img = document.getElementById('regictorPreview');
        img.src = window.URL.createObjectURL(input.files[0]);
      }
  });
});

const getFormDataUsers = () => {
  const formData = {
    registerDataID: document.getElementById("registerDataID") ? document.getElementById("registerDataID").value : null,
    registerData1: document.getElementById("registerData1").value,
    registerData2: document.getElementById("registerData2").value,
    registerData3: document.getElementById("registerData3").value,
    registerData4: document.getElementById("registerData4").value,
    registerData5: document.getElementById("registerData5").value,
    registerData6: document.getElementById("registerData6").value,
    check: $("#regictorImg").val()
  };

  if (formData.check === "") {
    formData.profile = $("#regictorPreview").attr("src");
  } else {
    const imgElement = document.getElementById("regictorPreview");
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.width = imgElement.naturalWidth;
    canvas.height = imgElement.naturalHeight;
    context.drawImage(imgElement, 0, 0, imgElement.naturalWidth, imgElement.naturalHeight);
    formData.imageDataUrlA = canvas.toDataURL("image/png");
    formData.filetype = "image/png";
    formData.filename = formData.registerData4;
  }

  return formData;
}

const submitRegisterForm = () => {
  event.preventDefault();
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  const formData = getFormDataUsers();
  if (!formData.registerData4 || !formData.registerData5 || !formData.registerData3) {
    createToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 3);
    $.LoadingOverlay("hide");
    return;
  }
  if (!formData.registerDataID) {
    google.script.run.withSuccessHandler(function(existingData) {
      const isDuplicate = existingData.filter(row => 
        row[1].trim() === formData.registerData4.trim()
      );
      if (isDuplicate.length > 0) {
        createToast("‚ö†Ô∏è ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Username ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß", 3);
        $.LoadingOverlay("hide");
        return;
      }
      google.script.run.withSuccessHandler(async (res) => {
        closeModalRegistor();
        $.LoadingOverlay("hide");
        await updateSpecificDataUsers();
        createToast("üßë ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 1);
      }).saveUser(formData);
    }).getDataUsers();
  } else {
    google.script.run.withSuccessHandler(async (res) => {
      closeModalRegistor();
      $.LoadingOverlay("hide");
      await updateSpecificDataUsers();
      createToast("üßë ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 1);
    }).editUser(formData);
  }
};

const editData = (userId) => {
  const user = dataUsers.find(row => row[0] === userId);
  if (user) {
    $('#RegisterModal').modal('show');
    $('#registerDataID').val(user[0]);
    $('#registerData5').val(user[1]);
    $('#registerData6').val(user[2]);
    $('#registerData4').val(user[3]);
    $('#registerData2').val(user[4]);
    $('#registerData1').val(user[5]);
    $('#registerData3').val(user[6]);
    $('#regictorPreview').attr('src', user[7]);
    //console.log(user[7]);
    //console.log(user[8]);
  }
}

const delDataUser = (userId) => {
  const record = dataUsers.find(row => row[0] === userId);
  if (record) {
    $('#confirmBtnDel').off('click').on('click', function() {
      $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
      $('#DelDataModal').modal('hide');
      google.script.run.withSuccessHandler(async (res) => {
        dataUsers = dataUsers.filter(row => row[0] !== userId);
        await updateSpecificDataUsers();
        $.LoadingOverlay("hide");
        createToast("‚õî ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 0);
      }).delRecordU(userId);
    });
    $('#xDelconfirmData').off('click').on('click', function() {
      $('#DelDataModal').modal('hide');
    });
    $('#DelDataModal').modal('show');
  }
}

const reviewdivprofile = () => {
  let divcontainer = document.getElementById('reviewdivprofile');
  divcontainer.innerHTML = "";
  let row = document.createElement('div');
  row.className = "row row-cols-6";
  for (let i = 1; i <= 50; i++) {
    let image = "https://cdn.jsdelivr.net/gh/EPICCODING17/image/user-" + i + ".png";
    let col = document.createElement('div');
    col.className = "col p-2";
    let img = document.createElement('img');
    img.className = "rounded-circle w-100 imageuser"; 
    img.src = image;
    img.style.cursor = "pointer";
    img.addEventListener('click', () => {
      let imgPreview = document.getElementById('regictorPreview');
      imgPreview.src = "https://cdn.jsdelivr.net/gh/EPICCODING17/image/user-" + i + ".png";
    });
    col.appendChild(img);
    row.appendChild(col);
  }
  divcontainer.appendChild(row); 
}

const closeModalRegistor = () =>{
  $('#addRegicter')[0].reset();
  $('#regictorPreview').attr('src', 'https://img2.pic.in.th/pic/vsvds.png');
  $('#resultMessage').hide();
  $('#RegisterModal').modal('hide');
}
</script>
