<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geodesy@2.1.0/leaflet-geodesy.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- SweetAlret -->
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.4/signature_pad.umd.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>

<!-- dataTables -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.0/dist/bootstrap-table.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table/dist/locale/bootstrap-table-th-TH.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>

<!-- CDN สำหรับ tree-multiselect -->
<script src="https://cdn.jsdelivr.net/npm/tree-multiselect@2.5.0/dist/jquery.tree-multiselect.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>

<!----- CDN สำหรับ MAPS LONGDO ------>
<script src="https://api.longdo.com/map/?key=e470536f836c3fb0c50bf65e80f2e4dc"></script>

<script>
var signaturePadUser = new SignaturePad(document.getElementById('signatureCanvas'));
var clearButtonA = document.getElementById('clearButtonA');
var colorPickerA = document.getElementById('colorPickerA');
var currentColorA = '#000000'; 
  clearButtonA.addEventListener('click', function () {
    signaturePadUser.clear();  
  });
  colorPickerA.addEventListener('input', function () {
    currentColorA = colorPickerA.value;
    signaturePadUser.penColor = currentColorA;
});

pdfMake.fonts = {
  THSarabunNew: {
    normal: 'https://sanwithz.github.io/font/THSarabunNew.ttf',
    bold: 'https://sanwithz.github.io/font/THSarabunNewBold.ttf',
    italics: 'https://sanwithz.github.io/font/THSarabunNewItalic.ttf',
  },

  Wingdings2: {
    normal: 'https://semicon.github.io/fonts/wingdings2.ttf'
  }
};

$(document).ready(function() {
  $('.sidebar').addClass('collapsed');
  $('.sidebar-dropdown-menu').slideUp('fast');

  $('.sidebar-menu-item.has-dropdown > a, .sidebar-dropdown-menu-item.has-dropdown > a').click(function(e) {
    e.preventDefault();
    $('.sidebar-dropdown-menu').css('overflow-y', 'hidden');
    if(!($(this).parent().hasClass('focused'))) {
      $(this).parent().parent().find('.sidebar-dropdown-menu').slideUp('fast');
      $(this).parent().parent().find('.has-dropdown').removeClass('focused');
    }
    $(this).next().slideToggle('fast');
    $(this).parent().toggleClass('focused');
  });

  $('.sidebar-menu-item > a, .sidebar-dropdown-menu-item > a').click(function(e) {
    if(!$(this).parent().hasClass('has-dropdown')) {
      $(this).closest('.sidebar-dropdown-menu').slideUp('fast');
      $(this).closest('.has-dropdown').removeClass('focused');
    }
  });

  $('.sidebar-toggle').click(function() {
    $('.sidebar').toggleClass('collapsed');

    $('.sidebar.collapsed').mouseleave(function() {
      $('.sidebar-dropdown-menu').slideUp('fast');
      $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
    });
  });

  $('.sidebar-overlay').click(function() {
    $('.sidebar').addClass('collapsed');
    $('.sidebar-dropdown-menu').slideUp('fast');
    $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
  });

  if(window.innerWidth < 768) {
    $('.sidebar').addClass('collapsed');
  }
});

$(document).ready(function() {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  if (isLoggedIn === 'true') {
    loadDataAfterLogin();
  } else {
    $("#pageformLogin").show();
    $("#dashboardPage").hide();
  }
});

function loadDataAfterLogin() {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  if (isLoggedIn !== 'true') {
    $("#pageformLogin").show();
    $("#dashboardPage").hide();
    return;
  }

  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  Promise.all([
    fetchUseAllData(),
    fetchAllData(),
    allDropdown()
  ]).then(() => {
    insertChartLev();
    loadLeaveTypes();
    $.LoadingOverlay("hide");
  }).catch(error => {
    console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลทั้งหมด:", error);
    $.LoadingOverlay("hide");
  });
}

const openimageModal = (imageSrc) => {
  const modalImage = document.getElementById('imageModalSrc');
  modalImage.src = imageSrc;
  $('#imageModal').modal('show');
}

document.addEventListener('DOMContentLoaded', () => {
  google.script.run.withSuccessHandler(data => {
    data.forEach((value, index) => {
      $(`#setData${index + 1}`).val(value);
    });
      $("#logoSystem").attr("src", data[8]);
      $("#textSystem").text(data[10]);
      $("#nameSystem").text(data[9]);
      $("#logoLogin").attr("src", data[8]);
      $("#textLogin").text(data[9]);
      $("#logoChat").attr("src", data[8]);
      $("#textChat").text(data[9]);
  }).getSet();
});

const addSetting = () => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  let data = {};
  for (let i = 1; i <= 11; i++) {
    data[`set${i}`] = document.getElementById(`setData${i}`).value;
  }
  google.script.run.withSuccessHandler(response => {
    $("#xModalsetting").click();
    google.script.run.withSuccessHandler(data => {
      $("#logoSystem").attr("src", data[8]);
      $("#textSystem").text(data[10]);
      $("#nameSystem").text(data[9]);
      $("#logoLogin").attr("src", data[8]);
      $("#textLogin").text(data[9]);
      $("#logoChat").attr("src", data[8]);
      $("#textChat").text(data[9]);
    }).getSet();
    $.LoadingOverlay("hide");
    createToast("🛠️ บันทึกการตั้งค่าสำเร็จ", 1);
  }).settingGS(data);
}

const setDisPlayMenu = (status, menuItems) => {
  const allMenuItems = Object.keys(menuItems);
  allMenuItems.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.style.display = "none";
    }
  });
  for (const item in menuItems) {
    if (menuItems[item][status]) {
      const element = document.getElementById(item);
      if (element) {
        element.style.display = "block";
      }
    }
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  if (isLoggedIn !== 'true') {
    localStorage.removeItem('uiduser');
    localStorage.removeItem('username');
    localStorage.removeItem('password');
    localStorage.removeItem('fullname');
    localStorage.removeItem('department');
    localStorage.removeItem('group');
    localStorage.removeItem('level');
    localStorage.removeItem('imgUser');
    localStorage.removeItem('tokenUser');
    localStorage.removeItem('sigUser');
    localStorage.removeItem('status');
    localStorage.removeItem('isLoggedIn');
  } else {
    let datauser = {
    uiduser: localStorage.getItem('uiduser'),
    username: localStorage.getItem('username'),
    password: localStorage.getItem('password'),
    fullname: localStorage.getItem('fullname'),
    department: localStorage.getItem('department'),
    group: localStorage.getItem('group'),
    level: localStorage.getItem('level'),
    imgUser: localStorage.getItem('imgUser'),
    tokenUser: localStorage.getItem('tokenUser'),
    sigUser: localStorage.getItem('sigUser'),
    status: localStorage.getItem('status')
    };
    google.script.run.withSuccessHandler(function(menuItems) {
      setDisPlayMenu(datauser.level, menuItems);
    }).getMenuItems();
    loadDataAfterLogin();
    loginUserSuc(datauser);
  }
  const storedUsername = localStorage.getItem("usernameSave");
  const storedPassword = localStorage.getItem("passwordSave");
  const storedChecked = localStorage.getItem("checked");

  if (storedUsername) {
    document.getElementById("loginusername").value = storedUsername;
  }
  if (storedPassword) {
    document.getElementById("loginpassword").value = storedPassword;
  }
  if (storedChecked === "checked") {
    document.getElementById("rememberMe").checked = true;
  }
});

const generateDeviceId = () => {
  const deviceId = `device-${Math.random().toString(36).substr(2, 9)}`;
  localStorage.setItem('deviceId', deviceId);
  return deviceId;
};

const getIPAddress = async () => {
  const ipAPI = "//api.ipify.org?format=json";
  const response = await fetch(ipAPI); 
  const data = await response.json(); 
  return data.ip;
}

const loginUsers = async () => {
  event.preventDefault();
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  const usernameCheck = $("#loginusername").val();
  const passwordCheck = $("#loginpassword").val();
  const rememberMe = document.getElementById("rememberMe");
  const ipCheck = await getIPAddress();
  const userAgent = navigator.userAgent;
  google.script.run.withSuccessHandler(function(datauser) {
    if (typeof datauser === 'object' && datauser !== null) {
      createToast("🔓 เข้าสู่ระบบสำเร็จ " + datauser.fullname, 1);
      localStorage.setItem('uiduser', datauser.uiduser);
      localStorage.setItem('username', datauser.username);
      localStorage.setItem('password', datauser.password);
      localStorage.setItem('fullname', datauser.fullname);
      localStorage.setItem('department', datauser.department);
      localStorage.setItem('group', datauser.group);
      localStorage.setItem('level', datauser.level);
      localStorage.setItem('imgUser', datauser.imgUser);
      localStorage.setItem('tokenUser', datauser.tokenUser);
      localStorage.setItem('sigUser', datauser.sigUser);
      localStorage.setItem('status', datauser.status);
      localStorage.setItem('isLoggedIn', 'true'); 
      if (rememberMe.checked) {
        localStorage.setItem('usernameSave', usernameCheck);
        localStorage.setItem('passwordSave', passwordCheck);
        localStorage.setItem('checked', 'checked');
      } else {
        localStorage.removeItem('usernameSave');
        localStorage.removeItem('passwordSave');
        localStorage.removeItem('checked'); 
      }
      loadDataAfterLogin();
      loginUserSuc(datauser);
      google.script.run.withSuccessHandler(function(menuItems) {
        setDisPlayMenu(datauser.level, menuItems);
      }).getMenuItems(); 
    } else {
      $.LoadingOverlay("hide");
      createToast("❌ ไม่พบข้อมูลผู้ใช้งาน กรุณาตรวจสอบอีกครั้ง", 3);
      $("#pageformLogin").show();
      $("#dashboardPage").hide();
    }
  }).checkUsers(usernameCheck, passwordCheck, ipCheck, userAgent);
}

const loginUserSuc = (datauser) => {
  $.LoadingOverlay("hide");
  $("#pageformLogin").hide();
  $("#dashboardPage").show();
  $('#user-show0').html(datauser.uiduser);
  $('#user-show1').html(datauser.fullname);
  $('#user-show2').html(datauser.department);
  $('#user-show3').html(datauser.level);
  $('#user-show4').html(datauser.sigUser);
  $('#user-show5').html(datauser.group);
  $('#picadmin1').attr('src', datauser.imgUser);
  $('#picadmin2').attr('src', datauser.imgUser);
  $('#picadmin3').attr('src', datauser.sigUser);
  $('#regictorNewPreview').attr('src', datauser.imgUser);
  leaveUserUID = datauser.uiduser;
  getDataLocation();
  reviewdivprofile();
  reviewdivBankCode();
}

const logoutUsers = async () => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  if (localStorage.getItem('isLoggedIn') === 'true') {
    const usernameGeneral = localStorage.getItem('username');
    const ipCheck = await getIPAddress();
    const userAgent = navigator.userAgent;
    google.script.run.withSuccessHandler(function() {
      $.LoadingOverlay("hide");
      const usernameSave = localStorage.getItem('usernameSave');
      const passwordSave = localStorage.getItem('passwordSave');
      const checkedSave = localStorage.getItem('checked');
      localStorage.removeItem('uiduser');
      localStorage.removeItem('username');
      localStorage.removeItem('password');
      localStorage.removeItem('fullname');
      localStorage.removeItem('department');
      localStorage.removeItem('group');
      localStorage.removeItem('level');
      localStorage.removeItem('imgUser');
      localStorage.removeItem('tokenUser');
      localStorage.removeItem('sigUser');
      localStorage.removeItem('status');
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('currentPage');
      if (checkedSave === "checked") {
        localStorage.setItem('usernameSave', usernameSave);
        localStorage.setItem('passwordSave', passwordSave);
        localStorage.setItem('checked', checkedSave);
      }
      changePage(1);
      $('#picadmin1').attr('src', "");
      $('#picadmin2').attr('src', "");
      $('#picadmin3').attr('src', "");
      $("#dashboardPage").hide();
      $('#pageformLogin').show();
      createToast("🔓 ออกจากระบบสำเร็จ", 1);
    }).checkLogoutUsers(usernameGeneral, ipCheck, userAgent);
  } else {
    $.LoadingOverlay("hide");
    createToast("❌ ไม่สามารถออกจากระบบได้", 0);
  }
}

$(document).ready(() => {
  updateAllDropdowns();
});

const updateAllDropdowns = () => {
  const dropdownsConfig = [
    { functionName: 'selectDepartment', selectIds: ['registerData1','searchUsers2','empData2'] },
    { functionName: 'selectGroup', selectIds: ['registerData2','empData3'] },
    { functionName: 'selectObjective', selectIds: ['approveDataLeave','approveDataRequest'] }
  ];

  dropdownsConfig.forEach(config => {
    updateDropdowns(config.functionName, config.selectIds);
  });
}

const updateDropdowns = (functionName, selectIds) => {
  google.script.run.withSuccessHandler((options) => {
    populateSelectElements(selectIds, options);
  })[functionName]();
}

const populateSelectElements = (selectIds, options) => {
  selectIds.forEach(selectId => {
    let selectElement = document.getElementById(selectId);
    if (selectElement) {
      selectElement.innerHTML = '';

      let defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.text = "กรุณาเลือกรายการ";
      defaultOption.selected = true;
      selectElement.appendChild(defaultOption);

      options.forEach(optionText => {
        let option = document.createElement("option");
        option.value = optionText;
        option.text = optionText;
        selectElement.appendChild(option);
      });
    }
  });
}

const saveTodosSet = () => {
  $.LoadingOverlay("show", {image: "", fontawesome: "fa fa-spinner fa-spin"});
    google.script.run.withSuccessHandler(() => {
    $.LoadingOverlay("hide");
    createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
    $('#todoInput').val("");
    $('#ModalDataSetting').modal('show');
      loadTodos(currentSheet);
      updateAllDropdowns();
  }).saveTodos({todos: todoList, sheetName: currentSheet});
}

$('#newsDBData2').summernote({
  placeholder: 'รายละเอียด',
  tabsize: 1,
  height: 200,
  fontNames: ['Prompt', 'Kanit', 'Sarabun', 'Itim', 'Mitr', 'TH SarabunPSK'],
  fontNamesIgnoreCheck: ['Prompt'],
  toolbar: [
    ['style', ['style']],
    ['font', ['bold', 'italic', 'underline', 'clear']],
    ['fontsize', ['fontsize', 'fontname']],
    ['para', ['ul', 'ol', 'paragraph', 'hr']],
    ['table', ['table']],
    ['insert', ['link']],
    ['view', ['fullscreen', 'codeview', 'help']]
  ]
});

const changePage = (data) => {
  let pageName = "";
  switch(data) {
    case 1:
      pageName = "หน้าหลักของระบบ";
      break;
    case 2:
      pageName = "ข้อมูลการลาพนักงาน";
      break;
    case 3:
      pageName = "ข้อมูลการขอหนังสือรับรอง";
      break;
    case 4:
      pageName = "จัดการเงินเดือน";
      break;
    case 5:
      pageName = "นำส่งเงินเดือน";
      break;
    case 6:
      pageName = "จัดการข้อมูลพนักงาน";
      break;
    case 7:
      pageName = "จัดการข้อมูลข่าวสาร";
      break;
    case 8:
      pageName = "รายงานการปฏิบัติงาน";
      break;
    case 9:
      pageName = "รายงานการลางาน";
      break;
    case 10:
      pageName = "ประวัติการเข้าใช้งาน";
       break;
    case 11:
      pageName = "ตารางข้อมูลผู้ใช้งาน";
       break;
    case 12:
      pageName = "ตั้งค่าการใช้งานระบบ";
      break;
    case 13:
      pageName = "ตั้งค่าการทำงานระบบ";
      break;
  }
  localStorage.setItem('currentPage', data);
  for (let i = 1; i <= 13; i++) {
    $("#page" + i).toggle(i === data);
  }
  createToast(`✅ คุณกำลังใช้งาน ${pageName}`, 2);
  if (data === 1) {
    getDataLocation();
  }
}

const savedPage = localStorage.getItem('currentPage');
if (savedPage) {
  changePage(parseInt(savedPage));
} else {
  changePage(1);
}

const closeWindow = () => {
  window.close();
}

let leaveUserUID = null;
let alltimeAttendance = [];
let allleave = [];
let allCalendarLev = [];
let allRequest = null;
let allSummary = null;
let allDataNewsDB = null;
let allLocations = [];
let allsetTime = [];
let allsetLeave = [];
let allsetSalary = [];
let allSetOT = [];
let allSetSSO = [];
let allBacnkCode = [];
let allSetDayOff = [];
let allSetWeekEnd = [];
let dataUsers = null;
let dataRecUsers = null;
let setDataMenu = null;
let previousAllData = null;
let previousAllLeave = null;
let previousAllRequest = null;
let previousAllSummary = null;

const sheetSetting = '186kyck-h9Ytg1ie8ho8X2EqxrOmdM2rXI1s5c5SXSAc';
const sheetData = '16glMiJchpwbufy3LwGAxUIPy8uzdOfTGEoQCMBGe_ts';
const sheetWebApp = '18VX9zgF9WJU6uiB8eY4pKP0iz4sknpTPtjuLuJSvQZY';
const apikey = 'AIzaSyBeTu_pIeQIR15fu2G16hthnmy6h13BQGE';

function fetchDataFromAPI(sheetId, sheetName) {
  const apiUrl = "https://sheets.googleapis.com/v4/spreadsheets/" + sheetId + "/values/" + sheetName + "?alt=json&key=" + apikey;
  return fetch(apiUrl)
    .then(response => response.json())
    .then(data => data.values.slice(1))
    .catch(error => {
      createToast(`❌ เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`, 0);
      return [];
    });
}

function dataHasChanged(newData, oldData) {
  if (!oldData || newData.length !== oldData.length) return true
  for (let i = 0; i < newData.length; i++) {
    if (JSON.stringify(newData[i]) !== JSON.stringify(oldData[i])) {
      return true;
    }
  }
  return false;
}

const fetchAllData = async () => {
  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

  try {
    const [locations, setTime, setLeave, setSalary, setOT, setSSO, bacnkCode, setDayOff, setWeekEnd, timeAttendance, leave, request, summary, newsdb] = await Promise.all([
      delay(100).then(() => fetchDataFromAPI(sheetSetting, 'Locations')),
      delay(200).then(() => fetchDataFromAPI(sheetSetting, 'SetTime')),
      delay(300).then(() => fetchDataFromAPI(sheetSetting, 'SetLeave')),
      delay(400).then(() => fetchDataFromAPI(sheetSetting, 'SetSalary')),
      delay(500).then(() => fetchDataFromAPI(sheetSetting, 'SetOT')),
      delay(600).then(() => fetchDataFromAPI(sheetSetting, 'SetSSO')),
      delay(700).then(() => fetchDataFromAPI(sheetSetting, 'BacnkCode')),
      delay(800).then(() => fetchDataFromAPI(sheetSetting, 'SetDayOff')),
      delay(900).then(() => fetchDataFromAPI(sheetSetting, 'SetWeekEnd')),
      delay(1000).then(() => fetchDataFromAPI(sheetData, 'TimeAttendance')),
      delay(1200).then(() => fetchDataFromAPI(sheetData, 'Leave')),
      delay(1400).then(() => fetchDataFromAPI(sheetData, 'Request')),
      delay(1600).then(() => fetchDataFromAPI(sheetData, 'Summary')),
      delay(1800).then(() => fetchDataFromAPI(sheetData, 'NewsDB'))
    ]);

    allLocations = locations;
    allsetTime = setTime;
    allsetLeave = setLeave;
    allsetSalary = setSalary;
    allSetOT = setOT;
    allSetSSO = setSSO;
    allBacnkCode = bacnkCode;
    allSetDayOff = setDayOff;
    allSetWeekEnd = setWeekEnd;
    alltimeAttendance = timeAttendance;
    allCalendarLev = leave;
    loadCheckinStatus();
    loadLeaveTypes();
    updateCalendarLev();
    insertChartLev();
    loadShiftTimes();
    updateCountsCheckIN();

    await checkAndUpdateDataSetLocations(locations);
    await checkAndUpdateDataSetTime(setTime);
    await checkAndUpdateDataSetLeave(setLeave);
    await checkAndUpdateDataSetSalary(setSalary);
    await checkAndUpdateDataSetOT(setOT);
    await checkAndUpdateDataSetSSO(setSSO);
    await checkAndUpdateDataSetBacnkCode(bacnkCode);
    await checkAndUpdateDataSetDayOff(setDayOff);
    await checkAndUpdateDataSetWeekEnd(setWeekEnd);
    await checkAndUpdateDataLeave(leave);
    await checkAndUpdateDataRequest(request);
    await checkAndUpdateDataSummary(summary);
    await checkAndUpdateDataNewsDB(newsdb);

    return true;
  } catch (error) {
    console.error("เกิดข้อผิดพลาดในการดึงข้อมูล", error);
    createToast(`❌ เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`, 0);
  }
};

const updateSpecificSetLocationsData = async () => {
  const newSetLocationsData = await fetchDataFromAPI(sheetSetting, 'Locations');
  await checkAndUpdateDataSetLocations(newSetLocationsData);
};

async function checkAndUpdateDataSetLocations(newSetLocationsData) {
  if (dataHasChanged(newSetLocationsData, previousAllData)) {
    previousAllData = [...newSetLocationsData];
    allLocations = newSetLocationsData;
    await updateDataSetLocations();
  }
}

const updateSpecificSetTimeData = async () => {
  const newSetTimeData = await fetchDataFromAPI(sheetSetting, 'SetTime');
  await checkAndUpdateDataSetTime(newSetTimeData);
};

async function checkAndUpdateDataSetTime(newSetTimeData) {
  if (dataHasChanged(newSetTimeData, previousAllData)) {
    previousAllData = [...newSetTimeData];
    allsetTime = newSetTimeData;
    await updateDataSetTime();
  }
}

const updateSpecificSetLeaveData = async () => {
  const newSetLeaveData = await fetchDataFromAPI(sheetSetting, 'SetLeave');
  await checkAndUpdateDataSetLeave(newSetLeaveData);
};

async function checkAndUpdateDataSetLeave(newSetLeaveData) {
  if (dataHasChanged(newSetLeaveData, previousAllData)) {
    previousAllData = [...newSetLeaveData];
    allsetLeave = newSetLeaveData;
    await updateDataSetLeave();
  }
}

const updateSpecificSetOTData = async () => {
  const newSetOTData = await fetchDataFromAPI(sheetSetting, 'SetOT');
  await checkAndUpdateDataSetOT(newSetOTData);
};

async function checkAndUpdateDataSetOT(newSetOTData) {
  if (dataHasChanged(newSetOTData, previousAllData)) {
    previousAllData = [...newSetOTData];
    allSetOT = newSetOTData;
    await updateDataSetOT();
  }
}

const updateSpecificSetSSOData = async () => {
  const newSetSSOData = await fetchDataFromAPI(sheetSetting, 'SetSSO');
  await checkAndUpdateDataSetSSO(newSetSSOData);
};

async function checkAndUpdateDataSetSSO(newSetSSOData) {
  if (dataHasChanged(newSetSSOData, previousAllData)) {
    previousAllData = [...newSetSSOData];
    allSetSSO = newSetSSOData;
    await updateDataSetSSO();
  }
}

const updateSpecificSetDayOffData = async () => {
  const newSetDayOffData = await fetchDataFromAPI(sheetSetting, 'SetDayOff');
  await checkAndUpdateDataSetDayOff(newSetDayOffData);
};

async function checkAndUpdateDataSetDayOff(newSetDayOffData) {
  if (dataHasChanged(newSetDayOffData, previousAllData)) {
    previousAllData = [...newSetDayOffData];
    allSetDayOff = newSetDayOffData;
    await updateDataSetDayOff();
  }
}

const updateSpecificSetWeekEndData = async () => {
  const newSetWeekEndData = await fetchDataFromAPI(sheetSetting, 'SetWeekEnd');
  await checkAndUpdateDataSetWeekEnd(newSetWeekEndData);
};

async function checkAndUpdateDataSetWeekEnd(newSetWeekEndData) {
  if (dataHasChanged(newSetWeekEndData, previousAllData)) {
    previousAllData = [...newSetWeekEndData];
    allSetWeekEnd = newSetWeekEndData;
    await updateDataSetWeekEnd();
  }
}

const updateSpecificSetSalaryData = async () => {
  const newSetSalaryData = await fetchDataFromAPI(sheetSetting, 'SetSalary');
  await checkAndUpdateDataSetSalary(newSetSalaryData);
};

async function checkAndUpdateDataSetSalary(newSetSalaryData) {
  if (dataHasChanged(newSetSalaryData, previousAllData)) {
    previousAllData = [...newSetSalaryData];
    allsetSalary = newSetSalaryData;
    await updateDataSetSalary();
  }
}

const updateSpecificSetBacnkCodeData = async () => {
  const newSetBacnkCodeData = await fetchDataFromAPI(sheetSetting, 'BacnkCode');
  await checkAndUpdateDataSetBacnkCode(newSetBacnkCodeData);
};

async function checkAndUpdateDataSetBacnkCode(newSetBacnkCodeData) {
  if (dataHasChanged(newSetBacnkCodeData, previousAllData)) {
    previousAllData = [...newSetBacnkCodeData];
    allBacnkCode = newSetBacnkCodeData;
    await updateDataSetBacnkCode();
  }
}

const updateSpecificSetTimeAttendanceData = async () => {
  const newTimeAttendanceData = await fetchDataFromAPI(sheetData, 'TimeAttendance');
  await checkAndUpdateDataTimeAttendance(newTimeAttendanceData);
};

async function checkAndUpdateDataTimeAttendance(newTimeAttendanceData) {
  if (dataHasChanged(newTimeAttendanceData, previousAllData)) {
    previousAllData = [...newTimeAttendanceData];
    alltimeAttendance = newTimeAttendanceData;
  }
}

const updateSpecificLeaveData = async () => {
  const newLeaveData = await fetchDataFromAPI(sheetData, 'Leave');
  await checkAndUpdateDataLeave(newLeaveData);
};

async function checkAndUpdateDataLeave(newLeaveData) {
  if (dataHasChanged(newLeaveData, previousAllLeave)) {
    previousAllLeave = [...newLeaveData];
    allleave = newLeaveData;
    await updateDataLeave();
  }
}

const updateSpecificRequestData = async () => {
  const newRequestData = await fetchDataFromAPI(sheetData, 'Request');
  await checkAndUpdateDataRequest(newRequestData);
};

async function checkAndUpdateDataRequest(newRequestData) {
  if (dataHasChanged(newRequestData, previousAllRequest)) {
    previousAllRequest = [...newRequestData];
    allRequest = newRequestData;
    await updateDataRequest();
  }
}

const updateSpecificSummaryData = async () => {
  const newSummaryData = await fetchDataFromAPI(sheetData, 'Summary');
  await checkAndUpdateDataSummary(newSummaryData);
};

async function checkAndUpdateDataSummary(newSummaryData) {
  if (dataHasChanged(newSummaryData, previousAllSummary)) {
    previousAllSummary = [...newSummaryData];
    allSummary = newSummaryData;
    await updateDataSummary();
  }
}

const updateSpecificNewsDBData = async () => {
  const newDataNewsDB = await fetchDataFromAPI(sheetData, 'NewsDB');
  await checkAndUpdateDataNewsDB(newDataNewsDB);
};

async function checkAndUpdateDataNewsDB(newDataNewsDB) {
  if (dataHasChanged(newDataNewsDB, previousAllData)) {
    previousAllData = [...newDataNewsDB];
    allDataNewsDB = newDataNewsDB;
    await updateNewsDBTable();
  }
}

async function updateDataLeave() {
  renderDataLeave(allleave);
  renderPageDataLeave(allleave.length);
  updateCountsLeave(allleave);
}

async function updateDataRequest() {
  renderDataRequest(allRequest);
  renderPageDataRequest(allRequest.length);
  updateCountsRequest(allRequest);
}

async function updateDataSummary() {
  renderSummary(allSummary);
  renderPageSummary(allSummary.length);
  updateCountsSalary(allSummary);
  insertChartSalary(allSummary);
}

async function updateNewsDBTable() {
  renderAllDataNewsDB(allDataNewsDB);
  renderPageAllDataNewsDB(allDataNewsDB.length);
  filteredAllDataNewsDB = allDataNewsDB;
  renderAllAnnouncements(allDataNewsDB);
}

async function updateDataSetLocations() {
  renderAllDataSetLocations(allLocations);
}

async function updateDataSetTime() {
  renderAllDataSetTime(allsetTime);
}

async function updateDataSetLeave() {
  renderAllDataSetLeave(allsetLeave);
}

async function updateDataSetOT() {
  renderAllDataSetOT(allSetOT);
}

async function updateDataSetSSO() {
  renderAllDataSetSSO(allSetSSO);
}

async function updateDataSetDayOff() {
  renderAllDataSetDayOff(allSetDayOff);
}

async function updateDataSetWeekEnd() {
  renderAllDataSetWeekEnd(allSetWeekEnd);
}

async function updateDataSetSalary() {
  renderAllDataSetSalary(allsetSalary);
}

async function updateDataSetBacnkCode() {
  renderAllDataSetBacnkCode(allBacnkCode);
}

const fetchUseAllData = async () => {
  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

  try {
    const [usersData, usersDataSet, usersRecData] = await Promise.all([
      delay(200).then(() => fetchDataFromAPI(sheetWebApp, 'Users')),
      delay(400).then(() => fetchDataFromAPI(sheetWebApp, 'UsersMenu')),
      delay(600).then(() => fetchDataFromAPI(sheetWebApp, 'LogUsers'))
    ]);

    await checkAndUpdateDataUsers(usersData);
    await checkAndUpdateDataMenu(usersDataSet);
    await checkAndUpdateDataRecUsers(usersRecData);

    return true;
  } catch (error) {
    createToast(`❌ เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`, 0);
  }
};

const updateSpecificDataUsers = async () => {
  const newDataUsers = await fetchDataFromAPI(sheetWebApp, 'Users');
  await checkAndUpdateDataUsers(newDataUsers);
};

async function checkAndUpdateDataUsers(newDataUsers) {
  if (dataHasChanged(newDataUsers, previousAllData)) {
    previousAllData = [...newDataUsers];
    dataUsers = newDataUsers;
    await updateUsersTable();
  }
}

const updateSpecificDataMenu = async () => {
  const newDataMenu = await fetchDataFromAPI(sheetWebApp, 'UsersMenu');
  await checkAndUpdateDataMenu(newDataMenu);
};

async function checkAndUpdateDataMenu(newDataMenu) {
  if (dataHasChanged(newDataMenu, previousAllData)) {
    previousAllData = [...newDataMenu];
    setDataMenu = newDataMenu;
    await updateMenuTable();
  }
}

const updateSpecificDataRecUsers = async () => {
  const newDataRecUsers = await fetchDataFromAPI(sheetWebApp, 'LogUsers');
  await checkAndUpdateDataRecUsers(newDataRecUsers);
};

async function checkAndUpdateDataRecUsers(newDataRecUsers) {
  if (dataHasChanged(newDataRecUsers, previousAllData)) {
    previousAllData = [...newDataRecUsers];
    dataRecUsers = newDataRecUsers;
    await updateRecUsersTable();
  }
}

async function updateUsersTable() {
  renderUsers(dataUsers);
  renderPageUsers(dataUsers.length);
  filteredUsers = dataUsers;
  updateCountsUsers(dataUsers);
  renderEmployee(dataUsers);
  filteredEmployee = dataUsers;
  showUserSelectListAT(dataUsers);
  showUserSelectListLev(dataUsers);
}

async function updateMenuTable() {
  renderMenuCars(setDataMenu);
}

async function updateRecUsersTable() {
  renderRecUsers(dataRecUsers);
  renderPageRecUsers(dataRecUsers.length);
  filteredRecUsers = dataRecUsers;
}

const allDropdown = () => {
  fetchDataFromAPI(sheetSetting, 'Setsalary').then(salaryData => {
    const selectPeriod = document.getElementById('selectPeriod');
    selectPeriod.innerHTML = '<option value="">เลือกงวดเงินเดือน</option>';
    salaryData.forEach(period => {
      const option = document.createElement('option');
      option.value = period[0];
      option.text = `งวดที่ ${period[3]} (${period[1]} - ${period[2]})`;
      selectPeriod.appendChild(option);
    });
  }).catch(error => {
    console.error("เกิดข้อผิดพลาดในการดึงข้อมูลงวดเงินเดือน:", error);
  });
}

const openLevSelectModal = () => { 
  $('#levSelectModal').modal('show');

  const levSelectList = $('#levSelectList');
  levSelectList.empty();

  allsetLeave.forEach(rowIndex => {
    if (rowIndex[3] === 'TRUE') {
    let imgLeaveTypes = '';
    switch (rowIndex[1]) {
      case 'ลาป่วยมีใบรับรองแพทย์':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/bed-leave.png';
        break;
      case 'ลาป่วยไม่มีใบรับรองแพทย์':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/fever-leave.png';
        break;
      case 'ลากิจจำเป็น':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/leave.png';
        break;
      case 'ลากิจทั่วไป':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/training-leave.png';
        break;
      case 'ลาพักร้อน':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/beach-chair-leave.png';
        break;
      case 'ลาบวช':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/monk-leave.png';
        break;
      case 'ลาคลอด':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/mother-leave.png';
        break;
      case 'ลารับราชการทหาร':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/soldier-leave.png';
        break;
      default:
        imgLeaveTypes = 'https://cdn.jsdelivr.net/gh/napusmobile/napusmobile@main/logo.png';
    }
    const leaveItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leavelist-item" style="background-color: #f8f9fa; cursor: pointer;" onclick="selectLeave('${rowIndex[1]}')">
        <div class="d-flex align-items-center">
          <img src="${imgLeaveTypes}" alt="${rowIndex[0]}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${rowIndex[1]}</strong>
            <br>
            <small class="text-muted">จำนวนสูงสุด ${rowIndex[2]} วัน</small>
          </div>
        </div>
      </div>
      `;
      levSelectList.append(leaveItem);
    }
  });
};

const selectLeave = (leaveTypeLabel) => {
  document.getElementById('leaveData1').value = leaveTypeLabel;
  document.getElementById('leaveData7').style.display = (leaveTypeLabel === 'ลาป่วยมีใบรับรองแพทย์') ? 'block' : 'none';
  document.getElementById('leaveData7Row').style.display = (leaveTypeLabel === 'ลาป่วยมีใบรับรองแพทย์') ? 'block' : 'none';

  createToast(`✅ เลือกรายการ (${leaveTypeLabel})`, 2);

  $('#levSelectModal').modal('hide');
  $('#RPTLModal').modal('show');
};

$('#RPTLModal').on('shown.bs.modal', () => {
  setMinDateLeave();

  const leaveData3 = document.getElementById('leaveData3');
  const leaveData4 = document.getElementById('leaveData4');

  if (leaveData3) {
    leaveData3.addEventListener('change', () => {
      const fullDaySwitch = document.getElementById('fullDaySwitch');
      const morningHalfDaySwitch = document.getElementById('morningHalfDaySwitch');
      const afternoonHalfDaySwitch = document.getElementById('afternoonHalfDaySwitch');
      if (fullDaySwitch?.checked) {
        toggleFullDayLeave();
      } else if (morningHalfDaySwitch?.checked) {
        toggleMorningHalfDayLeave();
      } else if (afternoonHalfDaySwitch?.checked) {
        toggleAfternoonHalfDayLeave();
      }
    });

    document.getElementById('leaveData3')?.addEventListener('change', handleLeaveStartDateChange);
    document.getElementById('leaveData3')?.addEventListener('change', calculateLeave);
    document.getElementById('leaveData4')?.addEventListener('change', calculateLeave);

  }
});

let selectedBankCode = null;
const openBankSelectModal = () => { 
  $('#bankSelectModal').modal('show');

  const bankSelectList = $('#bankSelectList');
  bankSelectList.empty();

  allBacnkCode.forEach(bank => {
    const bankNameTH = bank[1];
    const bankNameEN = bank[2];
    const bankID = bank[0];
    const bankImage = bank[3];
    const bankItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leavelist-item" style="background-color: #f8f9fa; cursor: pointer;" onclick="selectBank('${bankID}')" data-bank-id="${bankID}">
        <div class="d-flex align-items-center">
          <img src="${bankImage}" alt="${bankID}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${bankNameTH}</strong>
            <br>
            <small class="text-muted">${bankNameEN}</small>
          </div>
        </div>
      </div>
    `;
    bankSelectList.append(bankItem);
  });
};

const selectBank = (bankCode) => {
  selectedBankCode = bankCode;
  document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));
  const selectedItem = document.querySelector(`[data-bank-id="${bankCode}"]`);
  if (selectedItem) {
    selectedItem.classList.add('selected');
  }
  createToast(`✅ เลือกธนาคาร (${bankCode}) เรียบร้อย`, 2);
};

const applyBankSelection = () => {
  if (selectedBankCode) {
    $('#bankSelectModal').modal('hide');
    document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));
    sendSummaryBankCode(selectedBankCodeID, selectedBankCode);
  } else {
    createToast("⚠️ กรุณาเลือกธนาคารก่อน", 0);
  }
};

let cameraStream = null;
let capturedImageData = null;
let currentFacingMode = 'environment';
let selectedBranch = null;

const openBranchSelectModal = () => {
  $('#branchSelectModal').modal('show');
  checkCameras();
  const branchSelectList = $('#branchSelectList');
  branchSelectList.empty();

  allLocations.forEach(branch => {
    const branchID = branch[0];
    const branchName = `${branch[1]} ${branch[2]} ${branch[3]}`;

    const branchItem = `
      <div class="leavelist-item d-flex align-items-center justify-content-between p-2 mb-2 rounded" style="background-color: #f8f9fa; cursor: pointer;" onclick="selectBranch('${branchID}')" data-branch-id="${branchID}">
        <div class="d-flex align-items-center">
          <img src="https://cdn.jsdelivr.net/gh/napusmobile/napusmobile@main/logo.png" alt="${branchID}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${branchID}</strong>
            <br>
            <small class="text-muted">${branchName}</small>
          </div>
        </div>
      </div>
    `;
    branchSelectList.append(branchItem);
  });
};

// ปรับปรุงฟังก์ชัน selectBranch
const selectBranch = async (branchID) => {
  selectedBranch = allLocations.find(branch => branch[0] === branchID);

  document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));

  const selectedItem = document.querySelector(`[data-branch-id="${branchID}"]`);
  if (selectedItem) {
    selectedItem.classList.add('selected');
  }

  await checkUserLocation();
};

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('captureBtn').addEventListener('click', captureImage);
  document.getElementById('recaptureBtn').addEventListener('click', recaptureImage);
  document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
});

const openLeaveApprovalModal = () => {
  $('#leaveApprovalModal').modal('show');

  const approvalLeaveList = $('#approvalLeaveList');
  approvalLeaveList.empty();

  let pendingLeaves = allleave.filter(leave => leave[1] === "รอตรวจสอบ");
  let leaveCount = pendingLeaves.length;

  $('#leaveCount').text(leaveCount);

  pendingLeaves.forEach(rowIndex => {
    let user = dataUsers && dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/napusmobile/napusmobile@main/logo.png';

    const leaveItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leave-item" style="background-color: #f8f9fa;">
        <div class="d-flex align-items-center">
          <img src="${userImage}" alt="${rowIndex[3]}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${rowIndex[4]} (${rowIndex[5]})</strong>
            <br>
            <small class="text-muted">${rowIndex[8]} จำนวน ${rowIndex[13]} วัน ${rowIndex[14]} ชั่วโมง</small>
          </div>
        </div>
        <button class="btn upload-button btn-sm leave-button" onclick="setappLeave('${rowIndex[0]}')">
          <i class="fa-solid fa-pen-to-square"></i> จัดการ
        </button>
      </div>
    `;
    approvalLeaveList.append(leaveItem);
  });
};

let selectedAllleave = {};
const setappLeave = (codeID) => {
  const userRole = localStorage.getItem('level') || '';
  if (userRole !== 'SuperAdmin' && userRole !== 'Admin') {
    createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
    return;
  }
  
  const row = allleave.find(row => row[0] === codeID);
  $('#leaveApprovalModal').modal('hide');
  $('#leaveApprovalRequestModal').modal('show');
  selectedAllleave = row;
  
  if (row) {
    $('#nameLeaveapproval').html(row[4]);
    $('#dpmLeaveapproval').html(row[5]);
    $('#leaveApproval1').html(row[8]);

    if (row[13] === 0 && row[14] === 12) {
      $('#leaveApproval2').html('ครึ่งวัน');
    } else if (row[13] >= 1) {
      $('#leaveApproval2').html('เต็มวัน');
    } else {
      $('#leaveApproval2').html('');
    }
    
    $('#leaveApproval3').html(`เริ่ม ${row[11]}`);
    $('#leaveApproval4').html(`สิ้นสุด ${row[12]}`);
    $('#leaveApproval5').html(`${row[13]} วัน ${row[14]} ชั่วโมง`);
  }
};

const closesetappLeave = () => {
  $('#leaveApprovalModal').modal('show');
  $('#leaveApprovalRequestModal').modal('hide');
};

// function fetchChatMessages() {

// }

const loadImagepdfmake = (url, callback) => {
  var img = new Image();
  img.crossOrigin = 'Anonymous';
  img.onload = () => {
    var canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    var dataURL = canvas.toDataURL('image/png');
    callback(dataURL);
  };
  img.src = url;
};

const createPayroll = (payrollData, callback) => {
  loadImagepdfmake('https://cdn.jsdelivr.net/gh/napusmobile/napusmobile@main/logo.png', (imageBase64) => {
    const docPayrollPDF = {
      pageSize: { width: 595.28, height: 421.89 },
      pageMargins: [40, 30, 40, 30],
      content: [
        {
          columns: [
            [
              { text: 'Epic Coding Channel', style: 'subheader', alignment: 'left', fontSize: 20 },
              { text: `ชื่อพนักงาน (รหัส): ${payrollData.fullname} (${payrollData.uid})`, bold: true, fontSize: 14 },
              { text: `ตำแหน่ง: ${payrollData.department}`, fontSize: 14 },
              { text: `แผนก: ${payrollData.group}`, fontSize: 14 }
            ],
            { 
              image: imageBase64, 
              width: 50, 
              alignment: 'center', 
              margin: [0, 0, 0, 10]
            },
            [
              { text: 'สลิปเงินเดือน / Pay Slip', style: 'subheader', alignment: 'right', fontSize: 20 },
              { text: `รอบเงินเดือน: ${payrollData.paymentPeriod}`, alignment: 'right', fontSize: 14 },
              { text: `วันที่จ่าย: ${payrollData.paymentDate}`, alignment: 'right', fontSize: 14 },
              { text: `เลขที่บัญชี: ${payrollData.accountbank}`, alignment: 'right', fontSize: 14 }
            ]
          ]
        },
        {
          table: {
            headerRows: 1,
            widths: ['*', 'auto', '*', 'auto', '*', 'auto'],
            body: [
              [
                { text: 'เงินได้\nEarnings', colSpan: 2, style: 'tableHeader', alignment: 'center' }, 
                {},  
                { text: 'รายการหัก\nDeductions', colSpan: 2, style: 'tableHeader', alignment: 'center' },
                {},
                { text: 'รายได้สะสม\nRetained income', colSpan: 2, style: 'tableHeader', alignment: 'center' },
                {}
              ],
              [
                { text: 'เงินเดือน/ค่าจ้าง', alignment: 'left' },
                { text: payrollData.paysalary.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'ประกันสังคม', alignment: 'left' },
                { text: payrollData.socialSecurity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'เงินได้สะสม', alignment: 'left', bold: true },
                { text: payrollData.retainedIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' } 
              ],
              [
                { text: 'เงินพิเศษ', alignment: 'left' },
                { text: payrollData.payspecial.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'ภาษีหัก ณ ที่จ่าย', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'ภาษีหัก ณ ที่จ่ายสะสม', alignment: 'left', bold: true },
                { text: '0.00', alignment: 'right' } 
              ],
              [
                { text: 'ค่าล่วงเวลา', alignment: 'left' },
                { text: payrollData.overtime.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'เงินกู้ยืม กยศ./กรอ.', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'ประกันสังคมสะสม', alignment: 'left', bold: true },
                { text: payrollData.retainedSocialSecurity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' } 
              ],
              [
                { text: 'ค่าเบี้ยเลี้ยง/ค่าครองชีพ', alignment: 'left' },
                { text: payrollData.allowance ? payrollData.allowance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00', alignment: 'right' }, 
                { text: 'เงินประกัน', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'รวมเงินได้', alignment: 'left', bold: true },
                { text: payrollData.adjustments.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' } 
              ],
              [
                { text: 'โบนัส', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'ขาด/ลา/สาย', alignment: 'left' },
                { text: payrollData.absentDeduction.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'รวมรายการหัก', alignment: 'left', bold: true },
                { text: payrollData.deductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right', bold: true } 
              ],
              [
                { text: 'เงินอื่นๆ', alignment: 'left' },
                { text: payrollData.commission.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'รายการหักอื่นๆ', alignment: 'left' },
                { text: payrollData.otherDeduction.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'เงินได้สุทธิ', alignment: 'left', bold: true },
                { text: payrollData.totalpaysalary.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right', bold: true } 
              ]
            ]
          },
          layout: {
            hLineWidth: function(i, node) {
              return i === 0 || i === node.table.body.length ? 1 : 0; 
            },
            vLineWidth: function(i, node) {
              return i === 0 || i === node.table.widths.length ? 1 : 0; 
            },
            hLineColor: function(i, node) {
              return '#000000'; 
            },
            vLineColor: function(i, node) {
              return '#000000'; 
            },
            paddingLeft: function(i, node) { return 8; },  
            paddingRight: function(i, node) { return 8; }, 
            paddingTop: function(i, node) { return 3; },
            paddingBottom: function(i, node) { return 3; }
          }
        },
        // ลายเซ็นและหมายเหตุ
        {
          columns: [
            [{ text: 'หมายเหตุ:', style: 'subheader', alignment: 'left', fontSize: 16, margin: [0, 15, 0, 0] }],
            [{ text: 'ลายเซ็นผู้จ่ายเงิน:   ________________________', style: 'subheader', alignment: 'right', fontSize: 16, margin: [0, 15, 0, 0] }]
          ]
        },
        {
          columns: [
            [{ text: ' __________________________________________________________________________________________________________________', style: 'subheader', alignment: 'center', fontSize: 12, margin: [0, 10, 0, 0] }]
          ]
        },
        {
        stack: [
          { text: 'ข้อมูลเงินเดือนและค่าจ้างเป็นข้อมูลส่วนบุคคล ห้ามเปิดเผยโดยเด็ดขาดเอกสารนี้จะสมบูรณ์เมื่อมีลายเซ็นผู้มีอำนวจลงนามและตราประทับเท่านั้น', alignment: 'center' },
          { text: 'Salary and wages are confidential information. Disclosure is strictly prohibited. This document is only valid with an authorized signature and company stamp.', alignment: 'center' }
        ],
          style: 'footer',
          margin: [0, 0, 0, 0]
        }
      ],
      styles: {
        header: { fontSize: 16, bold: true },
        subheader: { fontSize: 14, bold: true },
        tableHeader: { bold: true, fontSize: 14, color: 'black' },
        footer: { fontSize: 9, italics: true }
      },
      defaultStyle: {
        font: 'THSarabunNew',
        fontSize: 14,
        color: 'black'
      }
    };

    pdfMake.createPdf(docPayrollPDF).getBase64((base64) => {
      callback(base64);
    });
  });
};

const openRequestApprovalModal = () => {
  $('#requestApprovalModal').modal('show');

  const approvalRequestList = $('#approvalRequestList');
  approvalRequestList.empty();

  let pendingREQ = allRequest.filter(row => row[1] === "รอตรวจสอบ");
  let requestCount = pendingREQ.length;

  $('#requestCount').text(requestCount);

  pendingREQ.forEach(rowIndex => {
    let user = dataUsers && dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/napusmobile/napusmobile@main/logo.png';

    const requestItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leave-item" style="background-color: #f8f9fa;">
        <div class="d-flex align-items-center">
          <img src="${userImage}" alt="${rowIndex[3]}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${rowIndex[4]} (${rowIndex[5]})</strong>
            <br>
            <small class="text-muted">${rowIndex[8]}</small>
          </div>
        </div>
        <button class="btn upload-button btn-sm leave-button" onclick="setapprequest('${rowIndex[0]}')">
          <i class="fa-solid fa-pen-to-square"></i> จัดการ
        </button>
      </div>
    `;
    approvalRequestList.append(requestItem);
  });
};

let selectedAllRequest = {};
const setapprequest = (codeID) => {
  const userRole = localStorage.getItem('level') || '';
  if (userRole !== 'SuperAdmin' && userRole !== 'Admin') {
    createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
    return;
  }
  
  const row = allRequest.find(row => row[0] === codeID);
  $('#requestApprovalModal').modal('hide');
  $('#reqApprovalRequestModal').modal('show');
  selectedAllRequest = [codeID];
  
  if (row) {
    $('#nameReqapproval').html(row[4]);
    $('#dpmReqapproval').html(row[5]);
    $('#ReqApproval1').html(row[8]);
  }
};

const closesetappRequest = () => {
  $('#requestApprovalModal').modal('show');
  $('#reqApprovalRequestModal').modal('hide');
}

$('#holidayModal').on('shown.bs.modal', () => {
  const currentYear = new Date().getFullYear();
  const years = [];
  for (let i = currentYear; i <= currentYear + 3; i++) {
    years.push(i);
  }
  document.getElementById("selectYearModal").innerHTML = years
    .map((year) => `<option value="${year}" ${year == currentYear ? 'selected' : ''}>${year}</option>`)
    .join("");
  document.getElementById("selectYearModal").addEventListener("change", showHolidayModal);
  showHolidayModal();
});
</script>
