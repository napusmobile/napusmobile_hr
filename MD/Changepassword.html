<div class="modal fade" id="NewProfileModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="NewProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h5 class="mb-2 fw-bold mt-2 text-primary"> เปลี่ยนรูปประจำตัว</h5>
            <div style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); border:3px solid white;" class="mb-3">
              <img id="regictorNewPreview" src="https://img2.pic.in.th/pic/vsvds.png" alt="รูปประจำตัว" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <input type="file" name="regictorNewImg" id="regictorNewImg" style="display:none">
        </div>
              <div class="mb-2">
                <div class="d-flex align-items-center justify-content-center mb-2">
                <label for="regictorNewImg" class="btn edit-button">อัพโหลดรูปคลิกที่นี่</label>
                </div>
              </div>
      <center>
      <div class="mt-2">
        <button type="button" class="btn set-button" onclick="saveUploadProfile()">ยืนยัน</button>
        <button type="button" class="btn del-button"  data-bs-dismiss="modal">ยกเลิก</button>
      </div>
      </center>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="NewSigModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="NewSigModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h5 class="mb-0 fw-bold mt-2 text-primary">เปลี่ยนรูปลายเซ็น</h5>
              <center>
                <div class="row mt-2">
                  <div class="col-md-6 text-center">
                    <a for="signatureCanvas" class="form-label mt-2"></a>
                    <canvas id="signatureCanvas" class="rounded-4 shadow" style="width: 300px;"></canvas>
                  </div>
                  <div class="col-md-12 text-center mt-2">
                    <span><i class="fa-solid fa-palette text-success"></i> เปลี่ยนสี <input type="color" id="colorPickerA" class="color-picker"></span>
                  </div>
                </div>
                <div class="row">
                </div>
                <div class="row col-md-6">
                  <button class="btn upload-button mt-2" name="clear-signature" id="clearButtonA"><i class="fa-solid fa-eraser"></i> ล้างลายมือชื่อ</button>
                </div>
              </center>         
        </div>
      <center>
      <div class="mt-2">
        <button type="button" class="btn set-button" onclick="saveUploadSig()">ยืนยัน</button>
        <button type="button" class="btn del-button" id="xbtnUploadsigModal" data-bs-dismiss="modal">ยกเลิก</button>
      </div>
      </center>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="userChangePwModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="userChangePwModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="text-center mb-2">
          <h5 class="mb-0 fw-bold mt-2 text-primary" id="textChange">ปลี่ยนรหัสผ่าน</h5>
        </div>
        <div class="mb-2">
          <label for="ChangePasswordA" class="form-label">กรอกรหัสผ่านใหม่ <span class="text-danger">*</span></label> 
          <div class="input-group">
            <input class="form-control" type="password" id="ChangePasswordA" placeholder="กรุณายืนยันรหัสผ่านใหม่">
            <button type="button" class="btn set-button" id="showChangeAPassword">
                <i class="fa fa-eye" id="toggleIconChangeA"></i>
            </button>
          </div>
        </div> 
        <div class="mb-2">
          <label for="ChangePasswordB" class="form-label">ยืนยันรหัสผ่านใหม่ <span class="text-danger">*</span></label> 
          <div class="input-group">
            <input class="form-control" type="password" id="ChangePasswordB" placeholder="กรุณายืนยันรหัสผ่านใหม่">
            <button type="button" class="btn set-button" id="showChangeBPassword">
                <i class="fa fa-eye" id="toggleIconChangeB"></i>
            </button>
          </div>
        </div> 
      <center>
      <div class="mt-2">
        <button type="button" class="btn set-button" onclick="changePassword()">ยืนยัน</button>
        <button type="button" class="btn del-button" id="xbtnUserChangePwModal" data-bs-dismiss="modal">ยกเลิก</button>
      </div>
      </center>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', (ev) => {
  let input = document.querySelector('input[id="regictorNewImg"]');
  input.addEventListener('change', (ev) => {
      if (input.files[0].type.indexOf("image/") > -1) {
        let img = document.getElementById('regictorNewPreview');
        img.src = window.URL.createObjectURL(input.files[0]);
      }
  });
});

document.getElementById('showChangeAPassword').addEventListener('click', function () {
  const passwordInput = document.getElementById('ChangePasswordA');
  const toggleIconChangeA = document.getElementById('toggleIconChangeA');
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIconChangeA.classList.remove('fa-eye');
    toggleIconChangeA.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIconChangeA.classList.remove('fa-eye-slash');
    toggleIconChangeA.classList.add('fa-eye');
  }
});

document.getElementById('showChangeBPassword').addEventListener('click', function () {
  const passwordInput = document.getElementById('ChangePasswordB');
  const toggleIconChangeB = document.getElementById('toggleIconChangeB');
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIconChangeB.classList.remove('fa-eye');
    toggleIconChangeB.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIconChangeB.classList.remove('fa-eye-slash');
    toggleIconChangeB.classList.add('fa-eye');
  }
});

const changePassword = () => {
  $.LoadingOverlay("show", {  image : "", fontawesome : "fa fa-spinner fa-spin" });
  $(".form-control").removeClass("text-bg-warning");
  if ($("#ChangePasswordA").val() === "") {
    $("#ChangePasswordA").addClass("text-bg-warning");
    createToast("⚠️ กรุณากรอกรหัสผ่านใหม่", 0);
    $.LoadingOverlay("hide");
  } else if ($("#ChangePasswordB").val() === "") {
    $("#ChangePasswordB").addClass("text-bg-warning");
    createToast("⚠️ กรุณายืนยันรหัสผ่าน", 0);
    $.LoadingOverlay("hide");
  } else if ($("#ChangePasswordA").val() !== $("#ChangePasswordB").val()) {
    $("#ChangePasswordB").addClass("text-bg-warning");
    $("#ChangePasswordA").addClass("text-bg-warning");
    createToast("⚠️ รหัสผ่านไม่ตรงกัน", 0);
    $.LoadingOverlay("hide");
  } else {
    let fullname = localStorage.getItem('fullname');
    let obj = {}
      obj.code = fullname;
      obj.password = $("#ChangePasswordA").val();

      $("#username").val(localStorage.getItem('User'));
      $("#password").val(obj.password);

    google.script.run.withSuccessHandler(function(response) {
      $.LoadingOverlay("hide");
      $("#xbtnUserChangePwModal").click();
      $('#ChangePasswordA').val("")
      $('#ChangePasswordB').val("")
      createToast("✅ เปลี่ยนรหัสผ่านสำเร็จ", 1);
      $('#logoutModal').modal('show')
    }).changePasswordMember(obj);  
  } 
}

const saveUploadProfile = () => {
  $.LoadingOverlay("show", {  image : "", fontawesome : "fa fa-spinner fa-spin" });
  let fullname = localStorage.getItem('fullname');
  let imgUser = localStorage.getItem('imgUser');
  var obj = {}
  obj.codeName = fullname;
  obj.check = $("#regictorNewImg").val();
  if (obj.check === "") {
    obj.profileNew = $("#regictorNewPreview").attr("src");
  } else {
    var imgElement = document.getElementById("regictorNewPreview");
    var canvas = document.createElement("canvas");
    var context = canvas.getContext("2d");
    canvas.width = imgElement.naturalWidth;
    canvas.height = imgElement.naturalHeight;
    context.drawImage(imgElement, 0, 0, imgElement.naturalWidth, imgElement.naturalHeight);
    var imageDataUrl = canvas.toDataURL("image/png");
    obj.imageDataUrl = imageDataUrl;
    obj.filetype = "image/png"; 
    obj.filename = fullname;
  }
  google.script.run.withSuccessHandler(function(response) {
    $.LoadingOverlay("hide");
    createToast("✅ เปลี่ยนรูปโปรไฟล์สำเร็จ", 1);
    $('#NewProfileModal').modal('hide');
    localStorage.setItem('imgUser', response);
    $("#picadmin1").attr('src', response);
    $("#picadmin2").attr('src', response); 
    $('#logoutModal').modal('show') 
  }).updateProfile(obj);
}

const saveUploadSig = () => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  let fullname = localStorage.getItem('fullname');
  let sigUser = localStorage.getItem('sigUser');
  let obj = {
    codeName: fullname,
    signatureCanvas: document.getElementById('signatureCanvas').toDataURL("image/png"),
    filetype: "image/png",
    filename: sigUser
  };
  google.script.run.withSuccessHandler(function(response) {
    $.LoadingOverlay("hide");
    createToast("✅ เปลี่ยนรูปลายเซ็นสำเร็จ", 1);
    $('#NewSigModal').modal('hide');
    signaturePadUser.clear();
    localStorage.setItem('sigUser', response);
    $('#logoutModal').modal('show');
  }).saveUploadSig(obj);
} 
</script>
