ชีต 3 ไฟล์
1.ชีต ชื่อ  New Web App HRdrive id = 1qSXdMug4fTOwiUvIIBnhecFI0Hz5LLM5LMqVTP9L1zQ  ในชีตประกอบด้วย  1.1 ชีต Setting ทำหน้าที่ บันทึก ค่า ต่างๆ : 1XZBZXvHRF247MZWHGrOgW7lMtbwrmrDb
1xUiA3rJwOJlkMxj3II6YckC95XU649HS
1xUiA3rJwOJlkMxj3II6YckC95XU649HS
1QZlRGf6YKE0t51XpwQeBc7bmQfWqNSvWmZQUzdYrkSs
1SxF5vcTyx4JwRt1RtR0RPXgmlF9cyq-PnViKBRGeDtM
xxx
xxx
xxx
https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png
HRDrive | Epic Coding Channel
HRDrive | ECC
1.2 ชีต ชื่อ Users ทำหน้าที่บันทึก user name ของสมาชิก และกำหนดสิทธิ์การเข้าถึง : UID	Username	Password	Fullname	department	group	status	ภาพ	Token	SIG	status	การจ้างงาน	เลขประจำตัวประชาชน	เลขประกันสังคม	เพศ	วันเกิด	สัญชาติ	สถานภาพ	พิการ/ทุพพลภาพ	เริ่มงาน	ค่าจ้าง	การจ่าย	เงินพิเศษ	การชำระ	ธนาคาร	เลขที่บัญชี	ประเภทบัญชี	สาขา	สิทธิ์ประกันสังคม	ที่อยู่	Email	Line	Phone	วันที่เลิกจ้าง
USER-001	admin	admin	ผู้ดูแลระบบ	IT Management	ฝ่ายบริหารสำนักงาน	SuperAdmin	https://lh3.googleusercontent.com/d/1vnYyfj8O-2NUNXs-ipXilvYVOWz1jnDJ	ibT6Zr9EqqBNQp16JDaWuLdi883EBxCwzHCnnq9C3De	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	TRUE	พนักงานประจำ	1122334455667	1122334455667	ชาย	17/12/1996	ไทย	โสด	ปกติ	01/01/2021	150,000.00	รายเดือน	100,000.00	โอนเงิน	ธนาคารกรุงเทพ	1234567890	บัญชีออมทรัพย์	แจ้งวัฒนะ2	ขึ้นสิทธิ์ประกันสังคม	185/10 เอื้ออาทรวัดกู้ 2 ต.บางพูด อ.ปากเกร็ด จ.นนทบุรี 11120	jakkapong171239@gmail.com	0659249350	0659249350	
USER-002	user1	1234	admin	หน่วยงานA	ฝ่ายบริหารงานบุคคล	User	https://cdn.jsdelivr.net/gh/EPICCODING17/image/user-1.png	ibT6Zr9EqqBNQp16JDaWuLdi883EBxCwzHCnnq9C3De	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	TRUE	พนักงานประจำ	1122334455667		ชาย	17/12/1996	ไทย	โสด	ปกติ	01/01/2021	15,000.00	รายเดือน	250.00	โอนเงิน	ธนาคารกสิกรไทย	1234567890	บัญชีออมทรัพย์	แจ้งวัฒนะ2		185/10 เอื้ออาทรวัดกู้ 2 ต.บางพูด อ.ปากเกร็ด จ.นนทบุรี 11120	jakkapong171239@gmail.com	0659249350	0659249350	
USER-003	admin1	1234	EpicCoding	IT Support	ฝ่ายจัดซื้อจัดจ้าง	Admin	https://cdn.jsdelivr.net/gh/EPICCODING17/image/user-28.png	ibT6Zr9EqqBNQp16JDaWuLdi883EBxCwzHCnnq9C3De	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	TRUE	พนักงานประจำ	1122334455667						ปกติ	01/01/2021	15,000.00	รายเดือน	250.00	โอนเงิน	ธนาคารกรุงเทพ	1234567890		แจ้งวัฒนะ2		185/10 เอื้ออาทรวัดกู้ 2 ต.บางพูด อ.ปากเกร็ด จ.นนทบุรี 11120	jakkapong171239@gmail.com	0659249350	0659249350	
USER-004	admin2	1234	Ecc.	หน่วยงานD	ฝ่ายจัดซื้อจัดจ้าง	Admin	https://cdn.jsdelivr.net/gh/EPICCODING17/image/user-3.png	ibT6Zr9EqqBNQp16JDaWuLdi883EBxCwzHCnnq9C3De	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	TRUE	พนักงานประจำ	1122334455667	1122334455667	ชาย	20/11/2024	ไทย	โสด	ปกติ	04/01/2021	15,000.00	รายเดือน	250.00	โอนเงิน	ธนาคารกรุงเทพ	รายเดือน	บัญชีออมทรัพย์	ห้าแยกปากเกร็ด	ขึ้นสิทธิ์ประกันสังคม	185/10 เอื้ออาทรวัดกู้ 2 ต.บางพูด อ.ปากเกร็ด จ.นนทบุรี 11120	jakkapong171239@gmail.com	0659249350	0659249350	
USER-005	user2	1234	pongza	หน่วยงานA	ฝ่ายบริหารงานบุคคล	User	https://cdn.jsdelivr.net/gh/EPICCODING17/image/user-44.png	ibT6Zr9EqqBNQp16JDaWuLdi883EBxCwzHCnnq9C3De	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	TRUE	พนักงานประจำ	1122334455667		ชาย	17/12/1996	ไทย	โสด		01/01/2021	15,000.00	รายเดือน	250.00	โอนเงิน		1234567890	บัญชีออมทรัพย์			185/10 เอื้ออาทรวัดกู้ 2 ต.บางพูด อ.ปากเกร็ด จ.นนทบุรี 11120	jakkapong171239@gmail.com	0659249350	0659249350	
USER-006	test1	1234	ธาวิน อุดมทรัพย์	หน่วยงานA	ฝ่ายจัดซื้อจัดจ้าง	User	https://lh3.googleusercontent.com/d/1PQFvcJBJRwK3Z-fhDvORn01CIhBC-6mo	ibT6Zr9EqqBNQp16JDaWuLdi883EBxCwzHCnnq9C3De	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	TRUE	พนักงานประจำ	1122334455668	1122334455668	ชาย		ไทย		ปกติ	01/01/2021	15,000.00	รายเดือน	0.00	โอนเงิน	ธนาคารกสิกรไทย	1234567890	บัญชีออมทรัพย์	แจ้งวัฒนะ2		185/10 เอื้ออาทรวัดกู้ 2 ต.บางพูด อ.ปากเกร็ด จ.นนทบุรี 11120	jakkapong171239@gmail.com		0659249350	
1.3 ชีต ชื่อ UsersMenu กำหนดสิทธิการเข้าถึงว่า user นั้นๆทำอะไรได้บ้าง เมนู	MenuItems	SuperAdmin	Admin	SuperUser	User
ปุ่มอนุมัติการลา	appLev-button	TRUE	TRUE	TRUE	FALSE
ปุ่มอนุมัติเอกสารรับรอง	reqList-button	TRUE	TRUE	FALSE	FALSE
หน้าหลัก	manuLi1	TRUE	TRUE	TRUE	TRUE
การลาพนักงาน	manuLi2	TRUE	TRUE	TRUE	FALSE
การขอหนังสือรับรอง	manuLi3	TRUE	TRUE	TRUE	FALSE
จัดการเงินเดือน	manuLi4	TRUE	TRUE	FALSE	FALSE
นำส่งเงินเดือน	manuLi5	TRUE	TRUE	FALSE	FALSE
จัดการข้อมูลพนักงาน	manuLi6	TRUE	TRUE	TRUE	FALSE
จัดการข้อมูลข่าวสาร	manuLi7	TRUE	TRUE	TRUE	FALSE
รายงานการปฏิบัติงาน	manuLi8	TRUE	TRUE	FALSE	FALSE
รายงานการลางาน	manuLi9	TRUE	TRUE	FALSE	FALSE
ประวัติเข้าใช้งาน	manuLi10	TRUE	TRUE	TRUE	FALSE
ผู้ใช้งาน	manuLi11	TRUE	TRUE	FALSE	FALSE
ตั้งค่าระบบ	manuLi12	TRUE	FALSE	FALSE	FALSE
ตั้งค่าการทำงานระบบ	manuLi13	TRUE	FALSE	FALSE	FALSE
1.4 ชีต ชื่อ LogUsers ทำหน้าที่บันทึกการเข้าใช้งานระบบ

2. ชีตชื่อ Setting ตั้งค่าระบบเงินเดือน ประกอบด้วย 2.1 ชีต  ชื่อDepartment ทำหน้าที่ กำหนดหน่วยงาน ID	หน่วยงาน
A	IT Management
B	IT Support
C	หน่วยงานA
D	หน่วยงานB
E	หน่วยงานC
F	หน่วยงานD
G	หน่วยงานE
H	หน่วยงานF
2.2 ชีต ชื่อ Group ทำหน้าที่ กำหนด  ฝ่ายการทำงาน ID	ฝ่าย
A	ฝ่ายบริหารสำนักงาน
B	ฝ่ายบริหารงานบุคคล
C	ฝ่ายจัดซื้อจัดจ้าง
D	ฝ่ายคอมพิวเตอร์
2.3 ชีต ชื่อ Objective ทำหน้าที่ กำหนด  ว่าอนุมัติว่าให้ลาไหม : ID	สถานะการตอบรับ
A	เห็นควรอนุมัติ
B	ไม่ตรงตามกฎ
C	อนุมัติตามเสนอ
D	ผิดข้อกำหนดบริษัท
2.4 ชีต ชื่อ Locations กำหนด ที่ตั้ง จุด ที่สามารถ ลงเวลาทำงานได้ : สถานที่	ที่อยู่	เมือง	รหัสไปรษณีย์	พิกัดละติจูด	พิกัดลองจิจูด
Epic Coding Channel1	78 11 หมู่ที่ 1 ถ. ติวานนท์ ตำบลบางตลาด อำเภอปากเกร็ด นนทบุรี 11120	ปากเกร็ด	11120	13.824819	100.551885
Epic Coding Channel2	78 11 หมู่ที่ 1 ถ. ติวานนท์ ตำบลบางตลาด อำเภอปากเกร็ด นนทบุรี 11120	ปากเกร็ด	11120	13.901211	100.505422
2.5 ชีต ชื่อ SetTime ทำหน้าที่ กำหนด  เวลาทำงาน : 
ID	checkin	checkout	status
ST-01	08:00:00	17:00:00	TRUE
ST-02	09:00:00	17:30:00	FALSE
2.6 ชีตชื่อ SetLeave กำหนดประเภทการลา : ID	ประเภท	จำนวน	Status
SL-01	ลาป่วยมีใบรับรองแพทย์	10	TRUE
SL-02	ลาป่วยไม่มีใบรับรองแพทย์	10	TRUE
SL-03	ลากิจจำเป็น	10	TRUE
SL-04	ลากิจทั่วไป	10	TRUE
SL-05	ลาพักร้อน	30	TRUE
SL-06	ลาบวช	120	TRUE
2.7 ชีต ชื่อ SetSalary กำหนด งวดของเงินเดือน : ScanDate	UID	Fullname	Check-In	Check-Out	สาขา	IPAddress	DeviceId	รูปเข้างาน	รูปออกงาน
01/10/2024	USER-001	ผู้ดูแลระบบ	9:18:00	18:14:00					
01/10/2024	USER-002	admin	7:44:00	19:25:00					
01/10/2024	USER-003	EpicCoding	8:10:00	19:13:00					
01/10/2024	USER-004	Ecc.	7:32:00	17:37:00					
2.8 ชีต ชื่อ SetOT กำหนด ค่า ot ทำงานเกินเวลา : ID	เปอร์เซ็น	status
OT-01	1.00%	FALSE
OT-02	1.50%	FALSE
OT-03	2.00%	FALSE
2.9 ชีต ชื่อ SetSSO กำหนดหัก ค่าประกันสังคม : ID	เปอร์เซ็น	status
SSO-01	1.00%	FALSE
SSO-02	2.00%	FALSE
SSO-03	3.00%	FALSE
2.10 ชีต ชื่อ BacnkCode กำหนดค่า บัญชีธนาคาร : ID	Bank Name (TH)	Bank Name (EN)	IMG
002	ธนาคารกรุงเทพ จำกัด (มหาชน)	BANGKOK BANK PUBLIC COMPANY LTD.	https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-1.png
004	ธนาคารกสิกรไทย จำกัด (มหาชน)	KASIKORNBANK PUBLIC COMPANY LIMITED	https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-2.png
2.11 ชีต ชื่อ SetDayOff กำหนดวันหยุด ตามปฏิทิน : ID	วันหยุด	รายละเอียด
SD-01	01/01/2024	วันขึ้นปีใหม่
SD-02	26/02/2024	วันหยุดชดเชยวันมาฆบูชา
SD-03	08/04/2024	วันหยุดชดเชยวันจักรี
SD-04	08/04/2024	วันหยุดราชการ เพิ่มเติมเป็นกรณีพิเศษ
SD-05	13/04/2024	วันสงกรานต์
SD-06	14/04/2024	วันสงกรานต์
SD-07	15/04/2024	วันสงกรานต์
SD-08	16/04/2024	วันหยุดชดเชยวันสงกรานต์
SD-09	06/05/2024	วันหยุดชดเชยวันฉัตรมงคล
SD-10	22/05/2024	วันวิสาขบูชา
SD-11	03/06/2024	วันเฉลิมพระชนมพรรษาสมเด็จพระนางเจ้าฯ พระบรมราชินี
SD-12	22/07/2024	วันหยุดชดเชยวันเข้าพรรษา
SD-13	29/07/2024	วันหยุดชดเชยวันเฉลิมพระชนมพรรษา
SD-14	12/08/2024	วันแม่แห่งชาติ
SD-15	14/10/2024	วันหยุดชดเชย วันคล้ายวันสวรรคต
SD-16	23/10/2024	วันปิยมหาราช
SD-17	05/12/2024	วันพ่อแห่งชาติ
SD-18	10/12/2024	วันรัฐธรรมนูญ
SD-19	31/12/2024	วันสิ้นปี
2.11 ชีต ชื่อ SetWeekEnd กำหนดวันปิดร้าน : ID	วันทำงาน	status
SW-01	จันทร์	FALSE
SW-02	อังคาร	FALSE
SW-03	พุธ	FALSE
SW-04	พฤหัสบดี	FALSE
SW-05	ศุกร์	FALSE
SW-06	เสาร์	TRUE
SW-07	อาทิตย์	TRUE

3. ชีต ชื่อ AllDataSalary ประกอบด้วย ชีต 3.1 TimeAttendance บันทึก เวลาเข้าออกของพนักงงาน : ScanDate	UID	Fullname	Check-In	Check-Out	สาขา	IPAddress	DeviceId	รูปเข้างาน	รูปออกงาน
01/10/2024	USER-001	ผู้ดูแลระบบ	9:18:00	18:14:00					
01/10/2024	USER-002	admin	7:44:00	19:25:00					
01/10/2024	USER-003	EpicCoding	8:10:00	19:13:00					
01/10/2024	USER-004	Ecc.	7:32:00	17:37:00					

3.2 ชีต ชื่อ Leave บันทึกการขออนุญาตลา ของพนักงงาน : ID	สถานะ	Date	UID	Fullname	Department	Group	ลายเซ็น1	การลางาน	รายละเอียด	File	เริ่มวันที่	สิ้นสุดวันที่	รวมวัน	รวมชั่วโมง	ผู้อนุมัติ	ความเห็น	วันที่อนุมัติ	ลายเซ็น2
LEV6700001	อนุมัติ	22/09/2024	USER-001	ผู้ดูแลระบบ	IT Management	ฝ่ายบริหารสำนักงาน	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	ลากิจจำเป็น	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!		2024-10-01T08:30	2024-10-03T16:30	3	0	ผู้ดูแลระบบ	เห็นควรอนุมัติ	22/09/2024	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa
LEV6700002	อนุมัติ	23/09/2024	USER-003	EpicCoding	IT Support	ฝ่ายจัดซื้อจัดจ้าง	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	ลากิจทั่วไป	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!		2024-10-02T08:30	2024-10-02T16:30	1	0	ผู้ดูแลระบบ	ไม่ตรงตามกฎ	24/09/2024	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa

3.3 ชีต ชื่อ Request ทำหน้าที่บันทึกการอนุมัติ การลา ให้กับพนักงาน : ID	สถานะ	Date	UID	Fullname	Department	Group	ลายเซ็น1	รายละเอียด	ผู้อนุมัติ	ความเห็น	วันที่อนุมัติ	ลายเซ็น2
REQ6700001	อนุมัติ	22/09/2024	USER-001	ผู้ดูแลระบบ	IT Management	ฝ่ายบริหารสำนักงาน	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	ผู้ดูแลระบบ	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	22/09/2024	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa
REQ6700002	อนุมัติ	23/09/2024	USER-003	EpicCoding	IT Support	ฝ่ายจัดซื้อจัดจ้าง	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	ผู้ดูแลระบบ	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	24/09/2024	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa
REQ6700003	อนุมัติ	24/09/2024	USER-005	pongza	หน่วยงานA	ฝ่ายบริหารงานบุคคล	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	ผู้ดูแลระบบ	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	24/09/2024	https://lh3.googleusercontent.com/d/1MfAxH995o3akSCGaD6_AemxbRUHGpuZa

3.4 ชีตชื่อ Summary ทำหน้าที่ บันทึกการจ่ายเงินเดือนพนักงงาน : KEY	งวดเงินเดือน	สถานะ	วันที่ทำรายการ	กำหนดชำระ	รายละเอียด	รวมหักสาย	รวมหักลา	รวมOT	รวมหักประกันสังคม	รวมหักอื่น	รายได้อื่นๆ	รวมจ่ายพนักงาน	รายได้รวม
20241017125151SUMKAJ5GQ2	1	ชำระเงินแล้ว	20/1/2567	26/1/2024	[{"otherLeave":0,"otherIncome":0,"lateHours":0.3,"totalIncome":233226.38,"department":"ตำแหน่ง: IT Management","lateDeductions":193.97,"group":"แผนก: ฝ่ายบริหารสำนักงาน","otherDeductions":0,"vacationLeave":0,"uidUser":"รหัสพนักงาน: USER-001","otIncome":4860,"sickLeave":2,"personalLeave":2,"leaveDeductions":20689.66,"specialAllowance":100000,"socialSecurity":750,"salary":150000,"fullName":"ชื่อ สกุล: ผู้ดูแลระบบ","otHours":16.2},{"otIncome":4755,"totalIncome":18220.52,"otherLeave":0,"sickLeave":0,"fullName":"ชื่อ สกุล: admin","group":"แผนก: ฝ่ายบริหารงานบุคคล","lateHours":0,"otHours":15.85,"otherDeductions":0,"personalLeave":2,"salary":15000,"vacationLeave":0,"uidUser":"รหัสพนักงาน: USER-002","specialAllowance":250,"leaveDeductions":1034.48,"lateDeductions":0,"socialSecurity":750,"department":"ตำแหน่ง: หน่วยงานA","otherIncome":0},{"sickLeave":0,"department":"ตำแหน่ง: IT Support","otIncome":5235,"otherIncome":0,"lateHours":0,"leaveDeductions":517.24,"otherDeductions":0,"uidUser":"รหัสพนักงาน: USER-003","specialAllowance":250,"socialSecurity":750,"totalIncome":19217.76,"fullName":"ชื่อ สกุล: EpicCoding","group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","vacationLeave":0,"personalLeave":1,"otHours":17.45,"otherLeave":0,"salary":15000,"lateDeductions":0},{"otherIncome":0,"lateHours":0,"department":"ตำแหน่ง: IT Support","leaveDeductions":0,"otherDeductions":0,"fullName":"ชื่อ สกุล: Ecc.","sickLeave":0,"uidUser":"รหัสพนักงาน: USER-004","socialSecurity":750,"otIncome":5270,"totalIncome":19770,"specialAllowance":250,"group":"แผนก: ฝ่ายบริหารสำนักงาน","otherLeave":0,"vacationLeave":0,"otHours":17.57,"personalLeave":0,"salary":15000,"lateDeductions":0},{"leaveDeductions":517.24,"personalLeave":0,"lateHours":0,"otIncome":5145,"fullName":"ชื่อ สกุล: pongza","department":"ตำแหน่ง: หน่วยงานA","otherIncome":0,"uidUser":"รหัสพนักงาน: USER-005","specialAllowance":250,"totalIncome":19127.76,"group":"แผนก: ฝ่ายบริหารงานบุคคล","otHours":17.15,"salary":15000,"socialSecurity":750,"lateDeductions":0,"vacationLeave":1,"otherDeductions":0,"otherLeave":0,"sickLeave":0},{"leaveDeductions":0,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","specialAllowance":0,"lateHours":0,"sickLeave":0,"fullName":"ชื่อ สกุล: ธาวิน อุดมทรัพย์","otIncome":4875,"otherIncome":0,"department":"ตำแหน่ง: หน่วยงานA","vacationLeave":0,"otherLeave":0,"salary":15000,"otherDeductions":0,"otHours":16.25,"socialSecurity":750,"lateDeductions":0,"totalIncome":19125,"uidUser":"รหัสพนักงาน: USER-006","personalLeave":0},{"lateHours":0,"lateDeductions":0,"socialSecurity":750,"fullName":"ชื่อ สกุล: ชนาธินาถ เจริญกาณต์","vacationLeave":0,"otIncome":5020,"group":"แผนก: ฝ่ายบริหารสำนักงาน","totalIncome":19270,"uidUser":"รหัสพนักงาน: USER-007","department":"ตำแหน่ง: หน่วยงานC","salary":15000,"sickLeave":0,"otHours":16.73,"otherIncome":0,"personalLeave":0,"specialAllowance":0,"leaveDeductions":0,"otherLeave":0,"otherDeductions":0},{"otHours":11.35,"specialAllowance":250,"otherLeave":0,"group":"แผนก: ฝ่ายบริหารงานบุคคล","sickLeave":0,"lateDeductions":0,"totalIncome":17905,"salary":15000,"department":"ตำแหน่ง: หน่วยงานD","uidUser":"รหัสพนักงาน: USER-008","otherDeductions":0,"socialSecurity":750,"otIncome":3405,"leaveDeductions":0,"otherIncome":0,"personalLeave":0,"lateHours":0,"fullName":"ชื่อ สกุล: กิตติพร สมบูรณ์ประวัติ","vacationLeave":0},{"personalLeave":0,"otherLeave":0,"lateHours":0,"salary":15000,"lateDeductions":0,"otherIncome":0,"otherDeductions":0,"otHours":17.67,"totalIncome":19850,"department":"ตำแหน่ง: หน่วยงานB","otIncome":5300,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","socialSecurity":750,"sickLeave":0,"leaveDeductions":0,"uidUser":"รหัสพนักงาน: USER-009","fullName":"ชื่อ สกุล: อนันตญา ปิ่นแก้ว","vacationLeave":0,"specialAllowance":300},{"vacationLeave":0,"otherDeductions":0,"otHours":20.87,"specialAllowance":400,"salary":15000,"lateDeductions":0,"lateHours":0,"socialSecurity":750,"uidUser":"รหัสพนักงาน: USER-010","personalLeave":0,"department":"ตำแหน่ง: หน่วยงานA","otherLeave":0,"totalIncome":20910,"sickLeave":0,"otherIncome":0,"fullName":"ชื่อ สกุล: ณัฐยศ ชัยเจริญ","otIncome":6260,"group":"แผนก: ฝ่ายบริหารสำนักงาน","leaveDeductions":0},{"otIncome":3720,"otherDeductions":0,"department":"ตำแหน่ง: IT Management","sickLeave":0,"otHours":12.4,"lateDeductions":0,"totalIncome":18470,"otherIncome":0,"specialAllowance":500,"salary":15000,"fullName":"ชื่อ สกุล: ณัฏฐ์ เกียรติโกศล","lateHours":0,"vacationLeave":0,"group":"แผนก: ฝ่ายบริหารงานบุคคล","otherLeave":0,"personalLeave":0,"socialSecurity":750,"uidUser":"รหัสพนักงาน: USER-011","leaveDeductions":0},{"otIncome":3450,"vacationLeave":0,"salary":15000,"department":"ตำแหน่ง: หน่วยงานE","sickLeave":0,"socialSecurity":750,"totalIncome":18300,"personalLeave":0,"specialAllowance":600,"uidUser":"รหัสพนักงาน: USER-012","group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","lateDeductions":0,"lateHours":0,"fullName":"ชื่อ สกุล: ฝนแก้ว ประเสริฐชัยวัฒน์","leaveDeductions":0,"otherIncome":0,"otherDeductions":0,"otHours":11.5,"otherLeave":0},{"lateDeductions":0,"department":"ตำแหน่ง: IT Management","leaveDeductions":0,"totalIncome":20650,"otHours":14.83,"uidUser":"รหัสพนักงาน: USER-013","personalLeave":0,"specialAllowance":1950,"otIncome":4450,"salary":15000,"otherIncome":0,"fullName":"ชื่อ สกุล: ปวัญญา ปราสาทงาม","group":"แผนก: ฝ่ายบริหารสำนักงาน","lateHours":0,"sickLeave":0,"otherLeave":0,"otherDeductions":0,"vacationLeave":0,"socialSecurity":750},{"leaveDeductions":0,"lateHours":0,"uidUser":"รหัสพนักงาน: USER-014","department":"ตำแหน่ง: IT Management","otIncome":4125,"personalLeave":0,"otherLeave":0,"totalIncome":18575,"vacationLeave":0,"fullName":"ชื่อ สกุล: ธาม ทรัพย์มา","specialAllowance":200,"group":"แผนก: ฝ่ายบริหารงานบุคคล","otherIncome":0,"salary":15000,"otherDeductions":0,"sickLeave":0,"otHours":13.75,"lateDeductions":0,"socialSecurity":750},{"personalLeave":0,"fullName":"ชื่อ สกุล: รัชชนก โชติพาณิชย์","salary":15000,"otherLeave":0,"uidUser":"รหัสพนักงาน: USER-015","socialSecurity":750,"lateDeductions":0,"totalIncome":19410,"otherDeductions":0,"sickLeave":0,"otIncome":4960,"lateHours":0,"department":"ตำแหน่ง: หน่วยงานD","otherIncome":0,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","otHours":16.53,"specialAllowance":200,"leaveDeductions":0,"vacationLeave":0},{"otIncome":3425,"socialSecurity":750,"lateHours":0,"otHours":11.42,"otherDeductions":0,"salary":15000,"otherLeave":0,"sickLeave":0,"specialAllowance":0,"group":"แผนก: ฝ่ายบริหารสำนักงาน","vacationLeave":0,"fullName":"ชื่อ สกุล: ภาธร ธาดาวรวงศ์","lateDeductions":0,"totalIncome":17675,"department":"ตำแหน่ง: IT Support","personalLeave":0,"uidUser":"รหัสพนักงาน: USER-016","leaveDeductions":0,"otherIncome":0},{"specialAllowance":200,"otherLeave":0,"lateDeductions":0,"otherIncome":0,"fullName":"ชื่อ สกุล: กนกนุช ภูภาค","group":"แผนก: ฝ่ายบริหารงานบุคคล","department":"ตำแหน่ง: IT Management","leaveDeductions":0,"socialSecurity":750,"lateHours":0,"uidUser":"รหัสพนักงาน: USER-017","personalLeave":0,"otIncome":4860,"sickLeave":0,"otherDeductions":0,"vacationLeave":0,"salary":15000,"totalIncome":19310,"otHours":16.2},{"specialAllowance":200,"totalIncome":18955,"salary":15000,"otherIncome":0,"personalLeave":0,"department":"ตำแหน่ง: IT Support","otIncome":4505,"fullName":"ชื่อ สกุล: จณัตว์ วีระโชติ","vacationLeave":0,"leaveDeductions":0,"uidUser":"รหัสพนักงาน: USER-018","otherDeductions":0,"lateDeductions":0,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","lateHours":0,"socialSecurity":750,"otherLeave":0,"otHours":15.02,"sickLeave":0},{"otIncome":4255,"personalLeave":0,"specialAllowance":200,"socialSecurity":750,"group":"แผนก: ฝ่ายบริหารสำนักงาน","department":"ตำแหน่ง: IT Support","otherIncome":0,"vacationLeave":0,"uidUser":"รหัสพนักงาน: USER-019","fullName":"ชื่อ สกุล: สิตาพัชญ์ โชตวาณิช","leaveDeductions":0,"salary":15000,"otHours":14.18,"sickLeave":0,"otherLeave":0,"totalIncome":18705,"lateHours":0,"lateDeductions":0,"otherDeductions":0},{"department":"ตำแหน่ง: หน่วยงานE","socialSecurity":750,"totalIncome":17925,"vacationLeave":0,"otherDeductions":0,"uidUser":"รหัสพนักงาน: USER-020","otherIncome":0,"sickLeave":0,"specialAllowance":0,"fullName":"ชื่อ สกุล: ธนินทร์ ชาติสมบัติ","personalLeave":0,"otIncome":3675,"otherLeave":0,"group":"แผนก: ฝ่ายบริหารงานบุคคล","salary":15000,"lateHours":0,"leaveDeductions":0,"lateDeductions":0,"otHours":12.25},{"otherLeave":0,"otHours":12.88,"leaveDeductions":0,"otherIncome":0,"salary":15000,"otIncome":3865,"lateHours":0,"otherDeductions":0,"totalIncome":18315,"socialSecurity":750,"specialAllowance":200,"personalLeave":0,"lateDeductions":0,"department":"ตำแหน่ง: IT Management","vacationLeave":0,"sickLeave":0,"fullName":"ชื่อ สกุล: แก้วขวัญ ก้องเกษมทรัพย์","uidUser":"รหัสพนักงาน: USER-021","group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง"},{"lateDeductions":0,"socialSecurity":750,"fullName":"ชื่อ สกุล: คงเกียรติ สิริประภาชัย","specialAllowance":0,"vacationLeave":0,"sickLeave":0,"leaveDeductions":0,"uidUser":"รหัสพนักงาน: USER-022","otherIncome":0,"department":"ตำแหน่ง: IT Support","otherLeave":0,"lateHours":0,"group":"แผนก: ฝ่ายบริหารสำนักงาน","otHours":15.28,"personalLeave":0,"otherDeductions":0,"totalIncome":18835,"salary":15000,"otIncome":4585},{"leaveDeductions":0,"fullName":"ชื่อ สกุล: นายจักรพงศ์ พัวสื่อ","otHours":14.18,"personalLeave":0,"sickLeave":0,"otherDeductions":0,"otIncome":4255,"otherLeave":0,"otherIncome":0,"salary":15000,"department":"ตำแหน่ง: IT Management","specialAllowance":0,"vacationLeave":0,"socialSecurity":750,"group":"แผนก: ฝ่ายบริหารงานบุคคล","totalIncome":18505,"uidUser":"รหัสพนักงาน: USER-023","lateHours":0,"lateDeductions":0}]	193.97	22,758.62	104,255.00	17,250.00	0.00	0.00	650,252.42	650,252.42
20241022182945SUMQ53MAKY	2	ชำระเงินแล้ว	20/2/2567	26/2/2024	[{"otherLeave":0,"otherIncome":0,"lateHours":0.3,"totalIncome":233226.38,"department":"ตำแหน่ง: IT Management","lateDeductions":193.97,"group":"แผนก: ฝ่ายบริหารสำนักงาน","otherDeductions":0,"vacationLeave":0,"uidUser":"รหัสพนักงาน: USER-001","otIncome":4860,"sickLeave":2,"personalLeave":2,"leaveDeductions":20689.66,"specialAllowance":100000,"socialSecurity":750,"salary":150000,"fullName":"ชื่อ สกุล: ผู้ดูแลระบบ","otHours":16.2},{"otIncome":4755,"totalIncome":18220.52,"otherLeave":0,"sickLeave":0,"fullName":"ชื่อ สกุล: admin","group":"แผนก: ฝ่ายบริหารงานบุคคล","lateHours":0,"otHours":15.85,"otherDeductions":0,"personalLeave":2,"salary":15000,"vacationLeave":0,"uidUser":"รหัสพนักงาน: USER-002","specialAllowance":250,"leaveDeductions":1034.48,"lateDeductions":0,"socialSecurity":750,"department":"ตำแหน่ง: หน่วยงานA","otherIncome":0},{"sickLeave":0,"department":"ตำแหน่ง: IT Support","otIncome":5235,"otherIncome":0,"lateHours":0,"leaveDeductions":517.24,"otherDeductions":0,"uidUser":"รหัสพนักงาน: USER-003","specialAllowance":250,"socialSecurity":750,"totalIncome":19217.76,"fullName":"ชื่อ สกุล: EpicCoding","group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","vacationLeave":0,"personalLeave":1,"otHours":17.45,"otherLeave":0,"salary":15000,"lateDeductions":0},{"otherIncome":0,"lateHours":0,"department":"ตำแหน่ง: IT Support","leaveDeductions":0,"otherDeductions":0,"fullName":"ชื่อ สกุล: Ecc.","sickLeave":0,"uidUser":"รหัสพนักงาน: USER-004","socialSecurity":750,"otIncome":5270,"totalIncome":19770,"specialAllowance":250,"group":"แผนก: ฝ่ายบริหารสำนักงาน","otherLeave":0,"vacationLeave":0,"otHours":17.57,"personalLeave":0,"salary":15000,"lateDeductions":0},{"leaveDeductions":517.24,"personalLeave":0,"lateHours":0,"otIncome":5145,"fullName":"ชื่อ สกุล: pongza","department":"ตำแหน่ง: หน่วยงานA","otherIncome":0,"uidUser":"รหัสพนักงาน: USER-005","specialAllowance":250,"totalIncome":19127.76,"group":"แผนก: ฝ่ายบริหารงานบุคคล","otHours":17.15,"salary":15000,"socialSecurity":750,"lateDeductions":0,"vacationLeave":1,"otherDeductions":0,"otherLeave":0,"sickLeave":0},{"leaveDeductions":0,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","specialAllowance":0,"lateHours":0,"sickLeave":0,"fullName":"ชื่อ สกุล: ธาวิน อุดมทรัพย์","otIncome":4875,"otherIncome":0,"department":"ตำแหน่ง: หน่วยงานA","vacationLeave":0,"otherLeave":0,"salary":15000,"otherDeductions":0,"otHours":16.25,"socialSecurity":750,"lateDeductions":0,"totalIncome":19125,"uidUser":"รหัสพนักงาน: USER-006","personalLeave":0},{"lateHours":0,"lateDeductions":0,"socialSecurity":750,"fullName":"ชื่อ สกุล: ชนาธินาถ เจริญกาณต์","vacationLeave":0,"otIncome":5020,"group":"แผนก: ฝ่ายบริหารสำนักงาน","totalIncome":19270,"uidUser":"รหัสพนักงาน: USER-007","department":"ตำแหน่ง: หน่วยงานC","salary":15000,"sickLeave":0,"otHours":16.73,"otherIncome":0,"personalLeave":0,"specialAllowance":0,"leaveDeductions":0,"otherLeave":0,"otherDeductions":0},{"otHours":11.35,"specialAllowance":250,"otherLeave":0,"group":"แผนก: ฝ่ายบริหารงานบุคคล","sickLeave":0,"lateDeductions":0,"totalIncome":17905,"salary":15000,"department":"ตำแหน่ง: หน่วยงานD","uidUser":"รหัสพนักงาน: USER-008","otherDeductions":0,"socialSecurity":750,"otIncome":3405,"leaveDeductions":0,"otherIncome":0,"personalLeave":0,"lateHours":0,"fullName":"ชื่อ สกุล: กิตติพร สมบูรณ์ประวัติ","vacationLeave":0},{"personalLeave":0,"otherLeave":0,"lateHours":0,"salary":15000,"lateDeductions":0,"otherIncome":0,"otherDeductions":0,"otHours":17.67,"totalIncome":19850,"department":"ตำแหน่ง: หน่วยงานB","otIncome":5300,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","socialSecurity":750,"sickLeave":0,"leaveDeductions":0,"uidUser":"รหัสพนักงาน: USER-009","fullName":"ชื่อ สกุล: อนันตญา ปิ่นแก้ว","vacationLeave":0,"specialAllowance":300},{"vacationLeave":0,"otherDeductions":0,"otHours":20.87,"specialAllowance":400,"salary":15000,"lateDeductions":0,"lateHours":0,"socialSecurity":750,"uidUser":"รหัสพนักงาน: USER-010","personalLeave":0,"department":"ตำแหน่ง: หน่วยงานA","otherLeave":0,"totalIncome":20910,"sickLeave":0,"otherIncome":0,"fullName":"ชื่อ สกุล: ณัฐยศ ชัยเจริญ","otIncome":6260,"group":"แผนก: ฝ่ายบริหารสำนักงาน","leaveDeductions":0},{"otIncome":3720,"otherDeductions":0,"department":"ตำแหน่ง: IT Management","sickLeave":0,"otHours":12.4,"lateDeductions":0,"totalIncome":18470,"otherIncome":0,"specialAllowance":500,"salary":15000,"fullName":"ชื่อ สกุล: ณัฏฐ์ เกียรติโกศล","lateHours":0,"vacationLeave":0,"group":"แผนก: ฝ่ายบริหารงานบุคคล","otherLeave":0,"personalLeave":0,"socialSecurity":750,"uidUser":"รหัสพนักงาน: USER-011","leaveDeductions":0},{"otIncome":3450,"vacationLeave":0,"salary":15000,"department":"ตำแหน่ง: หน่วยงานE","sickLeave":0,"socialSecurity":750,"totalIncome":18300,"personalLeave":0,"specialAllowance":600,"uidUser":"รหัสพนักงาน: USER-012","group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","lateDeductions":0,"lateHours":0,"fullName":"ชื่อ สกุล: ฝนแก้ว ประเสริฐชัยวัฒน์","leaveDeductions":0,"otherIncome":0,"otherDeductions":0,"otHours":11.5,"otherLeave":0},{"lateDeductions":0,"department":"ตำแหน่ง: IT Management","leaveDeductions":0,"totalIncome":20650,"otHours":14.83,"uidUser":"รหัสพนักงาน: USER-013","personalLeave":0,"specialAllowance":1950,"otIncome":4450,"salary":15000,"otherIncome":0,"fullName":"ชื่อ สกุล: ปวัญญา ปราสาทงาม","group":"แผนก: ฝ่ายบริหารสำนักงาน","lateHours":0,"sickLeave":0,"otherLeave":0,"otherDeductions":0,"vacationLeave":0,"socialSecurity":750},{"leaveDeductions":0,"lateHours":0,"uidUser":"รหัสพนักงาน: USER-014","department":"ตำแหน่ง: IT Management","otIncome":4125,"personalLeave":0,"otherLeave":0,"totalIncome":18575,"vacationLeave":0,"fullName":"ชื่อ สกุล: ธาม ทรัพย์มา","specialAllowance":200,"group":"แผนก: ฝ่ายบริหารงานบุคคล","otherIncome":0,"salary":15000,"otherDeductions":0,"sickLeave":0,"otHours":13.75,"lateDeductions":0,"socialSecurity":750},{"personalLeave":0,"fullName":"ชื่อ สกุล: รัชชนก โชติพาณิชย์","salary":15000,"otherLeave":0,"uidUser":"รหัสพนักงาน: USER-015","socialSecurity":750,"lateDeductions":0,"totalIncome":19410,"otherDeductions":0,"sickLeave":0,"otIncome":4960,"lateHours":0,"department":"ตำแหน่ง: หน่วยงานD","otherIncome":0,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","otHours":16.53,"specialAllowance":200,"leaveDeductions":0,"vacationLeave":0},{"otIncome":3425,"socialSecurity":750,"lateHours":0,"otHours":11.42,"otherDeductions":0,"salary":15000,"otherLeave":0,"sickLeave":0,"specialAllowance":0,"group":"แผนก: ฝ่ายบริหารสำนักงาน","vacationLeave":0,"fullName":"ชื่อ สกุล: ภาธร ธาดาวรวงศ์","lateDeductions":0,"totalIncome":17675,"department":"ตำแหน่ง: IT Support","personalLeave":0,"uidUser":"รหัสพนักงาน: USER-016","leaveDeductions":0,"otherIncome":0},{"specialAllowance":200,"otherLeave":0,"lateDeductions":0,"otherIncome":0,"fullName":"ชื่อ สกุล: กนกนุช ภูภาค","group":"แผนก: ฝ่ายบริหารงานบุคคล","department":"ตำแหน่ง: IT Management","leaveDeductions":0,"socialSecurity":750,"lateHours":0,"uidUser":"รหัสพนักงาน: USER-017","personalLeave":0,"otIncome":4860,"sickLeave":0,"otherDeductions":0,"vacationLeave":0,"salary":15000,"totalIncome":19310,"otHours":16.2},{"specialAllowance":200,"totalIncome":18955,"salary":15000,"otherIncome":0,"personalLeave":0,"department":"ตำแหน่ง: IT Support","otIncome":4505,"fullName":"ชื่อ สกุล: จณัตว์ วีระโชติ","vacationLeave":0,"leaveDeductions":0,"uidUser":"รหัสพนักงาน: USER-018","otherDeductions":0,"lateDeductions":0,"group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง","lateHours":0,"socialSecurity":750,"otherLeave":0,"otHours":15.02,"sickLeave":0},{"otIncome":4255,"personalLeave":0,"specialAllowance":200,"socialSecurity":750,"group":"แผนก: ฝ่ายบริหารสำนักงาน","department":"ตำแหน่ง: IT Support","otherIncome":0,"vacationLeave":0,"uidUser":"รหัสพนักงาน: USER-019","fullName":"ชื่อ สกุล: สิตาพัชญ์ โชตวาณิช","leaveDeductions":0,"salary":15000,"otHours":14.18,"sickLeave":0,"otherLeave":0,"totalIncome":18705,"lateHours":0,"lateDeductions":0,"otherDeductions":0},{"department":"ตำแหน่ง: หน่วยงานE","socialSecurity":750,"totalIncome":17925,"vacationLeave":0,"otherDeductions":0,"uidUser":"รหัสพนักงาน: USER-020","otherIncome":0,"sickLeave":0,"specialAllowance":0,"fullName":"ชื่อ สกุล: ธนินทร์ ชาติสมบัติ","personalLeave":0,"otIncome":3675,"otherLeave":0,"group":"แผนก: ฝ่ายบริหารงานบุคคล","salary":15000,"lateHours":0,"leaveDeductions":0,"lateDeductions":0,"otHours":12.25},{"otherLeave":0,"otHours":12.88,"leaveDeductions":0,"otherIncome":0,"salary":15000,"otIncome":3865,"lateHours":0,"otherDeductions":0,"totalIncome":18315,"socialSecurity":750,"specialAllowance":200,"personalLeave":0,"lateDeductions":0,"department":"ตำแหน่ง: IT Management","vacationLeave":0,"sickLeave":0,"fullName":"ชื่อ สกุล: แก้วขวัญ ก้องเกษมทรัพย์","uidUser":"รหัสพนักงาน: USER-021","group":"แผนก: ฝ่ายจัดซื้อจัดจ้าง"},{"lateDeductions":0,"socialSecurity":750,"fullName":"ชื่อ สกุล: คงเกียรติ สิริประภาชัย","specialAllowance":0,"vacationLeave":0,"sickLeave":0,"leaveDeductions":0,"uidUser":"รหัสพนักงาน: USER-022","otherIncome":0,"department":"ตำแหน่ง: IT Support","otherLeave":0,"lateHours":0,"group":"แผนก: ฝ่ายบริหารสำนักงาน","otHours":15.28,"personalLeave":0,"otherDeductions":0,"totalIncome":18835,"salary":15000,"otIncome":4585},{"leaveDeductions":0,"fullName":"ชื่อ สกุล: นายจักรพงศ์ พัวสื่อ","otHours":14.18,"personalLeave":0,"sickLeave":0,"otherDeductions":0,"otIncome":4255,"otherLeave":0,"otherIncome":0,"salary":15000,"department":"ตำแหน่ง: IT Management","specialAllowance":0,"vacationLeave":0,"socialSecurity":750,"group":"แผนก: ฝ่ายบริหารงานบุคคล","totalIncome":18505,"uidUser":"รหัสพนักงาน: USER-023","lateHours":0,"lateDeductions":0}]	193.97	22,758.62	104,255.00	17,250.00	0.00	0.00	650,252.42	650,252.42
3.5 ชีต ชื่อ NewsDB ทำหน้าที่ ... : ID	วันที่	เรื่อง	รายละเอียด	ผู้ลง	หน่วยงาน
20241017125151NewsKAJ5GQ2	17/10/2024	การจ่ายเงินประกันสังคม	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	ผู้ดูแลระบบ	IT Management
20241017125255News6K98JLE	17/10/2024	การจ่ายงวดเงินเดือน	Lorem ipsum dolor sit amet consectetur adipisicing elit. Maiores vitae non pariatur perspiciatis tempore corporis!	ผู้ดูแลระบบ	IT Management

css.html =
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

<!-- Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300&display=swap">

<!-- Remixicon -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css" rel="stylesheet">
<!-- Boxicons -->
<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
<!-- Font-awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<!-- FullCalerder -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js'></script>

<!-- dataTables -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.0/dist/bootstrap-table.min.css">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />

<!-- LoadIcon -->
<script src="https://cdn.lordicon.com/lordicon.js"></script>

<!-- swiperjs.com -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

<style>
:root {
    --grey: #F5F5F5;
    --bs-white: #fff;
    --bs-gray: #6c757d;
    --bs-gray-dark: #343a40;
    --bs-gray-100: #f8f9fa;
    --bs-gray-200: #e9ecef;
    --bs-gray-300: #dee2e6;
    --bs-gray-400: #ced4da;
    --bs-gray-500: #adb5bd;
    --box1: #3c8cf3;
    --box2: #05be8a;
    --box3: #745af2;
    --box4: #ef5350;
    --bs-edit: #745af2;
    --bs-edittwo: #beb4ed;
    --bs-del: #ef5350;
    --bs-set: #3c8cf3;
    --bs-settwo: #8bb9f5;
    --bs-upload: #05be8a;  
    --bs-table: #c4dcfb;
    --text-color: #1d1d1d;
    --font-color: #211d51;
}
body {
    font-family: 'Prompt', sans-serif;
}

::-webkit-scrollbar {
	width: 5px;
  height: 5px;
	background-color: var(--grey); 
}
::-webkit-scrollbar-thumb {
	background-color: var(--box3); 
	border-radius: 6px;
}
::-webkit-scrollbar-thumb:hover {
	background-color: var(--box4); 
}

.text-indigo:hover,
.text-indigo {
    color: var(--bs-blue);
}
.bg-indigo {
    background-color: var(--bs-blue);
}
.dropdown-toggle::after {
    display: none;
}
.cursor-pointer {
    cursor: pointer;
}
.fw-semibold {
    font-weight: 600;
}
.fs-7 {
    font-size: .875rem;
}


.fx-dropdown-menu {
    min-width: 16rem;
    padding: 0;
    overflow: hidden;
}

.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background-color: rgba(0, 0, 0, .5);
  z-index: 490;
  opacity: 1;
  visibility: visible;
  transition: opacity .2s;
}
.sidebar.collapsed ~ .sidebar-overlay {
    opacity: 0;
    visibility: hidden;
}
.sidebar.collapsed:hover,
.sidebar {
  width: 16rem;
  overflow-y: auto;
  transition: width .2s, left .2s;
  top: 0.5rem;
  left: 0;
  bottom: 0.5rem;
  z-index: 500;
  border-radius: 0.5rem;
}
.sidebar.collapsed {
    left: -16rem;
}
.sidebar::-webkit-scrollbar {
  width: .25rem;
}
.sidebar::-webkit-scrollbar {
	width: 5px;
  height: 5px;
	background-color: var(--bs-edit); 
}
.sidebar::-webkit-scrollbar-thumb {
	background-color: var(--bs-edit); 
	border-radius: 6px;
}
.sidebar::-webkit-scrollbar-thumb:hover {
	background-color: var(--bs-edit); 
}
.sidebar-toggle {
  color: var(--bs-set);
  cursor: pointer;
  transition: .2s;
}
.sidebar-toggle:hover {
  color: var(--bs-upload);
  transition: all 0.3s;
  transform: scale(1.1);
}
.sidebar-menu {
    list-style-type: none;
}
.sidebar-menu-item {
    margin-bottom: .25rem;
}
.sidebar-menu-item a {
    text-decoration: none;
    display: flex;
    align-items: center;
    color: var(--bs-dark);
    padding: .375rem .75rem;
    border-radius: .375rem;
    font-size: .875rem;
    white-space: nowrap;
}
.sidebar-menu-item > a {
    color: var(--bs-set);
    overflow: hidden;
}
.sidebar-menu-item.focused > a,
.sidebar-menu-item > a:hover {
  background-color: var(--bs-upload); 
  color: var(--bs-white) !important;
  transition: all 0.3s;
  transform: scale(1.1);
}
.sidebar-menu-item.active-home a {
  background-color: var(--bs-set);
  color: var(--bs-light);
  transition: all 0.3s;
  box-shadow: 0 .25rem .25rem rgba(0, 0, 0, 0.175);
}
.sidebar-menu-item.active-home:hover a {
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
  box-shadow: 0 .25rem .25rem rgba(0, 0, 0, 0.175);
}

.sidebar-menu-item.active-setting a {
  color: var(--bs-dark);
  transition: all 0.3s;
}
.sidebar-menu-item.active-setting:hover a {
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
}
.sidebar-menu-item.active-close a {
  background-color: var(--bs-del);
  color: var(--bs-light);
  transition: all 0.3s;
  box-shadow: 0 .25rem .25rem rgba(0, 0, 0, 0.175);
}
.sidebar-menu-item.active-close:hover a {
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
  box-shadow: 0 .25rem .25rem rgba(0, 0, 0, 0.175);
}
.sidebar-menu-item-icon {
    margin-right: .625rem;
    font-size: 1.25rem;
}
.sidebar-menu-item-accordion {
    transition: transform .2s;
}
.sidebar-dropdown-menu-item.focused > a .sidebar-menu-item-accordion,
.sidebar-menu-item.focused > a .sidebar-menu-item-accordion {
    transform: rotateZ(180deg);
}
.sidebar.collapsed:hover .sidebar-menu-divider,
.sidebar-menu-divider {
  font-size: .75rem;
  color: var(--bs-gray-600);
  transition: opacity .2s;
  opacity: 1;
  visibility: visible;
}
.sidebar-dropdown-menu-item a {
    padding: .375rem 0;
    padding-right: .75rem;
}
.sidebar-dropdown-menu-item.focused > a,
.sidebar-dropdown-menu-item a:hover {
    color: var(--bs-blue);
}
.sidebar-dropdown-menu {
    padding-left: 2rem;
}
.sidebar-dropdown-menu .sidebar-dropdown-menu {
    padding-left: 1rem;
    list-style-type: circle;
}
.dropdown-colored > a {
  background-color: var(--bs-settwo);
  color: var(--bs-light);
}

.dropdown-colored.focused > a,
.dropdown-colored > a:hover {
  background-color: var(--bs-settwo);
  color: var(--bs-dark);
}

main {
    padding-left: 0;
    min-height: 100vh;
    font-family: 'Prompt', sans-serif;
}

.text-gradient {
  background: linear-gradient(to right, var(--box1), var(--box2), var(--box3), var(--box4));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

nav {
    display: flex;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 400;
    //background: linear-gradient(to right, var(--box1), var(--box2), var(--box3), var(--box4));
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.navbar-profile-image {
    width: 2.5rem;
    height: 2.5rem;
    object-fit: cover;
    border-radius: 50%;
}

.navbar-profile-image:hover {
    transition: all 0.3s;
    transform: scale(1.1);
}

.navbar-link {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: .25rem;
}

.navbar-link:hover {
  background-color: var(--bs-gray-200);
}


@media (min-width: 576px) {
    
}

@media (min-width: 768px) {
    .sidebar-overlay {
        opacity: 0;
        visibility: hidden;
    }
    .sidebar.collapsed {
        width: 4.75rem;
        left: 0;
    }
    .sidebar.collapsed .sidebar-logo {
        display: none;
    }
    .sidebar.collapsed:hover .sidebar-logo {
        display: block;
    }
    .sidebar.collapsed:hover .sidebar-toggle {
        margin-left: auto;
        margin-right: 0;
    }
    .sidebar.collapsed .sidebar-toggle {
        margin: 0 auto;
        transform: rotateZ(180deg);
    }
    .sidebar.collapsed:hover .sidebar-menu-divider {
        font-size: .75rem;
        color: var(--bs-gray-600);
        transition: opacity .2s;
        opacity: 1;
        visibility: visible;
    }
    .sidebar.collapsed .sidebar-menu-divider {
        opacity: 0;
        visibility: hidden;
    }

    main {
        transition: padding-left .2s;
        padding-left: 16rem;
    }
    .sidebar.collapsed ~ main {
        padding-left: 4.75rem;
    }
}

@media (min-width: 992px) {
    
}

@media (min-width: 1200px) {
    
}

@media (min-width: 1400px) {
    
}

.box-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  grid-auto-rows: minmax(100px, auto); 
  grid-gap: 20px;
  margin-left: -30px;
  align-items: start; 
}

.box-info li {
  padding: 20px;
  background: var(--light);
  border-radius: 20px;
  display: flex;
  align-items: center;
  grid-gap: 24px;
  box-shadow: var(--shadow);
  transition: all 0.3s;
}
.box-info li:hover {
  transform: scale(1.05);
  box-shadow: rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset, rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset;
}
.box-info li i {
  width: 80px;
  height: 80px;
  border-radius: 10px;
  font-size: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.box-info li:nth-child(1),
.box-info li:nth-child(1) i {
  background: var(--box1);
}
.box-info li:nth-child(2),
.box-info li:nth-child(2) i {
  background: var(--box2);
}
.box-info li:nth-child(3),
.box-info li:nth-child(3) i {
  background: var(--box3);
}
.box-info li:nth-child(4),
.box-info li:nth-child(4) i {
  background: var(--box4);
}
.box-info li:nth-child(1) i, 
.box-info li:nth-child(2) i, 
.box-info li:nth-child(3) i, 
.box-info li:nth-child(4) i {
  color: #fff;
}
.box-info li .text h3 {
  font-size: 25px;
  font-weight: 500;
  color: #fff
}
.box-info li .text p {
  color: #fff
}

.toast-container {
  position: fixed;
  top: 40px;
  z-index: 4000;
  right: 20px;
}

.imageuser {
  transition: filter 300ms;
}
.imageuser:hover {
  transform: scale(1.08);
}
#reviewdivprofile:has(.imageuser:hover)
.imageuser:not(:hover) {
  filter: grayscale(100%) brightness(50%);
}
#reviewNewprofile:has(.imageuser:hover)
.imageuser:not(:hover) {
  filter: grayscale(100%) brightness(50%);
}

.dropdown-menu {
  z-index: 999;
  background-color: var(--bs-white);
}
.dropdown-menu span {
  font-weight: 300;
  font-size: 14px;
}
.dropdown-menu a .fw-semibold {
  font-weight: 300;
  font-size: 14px;
}
.dropdown-menu a span {
  font-weight: 300;
  font-size: 12px;
}
.authentication-login {
  background-color: var(--bs-gray) !important;
  color: var(--dark) !important;
}
.dropdown-content .dropdown-item:hover,
.dropdown-content .dropdown-item:hover span,
.dropdown-content .dropdown-item:hover h6,
.dropdown-content .dropdown-item:hover text-body-secondary {
  color: var(--bs-set) !important;
}
.dropdown-content .dropdown-item:hover .bg-secondary {
  background-color: var(--bs-set) !important;
}
.dropdown-content .dropdown-item:hover i {
  color: var(--bs-white) !important;
}

.dropdown-content {
  overflow-y: auto;
  max-height: 400px;
}
.dropdown-content .message-body .w-75 h6 {
  font-size: 14px;
  font-weight: 300;
}
.dropdown-content .message-body .w-75 span {
  font-size: 12px;
}
.dropdown-content .message-body .dropdown-item .bg-opacity-25 {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.dropdown-content .ms-3 span {
  font-size: 12px;
}
.dropdown-content .profile-user {
  width: 80px;
  height: 80px;
}
.edit-button{
  background-color: var(--bs-edit);
  color: var(--bs-light);
  transition: all 0.3s;
}
.edit-button:hover{
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
}
.del-button{
  background-color: var(--bs-del);
  color: var(--bs-light);
  transition: all 0.3s;
}
.del-button:hover{
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
}
.set-button{
  background-color: var(--bs-set);
  color: var(--bs-light);
  transition: all 0.3s;
}
.set-button:hover{
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
}
.upload-button{
  background-color: var(--bs-upload);
  color: var(--bs-light);
  transition: all 0.3s;
}
.upload-button:hover{
  background-color: var(--bs-edit);
  color: var(--bs-light);
  transition: all 0.3s;
  transform: scale(1.1);
}

.custom-table thead th {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1;
}
.todo-container {
  max-width: 600px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
}
.todo-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #ddd;
}
.todo-item:last-child {
  border-bottom: none;
}
.header-item {
  background: linear-gradient(to right, var(--box1), var(--box2), var(--box3), var(--box4));
  color: var(--bs-white);
  position: sticky;
  top: 0;
  z-index: 1;
}
.todo-list {
  max-height: 400px;
  overflow-y: auto;
}
.custom-table thead th {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1;
}
.custom-tooltip {
  --bs-tooltip-bg: var(--bs-edit);
  --bs-tooltip-color: var(--bs-white);
}
table tbody tr:hover {
  cursor: pointer;
}
.progress-bar-custom {
  width: 100px;
}
.table-responsive {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.table thead th {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1;
}
@media (max-width: 576px) {
  .modal-dialog {
    width: 90%;
    margin: auto;
  }
  .table th, .table td {
    font-size: 14px;
    padding: 0.5rem;
  }
}
.custom-table-responsive {
  overflow-x: auto;
}
.custom-table-responsive thead th {
  white-space: nowrap;
}
.custom-table-responsive tbody td {
  white-space: nowrap;
}
.custom-table-responsive .form-control {
  min-width: 200px;
}

.custom-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 25px;
}

.custom-switch-input {
  opacity: 0;
  width: 0;
  height: 0;
}

.custom-switch-label {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--bs-del);
  border-radius: 25px;
  transition: background-color 0.4s;
}

.custom-switch-label:before {
  position: absolute;
  content: "";
  height: 21px;
  width: 21px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border-radius: 50%;
  transition: transform 0.4s;
}

.custom-switch-input:checked + .custom-switch-label {
  background-color: var(--bs-upload);
}

.custom-switch-input:checked + .custom-switch-label:before {
  transform: translateX(25px);
}

.fc .fc-button {
  background-color: var(--box3);
  border-color: var(--box3);
  color: var(--bs-white);
}

.fc .fc-button:hover {
  background-color: var(--box3);
  border-color: var(--box3);
  opacity: 0.8;
}

.fc .fc-toolbar-title {
  color: var(--box3);
}

.fc .fc-button {
  background-color: var(--box3) !important;
  border-color: var(--box3) !important;
  color: var(--bs-white) !important;
  transition: transform 0.3s, background-color 0.3s, color 0.3s !important;
}

.fc .fc-button:hover {
  background-color: var(--box2) !important;
  border-color: var(--box2) !important;
  transform: scale(1.1) !important;
  color: var(--bs-white) !important;
  opacity: 0.8 !important;
}

.fc-daygrid-day:hover {
  background-color: var(--box2);
  color: var(--bs-white)
  transform: scale(1.05);
  transition: transform 0.3s, background-color 0.3s;
}

.fc-daygrid-day-number:hover {
  color: var(--bs-white)
}

.fc-day-sat .fc-daygrid-day-number, 
.fc-day-sat .fc-col-header-cell {
  color: var(--box4);
  transition: color 0.3s, transform 0.3s;
}

.fc-day-sun .fc-daygrid-day-number, 
.fc-day-sun .fc-col-header-cell {
  color: var(--box4);
  transition: color 0.3s, transform 0.3s;
}

.fc-day-sat:hover .fc-daygrid-day-number, 
.fc-day-sat:hover .fc-col-header-cell,
.fc-day-sun:hover .fc-daygrid-day-number, 
.fc-day-sun:hover .fc-col-header-cell {
  color: var(--box3);
  transform: scale(1.05);
}

.customSet-checkbox {
  display: inline-block;
  width: 28px;
  height: 28px;
  background-color: var(--bs-white);
  border-radius: 4px;
  position: relative;
  cursor: pointer;
}
.customSet-checkbox input {
  opacity: 0;
  width: 0;
  height: 0;
  position: absolute;
}
.customSet-checkbox .checkmark {
  position: absolute;
  top: 20;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bs-white);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
.customSet-checkbox input:checked ~ .checkmark {
  background-color: var(--bs-upload);
  color: white;
}
.customSet-checkbox input:not(:checked) ~ .checkmark {
  background-color: var(--bs-del);
  color: white;
}
.customSet-checkbox .fa-check, .customSet-checkbox .fa-xmark {
  display: none;
}
.customSet-checkbox input:checked ~ .checkmark .fa-check {
  display: block;
}
.customSet-checkbox input:not(:checked) ~ .checkmark .fa-xmark {
  display: block;
}

.user-item-set {
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  transition: background-color 0.3s;
}

.user-item-set:hover {
  background-color: var(--box2);
  color: var(--bs-white);
}

.user-item-set.selected {
  background-color: var(--box1);
  color: var(--bs-white);
}

.user-item-set img {
  width: 60px;
  height: 60px;
  border-radius: 8px;
}

.progress-Set {
  height: 10px;
  background-color: #e9ecef;
  border-radius: 0.25rem;
  overflow: hidden;
  width: 100%;
}
.progress-bar-Set {
  height: 100%;
  background: var(--box1);
  //background: linear-gradient(to right, var(--box4), var(--box3), var(--box1), var(--box2));
}

.circular-progress {
  position: relative;
  height: 50px; /* ปรับขนาดเล็กลง */
  width: 50px;  /* ปรับขนาดเล็กลง */
  border-radius: 50%;
  background: conic-gradient(var(--progress-color) var(--progress-angle), #ededed 0deg);
  display: flex;
  align-items: center;
  justify-content: center;
}

.circular-progress::before {
  content: "";
  position: absolute;
  height: 40px; /* ปรับขนาดเล็กลง */
  width: 40px;  /* ปรับขนาดเล็กลง */
  border-radius: 50%;
  background-color: #fff;
}

.progress-value {
  position: relative;
  font-size: 12px; /* ปรับขนาดเล็กลง */
  font-weight: 600;
  color: var(--progress-color);
}

.Employee-card {
  cursor: pointer;
  border: 2px solid var(--bs-gray-200);
  transition: border-color 0.3s, box-shadow 0.3s;
}

.Employee-card.selected {
  border-color: var(--box2);
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
}

.Employee-card:hover {
  border-color: var(--box2);
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
}

.announcement-item {
  border-bottom: 1px solid var(--bs-white);
  padding: 15px 15px;
  transition: background-color 0.3s;
  border-radius: 5px;
}

.announcement-item:last-child {
  border-bottom: none;
}

.announcement-item:hover {
  background-color: var(--box2);
  color: var(--bs-white);
}

.announcement-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.announcement-header img {
  margin-right: 10px;
}

.announcement-date {
  color: var(--bs-gray);
  font-size: 0.9em;
}

.announcement-name {
  font-size: 0.9em;
  color: var(--bs-gray);
}

.announcement-item:hover .announcement-date,
.announcement-item:hover .announcement-name {
  color: var(--bs-white);
}

.announcement-title {
  font-size: 0.9em;
  color: var(--box1);
  text-decoration: none;
  display: block;
  margin-top: 10px;
  padding-left: 50px;
}

.announcement-item:hover .announcement-title {
  color: var(--bs-white);
}

/* CHATBOX */
.chatbox-wrapper {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  width: 4rem;
  height: 4rem;
  z-index: 1000;
}
.chatbox-toggle {
	width: 100%;
	height: 100%;
	background: var(--bs-edit);
	color: var(--bs-white);
	font-size: 2rem;
	display: flex;
	justify-content: center;
	align-items: center;
	border-radius: 50%;
	cursor: pointer;
	transition: .2s;
}
.chatbox-toggle:active {
	transform: scale(.9);
}
.chatbox-message-wrapper {
	position: absolute;
	bottom: calc(100% + 1rem);
	right: 0;
	width: 420px;
	border-radius: .5rem;
	overflow: hidden;
	box-shadow: .5rem .5rem 2rem rgba(0, 0, 0, .1);
	transform: scale(0);
	transform-origin: bottom right;
	transition: .2s;
  max-height: 500px;
  overflow-y: auto;
}
.chatbox-message-wrapper.show {
  transform: scale(1);
  z-index: 1001;
}
.chatbox-message-header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	background: var(--bs-white);
	padding: .75rem .75rem;
}
.chatbox-message-profile {
	display: flex;
	align-items: center;
	grid-gap: .5rem;
}
.chatbox-message-image {
	width: 3rem;
	height: 3rem;
	object-fit: cover;
	border-radius: 50%;
}
.chatbox-message-name {
	font-size: 1.125rem;
	font-weight: 600;
}
.chatbox-message-content {
	background: var(--grey);
	padding: 1.5rem;
	display: flex;
	flex-direction: column;
	grid-row-gap: 1rem;
	max-height: 300px;
	overflow-y: auto;
}
.chatbox-message-item {
	width: 90%;
	padding: 1rem;
}
.chatbox-message-item.sent {
	align-self: flex-end;
	background: var(--bs-white);
	color: var(--bs-gray-dark);
	border-radius: .75rem 0 .75rem .75rem;
}
.chatbox-message-item.received {
	background: var(--bs-white);
  color: var(--bs-gray-dark);
	border-radius: 0 .75rem .75rem .75rem;
	box-shadow: .25rem .25rem 1.5rem rgba(0, 0, 0, .05);
}
.chatbox-message-item-time {
	float: right;
	font-size: .75rem;
	margin-top: .5rem;
	display: inline-block;
}
.chatbox-message-bottom {
	background: var(--bs-white);
	padding: .75rem 1.5rem;
}
.chatbox-message-form {
  display: flex;
  align-items: center;
  background: var(--grey);
  border-radius: .5rem;
  padding: .5rem 1.25rem;
}

.chatbox-message-input {
  flex-grow: 1; /* ให้ input ขยายเต็มที่ */
  background: transparent;
  outline: none;
  border: none;
  resize: none;
  scrollbar-width: none;
  margin-right: .5rem; /* เพิ่มระยะห่างระหว่าง input กับปุ่ม */
}

.chatbox-message-submit {
  font-size: 1.25rem;
  border: none;
  outline: none;
  cursor: pointer;
}

.chatbox-message-input::-webkit-scrollbar {
	display: none;
}
.chatbox-message-no-message {
	font-size: 1rem;
	font-weight: 600;
	text-align: center;
}

@media screen and (max-width: 576px) {
	.chatbox-message-wrapper {
		width: calc(100vw - 2rem);
	}
	.chatbox-wrapper {
		bottom: 1rem;
		right: 1rem;
	}
}
div.tree-multiselect {
    border: 0px solid #D8D8D8 !important;
    border-radius: 5px;
    display: table;
    height: inherit;
    width: 100%;
}
div.tree-multiselect div.title {
    background: #F5F5F5;
    border-radius: 10px;
    color: black;
    padding: 5px;
}
div.tree-multiselect .auxiliary {
    font-weight: 400;
}
div.tree-multiselect .auxiliary input.search {
    border: 2px solid #D8D8D8;
    border-radius: 15px;
    display: table-cell;
    margin-bottom: 15px;
    padding: 5px;
    width: 100%;
}
div.tree-multiselect span.remove-selected, div.tree-multiselect span.description {
    background: transparent;
    color: red;
    font-size: 16px;
    margin-right: 5px;
    padding: 0 3px;
}
div.tree-multiselect>div.selected>div.item {
    background: transparent;
    border-radius: 2px;
    padding: 2px 5px;
    overflow: auto;
}
div.tree-multiselect input[type=checkbox] {
    display: inline;
    margin-right: 6px;
}
[type="checkbox"].section, [type="checkbox"].option {
    height: 16px;
    width: 16px;
    margin-top: -2px;
    margin-bottom: 0px;
    vertical-align: middle;
    background: white;
    border: 1px solid #b1b8bb;
    top: 0px;
    z-index: 0;
}
.form-check img {
  margin-left: 10px;
}
.select-all {
    color: green;
}
.unselect-all {
    color: red;
}

.divider {
  border-left: 2px solid #ddd;
  height: 50px;
  margin: 0 15px;
}

.flex-fill {
  flex: 1; /* ให้ col ขยายออกจนเต็มพื้นที่ */
  min-width: 120px; /* หรือกำหนดขนาดขั้นต่ำให้แน่ใจว่าคอลัมน์เท่ากัน */
}

.form-switch-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
  flex-direction: column; /* สำหรับจัดแนวทางแนวตั้งในมือถือ */
}

.styled-switch {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 50px;
  height: 28px;
  background-color: var(--box4); /* สีเมื่อปิดอยู่ */
  border-radius: 50px;
  position: relative;
  cursor: pointer;
  outline: none;
  transition: background-color 0.3s ease;
}

.styled-switch:checked {
  background-color: var(--box2); /* สีเมื่อเปิดอยู่ */
}

.styled-switch::before {
  content: "";
  position: absolute;
  top: 3px;
  left: 3px;
  width: 22px;
  height: 22px;
  background-color: white;
  border-radius: 50%;
  transition: transform 0.3s ease;
}

.styled-switch:checked::before {
  transform: translateX(22px); /* เคลื่อนที่เมื่อเปิด */
}

.form-check-label {
  font-size: 16px;
  color: #333;
  margin-top: 5px; /* เพิ่มระยะห่างจากสวิตช์ */
  text-align: center;
}

@media (min-width: 576px) {
  .form-switch-wrapper {
    flex-direction: row; /* กลับเป็นแนวนอนเมื่ออยู่ในหน้าจอใหญ่ขึ้น */
  }
  .form-check-label {
    margin-top: 0;
    margin-left: 10px; /* ระยะห่างสำหรับข้อความเมื่ออยู่ด้านข้าง */
    text-align: left;
  }
}

.department-card {
  width: 400px;
  background-color: var(--bs-white);
  border-radius: 8px;
  padding: 16px;
}

.member-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.member-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.member-avatar {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background-color: #f0f0f0;
}

.member-info {
  flex-grow: 1; 
}

.task-list {
  padding: 10px;
  border-radius: 10px;
  width: 100%;
  margin-bottom: 10px;
}

.task-list-1 {
  background-color: var(--box1); 
}

.task-list-2 {
  background-color: var(--box2);
}

.task-list-3 {
  background-color: var(--box3);
}

.task-list-4 {
  background-color: var(--box4);
}

.task {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.task:last-child {
  margin-bottom: 0;
}

.icon-task {
  background-color: rgba(255, 255, 255, 0.2);
  padding: 10px;
  border-radius: 10px;
  margin-right: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px; 
  height: 40px;
}

.icon-task i {
  color: var(--bs-white);
  font-size: 20px;
}

.task-details {
  display: flex;
  flex-direction: column;
}

.task-title {
  font-size: 16px;
  font-weight: bold;
  color: var(--bs-white);
}

.task-date {
  font-size: 14px;
  color: var(--bs-white);
}

.task-badge {
  color: var(--bs-white);
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 50px;
  height: 50px;
  font-size: 30px;
  font-weight: bold;
  margin-left: auto;
}

@media (max-width: 768px) {
  .leave-item {
    flex-direction: column; 
  }
  .leave-item .leave-button {
    width: 100%;
    margin-top: 10px;
  }
}

.leave-item {
  border: 2px solid transparent;
  transition: border-color 0.3s ease;
}

.leave-item:hover {
  border-color: var(--box2);
}

.leavelist-item {
  border: 2px solid transparent;
  transition: border-color 0.3s ease;
}

.leavelist-item:hover {
  border-color: var(--box2);
}

.leavelist-item.selected {
  border-color: var(--box2);
}

.holiday-group {
  margin-bottom: 5px;
  padding: 5px;
  border-radius: 8px;
  color: var(--box1);
}
.holiday-item {
  background-color: #f8f9fa;;
  border-radius: 8px;
  padding: 5px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.holiday-date {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  font-size: 20px;
  font-weight: bold;
  color: var(--bs-white);
  background-color: var(--box4);
  margin-right: 15px;
  flex-shrink: 0;
}
.holiday-details {
  color: var(--bs-gray-dark);
  flex-grow: 1;
}
.holiday-details .day {
  font-size: 16px;
  color: var(--bs-gray);
}
.holiday-details .name {
  font-size: 18px;
  margin-top: 3px;
}

@media (max-width: 768px) {
  .holiday-item {
    flex-direction: row;
    align-items: center;
  }
  .holiday-date {
    width: 40px;
    height: 40px;
    font-size: 16px;
    margin-right: 10px;
    flex-shrink: 0;
  }
  .holiday-details .day {
    font-size: 14px;
  }
  .holiday-details .name {
    font-size: 16px;
  }
}


.login {
  width: 360px;
  height: min-content;
  padding: 20px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.8); 
  border: 1px solid rgba(224, 224, 224, 0.5);
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
}

.login form {
  font-size: 16px;
  color: var(--bs-edit);
}

.login form .form-group {
  margin-bottom: 12px;
}

.login form .form-control {
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid rgba(224, 224, 224, 0.5);
  color: var(--bs-edit);
}

.login form .form-control:focus {
  background: rgba(255, 255, 255, 0.8);
  box-shadow: none;
}
</style>

Code.gs = 
const doGet = () => {
var page = HtmlService.createTemplateFromFile('index').evaluate()
  .addMetaTag('viewport', 'width=device-width, initial-scale=1')
  .setTitle(nameSystem)
  .setFaviconUrl(logoUrl)
  .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
return page;
}

const getURL = () => {
  return ScriptApp.getService().getUrl();
}

const include = (filename) => {
  return HtmlService.createHtmlOutputFromFile(filename).getContent()
}

const formatDate = (date) => {
  const year = date.getFullYear();
  const month = ('0' + (date.getMonth() + 1)).slice(-2);
  const day = ('0' + date.getDate()).slice(-2);
  const hours = ('0' + date.getHours()).slice(-2);
  const minutes = ('0' + date.getMinutes()).slice(-2);
  const seconds = ('0' + date.getSeconds()).slice(-2);
  return year + month + day + hours + minutes + seconds;
}

const getLocationCheckIn = () => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName("Locations");
  const checkData = sheet.getRange("A2:F").getValues();
  let results = [];

  checkData.forEach(row => {
    results.push({
      name: row[0],
      address: row[1] + ' ' + row[2] + ', ' + row[3],
      lat: parseFloat(row[4]),
      lng: parseFloat(row[5])
    });
  });

  return results;
}

const formatDateForComparison = (date) => {
  const day = date.getDate().toString().padStart(2, '0');
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
};

const userDataCheckin = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('TimeAttendance');
  const today = formatDateForComparison(new Date());
  const data = sheet.getDataRange().getValues();
  const folder = DriveApp.getFolderById(idfolder);
  const rowIndex = data.findIndex(row => row[1] === obj.checkinuid && formatDateForComparison(new Date(row[0])) === today);

  let imgurl = "";
  if (obj.imageDataUrl !== "") {
    const datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
    const blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    const file = folder.createFile(blob);
    const fileId = file.getId();
    imgurl = "https://lh3.googleusercontent.com/d/" + fileId;
  }

  if (rowIndex !== -1) {
    if (obj.status === 'เข้างาน' || obj.status === 'สาย') {
      sheet.getRange(rowIndex + 1, 4).setValue(obj.checkinTime); // Check-In
      sheet.getRange(rowIndex + 1, 6).setValue(obj.branch); // สาขา
      sheet.getRange(rowIndex + 1, 7).setValue(obj.ipAddress); // IP Address
      sheet.getRange(rowIndex + 1, 8).setValue(obj.deviceId);  // Device ID
      sheet.getRange(rowIndex + 1, 9).setValue(imgurl); // รูปเข้างาน
    } 
    else if (obj.status === 'ออกงาน') {
      sheet.getRange(rowIndex + 1, 5).setValue(obj.checkinTime); // Check-Out
      sheet.getRange(rowIndex + 1, 10).setValue(imgurl); // รูปออกงาน
    }
  } else {
    sheet.appendRow([today, obj.checkinuid, obj.checkinfullname, obj.checkinTime, "", obj.branch, obj.ipAddress, obj.deviceId, obj.status === 'เข้างาน' || obj.status === 'สาย' ? imgurl : "", obj.status === 'ออกงาน' ? imgurl : ""]);
  }
};

const generateCodeLeave = (sheet) => {
  const prefix = 'LEV';
  const today = new Date();
  const thaiYear = (today.getFullYear() + 543).toString().slice(-2);
  const lastRow = sheet.getLastRow();

  if (lastRow <= 1) {
    return prefix + thaiYear + '00001';
  }

  const ids = sheet.getRange(2, 1, lastRow - 1).getValues().flat();

  const currentYearIds = ids
    .filter(id => id.startsWith(prefix + thaiYear))
    .map(id => parseInt(id.replace(prefix + thaiYear, ''), 10))
    .filter(num => !isNaN(num))
    .sort((a, b) => a - b);

  let newNumber = 1;
  for (let i = 0; i < currentYearIds.length; i++) {
    if (newNumber < currentYearIds[i]) {
      break;
    }
    newNumber++;
  }

  return prefix + thaiYear + newNumber.toString().padStart(5, '0');
}

const addDataLeave = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Leave');
  const codeuseLeave = generateCodeLeave(sheet);
  const folder = DriveApp.getFolderById(idfolder);
  const currentTime = new Date();
  const formattedDate = Utilities.formatDate(currentTime, Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowData;

  if (obj.imageDataUrl) {
    const datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
    const blob = Utilities.newBlob(datafile, obj.filetype, codeuseLeave);
    const file = folder.createFile(blob);
    const fileId = file.getId();
    const url = "https://lh3.googleusercontent.com/d/" + fileId;
    rowData = [
      codeuseLeave, "รอตรวจสอบ", formattedDate, obj.leaveA, obj.leaveB, obj.leaveC, obj.leaveD, obj.leaveE, obj.leaveData1, obj.leaveData2, url, "'"+obj.leaveData3,
      "'"+obj.leaveData4, obj.leaveData5, obj.leaveData6
    ];
  } else {
    rowData = [
      codeuseLeave, "รอตรวจสอบ", formattedDate, obj.leaveA, obj.leaveB, obj.leaveC, obj.leaveD, obj.leaveE, obj.leaveData1, obj.leaveData2, "", "'"+obj.leaveData3,
      "'"+obj.leaveData4, obj.leaveData5, obj.leaveData6
    ];
  }

  sheet.appendRow(rowData);

  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const userData = userSheet.getDataRange().getValues();
  let userEmail = "";

  for (let i = 1; i < userData.length; i++) {
    if (userData[i][0] === obj.leaveA) {
      userEmail = userData[i][30];
      break;
    }
  }

  if (userEmail) {
    const subject = "แจ้งขอลางาน";
    const body = `
      ขออนุญาตลางาน
      🆔 รหัส: ${codeuseLeave}
      🙋 ผู้ขออนุญาต: รหัสพนักงาน: ${obj.leaveA} ชื่อ สกุล: ${obj.leaveB} หน่วยงาน: ${obj.leaveC} ฝ่าย: ${obj.leaveD}
      🕒 วันที่ลงระบบ: ${formattedDate}
      📝 ประเภทลา: ${obj.leaveData1}
      📝 รายละเอียด: ${obj.leaveData2}
      📅 วันที่เริ่ม: ${obj.leaveData3} ถึงวันที่: ${obj.leaveData4}
      📅 จำนวนวัน: ${obj.leaveData5} วัน ${obj.leaveData6} ชั่วโมง
    `;
    MailApp.sendEmail(userEmail, subject, body);
  } else {
    Logger.log("ไม่พบอีเมลสำหรับผู้ใช้งาน: " + obj.leaveA);
  }  
}

const upDataLeave = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Leave');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.leaveKey) {
      rowIndex = i;
      break;
    }
  }

  if (rowIndex > -1) {
    let url = data[rowIndex][10];
    const oldFileId = url ? url.split('/d/')[1] : null;

    if (obj.imageDataUrl) {
      const folder = DriveApp.getFolderById(idfolder);
      const datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
      const blob = Utilities.newBlob(datafile, obj.filetype, obj.leaveKey);
      const file = folder.createFile(blob);
      const newFileId = file.getId();
      url = "https://lh3.googleusercontent.com/d/" + newFileId;

      if (oldFileId) {
        try {
          DriveApp.getFileById(oldFileId).setTrashed(true);
        } catch (error) {
          Logger.log("ไม่สามารถลบไฟล์เก่าได้: " + error);
        }
      }
    }

    sheet.getRange(rowIndex + 1, 9).setValue(obj.leaveData1);
    sheet.getRange(rowIndex + 1, 10).setValue(obj.leaveData2);
    sheet.getRange(rowIndex + 1, 11).setValue(url); // อัปเดต URL ของไฟล์ใหม่ (ถ้ามี)
    sheet.getRange(rowIndex + 1, 12).setValue("'" + obj.leaveData3);
    sheet.getRange(rowIndex + 1, 13).setValue("'" + obj.leaveData4);
    sheet.getRange(rowIndex + 1, 14).setValue(obj.leaveData5);
    sheet.getRange(rowIndex + 1, 15).setValue(obj.leaveData6);
  }

  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const userData = userSheet.getDataRange().getValues();
  let userEmail = "";

  for (let i = 1; i < userData.length; i++) {
    if (userData[i][0] === obj.leaveA) {
      userEmail = userData[i][30];
      break;
    }
  }

  if (userEmail) {
    const subject = "แก้ไขการลางาน";
    const body = `
      ขออนุญาตแก้ไขการลางาน
      🆔 รหัส: ${obj.leaveKey}
      🙋 ผู้ขออนุญาต: รหัสพนักงาน: ${obj.leaveA} ชื่อ สกุล: ${obj.leaveB} หน่วยงาน: ${obj.leaveC} ฝ่าย: ${obj.leaveD}
      📝 ประเภทลา: ${obj.leaveData1}
      📝 รายละเอียด: ${obj.leaveData2}
      📅 วันที่เริ่ม: ${obj.leaveData3} ถึงวันที่: ${obj.leaveData4}
      📅 จำนวนวัน: ${obj.leaveData5} วัน ${obj.leaveData6} ชั่วโมง
    `;
    MailApp.sendEmail(userEmail, subject, body);
  } else {
    Logger.log("ไม่พบอีเมลสำหรับผู้ใช้งาน: " + obj.leaveA);
  }
};

const delDataLeave = (record) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Leave');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    const file = sheet.getRange(rowIndex + 1, 11).getValue();
    if (file.includes("https://lh3.googleusercontent.com/d/")) {
      const fileId = file.split('/d/')[1];
      DriveApp.getFileById(fileId).setTrashed(true);
    }
    sheet.deleteRow(rowIndex + 1);
  }
}

const approvalLeave = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Leave'); 
  const data = sheet.getDataRange().getValues();
  const currentTime = new Date();
  const formattedDate = Utilities.formatDate(currentTime, Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowIndex;

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === obj.codeID) {
      rowIndex = i;
      sheet.getRange(rowIndex + 1, 2).setValue(obj.status);
      sheet.getRange(rowIndex + 1, 16).setValue(obj.fullname);
      sheet.getRange(rowIndex + 1, 17).setValue(obj.leavedata);
      sheet.getRange(rowIndex + 1, 18).setValue(formattedDate);
      sheet.getRange(rowIndex + 1, 19).setValue(obj.signame);
      break;
    }
  }

  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const userData = userSheet.getDataRange().getValues();
  let userEmail = "";

  for (let i = 1; i < userData.length; i++) {
    if (userData[i][0] === data[rowIndex][3]) {
      userEmail = userData[i][30];
      break;
    }
  }

  if (userEmail) {
    const subject = "อนุมัติการลาพนักงาน";
    const body = `
      ผลการตรวจสอบ 💡 สถานะ ${obj.status}
      🆔 รหัส: ${obj.codeID}
      🙋 ผู้ขออนุญาต: 
         รหัสพนักงาน: ${data[rowIndex][3]}
         ชื่อ สกุล: ${data[rowIndex][4]}
         หน่วยงาน: ${data[rowIndex][5]}
         ฝ่าย: ${data[rowIndex][6]}
      📝 ประเภทลา: ${data[rowIndex][8]}
      📝 รายละเอียด: ${data[rowIndex][9]}
      📅 วันที่เริ่ม: ${data[rowIndex][11]} ถึงวันที่: ${data[rowIndex][12]}
      📅 จำนวนวัน: ${data[rowIndex][13]} วัน ${data[rowIndex][14]} ชั่วโมง

      สำหรับผู้อนุมัติ
      🙋 ผู้ดำเนินการอนุมัติ:
         ชื่อ สกุล: ${obj.fullname}
         ความคิดเห็น: ${obj.leavedata}
         วันที่ตรวจสอบ: ${formattedDate}
    `;
    MailApp.sendEmail(userEmail, subject, body);
  } else {
    Logger.log("ไม่พบอีเมลสำหรับผู้ใช้งาน: " + data[rowIndex][3]);
  }
};

function generateCodereqList(current) {
  const prefix = 'REQ';
  const today = new Date();
  const thaiYear = (today.getFullYear() + 543).toString().slice(-2);
  const number = current.toString().padStart(5, '0');
  return prefix+`${thaiYear}${number}`;
}

const addDatareqList = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Request'); 
  const lastRow = sheet.getLastRow();
  const codeID = generateCodereqList(lastRow);
  const currentTime = new Date();
  const formattedDate = Utilities.formatDate(currentTime, Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowData;
    rowData = [codeID, "รอตรวจสอบ", formattedDate, obj.rqtuid, obj.rqtfullname, obj.rqtdpm, obj.rqtgroup, obj.rqtsig, "'"+obj.rqtdata1];
    sheet.appendRow(rowData);

  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const userData = userSheet.getDataRange().getValues();
  let userEmail = "";

  for (let i = 1; i < userData.length; i++) {
    if (userData[i][0] === obj.rqtuid) {
      userEmail = userData[i][30];
      break;
    }
  }

  if (userEmail) {
    const subject = "ขอหนังสือรับรอง";
    const body = `
      ขออนุญาตขอหนังสือรับรองเงินเดือน
      🆔 รหัสคำขอ: ${codeID}
      🙋 ผู้ขออนุญาต: รหัสพนักงาน: ${obj.rqtuid} ชื่อ สกุล: ${obj.rqtfullname} หน่วยงาน: ${obj.rqtdpm} ฝ่าย: ${obj.rqtgroup}
      🕒 วันที่ลงระบบ: ${formattedDate}
      📝 รายละเอียด: ${obj.rqtdata1}
    `;
    MailApp.sendEmail(userEmail, subject, body);
  } else {
    Logger.log("ไม่พบอีเมลสำหรับผู้ใช้งาน: " + obj.leaveA);
  }

  return sheet.getRange("A2:M" + sheet.getLastRow()).getValues();
}

const upDatareqList = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Request'); 
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.rqtKey) {
      rowIndex = i;
      break;
    }
  }

  if (rowIndex > -1) {
    sheet.getRange(rowIndex + 1, 9).setValue(obj.rqtdata1);
  }

  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const userData = userSheet.getDataRange().getValues();
  let userEmail = "";

  for (let i = 1; i < userData.length; i++) {
    if (userData[i][0] === obj.rqtuid) {
      userEmail = userData[i][30];
      break;
    }
  }

  if (userEmail) {
    const subject = "ขอแก้ไขเอกสารหนังสือรับรอง";
    const body = `
      ขออนุญาตขอแก้ไขเอกสารการขอหนังสือรับรองเงินเดือน
      🆔 รหัสคำขอ: ${obj.rqtKey}
      🙋 ผู้ขออนุญาต: รหัสพนักงาน: ${obj.rqtuid} ชื่อ สกุล: ${obj.rqtfullname} หน่วยงาน: ${obj.rqtdpm} ฝ่าย: ${obj.rqtgroup}
      📝 รายละเอียด: ${obj.rqtdata1}
    `;
    MailApp.sendEmail(userEmail, subject, body);
  } else {
    Logger.log("ไม่พบอีเมลสำหรับผู้ใช้งาน: " + obj.leaveA);
  }

  return sheet.getRange("A2:M" + sheet.getLastRow()).getValues();
}

const delDatareqList = (codeID) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Request');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === codeID) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
}

const approvalRequest = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Request'); 
  const data = sheet.getDataRange().getValues();
  const currentTime = new Date();
  const formattedDate = Utilities.formatDate(currentTime, Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowIndex = null;

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === obj.codeID) {
      rowIndex = i + 1;
      break;
    }
  }

  if (rowIndex !== null) {
    sheet.getRange(rowIndex, 2).setValue(obj.status);
    sheet.getRange(rowIndex, 10).setValue(obj.fullname);
    sheet.getRange(rowIndex, 11).setValue(obj.reqdata);
    sheet.getRange(rowIndex, 12).setValue(formattedDate);
    sheet.getRange(rowIndex, 13).setValue(obj.signame);

    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const userData = userSheet.getDataRange().getValues();
    let userEmail = "";

    for (let i = 1; i < userData.length; i++) {
      if (userData[i][0] === data[rowIndex-1][3]) {
        userEmail = userData[i][30];
        break;
      }
    }

    if (userEmail) {
      const subject = "อนุมัติการขอหนังสือรับพนักงาน";
      const body = `
        ผลการตรวจสอบ 💡 สถานะ ${obj.status}
        🆔 รหัส: ${obj.codeID}
        🙋 ผู้ขออนุญาต: 
           รหัสพนักงาน: ${data[rowIndex-1][3]}
           ชื่อ สกุล: ${data[rowIndex-1][4]}
           หน่วยงาน: ${data[rowIndex-1][5]}
           ฝ่าย: ${data[rowIndex-1][6]}

        สำหรับผู้อนุมัติ
        🙋 ผู้ดำเนินการอนุมัติ:
           ชื่อ สกุล: ${obj.fullname}
           ความคิดเห็น: ${obj.reqdata}
           วันที่ตรวจสอบ: ${formattedDate}
      `;
      MailApp.sendEmail(userEmail, subject, body);
    } else {
      Logger.log("ไม่พบอีเมลสำหรับผู้ใช้งาน: " + data[rowIndex-1][3]);
    }
  } else {
    Logger.log("ไม่พบรายการที่ต้องการอัพเดท: " + obj.codeID);
  }
};

const generateCodeSalary = () => {
  const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const prefix = 'SUM';
  const currentDate = new Date(); 
  const timestamp = formatDate(currentDate); 
  let key = timestamp + prefix; 
  for (let i = 0; i < 7; i++) {
    const randomIndex = Math.floor(Math.random() * characters.length);
    key += characters[randomIndex];
  }
  return key;
}

const saveSummary = (summaryData) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Summary');
  const codeID = generateCodeSalary();
  const formatDate = (rawDate) => {
    const date = new Date(rawDate);
    const day = ('0' + date.getDate()).slice(-2);
    const month = ('0' + (date.getMonth() + 1)).slice(-2);
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };
  summaryData.forEach((summary) => {
    const paymentDate = formatDate(summary.dueDate);
    const detailsJson = JSON.stringify(summary.details);
    sheet.appendRow([codeID, summary.period, summary.status, summary.day, paymentDate, detailsJson, summary.totalLateDeductions, summary.totalLeaveDeductions, summary.totalOTIncome, summary.totalSocialSecurity, summary.totalOtherDeductions, summary.totalOtherIncome, summary.salaryBeforeTotal, summary.totalRowIncome]);
  });
};

const updateSummary = (summaryData) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Summary');
  const formatDate = (rawDate) => {
    const date = new Date(rawDate);
    const day = ('0' + date.getDate()).slice(-2);
    const month = ('0' + (date.getMonth() + 1)).slice(-2);
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };
  summaryData.forEach((summary) => {
    const codeID = summary.key;
    const detailsJson = JSON.stringify(summary.details);
    const paymentDate = formatDate(summary.dueDate);
    const rows = sheet.getDataRange().getValues();
    let rowIndex = -1;
    
    for (let i = 0; i < rows.length; i++) {
      if (rows[i][0] === codeID) {  
        rowIndex = i; 
        break;
      }
    }
    
    if (rowIndex > -1) {
      sheet.getRange(rowIndex + 1, 2).setValue(summary.period);  // งวดเงินเดือน
      sheet.getRange(rowIndex + 1, 3).setValue(summary.status);  // สถานะ
      sheet.getRange(rowIndex + 1, 4).setValue(summary.day);  // วันที่ทำรายการ
      sheet.getRange(rowIndex + 1, 5).setValue(paymentDate);  // กำหนดชำระ
      sheet.getRange(rowIndex + 1, 6).setValue(detailsJson);  // รายละเอียดพนักงาน (JSON)
      sheet.getRange(rowIndex + 1, 7).setValue(summary.totalLateDeductions);  // รวมหักสาย
      sheet.getRange(rowIndex + 1, 8).setValue(summary.totalLeaveDeductions);  // รวมหักลา
      sheet.getRange(rowIndex + 1, 9).setValue(summary.totalOTIncome);  // รวม OT
      sheet.getRange(rowIndex + 1, 10).setValue(summary.totalSocialSecurity);  // รวมหักประกันสังคม
      sheet.getRange(rowIndex + 1, 11).setValue(summary.totalOtherDeductions);  // รวมหักอื่น
      sheet.getRange(rowIndex + 1, 12).setValue(summary.totalOtherIncome);  // รายได้อื่นๆ
      sheet.getRange(rowIndex + 1, 13).setValue(summary.salaryBeforeTotal);  // รวมจ่ายพนักงาน
      sheet.getRange(rowIndex + 1, 14).setValue(summary.totalRowIncome);  // รายได้รวมทั้งหมด
    }
  });
};

const delDataSummary = (record) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Summary');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
}

const updatebankCode = (codeID, status) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('Summary');
  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === codeID) {
      sheet.getRange(i + 1, 3).setValue(status);
      rowIndex = i;
      break;
    }
  }
  if (rowIndex === -1) {
    throw new Error("ไม่พบรายการในชีตที่ตรงกับรหัส");
  }
}

const sendPayrollEmail = (email, payrollData) => {
  const base64Data = payrollData.base64;
  const pdfBlob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'application/pdf', `Payslip_${payrollData.uid}.pdf`);

  const htmlBody = `
  <div style="font-family: 'Arial', sans-serif; color: #333; display: flex; justify-content: center; padding: 20px;">
    <div style="max-width: 600px; width: 100%; background-color: #f9f9f9; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 20px; text-align: center;">
      <img src="https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png" alt="Company Logo" style="width: 150px; margin-bottom: 20px;">
      <h1 style="color: #4CAF50;">PAY SLIP</h1>
      <p>สลิปเงินเดือนของคุณ ${payrollData.fullname} จาก Epic Coding Channel</p>
      <p>งวดที่ชำระ: <strong>${payrollData.paymentPeriod}</strong></p>
      <p>กำหนดชำระ: <strong>${payrollData.paymentDate}</strong></p>
      <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">
      <p>เรียนคุณ ${payrollData.fullname},</p>
      <p>ท่านสามารถดาวน์โหลดสลิปเงินเดือนของท่านได้ในไฟล์แนบ</p>
      <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">
      <p style="color: #888;">ขอแสดงความนับถือ,</p>
      <p style="color: #888;">Epic Coding Channel</p>
    </div>
  </div>
  `;

  MailApp.sendEmail({
    to: email,
    subject: `สลิปเงินเดือนของคุณสำหรับงวด ${payrollData.paymentPeriod}`, 
    htmlBody: htmlBody,
    attachments: [pdfBlob]
  });
}

const generateCodeNewsDB = () => {
  const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const prefix = 'News';
  const currentDate = new Date(); 
  const timestamp = formatDate(currentDate); 
  let key = timestamp + prefix; 
  for (let i = 0; i < 7; i++) {
    const randomIndex = Math.floor(Math.random() * characters.length);
    key += characters[randomIndex];
  }
  return key;
}

const addDataNewsDB = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('NewsDB'); 
  const lastRow = sheet.getLastRow();
  const codeID = generateCodeNewsDB(lastRow);
  const currentTime = new Date();
  const formattedDate = Utilities.formatDate(currentTime, Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowData;
    rowData = [codeID, formattedDate, obj.news1, obj.news2, obj.fullname, obj.dpm];
    sheet.appendRow(rowData);
  return sheet.getRange("A2:F" + sheet.getLastRow()).getValues();
}

const upDataNewsDB = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('NewsDB'); 
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 3).setValue(obj.news1);
  sheet.getRange(rowIndex + 1, 4).setValue(obj.news2);
  }

  return sheet.getRange("A2:F" + sheet.getLastRow()).getValues();
}

const delDataNewsDB = (record) => {
  const sheet = SpreadsheetApp.openById(sheetData).getSheetByName('NewsDB'); 
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
}

const addDataSetLocations = (obj) => { 
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('Locations');

  let rowData = [obj.location1, obj.location2, obj.location3, obj.location4, obj.location5, obj.location6];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:F" + sheet.getLastRow()).getValues();
};

const delDataSetLocations = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('Locations');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting1 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'ST-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
}

const addDataSetTime = (obj) => { 
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetTime');
  const codeID = generateCodeSetting1(sheet);

  const formatTime = (time) => {
    const date = new Date();
    const [hours, minutes] = time.split(':');
    date.setHours(hours, minutes);
    date.setSeconds(0);
    return Utilities.formatDate(date, Session.getScriptTimeZone(), "HH:mm:ss");
  };

  const formattedTime1 = formatTime(obj.times1);
  const formattedTime2 = formatTime(obj.times2);

  let rowData = [codeID, "'"+formattedTime1, "'"+formattedTime2, false];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const upDataSetTime = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetTime');
  const data = sheet.getDataRange().getDisplayValues();

  const formatTime = (time) => {
    const date = new Date();
    const [hours, minutes] = time.split(':');
    date.setHours(hours, minutes);
    date.setSeconds(0);
    return Utilities.formatDate(date, Session.getScriptTimeZone(), "HH:mm:ss");
  };

  const formattedTime1 = formatTime(obj.times1);
  const formattedTime2 = formatTime(obj.times2);

  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 2).setValue("'"+formattedTime1);
  sheet.getRange(rowIndex + 1, 3).setValue("'"+formattedTime2);
  }
  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const delDataSetTime = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetTime');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting2 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'SL-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
};

const addDataSetLeave = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetLeave');
  const codeID = generateCodeSetting2(sheet);
  let rowData;
    rowData = [codeID, "'"+obj.leave1, "'"+obj.leave2, false];
    sheet.appendRow(rowData);
  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const upDataSetLeave = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetLeave');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 2).setValue("'"+obj.leave1);
  sheet.getRange(rowIndex + 1, 3).setValue("'"+obj.leave2);
  }
  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const delDataSetLeave = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetLeave');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting3 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'OT-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
};

const addDataSetOT = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetOT');
  const codeID = generateCodeSetting3(sheet);

  const percentValue = parseFloat(obj.ot1).toFixed(2) + '%';

  const rowData = [codeID, percentValue, false];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const upDataSetOT = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetOT');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  const percentValue = parseFloat(obj.ot1).toFixed(2) + '%';
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 2).setValue(percentValue);
  }
  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const delDataSetOT = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetOT');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting4 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'SSO-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
};

const addDataSetSSO = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSSO');
  const codeID = generateCodeSetting4(sheet);

  const percentValue = parseFloat(obj.sso1).toFixed(2) + '%';

  const rowData = [codeID, percentValue, false];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const upDataSetSSO = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSSO');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  const percentValue = parseFloat(obj.sso1).toFixed(2) + '%';
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 2).setValue(percentValue);
  }
  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const delDataSetSSO = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSSO');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting5 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'SD-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
};

const addDataSetDayOff = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetDayOff');
  const codeID = generateCodeSetting5(sheet);
  const dateParts = obj.sdoff1.split('-');
  const formattedDate = Utilities.formatDate(new Date(dateParts[0], dateParts[1] - 1, dateParts[2]), Session.getScriptTimeZone(), 'dd/MM/yyyy');
  const rowData = [codeID, formattedDate, obj.sdoff2];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const upDataSetDayOff = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetDayOff');
  const data = sheet.getDataRange().getDisplayValues();
  const dateParts = obj.sdoff1.split('-');
  const formattedDate = Utilities.formatDate(new Date(dateParts[0], dateParts[1] - 1, dateParts[2]), Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
    sheet.getRange(rowIndex + 1, 2).setValue(formattedDate);
    sheet.getRange(rowIndex + 1, 3).setValue(obj.sdoff2);
  }
  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const delDataSetDayOff = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetDayOff');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting6 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'SW-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
};

const addDataSetWeekEnd = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetWeekEnd');
  const codeID = generateCodeSetting6(sheet);

  const rowData = [codeID, obj.weoff1, false];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const upDataSetWeekEnd = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetWeekEnd');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 2).setValue(obj.weoff1);
  }
  return sheet.getRange("A2:C" + sheet.getLastRow()).getValues();
};

const delDataSetWeekEnd = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetWeekEnd');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const generateCodeSetting7 = (sheet) => {
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
  const prefix = 'SS-';
  const existingNumbers = ids.map(id => parseInt(id.replace(prefix, ''), 10)).sort((a, b) => a - b);
  let newNumber = 1;
  for (let i = 0; i < existingNumbers.length; i++) {
    if (newNumber < existingNumbers[i]) {
      break;
    }
    newNumber++;
  }
  return prefix + newNumber.toString().padStart(2, '0');
};

const addDataSetSalary = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSalary');
  const codeID = generateCodeSetting7(sheet);
  const dateParts1 = obj.salary1.split('-');
  const formattedDate1 = Utilities.formatDate(new Date(dateParts1[0], dateParts1[1] - 1, dateParts1[2]), Session.getScriptTimeZone(), 'dd/MM/yyyy');
  const dateParts2 = obj.salary2.split('-');
  const formattedDate2 = Utilities.formatDate(new Date(dateParts2[0], dateParts2[1] - 1, dateParts2[2]), Session.getScriptTimeZone(), 'dd/MM/yyyy');
  const rowData = [codeID, formattedDate1, formattedDate2, obj.salary3];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const upDataSetSalary = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSalary');
  const data = sheet.getDataRange().getDisplayValues();
  const dateParts1 = obj.salary1.split('-');
  const formattedDate1 = Utilities.formatDate(new Date(dateParts1[0], dateParts1[1] - 1, dateParts1[2]), Session.getScriptTimeZone(), 'dd/MM/yyyy');
  const dateParts2 = obj.salary2.split('-');
  const formattedDate2 = Utilities.formatDate(new Date(dateParts2[0], dateParts2[1] - 1, dateParts2[2]), Session.getScriptTimeZone(), 'dd/MM/yyyy');
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.key) {
      rowIndex = i;
      break;
    }
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 2).setValue(formattedDate1);
  sheet.getRange(rowIndex + 1, 3).setValue(formattedDate2);
  sheet.getRange(rowIndex + 1, 4).setValue(obj.salary3);
  }
  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const delDataSetSalary = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSalary');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const addDataSetBank = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('BacnkCode');
  var bankfileUrl = "";
  if (obj.check !== "") {
    var datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
    var blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    var file = folder.createFile(blob);
    var fileId = file.getId();
    bankfileUrl = "https://lh3.googleusercontent.com/d/" + fileId;
  } else {
    bankfileUrl = obj.bankfile;
  }
  const rowData = ["'"+obj.bankkey, obj.bank1, obj.bank2, bankfileUrl];
  sheet.appendRow(rowData);

  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const upDataSetBank = (obj) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('BacnkCode');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  let bankfileUrl = obj.bankfile;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.bankkey) {
      rowIndex = i;
      break;
    }
  }
  if (obj.check !== "" && obj.imageDataUrl && obj.imageDataUrl.length > 0) {
    const datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
    const blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    const file = folder.createFile(blob);
    bankfileUrl = file.getUrl();
  }
  if(rowIndex > -1){
  sheet.getRange(rowIndex + 1, 4).setValue(bankfileUrl);
  }
  return sheet.getRange("A2:D" + sheet.getLastRow()).getValues();
};

const delDataSetBankCode = (record) => {
  const sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('BacnkCode');
  const data = sheet.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }
  if (rowIndex > -1) {
    sheet.deleteRow(rowIndex + 1);
  }
};

const saveSetStatus = (codeId, isActive, status) => {
  let sheet;
  let targetRow;

  if (status === 'statusTime') {
    sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetTime');
    targetRow = 4;
  } else if (status === 'statusLeave') {
    sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetLeave');
    targetRow = 4;
  } else if (status === 'statusOT') {
    sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetOT');
    targetRow = 3;
  } else if (status === 'statusSSO') {
    sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetSSO');
    targetRow = 3;
  } else if (status === 'statusWeekEnd') {
    sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName('SetWeekEnd');
    targetRow = 3;
  }
  
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === codeId) {
      sheet.getRange(i + 1, targetRow).setValue(isActive ? 'TRUE' : 'FALSE');
      break;
    }
  }
}

Gs/Register.gs = 
const getDataUsers = () => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users')
  const data = sheet.getDataRange().getDisplayValues().slice(1)
  //Logger.log(data)
  return data
}

const getUserLog = () => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('LogUsers');
  const data = sheet.getDataRange().getDisplayValues().slice(1);
  return data
}

const sendForgotPassword = (username) => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheet.getDataRange().getValues();
  const user = data.find(row => row[1] === username);
  if (user && user[1]) {
    const emailAddress = user[30];
    const subject = "คำขอลืมรหัสผ่าน";
    const body = `คำขอลืมรหัสผ่านจากผู้ใช้งาน:` +
                 `\n👨‍💻 Username: ${user[1]}` +
                 `\n🔐 Password: ${user[2]}`;
    const imgUrl = user[7];

    MailApp.sendEmail({
      to: emailAddress,
      subject: subject,
      htmlBody: `${body}<br><img src="${imgUrl}" alt="User Image">`,
      attachments: []
    });
  }
};

const setUserStatus = (userId, isActive) => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheet.getDataRange().getValues();
  const currentTime = new Date();
  const formattedDate = Utilities.formatDate(currentTime, Session.getScriptTimeZone(), 'dd/MM/yyyy');
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId) {
      sheet.getRange(i + 1, 11).setValue(isActive ? 'TRUE' : 'FALSE');
      sheet.getRange(i + 1, 34).setValue(formattedDate);
      break;
    }
  }
}

const generateIDMember = (currentIDNumber) => {
  var prefix = 'USER-';
  var paddingSize = 3;
  var number = currentIDNumber.toString();
  while (number.length < paddingSize) {
    number = '0' + number;
  }
  return prefix + number;
}

const saveUser = (obj) => {
  const sheetUsers = SpreadsheetApp.getActive().getSheetByName('Users');
  const lastRowID = sheetUsers.getLastRow();
  var codeUserIDMember = generateIDMember(lastRowID);
  var folder = DriveApp.getFolderById(idfolder);
  var profileUrl = "";

  if (obj.check !== "") {
    var datafile = Utilities.base64Decode(obj.imageDataUrlA.split(',')[1]);
    var blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    var file = folder.createFile(blob);
    var fileId = file.getId();
    profileUrl = "https://lh3.googleusercontent.com/d/" + fileId;
  } else {
    profileUrl = obj.profile;
  }
      
      sheetUsers.appendRow(["'" + codeUserIDMember,
                    "'"+obj.registerData5, 
                    "'"+obj.registerData6,
                    "'"+obj.registerData4,
                    "'"+obj.registerData1,  
                    "'"+obj.registerData2,
                    "'"+obj.registerData3, 
                    profileUrl,
                    "",
                    "",
                    true]);

  return sheetUsers.getRange("A2:G" + sheetUsers.getLastRow()).getValues();
}

const editUser = (obj) => {
  const sheetUsers = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheetUsers.getDataRange().getDisplayValues();
  const folder = DriveApp.getFolderById(idfolder);
  let profileUrl = obj.profile;
  let rowIndex = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.registerDataID) {
      rowIndex = i;
      break;
    }
  }

  if (obj.check !== "" && obj.imageDataUrlA.length > 0) {
    const datafile = Utilities.base64Decode(obj.imageDataUrlA.split(',')[1]);
    const blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    const file = folder.createFile(blob);
    const fileId = file.getId();
    profileUrl = "https://lh3.googleusercontent.com/d/" + fileId;
    const oldProfile = sheetUsers.getRange(rowIndex + 1, 8).getValue().split('/d/')[1];
    if (oldProfile) {
      DriveApp.getFileById(oldProfile).setTrashed(true);
    }
  }

  if (rowIndex > -1) {
    sheetUsers.getRange(rowIndex + 1, 1, 1, 8).setValues([
      [obj.registerDataID,  
        "'"+obj.registerData5, 
        "'"+obj.registerData6,
        "'"+obj.registerData4,
        "'"+obj.registerData1,  
        "'"+obj.registerData2,
        "'"+obj.registerData3, 
        profileUrl]
    ]);
  }

  return sheetUsers.getRange("A2:G" + sheetUsers.getLastRow()).getValues();
}

const delRecordU = (record) => {
  const sheetUsers = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheetUsers.getDataRange().getDisplayValues();
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === record) {
      rowIndex = i;
      break;
    }
  }

  if (rowIndex > -1) {
    const fileDlUser = sheetUsers.getRange(rowIndex + 1, 8).getValue();
    const sigDlUser = sheetUsers.getRange(rowIndex + 1, 10).getValue(); 

    if (fileDlUser.includes("https://lh3.googleusercontent.com/d/")) {
      const fileId = fileDlUser.split('/d/')[1];
      DriveApp.getFileById(fileId).setTrashed(true);
    }

    if (sigDlUser.includes("https://lh3.googleusercontent.com/d/")) {
      const fileId = sigDlUser.split('/d/')[1];
      DriveApp.getFileById(fileId).setTrashed(true);
    }

    sheetUsers.deleteRow(rowIndex + 1);
  }
}

const updateProfile = (obj) => {
  const sheetUsers = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Users");
  const data = sheetUsers.getDataRange().getValues();
  var folder = DriveApp.getFolderById(idfolder);
  var profileUrl = "";

  if (obj.check !== "") {
    var datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
    var blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    var file = folder.createFile(blob);
    var fileId = file.getId();
    profileUrl = "https://lh3.googleusercontent.com/d/" + fileId;

    for (let i = 1; i < data.length; i++) {
      const userValue = data[i][3];
      if (userValue === obj.codeName) {
        const oldprofileValue = data[i][7];
        if (oldprofileValue && oldprofileValue.startsWith("https://lh3.googleusercontent.com/d/") && oldprofileValue !== "https://lh3.googleusercontent.com/d/") {
          let oldprofile = oldprofileValue.split('/d/')[1];
          if (oldprofile) {
            DriveApp.getFileById(oldprofile).setTrashed(true);
          }
        }
        sheetUsers.getRange(i + 1, 8).setValue(profileUrl);
        break;
      }
    }
    return profileUrl;
  } else {
    profileUrl = obj.profileNew;
    return profileUrl;
  }
}

const saveUploadSig = (obj) => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Users");
  const data = sheet.getDataRange().getValues();
  var folderSig = DriveApp.getFolderById(idfolder);

  if (obj.signatureCanvas === "") {
    for (let i = 1; i < data.length; i++) {
      const userValue = data[i][3];
      if (userValue === obj.codeName) {
        const oldUrlSig = data[i][9];
        if (oldUrlSig) {
          const oldSig = oldUrlSig.split('/d/')[1];
          const oldFile = DriveApp.getFileById(oldSig);
          oldFile.setTrashed(true);
          sheet.getRange(i + 1, 10).setValue("");
          break;
        }
      }
    }
    return "";
  } else {
    var datafile2 = Utilities.base64Decode(obj.signatureCanvas.split(',')[1]);
    var blob2 = Utilities.newBlob(datafile2, obj.filetype, obj.filename);
    var fileSig = folderSig.createFile(blob2);
    var sig = fileSig.getId();
    var urlsig = "https://lh3.googleusercontent.com/d/" + sig;

    for (let i = 1; i < data.length; i++) {
      const userValue = data[i][3];
      if (userValue === obj.codeName) {
        const oldUrlSig = data[i][9];
        if (oldUrlSig) {
          const oldSig = oldUrlSig.split('/d/')[1];
          const oldFile = DriveApp.getFileById(oldSig);
          oldFile.setTrashed(true);
        }
        sheet.getRange(i + 1, 10).setValue(urlsig);
        break;
      }
    }
    return urlsig;
  }
}

const changePasswordMember = (obj) => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Users"); 
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    const userValue = data[i][3];
    if (userValue === obj.code) {
      sheet.getRange(i + 1, 3).setValue("'" + obj.password);
      break;
    }
  }
}

Gs/UserLogin.gs = 
function checkUsers(username, password, userIpAddress, userAgent){
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Users"); 
  const data = sheet.getDataRange().getValues();

  const browserInfo = userAgent.match(/(Chrome|Safari|Firefox|Edge|Opera)\/[\d.]+/);
  const osInfo = userAgent.match(/(Windows NT|Windows|Linux|Mac OS|iOS|Android) [\d.]+/);

  for (let i = 1; i < data.length; i++) { 
    if (data[i][1].toLowerCase() === username.toLowerCase() && data[i][2] === password) {
      if (data[i][10] === true) {
        let datauser = {
          uiduser: data[i][0],
          username: data[i][1],
          password: data[i][2],
          fullname: data[i][3],
          department: data[i][4],
          group: data[i][5],
          level: data[i][6],
          imgUser: data[i][7],
          tokenUser: data[i][8],
          sigUser: data[i][9],
          status: data[i][10],
        };

        const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("LogUsers"); 
        logSheet.appendRow(["'" + datauser.username, userIpAddress, browserInfo + " " + osInfo, new Date(), "เข้าสู่ระบบ"]);

        return datauser;
      } else {
        return '⚠️ ชื่อผู้ใช้งานนี้ถูกระงับการใช้งาน';
      }
    } 
  } 
  return '⚠️ ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง';
}

function checkLogoutUsers(username, userIpAddress, userAgent) {
  const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("LogUsers"); 
  const browserInfo = userAgent.match(/(Chrome|Safari|Firefox|Edge|Opera)\/[\d.]+/);
  const osInfo = userAgent.match(/(Windows NT|Windows|Linux|Mac OS|iOS|Android|iPhone) [\d.]+/);
  logSheet.appendRow(["'" + username, userIpAddress, browserInfo + " " + osInfo, new Date(), "ออกจากระบบ"]);
}

const formatDateStr = (dateStr) => {
  const date = new Date(dateStr); 
  date.setDate(date.getDate() + 3); 
  const day = ("0" + date.getDate()).slice(-2);
  const month = ("0" + (date.getMonth() + 1)).slice(-2);
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
};

const saveDataEmployee = (obj) => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheet.getDataRange().getDisplayValues();
  const folder = DriveApp.getFolderById(imageFolder);
  let profileUrl = obj.profile;
  let rowIndex = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === obj.empCode) {
      rowIndex = i;
      break;
    }
  }
  if (obj.check !== "" && obj.imageDataUrl && obj.imageDataUrl.length > 0) {
    const datafile = Utilities.base64Decode(obj.imageDataUrl.split(',')[1]);
    const blob = Utilities.newBlob(datafile, obj.filetype, obj.filename);
    const file = folder.createFile(blob);
    const fileId = file.getId();
    profileUrl = "https://lh3.googleusercontent.com/d/" + fileId;
    const oldProfile = sheet.getRange(rowIndex + 1, 8).getValue().split('/d/')[1];
    if (oldProfile) {
      DriveApp.getFileById(oldProfile).setTrashed(true);
    }
  }
  if(rowIndex > -1){
    sheet.getRange(rowIndex + 1, 4).setValue(obj.empData1); //ชื่อสกุล
    sheet.getRange(rowIndex + 1, 5).setValue(obj.empData2); //ตำแหน่ง
    sheet.getRange(rowIndex + 1, 6).setValue(obj.empData3); //แผนก
    sheet.getRange(rowIndex + 1, 8).setValue(profileUrl); //โปรไฟล์
    sheet.getRange(rowIndex + 1, 12).setValue(obj.empData16); //การจ้างงาน
    sheet.getRange(rowIndex + 1, 13).setValue("'"+ obj.empData9); //เลขประจำตัวประชาชน
    sheet.getRange(rowIndex + 1, 14).setValue("'"+ obj.empData10); //เลขประกันสังคม
    sheet.getRange(rowIndex + 1, 15).setValue(obj.empData4); //เพศ
    sheet.getRange(rowIndex + 1, 16).setValue(formatDateStr(obj.empData5)); //วันเกิด
    sheet.getRange(rowIndex + 1, 17).setValue(obj.empData6); //สัญชาติ
    sheet.getRange(rowIndex + 1, 18).setValue(obj.empData7); //สถานภาพ
    sheet.getRange(rowIndex + 1, 19).setValue(obj.empData8); //พิการ/ทุพพลภาพ
    sheet.getRange(rowIndex + 1, 20).setValue(formatDateStr(obj.empData17)); //เริ่มงาน
    sheet.getRange(rowIndex + 1, 21).setValue(obj.empData19); //ค่าจ้าง
    sheet.getRange(rowIndex + 1, 22).setValue(obj.empData18); //การจ่าย
    sheet.getRange(rowIndex + 1, 23).setValue(obj.empData20); //เงินพิเศษ
    sheet.getRange(rowIndex + 1, 24).setValue(obj.empData21); //การชำระ
    sheet.getRange(rowIndex + 1, 25).setValue(obj.empData22); //ธนาคาร
    sheet.getRange(rowIndex + 1, 26).setValue("'"+ obj.empData18); //เลขที่บัญชี
    sheet.getRange(rowIndex + 1, 27).setValue(obj.empData24); //ประเภทบัญชี
    sheet.getRange(rowIndex + 1, 28).setValue(obj.empData25); //สาขา
    sheet.getRange(rowIndex + 1, 29).setValue(obj.empData11); //สิทธิ์ประกันสังคม
    sheet.getRange(rowIndex + 1, 30).setValue("'"+ obj.empData12); //ที่อยู่
    sheet.getRange(rowIndex + 1, 31).setValue("'"+ obj.empData13); //Email
    sheet.getRange(rowIndex + 1, 32).setValue("'"+ obj.empData14); //Line
    sheet.getRange(rowIndex + 1, 33).setValue("'"+ obj.empData15); //Phone
  }
  return sheet.getRange("A2:AA" + sheet.getLastRow()).getValues();
}

function getLatestRoomID() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ChatRooms');
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    const lastRoomID = sheet.getRange(lastRow, 1).getValue(); 
    return lastRoomID;
  }
  return null; 
}

function saveChatRoom(newRoom) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("ChatRooms"); 
  sheet.appendRow(newRoom);
}

function saveMessage(newMessage) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Messages"); 
  sheet.appendRow(newMessage);
}

Gs/settingsystem.gs = 
const settingSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Setting');
const idfolder = settingSheet.getRange('B1').getDisplayValue();
const sigFolder = settingSheet.getRange('B2').getDisplayValue();
const imageFolder = settingSheet.getRange('B3').getDisplayValue();
const sheetData = settingSheet.getRange('B4').getDisplayValue();
const sheetDataSet = settingSheet.getRange('B5').getDisplayValue();
const clientId = settingSheet.getRange('B6').getDisplayValue();
const clientSecret = settingSheet.getRange('B7').getDisplayValue();
const redirectUri = settingSheet.getRange('B8').getDisplayValue();
const logoUrl = settingSheet.getRange('B9').getDisplayValue();
const nameSystem = settingSheet.getRange('B10').getDisplayValue();

const getSet = () => {
  var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Setting');
  var data = ss.getRange("B1:B").getDisplayValues();
  return data;
}

const getLineSet = () => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Setting');
  const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();

  const settings = {};

  data.forEach(row => {
    const key = row[0];
    const value = row[1];
    settings[key] = value;
  });

  return settings;
};

const settingGS = (data) => {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Setting');
  var valuesToSet = [];
  for (let i = 1; i <= 11; i++) {
    valuesToSet.push([data[`set${i}`]]);
  }
  var range = sheet.getRange(1, 2, valuesToSet.length, 1);
  range.setValues(valuesToSet);
}

const selectDataFromSheet = (sheetName) => {
  var sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName(sheetName);
  var getLastRow = sheet.getLastRow();
  var data = sheet.getRange(2, 2, getLastRow - 1, 1).getValues().flat();
  return data;
}

const selectDepartment = () => selectDataFromSheet("Department");
const selectGroup = () => selectDataFromSheet("Group");
const selectObjective = () => selectDataFromSheet("Objective");

const getTodos = (sheetName) => {
  var sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName(sheetName);
  var data = sheet.getRange('B2:B' + sheet.getLastRow()).getValues();
  return data.flat().filter(Boolean);
}

const saveTodos = (data) => {
  var sheet = SpreadsheetApp.openById(sheetDataSet).getSheetByName(data.sheetName);
  sheet.getRange(2, 2, sheet.getLastRow() - 1, 1).clearContent();
  data.todos.forEach((todo, index) => {
    sheet.getRange(index + 2, 2).setValue(todo);
  });
}

const getsetMenuItems = () => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("UsersMenu");
  const data = sheet.getDataRange().getDisplayValues().slice(1);
  return data;
}

const updateMenuStatus = (menuItem, role, isChecked) => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("UsersMenu");
  const data = sheet.getDataRange().getValues();
  const index = data.findIndex(row => row[1] === menuItem);
  if (index !== -1) {
    const roleColumn = role === 'SuperAdmin' ? 3 : role === 'Admin' ? 4 : role === 'SuperUser' ? 5 : 6;
    const range = sheet.getRange(index + 1, roleColumn);
    range.setValue(isChecked ? "TRUE" : "FALSE");
  }
}

const getMenuItems = () => {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("UsersMenu");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const menuItems = {};

  for (let i = 1; i < data.length; i++) {
    const item = data[i][1];
    menuItems[item] = {};
    for (let j = 2; j < headers.length; j++) { 
      const cellValue = String(data[i][j]).toUpperCase() || "FALSE"; 
      menuItems[item][headers[j]] = cellValue === "TRUE";
    }
  }
  return menuItems;
};

function shortenURL(longURL) {
  var apiUrl = "http://tinyurl.com/api-create.php?url=" + encodeURI(longURL);
  var response = UrlFetchApp.fetch(apiUrl);
  return response.getContentText();
}

function sendNotify(msg, tokens, imgUrl) {
    let payloadJson = {
        "message": msg
    };
    if (imgUrl) {
        payloadJson.imageThumbnail = imgUrl;
        payloadJson.imageFullsize = imgUrl;
    }
    let options = {
        "method": "post",
        "payload": payloadJson,
        "headers": {
            "Authorization": "Bearer " + tokens
        }
    };
    UrlFetchApp.fetch("https://notify-api.line.me/api/notify", options);
}

JS/JavaScript.html = 
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geodesy@2.1.0/leaflet-geodesy.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- SweetAlret -->
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.4/signature_pad.umd.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>

<!-- dataTables -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.0/dist/bootstrap-table.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table/dist/locale/bootstrap-table-th-TH.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>

<!-- CDN สำหรับ tree-multiselect -->
<script src="https://cdn.jsdelivr.net/npm/tree-multiselect@2.5.0/dist/jquery.tree-multiselect.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>

<!----- CDN สำหรับ MAPS LONGDO ------>
<script src="https://api.longdo.com/map/?key=e470536f836c3fb0c50bf65e80f2e4dc"></script>

<script>
var signaturePadUser = new SignaturePad(document.getElementById('signatureCanvas'));
var clearButtonA = document.getElementById('clearButtonA');
var colorPickerA = document.getElementById('colorPickerA');
var currentColorA = '#000000'; 
  clearButtonA.addEventListener('click', function () {
    signaturePadUser.clear();  
  });
  colorPickerA.addEventListener('input', function () {
    currentColorA = colorPickerA.value;
    signaturePadUser.penColor = currentColorA;
});

pdfMake.fonts = {
  THSarabunNew: {
    normal: 'https://sanwithz.github.io/font/THSarabunNew.ttf',
    bold: 'https://sanwithz.github.io/font/THSarabunNewBold.ttf',
    italics: 'https://sanwithz.github.io/font/THSarabunNewItalic.ttf',
  },

  Wingdings2: {
    normal: 'https://semicon.github.io/fonts/wingdings2.ttf'
  }
};

$(document).ready(function() {
  $('.sidebar').addClass('collapsed');
  $('.sidebar-dropdown-menu').slideUp('fast');

  $('.sidebar-menu-item.has-dropdown > a, .sidebar-dropdown-menu-item.has-dropdown > a').click(function(e) {
    e.preventDefault();
    $('.sidebar-dropdown-menu').css('overflow-y', 'hidden');
    if(!($(this).parent().hasClass('focused'))) {
      $(this).parent().parent().find('.sidebar-dropdown-menu').slideUp('fast');
      $(this).parent().parent().find('.has-dropdown').removeClass('focused');
    }
    $(this).next().slideToggle('fast');
    $(this).parent().toggleClass('focused');
  });

  $('.sidebar-menu-item > a, .sidebar-dropdown-menu-item > a').click(function(e) {
    if(!$(this).parent().hasClass('has-dropdown')) {
      $(this).closest('.sidebar-dropdown-menu').slideUp('fast');
      $(this).closest('.has-dropdown').removeClass('focused');
    }
  });

  $('.sidebar-toggle').click(function() {
    $('.sidebar').toggleClass('collapsed');

    $('.sidebar.collapsed').mouseleave(function() {
      $('.sidebar-dropdown-menu').slideUp('fast');
      $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
    });
  });

  $('.sidebar-overlay').click(function() {
    $('.sidebar').addClass('collapsed');
    $('.sidebar-dropdown-menu').slideUp('fast');
    $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
  });

  if(window.innerWidth < 768) {
    $('.sidebar').addClass('collapsed');
  }
});

$(document).ready(function() {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  if (isLoggedIn === 'true') {
    loadDataAfterLogin();
  } else {
    $("#pageformLogin").show();
    $("#dashboardPage").hide();
  }
});

function loadDataAfterLogin() {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  if (isLoggedIn !== 'true') {
    $("#pageformLogin").show();
    $("#dashboardPage").hide();
    return;
  }

  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  Promise.all([
    fetchUseAllData(),
    fetchAllData(),
    allDropdown()
  ]).then(() => {
    insertChartLev();
    loadLeaveTypes();
    $.LoadingOverlay("hide");
  }).catch(error => {
    console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลทั้งหมด:", error);
    $.LoadingOverlay("hide");
  });
}

const openimageModal = (imageSrc) => {
  const modalImage = document.getElementById('imageModalSrc');
  modalImage.src = imageSrc;
  $('#imageModal').modal('show');
}

document.addEventListener('DOMContentLoaded', () => {
  google.script.run.withSuccessHandler(data => {
    data.forEach((value, index) => {
      $(`#setData${index + 1}`).val(value);
    });
      $("#logoSystem").attr("src", data[8]);
      $("#textSystem").text(data[10]);
      $("#nameSystem").text(data[9]);
      $("#logoLogin").attr("src", data[8]);
      $("#textLogin").text(data[9]);
      $("#logoChat").attr("src", data[8]);
      $("#textChat").text(data[9]);
  }).getSet();
});

const addSetting = () => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  let data = {};
  for (let i = 1; i <= 11; i++) {
    data[`set${i}`] = document.getElementById(`setData${i}`).value;
  }
  google.script.run.withSuccessHandler(response => {
    $("#xModalsetting").click();
    google.script.run.withSuccessHandler(data => {
      $("#logoSystem").attr("src", data[8]);
      $("#textSystem").text(data[10]);
      $("#nameSystem").text(data[9]);
      $("#logoLogin").attr("src", data[8]);
      $("#textLogin").text(data[9]);
      $("#logoChat").attr("src", data[8]);
      $("#textChat").text(data[9]);
    }).getSet();
    $.LoadingOverlay("hide");
    createToast("🛠️ บันทึกการตั้งค่าสำเร็จ", 1);
  }).settingGS(data);
}

const setDisPlayMenu = (status, menuItems) => {
  const allMenuItems = Object.keys(menuItems);
  allMenuItems.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.style.display = "none";
    }
  });
  for (const item in menuItems) {
    if (menuItems[item][status]) {
      const element = document.getElementById(item);
      if (element) {
        element.style.display = "block";
      }
    }
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  if (isLoggedIn !== 'true') {
    localStorage.removeItem('uiduser');
    localStorage.removeItem('username');
    localStorage.removeItem('password');
    localStorage.removeItem('fullname');
    localStorage.removeItem('department');
    localStorage.removeItem('group');
    localStorage.removeItem('level');
    localStorage.removeItem('imgUser');
    localStorage.removeItem('tokenUser');
    localStorage.removeItem('sigUser');
    localStorage.removeItem('status');
    localStorage.removeItem('isLoggedIn');
  } else {
    let datauser = {
    uiduser: localStorage.getItem('uiduser'),
    username: localStorage.getItem('username'),
    password: localStorage.getItem('password'),
    fullname: localStorage.getItem('fullname'),
    department: localStorage.getItem('department'),
    group: localStorage.getItem('group'),
    level: localStorage.getItem('level'),
    imgUser: localStorage.getItem('imgUser'),
    tokenUser: localStorage.getItem('tokenUser'),
    sigUser: localStorage.getItem('sigUser'),
    status: localStorage.getItem('status')
    };
    google.script.run.withSuccessHandler(function(menuItems) {
      setDisPlayMenu(datauser.level, menuItems);
    }).getMenuItems();
    loadDataAfterLogin();
    loginUserSuc(datauser);
  }
  const storedUsername = localStorage.getItem("usernameSave");
  const storedPassword = localStorage.getItem("passwordSave");
  const storedChecked = localStorage.getItem("checked");

  if (storedUsername) {
    document.getElementById("loginusername").value = storedUsername;
  }
  if (storedPassword) {
    document.getElementById("loginpassword").value = storedPassword;
  }
  if (storedChecked === "checked") {
    document.getElementById("rememberMe").checked = true;
  }
});

const generateDeviceId = () => {
  const deviceId = `device-${Math.random().toString(36).substr(2, 9)}`;
  localStorage.setItem('deviceId', deviceId);
  return deviceId;
};

const getIPAddress = async () => {
  const ipAPI = "//api.ipify.org?format=json";
  const response = await fetch(ipAPI); 
  const data = await response.json(); 
  return data.ip;
}

const loginUsers = async () => {
  event.preventDefault();
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  const usernameCheck = $("#loginusername").val();
  const passwordCheck = $("#loginpassword").val();
  const rememberMe = document.getElementById("rememberMe");
  const ipCheck = await getIPAddress();
  const userAgent = navigator.userAgent;
  google.script.run.withSuccessHandler(function(datauser) {
    if (typeof datauser === 'object' && datauser !== null) {
      createToast("🔓 เข้าสู่ระบบสำเร็จ " + datauser.fullname, 1);
      localStorage.setItem('uiduser', datauser.uiduser);
      localStorage.setItem('username', datauser.username);
      localStorage.setItem('password', datauser.password);
      localStorage.setItem('fullname', datauser.fullname);
      localStorage.setItem('department', datauser.department);
      localStorage.setItem('group', datauser.group);
      localStorage.setItem('level', datauser.level);
      localStorage.setItem('imgUser', datauser.imgUser);
      localStorage.setItem('tokenUser', datauser.tokenUser);
      localStorage.setItem('sigUser', datauser.sigUser);
      localStorage.setItem('status', datauser.status);
      localStorage.setItem('isLoggedIn', 'true'); 
      if (rememberMe.checked) {
        localStorage.setItem('usernameSave', usernameCheck);
        localStorage.setItem('passwordSave', passwordCheck);
        localStorage.setItem('checked', 'checked');
      } else {
        localStorage.removeItem('usernameSave');
        localStorage.removeItem('passwordSave');
        localStorage.removeItem('checked'); 
      }
      loadDataAfterLogin();
      loginUserSuc(datauser);
      google.script.run.withSuccessHandler(function(menuItems) {
        setDisPlayMenu(datauser.level, menuItems);
      }).getMenuItems(); 
    } else {
      $.LoadingOverlay("hide");
      createToast("❌ ไม่พบข้อมูลผู้ใช้งาน กรุณาตรวจสอบอีกครั้ง", 3);
      $("#pageformLogin").show();
      $("#dashboardPage").hide();
    }
  }).checkUsers(usernameCheck, passwordCheck, ipCheck, userAgent);
}

const loginUserSuc = (datauser) => {
  $.LoadingOverlay("hide");
  $("#pageformLogin").hide();
  $("#dashboardPage").show();
  $('#user-show0').html(datauser.uiduser);
  $('#user-show1').html(datauser.fullname);
  $('#user-show2').html(datauser.department);
  $('#user-show3').html(datauser.level);
  $('#user-show4').html(datauser.sigUser);
  $('#user-show5').html(datauser.group);
  $('#picadmin1').attr('src', datauser.imgUser);
  $('#picadmin2').attr('src', datauser.imgUser);
  $('#picadmin3').attr('src', datauser.sigUser);
  $('#regictorNewPreview').attr('src', datauser.imgUser);
  leaveUserUID = datauser.uiduser;
  getDataLocation();
  reviewdivprofile();
  reviewdivBankCode();
}

const logoutUsers = async () => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  if (localStorage.getItem('isLoggedIn') === 'true') {
    const usernameGeneral = localStorage.getItem('username');
    const ipCheck = await getIPAddress();
    const userAgent = navigator.userAgent;
    google.script.run.withSuccessHandler(function() {
      $.LoadingOverlay("hide");
      const usernameSave = localStorage.getItem('usernameSave');
      const passwordSave = localStorage.getItem('passwordSave');
      const checkedSave = localStorage.getItem('checked');
      localStorage.removeItem('uiduser');
      localStorage.removeItem('username');
      localStorage.removeItem('password');
      localStorage.removeItem('fullname');
      localStorage.removeItem('department');
      localStorage.removeItem('group');
      localStorage.removeItem('level');
      localStorage.removeItem('imgUser');
      localStorage.removeItem('tokenUser');
      localStorage.removeItem('sigUser');
      localStorage.removeItem('status');
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('currentPage');
      if (checkedSave === "checked") {
        localStorage.setItem('usernameSave', usernameSave);
        localStorage.setItem('passwordSave', passwordSave);
        localStorage.setItem('checked', checkedSave);
      }
      changePage(1);
      $('#picadmin1').attr('src', "");
      $('#picadmin2').attr('src', "");
      $('#picadmin3').attr('src', "");
      $("#dashboardPage").hide();
      $('#pageformLogin').show();
      createToast("🔓 ออกจากระบบสำเร็จ", 1);
    }).checkLogoutUsers(usernameGeneral, ipCheck, userAgent);
  } else {
    $.LoadingOverlay("hide");
    createToast("❌ ไม่สามารถออกจากระบบได้", 0);
  }
}

$(document).ready(() => {
  updateAllDropdowns();
});

const updateAllDropdowns = () => {
  const dropdownsConfig = [
    { functionName: 'selectDepartment', selectIds: ['registerData1','searchUsers2','empData2'] },
    { functionName: 'selectGroup', selectIds: ['registerData2','empData3'] },
    { functionName: 'selectObjective', selectIds: ['approveDataLeave','approveDataRequest'] }
  ];

  dropdownsConfig.forEach(config => {
    updateDropdowns(config.functionName, config.selectIds);
  });
}

const updateDropdowns = (functionName, selectIds) => {
  google.script.run.withSuccessHandler((options) => {
    populateSelectElements(selectIds, options);
  })[functionName]();
}

const populateSelectElements = (selectIds, options) => {
  selectIds.forEach(selectId => {
    let selectElement = document.getElementById(selectId);
    if (selectElement) {
      selectElement.innerHTML = '';

      let defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.text = "กรุณาเลือกรายการ";
      defaultOption.selected = true;
      selectElement.appendChild(defaultOption);

      options.forEach(optionText => {
        let option = document.createElement("option");
        option.value = optionText;
        option.text = optionText;
        selectElement.appendChild(option);
      });
    }
  });
}

const saveTodosSet = () => {
  $.LoadingOverlay("show", {image: "", fontawesome: "fa fa-spinner fa-spin"});
    google.script.run.withSuccessHandler(() => {
    $.LoadingOverlay("hide");
    createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
    $('#todoInput').val("");
    $('#ModalDataSetting').modal('show');
      loadTodos(currentSheet);
      updateAllDropdowns();
  }).saveTodos({todos: todoList, sheetName: currentSheet});
}

$('#newsDBData2').summernote({
  placeholder: 'รายละเอียด',
  tabsize: 1,
  height: 200,
  fontNames: ['Prompt', 'Kanit', 'Sarabun', 'Itim', 'Mitr', 'TH SarabunPSK'],
  fontNamesIgnoreCheck: ['Prompt'],
  toolbar: [
    ['style', ['style']],
    ['font', ['bold', 'italic', 'underline', 'clear']],
    ['fontsize', ['fontsize', 'fontname']],
    ['para', ['ul', 'ol', 'paragraph', 'hr']],
    ['table', ['table']],
    ['insert', ['link']],
    ['view', ['fullscreen', 'codeview', 'help']]
  ]
});

const changePage = (data) => {
  let pageName = "";
  switch(data) {
    case 1:
      pageName = "หน้าหลักของระบบ";
      break;
    case 2:
      pageName = "ข้อมูลการลาพนักงาน";
      break;
    case 3:
      pageName = "ข้อมูลการขอหนังสือรับรอง";
      break;
    case 4:
      pageName = "จัดการเงินเดือน";
      break;
    case 5:
      pageName = "นำส่งเงินเดือน";
      break;
    case 6:
      pageName = "จัดการข้อมูลพนักงาน";
      break;
    case 7:
      pageName = "จัดการข้อมูลข่าวสาร";
      break;
    case 8:
      pageName = "รายงานการปฏิบัติงาน";
      break;
    case 9:
      pageName = "รายงานการลางาน";
      break;
    case 10:
      pageName = "ประวัติการเข้าใช้งาน";
       break;
    case 11:
      pageName = "ตารางข้อมูลผู้ใช้งาน";
       break;
    case 12:
      pageName = "ตั้งค่าการใช้งานระบบ";
      break;
    case 13:
      pageName = "ตั้งค่าการทำงานระบบ";
      break;
  }
  localStorage.setItem('currentPage', data);
  for (let i = 1; i <= 13; i++) {
    $("#page" + i).toggle(i === data);
  }
  createToast(`✅ คุณกำลังใช้งาน ${pageName}`, 2);
  if (data === 1) {
    getDataLocation();
  }
}

const savedPage = localStorage.getItem('currentPage');
if (savedPage) {
  changePage(parseInt(savedPage));
} else {
  changePage(1);
}

const closeWindow = () => {
  window.close();
}

let leaveUserUID = null;
let alltimeAttendance = [];
let allleave = [];
let allCalendarLev = [];
let allRequest = null;
let allSummary = null;
let allDataNewsDB = null;
let allLocations = [];
let allsetTime = [];
let allsetLeave = [];
let allsetSalary = [];
let allSetOT = [];
let allSetSSO = [];
let allBacnkCode = [];
let allSetDayOff = [];
let allSetWeekEnd = [];
let dataUsers = null;
let dataRecUsers = null;
let setDataMenu = null;
let previousAllData = null;
let previousAllLeave = null;
let previousAllRequest = null;
let previousAllSummary = null;

const sheetSetting = '1SxF5vcTyx4JwRt1RtR0RPXgmlF9cyq-PnViKBRGeDtM';
const sheetData = '1QZlRGf6YKE0t51XpwQeBc7bmQfWqNSvWmZQUzdYrkSs';
const sheetWebApp = '13h_dTCTMhhU29dZM6M6kTmRIbnIoKwL3lPZmkKw_kT8';
const apikey = 'AIzaSyBYGTOj0zSU2DYu2gnJMOUHeZx-XvsklEo';

function fetchDataFromAPI(sheetId, sheetName) {
  const apiUrl = "https://sheets.googleapis.com/v4/spreadsheets/" + sheetId + "/values/" + sheetName + "?alt=json&key=" + apikey;
  return fetch(apiUrl)
    .then(response => response.json())
    .then(data => data.values.slice(1))
    .catch(error => {
      createToast(`❌ เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`, 0);
      return [];
    });
}

function dataHasChanged(newData, oldData) {
  if (!oldData || newData.length !== oldData.length) return true
  for (let i = 0; i < newData.length; i++) {
    if (JSON.stringify(newData[i]) !== JSON.stringify(oldData[i])) {
      return true;
    }
  }
  return false;
}

const fetchAllData = async () => {
  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

  try {
    const [locations, setTime, setLeave, setSalary, setOT, setSSO, bacnkCode, setDayOff, setWeekEnd, timeAttendance, leave, request, summary, newsdb] = await Promise.all([
      delay(100).then(() => fetchDataFromAPI(sheetSetting, 'Locations')),
      delay(200).then(() => fetchDataFromAPI(sheetSetting, 'SetTime')),
      delay(300).then(() => fetchDataFromAPI(sheetSetting, 'SetLeave')),
      delay(400).then(() => fetchDataFromAPI(sheetSetting, 'SetSalary')),
      delay(500).then(() => fetchDataFromAPI(sheetSetting, 'SetOT')),
      delay(600).then(() => fetchDataFromAPI(sheetSetting, 'SetSSO')),
      delay(700).then(() => fetchDataFromAPI(sheetSetting, 'BacnkCode')),
      delay(800).then(() => fetchDataFromAPI(sheetSetting, 'SetDayOff')),
      delay(900).then(() => fetchDataFromAPI(sheetSetting, 'SetWeekEnd')),
      delay(1000).then(() => fetchDataFromAPI(sheetData, 'TimeAttendance')),
      delay(1200).then(() => fetchDataFromAPI(sheetData, 'Leave')),
      delay(1400).then(() => fetchDataFromAPI(sheetData, 'Request')),
      delay(1600).then(() => fetchDataFromAPI(sheetData, 'Summary')),
      delay(1800).then(() => fetchDataFromAPI(sheetData, 'NewsDB'))
    ]);

    allLocations = locations;
    allsetTime = setTime;
    allsetLeave = setLeave;
    allsetSalary = setSalary;
    allSetOT = setOT;
    allSetSSO = setSSO;
    allBacnkCode = bacnkCode;
    allSetDayOff = setDayOff;
    allSetWeekEnd = setWeekEnd;
    alltimeAttendance = timeAttendance;
    allCalendarLev = leave;
    loadCheckinStatus();
    loadLeaveTypes();
    updateCalendarLev();
    insertChartLev();
    loadShiftTimes();
    updateCountsCheckIN();

    await checkAndUpdateDataSetLocations(locations);
    await checkAndUpdateDataSetTime(setTime);
    await checkAndUpdateDataSetLeave(setLeave);
    await checkAndUpdateDataSetSalary(setSalary);
    await checkAndUpdateDataSetOT(setOT);
    await checkAndUpdateDataSetSSO(setSSO);
    await checkAndUpdateDataSetBacnkCode(bacnkCode);
    await checkAndUpdateDataSetDayOff(setDayOff);
    await checkAndUpdateDataSetWeekEnd(setWeekEnd);
    await checkAndUpdateDataLeave(leave);
    await checkAndUpdateDataRequest(request);
    await checkAndUpdateDataSummary(summary);
    await checkAndUpdateDataNewsDB(newsdb);

    return true;
  } catch (error) {
    console.error("เกิดข้อผิดพลาดในการดึงข้อมูล", error);
    createToast(`❌ เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`, 0);
  }
};

const updateSpecificSetLocationsData = async () => {
  const newSetLocationsData = await fetchDataFromAPI(sheetSetting, 'Locations');
  await checkAndUpdateDataSetLocations(newSetLocationsData);
};

async function checkAndUpdateDataSetLocations(newSetLocationsData) {
  if (dataHasChanged(newSetLocationsData, previousAllData)) {
    previousAllData = [...newSetLocationsData];
    allLocations = newSetLocationsData;
    await updateDataSetLocations();
  }
}

const updateSpecificSetTimeData = async () => {
  const newSetTimeData = await fetchDataFromAPI(sheetSetting, 'SetTime');
  await checkAndUpdateDataSetTime(newSetTimeData);
};

async function checkAndUpdateDataSetTime(newSetTimeData) {
  if (dataHasChanged(newSetTimeData, previousAllData)) {
    previousAllData = [...newSetTimeData];
    allsetTime = newSetTimeData;
    await updateDataSetTime();
  }
}

const updateSpecificSetLeaveData = async () => {
  const newSetLeaveData = await fetchDataFromAPI(sheetSetting, 'SetLeave');
  await checkAndUpdateDataSetLeave(newSetLeaveData);
};

async function checkAndUpdateDataSetLeave(newSetLeaveData) {
  if (dataHasChanged(newSetLeaveData, previousAllData)) {
    previousAllData = [...newSetLeaveData];
    allsetLeave = newSetLeaveData;
    await updateDataSetLeave();
  }
}

const updateSpecificSetOTData = async () => {
  const newSetOTData = await fetchDataFromAPI(sheetSetting, 'SetOT');
  await checkAndUpdateDataSetOT(newSetOTData);
};

async function checkAndUpdateDataSetOT(newSetOTData) {
  if (dataHasChanged(newSetOTData, previousAllData)) {
    previousAllData = [...newSetOTData];
    allSetOT = newSetOTData;
    await updateDataSetOT();
  }
}

const updateSpecificSetSSOData = async () => {
  const newSetSSOData = await fetchDataFromAPI(sheetSetting, 'SetSSO');
  await checkAndUpdateDataSetSSO(newSetSSOData);
};

async function checkAndUpdateDataSetSSO(newSetSSOData) {
  if (dataHasChanged(newSetSSOData, previousAllData)) {
    previousAllData = [...newSetSSOData];
    allSetSSO = newSetSSOData;
    await updateDataSetSSO();
  }
}

const updateSpecificSetDayOffData = async () => {
  const newSetDayOffData = await fetchDataFromAPI(sheetSetting, 'SetDayOff');
  await checkAndUpdateDataSetDayOff(newSetDayOffData);
};

async function checkAndUpdateDataSetDayOff(newSetDayOffData) {
  if (dataHasChanged(newSetDayOffData, previousAllData)) {
    previousAllData = [...newSetDayOffData];
    allSetDayOff = newSetDayOffData;
    await updateDataSetDayOff();
  }
}

const updateSpecificSetWeekEndData = async () => {
  const newSetWeekEndData = await fetchDataFromAPI(sheetSetting, 'SetWeekEnd');
  await checkAndUpdateDataSetWeekEnd(newSetWeekEndData);
};

async function checkAndUpdateDataSetWeekEnd(newSetWeekEndData) {
  if (dataHasChanged(newSetWeekEndData, previousAllData)) {
    previousAllData = [...newSetWeekEndData];
    allSetWeekEnd = newSetWeekEndData;
    await updateDataSetWeekEnd();
  }
}

const updateSpecificSetSalaryData = async () => {
  const newSetSalaryData = await fetchDataFromAPI(sheetSetting, 'SetSalary');
  await checkAndUpdateDataSetSalary(newSetSalaryData);
};

async function checkAndUpdateDataSetSalary(newSetSalaryData) {
  if (dataHasChanged(newSetSalaryData, previousAllData)) {
    previousAllData = [...newSetSalaryData];
    allsetSalary = newSetSalaryData;
    await updateDataSetSalary();
  }
}

const updateSpecificSetBacnkCodeData = async () => {
  const newSetBacnkCodeData = await fetchDataFromAPI(sheetSetting, 'BacnkCode');
  await checkAndUpdateDataSetBacnkCode(newSetBacnkCodeData);
};

async function checkAndUpdateDataSetBacnkCode(newSetBacnkCodeData) {
  if (dataHasChanged(newSetBacnkCodeData, previousAllData)) {
    previousAllData = [...newSetBacnkCodeData];
    allBacnkCode = newSetBacnkCodeData;
    await updateDataSetBacnkCode();
  }
}

const updateSpecificSetTimeAttendanceData = async () => {
  const newTimeAttendanceData = await fetchDataFromAPI(sheetData, 'TimeAttendance');
  await checkAndUpdateDataTimeAttendance(newTimeAttendanceData);
};

async function checkAndUpdateDataTimeAttendance(newTimeAttendanceData) {
  if (dataHasChanged(newTimeAttendanceData, previousAllData)) {
    previousAllData = [...newTimeAttendanceData];
    alltimeAttendance = newTimeAttendanceData;
  }
}

const updateSpecificLeaveData = async () => {
  const newLeaveData = await fetchDataFromAPI(sheetData, 'Leave');
  await checkAndUpdateDataLeave(newLeaveData);
};

async function checkAndUpdateDataLeave(newLeaveData) {
  if (dataHasChanged(newLeaveData, previousAllLeave)) {
    previousAllLeave = [...newLeaveData];
    allleave = newLeaveData;
    await updateDataLeave();
  }
}

const updateSpecificRequestData = async () => {
  const newRequestData = await fetchDataFromAPI(sheetData, 'Request');
  await checkAndUpdateDataRequest(newRequestData);
};

async function checkAndUpdateDataRequest(newRequestData) {
  if (dataHasChanged(newRequestData, previousAllRequest)) {
    previousAllRequest = [...newRequestData];
    allRequest = newRequestData;
    await updateDataRequest();
  }
}

const updateSpecificSummaryData = async () => {
  const newSummaryData = await fetchDataFromAPI(sheetData, 'Summary');
  await checkAndUpdateDataSummary(newSummaryData);
};

async function checkAndUpdateDataSummary(newSummaryData) {
  if (dataHasChanged(newSummaryData, previousAllSummary)) {
    previousAllSummary = [...newSummaryData];
    allSummary = newSummaryData;
    await updateDataSummary();
  }
}

const updateSpecificNewsDBData = async () => {
  const newDataNewsDB = await fetchDataFromAPI(sheetData, 'NewsDB');
  await checkAndUpdateDataNewsDB(newDataNewsDB);
};

async function checkAndUpdateDataNewsDB(newDataNewsDB) {
  if (dataHasChanged(newDataNewsDB, previousAllData)) {
    previousAllData = [...newDataNewsDB];
    allDataNewsDB = newDataNewsDB;
    await updateNewsDBTable();
  }
}

async function updateDataLeave() {
  renderDataLeave(allleave);
  renderPageDataLeave(allleave.length);
  updateCountsLeave(allleave);
}

async function updateDataRequest() {
  renderDataRequest(allRequest);
  renderPageDataRequest(allRequest.length);
  updateCountsRequest(allRequest);
}

async function updateDataSummary() {
  renderSummary(allSummary);
  renderPageSummary(allSummary.length);
  updateCountsSalary(allSummary);
  insertChartSalary(allSummary);
}

async function updateNewsDBTable() {
  renderAllDataNewsDB(allDataNewsDB);
  renderPageAllDataNewsDB(allDataNewsDB.length);
  filteredAllDataNewsDB = allDataNewsDB;
  renderAllAnnouncements(allDataNewsDB);
}

async function updateDataSetLocations() {
  renderAllDataSetLocations(allLocations);
}

async function updateDataSetTime() {
  renderAllDataSetTime(allsetTime);
}

async function updateDataSetLeave() {
  renderAllDataSetLeave(allsetLeave);
}

async function updateDataSetOT() {
  renderAllDataSetOT(allSetOT);
}

async function updateDataSetSSO() {
  renderAllDataSetSSO(allSetSSO);
}

async function updateDataSetDayOff() {
  renderAllDataSetDayOff(allSetDayOff);
}

async function updateDataSetWeekEnd() {
  renderAllDataSetWeekEnd(allSetWeekEnd);
}

async function updateDataSetSalary() {
  renderAllDataSetSalary(allsetSalary);
}

async function updateDataSetBacnkCode() {
  renderAllDataSetBacnkCode(allBacnkCode);
}

const fetchUseAllData = async () => {
  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

  try {
    const [usersData, usersDataSet, usersRecData] = await Promise.all([
      delay(200).then(() => fetchDataFromAPI(sheetWebApp, 'Users')),
      delay(400).then(() => fetchDataFromAPI(sheetWebApp, 'UsersMenu')),
      delay(600).then(() => fetchDataFromAPI(sheetWebApp, 'LogUsers'))
    ]);

    await checkAndUpdateDataUsers(usersData);
    await checkAndUpdateDataMenu(usersDataSet);
    await checkAndUpdateDataRecUsers(usersRecData);

    return true;
  } catch (error) {
    createToast(`❌ เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`, 0);
  }
};

const updateSpecificDataUsers = async () => {
  const newDataUsers = await fetchDataFromAPI(sheetWebApp, 'Users');
  await checkAndUpdateDataUsers(newDataUsers);
};

async function checkAndUpdateDataUsers(newDataUsers) {
  if (dataHasChanged(newDataUsers, previousAllData)) {
    previousAllData = [...newDataUsers];
    dataUsers = newDataUsers;
    await updateUsersTable();
  }
}

const updateSpecificDataMenu = async () => {
  const newDataMenu = await fetchDataFromAPI(sheetWebApp, 'UsersMenu');
  await checkAndUpdateDataMenu(newDataMenu);
};

async function checkAndUpdateDataMenu(newDataMenu) {
  if (dataHasChanged(newDataMenu, previousAllData)) {
    previousAllData = [...newDataMenu];
    setDataMenu = newDataMenu;
    await updateMenuTable();
  }
}

const updateSpecificDataRecUsers = async () => {
  const newDataRecUsers = await fetchDataFromAPI(sheetWebApp, 'LogUsers');
  await checkAndUpdateDataRecUsers(newDataRecUsers);
};

async function checkAndUpdateDataRecUsers(newDataRecUsers) {
  if (dataHasChanged(newDataRecUsers, previousAllData)) {
    previousAllData = [...newDataRecUsers];
    dataRecUsers = newDataRecUsers;
    await updateRecUsersTable();
  }
}

async function updateUsersTable() {
  renderUsers(dataUsers);
  renderPageUsers(dataUsers.length);
  filteredUsers = dataUsers;
  updateCountsUsers(dataUsers);
  renderEmployee(dataUsers);
  filteredEmployee = dataUsers;
  showUserSelectListAT(dataUsers);
  showUserSelectListLev(dataUsers);
}

async function updateMenuTable() {
  renderMenuCars(setDataMenu);
}

async function updateRecUsersTable() {
  renderRecUsers(dataRecUsers);
  renderPageRecUsers(dataRecUsers.length);
  filteredRecUsers = dataRecUsers;
}

const allDropdown = () => {
  fetchDataFromAPI(sheetSetting, 'Setsalary').then(salaryData => {
    const selectPeriod = document.getElementById('selectPeriod');
    selectPeriod.innerHTML = '<option value="">เลือกงวดเงินเดือน</option>';
    salaryData.forEach(period => {
      const option = document.createElement('option');
      option.value = period[0];
      option.text = `งวดที่ ${period[3]} (${period[1]} - ${period[2]})`;
      selectPeriod.appendChild(option);
    });
  }).catch(error => {
    console.error("เกิดข้อผิดพลาดในการดึงข้อมูลงวดเงินเดือน:", error);
  });
}

const openLevSelectModal = () => { 
  $('#levSelectModal').modal('show');

  const levSelectList = $('#levSelectList');
  levSelectList.empty();

  allsetLeave.forEach(rowIndex => {
    if (rowIndex[3] === 'TRUE') {
    let imgLeaveTypes = '';
    switch (rowIndex[1]) {
      case 'ลาป่วยมีใบรับรองแพทย์':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/bed-leave.png';
        break;
      case 'ลาป่วยไม่มีใบรับรองแพทย์':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/fever-leave.png';
        break;
      case 'ลากิจจำเป็น':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/leave.png';
        break;
      case 'ลากิจทั่วไป':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/training-leave.png';
        break;
      case 'ลาพักร้อน':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/beach-chair-leave.png';
        break;
      case 'ลาบวช':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/monk-leave.png';
        break;
      case 'ลาคลอด':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/mother-leave.png';
        break;
      case 'ลารับราชการทหาร':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/soldier-leave.png';
        break;
      default:
        imgLeaveTypes = 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';
    }
    const leaveItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leavelist-item" style="background-color: #f8f9fa; cursor: pointer;" onclick="selectLeave('${rowIndex[1]}')">
        <div class="d-flex align-items-center">
          <img src="${imgLeaveTypes}" alt="${rowIndex[0]}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${rowIndex[1]}</strong>
            <br>
            <small class="text-muted">จำนวนสูงสุด ${rowIndex[2]} วัน</small>
          </div>
        </div>
      </div>
      `;
      levSelectList.append(leaveItem);
    }
  });
};

const selectLeave = (leaveTypeLabel) => {
  document.getElementById('leaveData1').value = leaveTypeLabel;
  document.getElementById('leaveData7').style.display = (leaveTypeLabel === 'ลาป่วยมีใบรับรองแพทย์') ? 'block' : 'none';
  document.getElementById('leaveData7Row').style.display = (leaveTypeLabel === 'ลาป่วยมีใบรับรองแพทย์') ? 'block' : 'none';

  createToast(`✅ เลือกรายการ (${leaveTypeLabel})`, 2);

  $('#levSelectModal').modal('hide');
  $('#RPTLModal').modal('show');
};

$('#RPTLModal').on('shown.bs.modal', () => {
  setMinDateLeave();

  const leaveData3 = document.getElementById('leaveData3');
  const leaveData4 = document.getElementById('leaveData4');

  if (leaveData3) {
    leaveData3.addEventListener('change', () => {
      const fullDaySwitch = document.getElementById('fullDaySwitch');
      const morningHalfDaySwitch = document.getElementById('morningHalfDaySwitch');
      const afternoonHalfDaySwitch = document.getElementById('afternoonHalfDaySwitch');
      if (fullDaySwitch?.checked) {
        toggleFullDayLeave();
      } else if (morningHalfDaySwitch?.checked) {
        toggleMorningHalfDayLeave();
      } else if (afternoonHalfDaySwitch?.checked) {
        toggleAfternoonHalfDayLeave();
      }
    });

    document.getElementById('leaveData3')?.addEventListener('change', handleLeaveStartDateChange);
    document.getElementById('leaveData3')?.addEventListener('change', calculateLeave);
    document.getElementById('leaveData4')?.addEventListener('change', calculateLeave);

  }
});

let selectedBankCode = null;
const openBankSelectModal = () => { 
  $('#bankSelectModal').modal('show');

  const bankSelectList = $('#bankSelectList');
  bankSelectList.empty();

  allBacnkCode.forEach(bank => {
    const bankNameTH = bank[1];
    const bankNameEN = bank[2];
    const bankID = bank[0];
    const bankImage = bank[3];
    const bankItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leavelist-item" style="background-color: #f8f9fa; cursor: pointer;" onclick="selectBank('${bankID}')" data-bank-id="${bankID}">
        <div class="d-flex align-items-center">
          <img src="${bankImage}" alt="${bankID}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${bankNameTH}</strong>
            <br>
            <small class="text-muted">${bankNameEN}</small>
          </div>
        </div>
      </div>
    `;
    bankSelectList.append(bankItem);
  });
};

const selectBank = (bankCode) => {
  selectedBankCode = bankCode;
  document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));
  const selectedItem = document.querySelector(`[data-bank-id="${bankCode}"]`);
  if (selectedItem) {
    selectedItem.classList.add('selected');
  }
  createToast(`✅ เลือกธนาคาร (${bankCode}) เรียบร้อย`, 2);
};

const applyBankSelection = () => {
  if (selectedBankCode) {
    $('#bankSelectModal').modal('hide');
    document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));
    sendSummaryBankCode(selectedBankCodeID, selectedBankCode);
  } else {
    createToast("⚠️ กรุณาเลือกธนาคารก่อน", 0);
  }
};

let cameraStream = null;
let capturedImageData = null;
let currentFacingMode = 'environment';
let selectedBranch = null;

const openBranchSelectModal = () => {
  $('#branchSelectModal').modal('show');
  checkCameras();
  const branchSelectList = $('#branchSelectList');
  branchSelectList.empty();

  allLocations.forEach(branch => {
    const branchID = branch[0];
    const branchName = `${branch[1]} ${branch[2]} ${branch[3]}`;

    const branchItem = `
      <div class="leavelist-item d-flex align-items-center justify-content-between p-2 mb-2 rounded" style="background-color: #f8f9fa; cursor: pointer;" onclick="selectBranch('${branchID}')" data-branch-id="${branchID}">
        <div class="d-flex align-items-center">
          <img src="https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png" alt="${branchID}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${branchID}</strong>
            <br>
            <small class="text-muted">${branchName}</small>
          </div>
        </div>
      </div>
    `;
    branchSelectList.append(branchItem);
  });
};

// ปรับปรุงฟังก์ชัน selectBranch
const selectBranch = async (branchID) => {
  selectedBranch = allLocations.find(branch => branch[0] === branchID);

  document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));

  const selectedItem = document.querySelector(`[data-branch-id="${branchID}"]`);
  if (selectedItem) {
    selectedItem.classList.add('selected');
  }

  await checkUserLocation();
};

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('captureBtn').addEventListener('click', captureImage);
  document.getElementById('recaptureBtn').addEventListener('click', recaptureImage);
  document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
});

const openLeaveApprovalModal = () => {
  $('#leaveApprovalModal').modal('show');

  const approvalLeaveList = $('#approvalLeaveList');
  approvalLeaveList.empty();

  let pendingLeaves = allleave.filter(leave => leave[1] === "รอตรวจสอบ");
  let leaveCount = pendingLeaves.length;

  $('#leaveCount').text(leaveCount);

  pendingLeaves.forEach(rowIndex => {
    let user = dataUsers && dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';

    const leaveItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leave-item" style="background-color: #f8f9fa;">
        <div class="d-flex align-items-center">
          <img src="${userImage}" alt="${rowIndex[3]}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${rowIndex[4]} (${rowIndex[5]})</strong>
            <br>
            <small class="text-muted">${rowIndex[8]} จำนวน ${rowIndex[13]} วัน ${rowIndex[14]} ชั่วโมง</small>
          </div>
        </div>
        <button class="btn upload-button btn-sm leave-button" onclick="setappLeave('${rowIndex[0]}')">
          <i class="fa-solid fa-pen-to-square"></i> จัดการ
        </button>
      </div>
    `;
    approvalLeaveList.append(leaveItem);
  });
};

let selectedAllleave = {};
const setappLeave = (codeID) => {
  const userRole = localStorage.getItem('level') || '';
  if (userRole !== 'SuperAdmin' && userRole !== 'Admin') {
    createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
    return;
  }
  
  const row = allleave.find(row => row[0] === codeID);
  $('#leaveApprovalModal').modal('hide');
  $('#leaveApprovalRequestModal').modal('show');
  selectedAllleave = row;
  
  if (row) {
    $('#nameLeaveapproval').html(row[4]);
    $('#dpmLeaveapproval').html(row[5]);
    $('#leaveApproval1').html(row[8]);

    if (row[13] === 0 && row[14] === 12) {
      $('#leaveApproval2').html('ครึ่งวัน');
    } else if (row[13] >= 1) {
      $('#leaveApproval2').html('เต็มวัน');
    } else {
      $('#leaveApproval2').html('');
    }
    
    $('#leaveApproval3').html(`เริ่ม ${row[11]}`);
    $('#leaveApproval4').html(`สิ้นสุด ${row[12]}`);
    $('#leaveApproval5').html(`${row[13]} วัน ${row[14]} ชั่วโมง`);
  }
};

const closesetappLeave = () => {
  $('#leaveApprovalModal').modal('show');
  $('#leaveApprovalRequestModal').modal('hide');
};

// function fetchChatMessages() {

// }

const loadImagepdfmake = (url, callback) => {
  var img = new Image();
  img.crossOrigin = 'Anonymous';
  img.onload = () => {
    var canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    var dataURL = canvas.toDataURL('image/png');
    callback(dataURL);
  };
  img.src = url;
};

const createPayroll = (payrollData, callback) => {
  loadImagepdfmake('https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png', (imageBase64) => {
    const docPayrollPDF = {
      pageSize: { width: 595.28, height: 421.89 },
      pageMargins: [40, 30, 40, 30],
      content: [
        {
          columns: [
            [
              { text: 'Epic Coding Channel', style: 'subheader', alignment: 'left', fontSize: 20 },
              { text: `ชื่อพนักงาน (รหัส): ${payrollData.fullname} (${payrollData.uid})`, bold: true, fontSize: 14 },
              { text: `ตำแหน่ง: ${payrollData.department}`, fontSize: 14 },
              { text: `แผนก: ${payrollData.group}`, fontSize: 14 }
            ],
            { 
              image: imageBase64, 
              width: 50, 
              alignment: 'center', 
              margin: [0, 0, 0, 10]
            },
            [
              { text: 'สลิปเงินเดือน / Pay Slip', style: 'subheader', alignment: 'right', fontSize: 20 },
              { text: `รอบเงินเดือน: ${payrollData.paymentPeriod}`, alignment: 'right', fontSize: 14 },
              { text: `วันที่จ่าย: ${payrollData.paymentDate}`, alignment: 'right', fontSize: 14 },
              { text: `เลขที่บัญชี: ${payrollData.accountbank}`, alignment: 'right', fontSize: 14 }
            ]
          ]
        },
        {
          table: {
            headerRows: 1,
            widths: ['*', 'auto', '*', 'auto', '*', 'auto'],
            body: [
              [
                { text: 'เงินได้\nEarnings', colSpan: 2, style: 'tableHeader', alignment: 'center' }, 
                {},  
                { text: 'รายการหัก\nDeductions', colSpan: 2, style: 'tableHeader', alignment: 'center' },
                {},
                { text: 'รายได้สะสม\nRetained income', colSpan: 2, style: 'tableHeader', alignment: 'center' },
                {}
              ],
              [
                { text: 'เงินเดือน/ค่าจ้าง', alignment: 'left' },
                { text: payrollData.paysalary.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'ประกันสังคม', alignment: 'left' },
                { text: payrollData.socialSecurity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'เงินได้สะสม', alignment: 'left', bold: true },
                { text: payrollData.retainedIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' } 
              ],
              [
                { text: 'เงินพิเศษ', alignment: 'left' },
                { text: payrollData.payspecial.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'ภาษีหัก ณ ที่จ่าย', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'ภาษีหัก ณ ที่จ่ายสะสม', alignment: 'left', bold: true },
                { text: '0.00', alignment: 'right' } 
              ],
              [
                { text: 'ค่าล่วงเวลา', alignment: 'left' },
                { text: payrollData.overtime.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'เงินกู้ยืม กยศ./กรอ.', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'ประกันสังคมสะสม', alignment: 'left', bold: true },
                { text: payrollData.retainedSocialSecurity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' } 
              ],
              [
                { text: 'ค่าเบี้ยเลี้ยง/ค่าครองชีพ', alignment: 'left' },
                { text: payrollData.allowance ? payrollData.allowance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00', alignment: 'right' }, 
                { text: 'เงินประกัน', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'รวมเงินได้', alignment: 'left', bold: true },
                { text: payrollData.adjustments.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' } 
              ],
              [
                { text: 'โบนัส', alignment: 'left' },
                { text: '0.00', alignment: 'right' }, 
                { text: 'ขาด/ลา/สาย', alignment: 'left' },
                { text: payrollData.absentDeduction.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'รวมรายการหัก', alignment: 'left', bold: true },
                { text: payrollData.deductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right', bold: true } 
              ],
              [
                { text: 'เงินอื่นๆ', alignment: 'left' },
                { text: payrollData.commission.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'รายการหักอื่นๆ', alignment: 'left' },
                { text: payrollData.otherDeduction.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right' }, 
                { text: 'เงินได้สุทธิ', alignment: 'left', bold: true },
                { text: payrollData.totalpaysalary.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), alignment: 'right', bold: true } 
              ]
            ]
          },
          layout: {
            hLineWidth: function(i, node) {
              return i === 0 || i === node.table.body.length ? 1 : 0; 
            },
            vLineWidth: function(i, node) {
              return i === 0 || i === node.table.widths.length ? 1 : 0; 
            },
            hLineColor: function(i, node) {
              return '#000000'; 
            },
            vLineColor: function(i, node) {
              return '#000000'; 
            },
            paddingLeft: function(i, node) { return 8; },  
            paddingRight: function(i, node) { return 8; }, 
            paddingTop: function(i, node) { return 3; },
            paddingBottom: function(i, node) { return 3; }
          }
        },
        // ลายเซ็นและหมายเหตุ
        {
          columns: [
            [{ text: 'หมายเหตุ:', style: 'subheader', alignment: 'left', fontSize: 16, margin: [0, 15, 0, 0] }],
            [{ text: 'ลายเซ็นผู้จ่ายเงิน:   ________________________', style: 'subheader', alignment: 'right', fontSize: 16, margin: [0, 15, 0, 0] }]
          ]
        },
        {
          columns: [
            [{ text: ' __________________________________________________________________________________________________________________', style: 'subheader', alignment: 'center', fontSize: 12, margin: [0, 10, 0, 0] }]
          ]
        },
        {
        stack: [
          { text: 'ข้อมูลเงินเดือนและค่าจ้างเป็นข้อมูลส่วนบุคคล ห้ามเปิดเผยโดยเด็ดขาดเอกสารนี้จะสมบูรณ์เมื่อมีลายเซ็นผู้มีอำนวจลงนามและตราประทับเท่านั้น', alignment: 'center' },
          { text: 'Salary and wages are confidential information. Disclosure is strictly prohibited. This document is only valid with an authorized signature and company stamp.', alignment: 'center' }
        ],
          style: 'footer',
          margin: [0, 0, 0, 0]
        }
      ],
      styles: {
        header: { fontSize: 16, bold: true },
        subheader: { fontSize: 14, bold: true },
        tableHeader: { bold: true, fontSize: 14, color: 'black' },
        footer: { fontSize: 9, italics: true }
      },
      defaultStyle: {
        font: 'THSarabunNew',
        fontSize: 14,
        color: 'black'
      }
    };

    pdfMake.createPdf(docPayrollPDF).getBase64((base64) => {
      callback(base64);
    });
  });
};

const openRequestApprovalModal = () => {
  $('#requestApprovalModal').modal('show');

  const approvalRequestList = $('#approvalRequestList');
  approvalRequestList.empty();

  let pendingREQ = allRequest.filter(row => row[1] === "รอตรวจสอบ");
  let requestCount = pendingREQ.length;

  $('#requestCount').text(requestCount);

  pendingREQ.forEach(rowIndex => {
    let user = dataUsers && dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';

    const requestItem = `
      <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded leave-item" style="background-color: #f8f9fa;">
        <div class="d-flex align-items-center">
          <img src="${userImage}" alt="${rowIndex[3]}" class="rounded-circle me-3" width="40" height="40">
          <div>
            <strong>${rowIndex[4]} (${rowIndex[5]})</strong>
            <br>
            <small class="text-muted">${rowIndex[8]}</small>
          </div>
        </div>
        <button class="btn upload-button btn-sm leave-button" onclick="setapprequest('${rowIndex[0]}')">
          <i class="fa-solid fa-pen-to-square"></i> จัดการ
        </button>
      </div>
    `;
    approvalRequestList.append(requestItem);
  });
};

let selectedAllRequest = {};
const setapprequest = (codeID) => {
  const userRole = localStorage.getItem('level') || '';
  if (userRole !== 'SuperAdmin' && userRole !== 'Admin') {
    createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
    return;
  }
  
  const row = allRequest.find(row => row[0] === codeID);
  $('#requestApprovalModal').modal('hide');
  $('#reqApprovalRequestModal').modal('show');
  selectedAllRequest = [codeID];
  
  if (row) {
    $('#nameReqapproval').html(row[4]);
    $('#dpmReqapproval').html(row[5]);
    $('#ReqApproval1').html(row[8]);
  }
};

const closesetappRequest = () => {
  $('#requestApprovalModal').modal('show');
  $('#reqApprovalRequestModal').modal('hide');
}

$('#holidayModal').on('shown.bs.modal', () => {
  const currentYear = new Date().getFullYear();
  const years = [];
  for (let i = currentYear; i <= currentYear + 3; i++) {
    years.push(i);
  }
  document.getElementById("selectYearModal").innerHTML = years
    .map((year) => `<option value="${year}" ${year == currentYear ? 'selected' : ''}>${year}</option>`)
    .join("");
  document.getElementById("selectYearModal").addEventListener("change", showHolidayModal);
  showHolidayModal();
});
</script>

MD/Changepassword.html = 
<div class="modal fade" id="NewProfileModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="NewProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h5 class="mb-2 fw-bold mt-2 text-primary"> เปลี่ยนรูปประจำตัว</h5>
            <div style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); border:3px solid white;" class="mb-3">
              <img id="regictorNewPreview" src="https://img2.pic.in.th/pic/vsvds.png" alt="รูปประจำตัว" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <input type="file" name="regictorNewImg" id="regictorNewImg" style="display:none">
        </div>
              <div class="mb-2">
                <div class="d-flex align-items-center justify-content-center mb-2">
                <label for="regictorNewImg" class="btn edit-button">อัพโหลดรูปคลิกที่นี่</label>
                </div>
              </div>
      <center>
      <div class="mt-2">
        <button type="button" class="btn set-button" onclick="saveUploadProfile()">ยืนยัน</button>
        <button type="button" class="btn del-button"  data-bs-dismiss="modal">ยกเลิก</button>
      </div>
      </center>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="NewSigModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="NewSigModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h5 class="mb-0 fw-bold mt-2 text-primary">เปลี่ยนรูปลายเซ็น</h5>
              <center>
                <div class="row mt-2">
                  <div class="col-md-6 text-center">
                    <a for="signatureCanvas" class="form-label mt-2"></a>
                    <canvas id="signatureCanvas" class="rounded-4 shadow" style="width: 300px;"></canvas>
                  </div>
                  <div class="col-md-12 text-center mt-2">
                    <span><i class="fa-solid fa-palette text-success"></i> เปลี่ยนสี <input type="color" id="colorPickerA" class="color-picker"></span>
                  </div>
                </div>
                <div class="row">
                </div>
                <div class="row col-md-6">
                  <button class="btn upload-button mt-2" name="clear-signature" id="clearButtonA"><i class="fa-solid fa-eraser"></i> ล้างลายมือชื่อ</button>
                </div>
              </center>         
        </div>
      <center>
      <div class="mt-2">
        <button type="button" class="btn set-button" onclick="saveUploadSig()">ยืนยัน</button>
        <button type="button" class="btn del-button" id="xbtnUploadsigModal" data-bs-dismiss="modal">ยกเลิก</button>
      </div>
      </center>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="userChangePwModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="userChangePwModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="text-center mb-2">
          <h5 class="mb-0 fw-bold mt-2 text-primary" id="textChange">ปลี่ยนรหัสผ่าน</h5>
        </div>
        <div class="mb-2">
          <label for="ChangePasswordA" class="form-label">กรอกรหัสผ่านใหม่ <span class="text-danger">*</span></label> 
          <div class="input-group">
            <input class="form-control" type="password" id="ChangePasswordA" placeholder="กรุณายืนยันรหัสผ่านใหม่">
            <button type="button" class="btn set-button" id="showChangeAPassword">
                <i class="fa fa-eye" id="toggleIconChangeA"></i>
            </button>
          </div>
        </div> 
        <div class="mb-2">
          <label for="ChangePasswordB" class="form-label">ยืนยันรหัสผ่านใหม่ <span class="text-danger">*</span></label> 
          <div class="input-group">
            <input class="form-control" type="password" id="ChangePasswordB" placeholder="กรุณายืนยันรหัสผ่านใหม่">
            <button type="button" class="btn set-button" id="showChangeBPassword">
                <i class="fa fa-eye" id="toggleIconChangeB"></i>
            </button>
          </div>
        </div> 
      <center>
      <div class="mt-2">
        <button type="button" class="btn set-button" onclick="changePassword()">ยืนยัน</button>
        <button type="button" class="btn del-button" id="xbtnUserChangePwModal" data-bs-dismiss="modal">ยกเลิก</button>
      </div>
      </center>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', (ev) => {
  let input = document.querySelector('input[id="regictorNewImg"]');
  input.addEventListener('change', (ev) => {
      if (input.files[0].type.indexOf("image/") > -1) {
        let img = document.getElementById('regictorNewPreview');
        img.src = window.URL.createObjectURL(input.files[0]);
      }
  });
});

document.getElementById('showChangeAPassword').addEventListener('click', function () {
  const passwordInput = document.getElementById('ChangePasswordA');
  const toggleIconChangeA = document.getElementById('toggleIconChangeA');
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIconChangeA.classList.remove('fa-eye');
    toggleIconChangeA.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIconChangeA.classList.remove('fa-eye-slash');
    toggleIconChangeA.classList.add('fa-eye');
  }
});

document.getElementById('showChangeBPassword').addEventListener('click', function () {
  const passwordInput = document.getElementById('ChangePasswordB');
  const toggleIconChangeB = document.getElementById('toggleIconChangeB');
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIconChangeB.classList.remove('fa-eye');
    toggleIconChangeB.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIconChangeB.classList.remove('fa-eye-slash');
    toggleIconChangeB.classList.add('fa-eye');
  }
});

const changePassword = () => {
  $.LoadingOverlay("show", {  image : "", fontawesome : "fa fa-spinner fa-spin" });
  $(".form-control").removeClass("text-bg-warning");
  if ($("#ChangePasswordA").val() === "") {
    $("#ChangePasswordA").addClass("text-bg-warning");
    createToast("⚠️ กรุณากรอกรหัสผ่านใหม่", 0);
    $.LoadingOverlay("hide");
  } else if ($("#ChangePasswordB").val() === "") {
    $("#ChangePasswordB").addClass("text-bg-warning");
    createToast("⚠️ กรุณายืนยันรหัสผ่าน", 0);
    $.LoadingOverlay("hide");
  } else if ($("#ChangePasswordA").val() !== $("#ChangePasswordB").val()) {
    $("#ChangePasswordB").addClass("text-bg-warning");
    $("#ChangePasswordA").addClass("text-bg-warning");
    createToast("⚠️ รหัสผ่านไม่ตรงกัน", 0);
    $.LoadingOverlay("hide");
  } else {
    let fullname = localStorage.getItem('fullname');
    let obj = {}
      obj.code = fullname;
      obj.password = $("#ChangePasswordA").val();

      $("#username").val(localStorage.getItem('User'));
      $("#password").val(obj.password);

    google.script.run.withSuccessHandler(function(response) {
      $.LoadingOverlay("hide");
      $("#xbtnUserChangePwModal").click();
      $('#ChangePasswordA').val("")
      $('#ChangePasswordB').val("")
      createToast("✅ เปลี่ยนรหัสผ่านสำเร็จ", 1);
      $('#logoutModal').modal('show')
    }).changePasswordMember(obj);  
  } 
}

const saveUploadProfile = () => {
  $.LoadingOverlay("show", {  image : "", fontawesome : "fa fa-spinner fa-spin" });
  let fullname = localStorage.getItem('fullname');
  let imgUser = localStorage.getItem('imgUser');
  var obj = {}
  obj.codeName = fullname;
  obj.check = $("#regictorNewImg").val();
  if (obj.check === "") {
    obj.profileNew = $("#regictorNewPreview").attr("src");
  } else {
    var imgElement = document.getElementById("regictorNewPreview");
    var canvas = document.createElement("canvas");
    var context = canvas.getContext("2d");
    canvas.width = imgElement.naturalWidth;
    canvas.height = imgElement.naturalHeight;
    context.drawImage(imgElement, 0, 0, imgElement.naturalWidth, imgElement.naturalHeight);
    var imageDataUrl = canvas.toDataURL("image/png");
    obj.imageDataUrl = imageDataUrl;
    obj.filetype = "image/png"; 
    obj.filename = fullname;
  }
  google.script.run.withSuccessHandler(function(response) {
    $.LoadingOverlay("hide");
    createToast("✅ เปลี่ยนรูปโปรไฟล์สำเร็จ", 1);
    $('#NewProfileModal').modal('hide');
    localStorage.setItem('imgUser', response);
    $("#picadmin1").attr('src', response);
    $("#picadmin2").attr('src', response); 
    $('#logoutModal').modal('show') 
  }).updateProfile(obj);
}

const saveUploadSig = () => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  let fullname = localStorage.getItem('fullname');
  let sigUser = localStorage.getItem('sigUser');
  let obj = {
    codeName: fullname,
    signatureCanvas: document.getElementById('signatureCanvas').toDataURL("image/png"),
    filetype: "image/png",
    filename: sigUser
  };
  google.script.run.withSuccessHandler(function(response) {
    $.LoadingOverlay("hide");
    createToast("✅ เปลี่ยนรูปลายเซ็นสำเร็จ", 1);
    $('#NewSigModal').modal('hide');
    signaturePadUser.clear();
    localStorage.setItem('sigUser', response);
    $('#logoutModal').modal('show');
  }).saveUploadSig(obj);
} 
</script>

MD/Modal.html = 
<div class="modal fade" id="RegisterModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="RegisterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="text-center mb-2">
          <h4 class="mb-0 fw-bold mt-2" id="textAddregis1">👦 เพิ่มข้อมูลผู้ใช้งาน</h4>
          <h5 class="mb-0 fw-bold mt-2" id="textAddregis2" style="display:none">👦 แก้ไขข้อมูลผู้ใช้งาน</h5>
        </div>
        <form id="addRegicter">
          <input type="text" class="form-control" id="registerDataID" name="registerDataID" hidden>
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="d-flex align-items-center justify-content-center">
                  <div style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); border:3px solid white;" class="mb-3">
                    <img id="regictorPreview" src="https://img2.pic.in.th/pic/vsvds.png" alt="รูปประจำตัว" style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  <input type="file" name="regictorImg" id="regictorImg" style="display:none">
                </div>
                <div class="mb-3">
                  <label class="control-label">ตำแหน่ง <span class="text-danger">*</span></label>
                  <select class="form-select" id="registerData1" name="registerData1" required></select>
                </div>
                <div class="mb-3">
                  <label class="control-label">แผนก <span class="text-danger">*</span></label>
                  <select class="form-select" id="registerData2" name="registerData2" required></select>
                </div>
                <div class="mb-3">
                  <label class="control-label">ระดับผู้ใช้งาน <span class="text-danger">*</span></label>
                  <select class="form-select" id="registerData3" name="registerData3" required>
                    <option selected value="">กรุณาเลือกรายการ</option>
                    <option value="SuperAdmin">SuperAdmin</option>
                    <option value="Admin">Admin</option>
                    <option value="SuperUser">SuperUser</option>
                    <option value="User">User</option>
                    <option value="Driver">Driver</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="control-label">ชื่อผู้ใช้งาน <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="registerData4" name="registerData4" placeholder="กรุณากรอกชื่อผู้ใช้งาน" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Username <span class="text-danger me-2">*</span><span id="resultMessage"></span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="registerData5" name="registerData5" placeholder="กรุณากรอก Username" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Password <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="registerData6" name="registerData6" placeholder="กรุณากรอก Password" required>
                  <button class="btn set-button" type="button" onclick="password_showAdd_hide()">
                    <i class="fa-regular fa-eye" id="showadd_eye"></i>
                    <i class="fa-regular fa-eye-slash d-none" id="hideadd_eye"></i>
                  </button>
                  </div>
                </div>
        <div class="mt-2 text-center">
          <button type="submit" class="btn set-button" onclick="submitRegisterForm()">บันทึกข้อมูล</button>
          <button type="button" class="btn del-button" onclick="closeModalRegistor()" data-bs-dismiss="modal">ยกเลิก</button>
        </div>
            </div>
            <div class="col-md-6">
              <div class="mb-2">
                <div class="d-flex align-items-center justify-content-center mb-2">
                <label for="regictorImg" class="btn edit-button w-100">อัพโหลดรูปคลิกที่นี่</label>
                </div>
                <div id="reviewdivprofile"></div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="imageModalSrc" src="" alt="Full Size Image" style="width: 100%; height: auto;">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="bankSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="bankSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="text-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🏛️ เลือกธนาคารนำส่ง</h5>
        </div>

        <div id="bankSelectList" style="max-height: 500px; overflow-y: auto;"></div>

        <div class="mt-2 text-center">
          <button type="button" class="btn set-button" onclick="applyBankSelection()">นำส่งข้อมูล</button>
          <button type="button" class="btn del-button" data-bs-dismiss="modal">ยกเลิก</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="branchSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="branchSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🏢 เลือกสาขาสำหรับลงเวลา</h5>
          <button type="button" class="btn del-button" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div id="branchSelectList" style="max-height: 500px; overflow-y: auto;"></div>

        <div id="cameraSection" class="d-none">
          <div class="mb-2">
            <video id="cameraVideo" class="w-100 rounded border" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <img id="capturedImage" class="w-100 rounded border mt-2" style="display: none;">
          </div>
          <div class="d-flex gap-2 mb-2">
            <button id="switchCameraBtn" class="btn upload-button w-100">
              <i class="fa-solid fa-camera-rotate"></i> สลับกล้อง
            </button>
          </div>
          <div class="d-flex gap-2">
            <button id="captureBtn" class="btn set-button w-100">
              <i class="fa-solid fa-camera"></i> ถ่ายรูป
            </button>
            <button id="recaptureBtn" class="btn del-button w-100" style="display: none;">
              <i class="fa-solid fa-rotate"></i> ถ่ายใหม่
            </button>
          </div>
        </div>

        <div class="mt-2">
          <button type="button" id="checkin-button" class="btn upload-button w-100" onclick="submitCheckInTime('เข้างาน')">
            <i class="fa-solid fa-circle-chevron-right"></i> ลงเวลาเข้า/CheckIN
          </button>
          <button type="button" id="ot-button" class="btn edit-button w-100" onclick="submitCheckInTime('OT')">
            <i class="fa-regular fa-clock"></i> ลงเวลาเข้า/OT
          </button>
          <button type="button" id="checkout-button" class="btn del-button w-100 mt-2" onclick="submitCheckInTime('ออกงาน')">
            <i class="fa-solid fa-circle-chevron-left"></i> ลงเวลาออก/CheckOut
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="levSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="levSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">👨‍⚕️ เลือกประเภทการลา</h5>
          <button type="button" class="btn del-button" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div id="levSelectList"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="RPTLModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="RPTLModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class=" mt-2" style="color: var(--box3); font-weight: bold;">📝 แบบฟอร์มขออนุญาตลา</h5>
          <button type="button" class="btn del-button" onclick="clearFormLeave();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="adduserLeave">
        <input type="text" class="form-control" id="leaveDataKey" name="leaveDataKey" hidden>
        <div class="row mt-2">
          <div class="col-md-12">
            <div class="mb-1">
                <label class="control-label"> ประเภทลา <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="leaveData1" name="leaveData1" placeholder="กรุณากรอกประเภทลา" readonly>
            </div>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-12">
            <div class="mb-1">
                <label class="control-label"> รายละเอียดการลา <span class="text-danger">*</span></label>
                <textarea type="text" class="form-control " id="leaveData2" name="leaveData2" rows="3" placeholder="กรุณากรอกรายละเอียดการลาที่นี่"></textarea>
            </div>
          </div>
        </div>
      <div class="row mt-2">
        <div class="col-md-12">
          <div class="d-flex">
            <div class="form-switch-wrapper me-2">
              <input type="checkbox" class="styled-switch" id="morningHalfDaySwitch" onchange="toggleMorningHalfDayLeave()">
              <label class="form-check-label" for="morningHalfDaySwitch">ครึ่งวันเช้า</label>
            </div>
            <div class="form-switch-wrapper me-2">
              <input type="checkbox" class="styled-switch" id="afternoonHalfDaySwitch" onchange="toggleAfternoonHalfDayLeave()">
              <label class="form-check-label" for="afternoonHalfDaySwitch">ครึ่งวันบ่าย</label>
            </div>
            <div class="form-switch-wrapper me-2">
              <input type="checkbox" class="styled-switch" id="fullDaySwitch" onchange="toggleFullDayLeave()">
              <label class="form-check-label" for="fullDaySwitch">เต็มวัน</label>
            </div>
          </div>
        </div>
      </div>
        <div class="row mt-2">
          <div class="col-md-6">
            <div class="mb-1">
              <label class="control-label">ตั้งแต่วันที่ <span class="text-danger">*</span></label>
              <input type="datetime-local" class="form-control" id="leaveData3" name="leaveData3" onchange="handleLeaveStartDateChange();">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-1">
              <label class="control-label">ถึงวันที่ <span class="text-danger">*</span></label>
              <input type="datetime-local" class="form-control" id="leaveData4" name="leaveData4" onchange="handleLeaveEndDateChange();">
            </div>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-6">
            <div class="mb-1">
              <label class="control-label">จำนวนวัน <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="leaveData5" name="leaveData5" placeholder="กรุณากรอกข้อมูล" readonly>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-1">
              <label class="control-label">จำนวนชั่วโมง <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="leaveData6" name="leaveData6" placeholder="กรุณากรอกข้อมูล" readonly>
            </div>
          </div>
        </div>
        <div class="row mt-2" id="leaveData7Row" style="display: none;">
          <div class="col-md-12">
            <div class="mb-1">
              <label class="control-label">อัปโหลดใบรับรองแพทย์ <span class="text-danger">*</span></label>
              <input type="file" class="form-control" id="leaveData7" name="leaveData7">
            </div>
          </div>
        </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormLeave()">ขออนุญาตลา</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rqtBodyModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="rqtBodyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class=" mt-2" style="color: var(--box3); font-weight: bold;">📝 ขอหนังสือรับรองเงินเดือน</h5>
          <button type="button" class="btn del-button" onclick="clearFormreqList();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormreqList">
        <input type="text" class="form-control" id="reqListDataKey" name="reqListDataKey" hidden>
        <div class="row mt-2">
          <div class="col-md-12">
            <div class="mb-1">
                <label class="control-label"> รายละเอียดการขอ <span class="text-danger">*</span></label>
                <textarea type="text" class="form-control " id="reqListData1" name="reqListData1" rows="4" placeholder="ระบุวัตถุประสงค์ในการขอใช้หนังสือรับรองเงินเดือน"></textarea>
            </div>
          </div>
        </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormreqList();">ยืนยันคำขอ</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="leaveApprovalModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="leaveApprovalModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">👨‍⚕️ รายการลางาน จำนวน <span id="leaveCount"></span> คน</h5>
          <button type="button" class="btn del-button" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div id="approvalLeaveList" style="max-height: 500px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="requestApprovalModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="requestApprovalModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">👨‍⚕️ รายการคำขอ จำนวน <span id="requestCount"></span> คน</h5>
          <button type="button" class="btn del-button" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div id="approvalRequestList" style="max-height: 500px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="leaveApprovalRequestModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="leaveApprovalRequestLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class=" mt-2" style="color: var(--box3); font-weight: bold;">📝ขออนุญาตลางาน คุณอนุมัติหรือไม่?</h5>
          <button type="button" class="btn del-button" onclick="closesetappLeave();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <hr>
        <div class="row text-start mb-2">
          <div class="col-6">
            <p class="mb-1"><strong>ผู้ขออนุญาต</strong></p>
            <small id="nameLeaveapproval"></small>
          </div>
          <div class="col-6">
            <p class="mb-1"><strong>หน่วยงาน</strong></p>
            <small id="dpmLeaveapproval"></small>
          </div>
        </div>
        <div class="row text-start mb-2">
          <div class="col-6">
            <p class="mb-1"><strong>ประเภทการลา</strong></p>
            <small id="leaveApproval1"></small>
          </div>
          <div class="col-6">
            <p class="mb-1"><strong>รูปแบบการลา</strong></p>
            <small id="leaveApproval2"></small>
          </div>
        </div>
        <div class="row text-start">
          <div class="col-6">
            <p class="mb-1"><strong>ลาจากวันที่</strong></p>
            <small id="leaveApproval3"></small><br>
            <small id="leaveApproval4"></small>
          </div>
          <div class="col-6">
            <p class="mb-1"><strong>จำนวนวัน</strong></p>
            <small id="leaveApproval5"></small>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-12">
            <div class="mb-1">
              <select type="text" class="form-control"  id="approveDataLeave" name="approveDataLeave" style="color: var(--box1);"></select>
            </div>
          </div>
        </div>
        <div class="d-flex mt-2">
          <button type="button" class="btn del-button flex-fill me-2" onclick="submitApprovalLeave('ไม่อนุมัติ');"><i class="fa-solid fa-xmark"></i> ไม่อนุมัติ</button>
          <button type="button" class="btn upload-button flex-fill" onclick="submitApprovalLeave('อนุมัติ');"><i class="fa-solid fa-check"></i> อนุมัติการลา</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reqApprovalRequestModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="reqApprovalRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class=" mt-2" style="color: var(--box3); font-weight: bold;">📝ขอหนังสือรับรอง คุณอนุมัติหรือไม่?</h5>
          <button type="button" class="btn del-button" onclick="closesetappRequest();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <hr>
        <div class="row text-start mb-2">
          <div class="col-6">
            <p class="mb-1"><strong>ผู้ขออนุญาต</strong></p>
            <small id="nameReqapproval"></small>
          </div>
          <div class="col-6">
            <p class="mb-1"><strong>หน่วยงาน</strong></p>
            <small id="dpmReqapproval"></small>
          </div>
        </div>
        <div class="row text-start mb-2">
          <div class="col-12">
            <p class="mb-1"><strong>รายละเอียดคำขอ</strong></p>
            <small id="ReqApproval1"></small>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-12">
            <div class="mb-1">
              <select type="text" class="form-control"  id="approveDataRequest" name="approveDataRequest" style="color: var(--box1);"></select>
            </div>
          </div>
        </div>
        <div class="d-flex mt-2">
          <button type="button" class="btn del-button flex-fill me-2" onclick="submitApprovalRequest('ไม่อนุมัติ');"><i class="fa-solid fa-xmark"></i> ไม่อนุมัติ</button>
          <button type="button" class="btn upload-button flex-fill" onclick="submitApprovalRequest('อนุมัติ');"><i class="fa-solid fa-check"></i> อนุมัติ</button>
        </div>
      </div>
    </div>
  </div>
</div> 

<div class="modal fade" id="EmployeeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen">
    <div class="modal-content">
      <div class="modal-body p-4">
        <h5 class="text-center mb-4 mt-2" style="color: var(--box3); font-weight: bold;">📝 ฟอร์มข้อมูลพนักงาน</h5>
        <form>
          <div class="row g-3">
            <div class="col-md-4">
              <h5 style="color: var(--box1); font-weight: bold;">🙇 ข้อมูลส่วนตัวพนักงาน</h5>
              <div class="d-flex align-items-center justify-content-center mb-2">
                <label for="employeeImg" style="width: 250px; height: 250px; overflow: hidden; border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); border: 3px solid white;" class="mb-3">
                  <img id="employeePreview" src="https://img2.pic.in.th/pic/vsvds.png" alt="รูปประจำตัว" style="width: 100%; height: 100%; object-fit: cover;">
                </label>
                <input type="file" name="employeeImg" id="employeeImg" style="display:none">
              </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">รหัสพนักงาน <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="empDataKey" name="empDataKey" placeholder="กรอกรหัสพนักงานที่นี่" readonly>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">ชื่อ นามสกุล <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="empData1" name="empData1" placeholder="กรอกชื่อ นามสกุลที่นี่">
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">เพศ <span class="text-danger">*</span></label>
                  <select class="form-select" id="empData4" name="empData4">
                    <option selected value="">กรุณาเลือกรายการ</option>
                    <option value="ชาย">👨‍💼 ชาย</option>
                    <option value="หญิง">👨‍💼 หญิง</option>
                  </select>
                </div>            
              </div>

              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">สัญชาติ <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="empData6" name="empData6" placeholder="กรอกสัญชาติที่นี่">
                </div>     
              </div>

              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">สถานภาพ <span class="text-danger">*</span></label>
                  <select class="form-select" id="empData7" name="empData7">
                    <option selected value="">กรุณาเลือกรายการ</option>
                    <option value="โสด">โสด</option>
                    <option value="สมรส">สมรส</option>
                    <option value="หย่า">หย่า</option>
                    <option value="หม้าย">หม้าย</option>
                    <option value="แยกกันอยู่">แยกกันอยู่</option>
                  </select>
                </div>          
              </div>

              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">พิการ/ทุพพลภาพ <span class="text-danger">*</span></label>
                  <select class="form-select" id="empData8" name="empData8">
                    <option selected value="">กรุณาเลือกรายการ</option>
                    <option value="ปกติ">ปกติ</option>
                    <option value="คนพิการทางการมองเห็น">คนพิการทางการมองเห็น</option>
                    <option value="คนพิการทางการได้ยินหรือการสื่อความหมาย">คนพิการทางการได้ยินหรือการสื่อความหมาย</option>
                    <option value="คนพิการทางกายหรือการเคลื่อนไหว">คนพิการทางกายหรือการเคลื่อนไหว</option>
                    <option value="คนพิการทางจิตใจหรือพฤติกรรม">คนพิการทางจิตใจหรือพฤติกรรม</option>
                    <option value="คนพิการทางสติปัญญาหรือการเรียนรู้">คนพิการทางสติปัญญาหรือการเรียนรู้</option>
                  </select>
                </div>         
              </div>
          
              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">เลขบัตรประชาชน <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="empData9" name="empData9" minlength="13" placeholder="กรอกเลขบัตรประชาชนที่นี่">
                </div>        
              </div>

              <div class="col-md-6">
                <div class="mb-2">
                  <label class="form-label">วัน/เดือน/ปี(เกิด) <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="empData5" name="empData5" placeholder="กรอกวันที่จ้างที่นี่">
                </div>
              </div>
              
            </div>
          </div>

            <div class="col-12 col-lg-4">
              <h5 style="color: var(--box1); font-weight: bold;">🌏 ข้อมูลการติดต่อ</h5>
              <div class="row">
                <div class="col-md-12">
                  <div class="mb-2">
                    <label class="form-label">ที่อยู่ <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="empData12" name="empData12" minlength="10" placeholder="กรอกที่อยู่ที่นี่">
                  </div>              
                </div>
                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">อีเมล <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="empData13" name="empData13" placeholder="กรอกอีเมลที่นี่">
                  </div>         
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">Line ID <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="empData14" name="empData14" placeholder="กรอก Line IDที่นี่">
                  </div>            
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">เบอร์โทรศัพท์ <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="empData15" name="empData15" minlength="10" placeholder="กรอกเบอร์โทรศัพท์ที่นี่">
                  </div>                
                </div>
              </div>

              <h5 class="mt-3" style="color: var(--box1); font-weight: bold;">👨‍💼 ข้อมูลการจ้าง</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="control-label">ตำแหน่ง <span class="text-danger">*</span></label>
                    <select class="form-select" id="empData2" name="empData2" required></select>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="control-label">แผนก <span class="text-danger">*</span></label>
                    <select class="form-select" id="empData3" name="empData3" required></select>
                  </div>         
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">การจ้างงาน <span class="text-danger">*</span></label>
                    <select class="form-select" id="empData16" name="empData16">
                      <option selected value="">กรุณาเลือกรายการ</option>
                      <option value="พนักงานประจำ">👨‍💼 พนักงานประจำ</option>
                      <option value="พนักงานรายวัน">👨‍💼 พนักงานรายวัน</option>
                    </select>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">วันที่จ้าง <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="empData17" name="empData17" placeholder="กรอกวันที่จ้างที่นี่">
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">การจ่าย <span class="text-danger">*</span></label>
                    <select class="form-select" id="empData18" name="empData18">
                      <option selected value="">กรุณาเลือกรายการ</option>
                      <option value="รายเดือน">💵 รายเดือน</option>
                      <option value="รายวัน">💵 รายวัน</option>
                    </select>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">ค่าจ้าง <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="empData19" name="empData19" placeholder="กรอกค่าจ้างที่นี่">
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-2">
                    <label class="form-label">เงินพิเศษ <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="empData20" name="empData20" placeholder="กรอกเงินพิเศษที่นี่">
                  </div>
                </div>

              </div>
            </div>

            <div class="col-md-4">
              <h5 style="color: var(--box1); font-weight: bold;">👨‍💼 สิทธิ์ประกันสังคม</h5>
              <div class="mb-2">
                <label class="form-label">เลขประกันสังคม <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="empData10" name="empData10" minlength="13" placeholder="กรอกเลขประกันสังคมที่นี่">
              </div>
              <div class="row">
                <div class="col-6">
                  <div class="card Employee-card" id="cardCheckDataA" onclick="selectEmpCard('cardCheckDataA', 'empData11')">
                    <div class="card-body">
                      <input type="radio" name="empData11" id="radioCheckDataA" value="ขึ้นสิทธิ์ประกันสังคม" checked style="display:none;">
                      <h6 class="card-title" style="color: var(--box1)">✔️ มีสิทธิ์</h6>
                      <p class="card-text" style="color: var(--box3); font-size: 14px;">ขึ้นสิทธิ์ประกันสังคม</p>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card Employee-card" id="cardCheckDataB" onclick="selectEmpCard('cardCheckDataB', 'empData11')">
                    <div class="card-body">
                      <input type="radio" name="empData11" id="radioCheckDataB" value="ไม่ขึ้นสิทธิ์ประกันสังคม" style="display:none;">
                      <h6 class="card-title" style="color: var(--box1)">❌ ไม่มีสิทธิ์</h6>
                      <p class="card-text" style="color: var(--box3); font-size: 14px;">ไม่ขึ้นสิทธิ์ประกันสังคม</p>
                    </div>
                  </div>
                </div>
              </div>

              <h5 class="mt-3" style="color: var(--box1); font-weight: bold;">💳 ข้อมูลการชำระเงินเดือน/ค่าจ้าง</h5>
              <div class="row">
                <div class="col-6">
                  <div class="mb-2">
                    <label class="form-label">ช่องทางการชำระ <span class="text-danger">*</span></label>
                    <select class="form-select" id="empData21" name="empData21">
                      <option selected value="">กรุณาเลือกรายการ</option>
                      <option value="โอนเงิน">💳 โอนเงิน</option>
                      <option value="เงินสด">💵 เงินสด</option>
                      <option value="เช็ค">💸 เช็ค</option>
                    </select>
                  </div>
                </div>

                <div class="col-6">
                  <div class="mb-2">
                    <label class="form-label">ธนาคาร <span class="text-danger">*</span></label>
                    <select class="form-select" id="empData22" name="empData22">
                      <option selected value="">กรุณาเลือกรายการ</option>
                      <option value="ธนาคารกรุงเทพ">💳 ธนาคารกรุงเทพ</option>
                      <option value="ธนาคารกสิกรไทย">💳 ธนาคารกสิกรไทย</option>
                      <option value="ธนาคารกรุงไทย">💳 ธนาคารกรุงไทย</option>
                      <option value="ธนาคารทหารไทย">💳 ธนาคารทหารไทย</option>
                      <option value="ธนาคารไทยพาณิชย์">💳 ธนาคารไทยพาณิชย์</option>
                      <option value="ธนาคารกรุงศรีอยุธยา">💳 ธนาคารกรุงศรีอยุธยา</option>
                      <option value="ธนาคารเกียรตินาคิน">💳 ธนาคารเกียรตินาคิน</option>
                      <option value="ธนาคารซีไอเอ็มบีไทย">💳 ธนาคารซีไอเอ็มบีไทย</option>
                      <option value="ธนาคารทิสโก้">💳 ธนาคารทิสโก้</option>
                      <option value="ธนาคารธนชาต">💳 ธนาคารธนชาต</option>
                      <option value="ธนาคารยูโอบี">💳 ธนาคารยูโอบี</option>
                      <option value="ธนาคารไอซีบีซี(ไทย)">💳 ธนาคารไอซีบีซี(ไทย)</option>
                      <option value="ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร">💳 ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร</option>
                      <option value="ธนาคารออมสิน">💳 ธนาคารออมสิน</option>                  
                      <option value="ธนาคารอาคารสงเคราะห์">💳 ธนาคารอาคารสงเคราะห์</option>
                      <option value="ธนาคารอิสลามแห่งประเทศไทย">💳 ธนาคารอิสลามแห่งประเทศไทย</option>
                      <option value="ธนาคารไทยเครดิตเพื่อรายย่อย">💳 ธนาคารไทยเครดิตเพื่อรายย่อย</option>
                    </select>
                  </div>
                </div>

                <div class="col-6">
                  <div class="mb-2">
                    <label class="form-label">เลขบัญชีธนาคาร <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="empData23" name="empData23" placeholder="กรอกเลขบัญชีที่นี่">
                  </div>
                </div>

                <div class="col-6">
                  <div class="mb-2">
                    <label class="form-label">สาขาธนาคาร <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="empData25" name="empData25" placeholder="กรอกสาขาธนาคารที่นี่">
                  </div>            
                </div>

                  <div class="row">
                    <div class="col-6">
                      <div class="card Employee-card" id="cardCheckDataC" onclick="selectEmpCard('cardCheckDataC', 'empData24')">
                        <div class="card-body">
                          <input type="radio" name="empData24" id="radioCheckDataC" value="บัญชีออมทรัพย์" checked style="display:none;">
                          <h6 class="card-title" style="color: var(--box1)">💳 บัญชีออมทรัพย์</h6>
                          <p class="card-text" style="color: var(--box3); font-size: 14px;">เหมาะสำหรับการออมเงิน</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="card Employee-card" id="cardCheckDataD" onclick="selectEmpCard('cardCheckDataD', 'empData24')">
                        <div class="card-body">
                          <input type="radio" name="empData24" id="radioCheckDataD" value="บัญชีกระแสรายวัน" style="display:none;">
                          <h6 class="card-title" style="color: var(--box1)">💳 บัญชีกระแสรายวัน</h6>
                          <p class="card-text" style="color: var(--box3); font-size: 14px;">เหมาะสำหรับการโอนเงิน</p>
                        </div>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn set-button me-2" onclick="submitDataEmployee()">บันทึกข้อมูล</button>
        <button type="button" class="btn del-button" onclick="clearDataEmployee()">ยกเลิก</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="holidayModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="holidayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">📅 วันหยุด <span id="totalHolidays"></span> วัน</h5>
          <select id="selectYearModal" class="form-select" style="width: 100px;"></select>
          <button type="button" class="btn del-button" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div id="holidayList" style="max-height: 500px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setLocationsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setLocationsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🌏 Locations/สถานที่</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetLocations();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormSetLocations">
          <input type="text" class="form-control" id="dataSetLocationsKey" name="dataSetLocationsKey" hidden>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> สถานที่ <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetLocations1" name="dataSetLocations1" placeholder="กรุณากรอกสถานที่">
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> ที่อยู่ <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetLocations2" name="dataSetLocations2" placeholder="กรุณากรอกที่อยู่">
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> เมือง <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetLocations3" name="dataSetLocations3" placeholder="กรุณากรอกเมือง">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> รหัสไปรษณีย์ <span class="text-danger">*</span></label>
                <input type="number" class="form-control " id="dataSetLocations4" name="dataSetLocations4" placeholder="กรุณากรอกรหัสไปรษณีย์">
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> พิกัดละติจูด <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetLocations5" name="dataSetLocations5" placeholder="กรุณากรอกพิกัดละติจูด">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> พิกัดลองจิจูด <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetLocations6" name="dataSetLocations6" placeholder="กรุณากรอกพิกัดลองจิจูด">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetLocations()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setTimeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setTimeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🕒 Time/เวลาทำงาน</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetTime();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormSetTime">
          <input type="text" class="form-control" id="dataSetTimeKey" name="dataSetTimeKey" hidden>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> เวลาเข้างาน <span class="text-danger">*</span></label>
                <input type="time" class="form-control " id="dataSetTime1" name="dataSetTime1" placeholder="กรุณากรอกเวลาเข้างาน">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> เวลาออกงาน <span class="text-danger">*</span></label>
                <input type="time" class="form-control " id="dataSetTime2" name="dataSetTime2" placeholder="กรุณากรอกเวลาออกงาน">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetTime()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setLeaveModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setLeaveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">😷 Leave/ประเภทลา</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetLeave();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormSetLeave">
          <input type="text" class="form-control" id="dataSetLeaveKey" name="dataSetLeaveKey" hidden>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> ประเภท <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetLeave1" name="dataSetLeave1" placeholder="กรุณากรอกประเภท">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> จำนวนวัน <span class="text-danger">*</span></label>
                <input type="number" class="form-control " id="dataSetLeave2" name="dataSetLeave2" placeholder="กรุณากรอกจำนวนวัน">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetLeave()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setOTModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setOTModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🕒 OT/โอที</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetOT();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormSetOT">
          <input type="text" class="form-control" id="dataSetOTKey" name="dataSetOTKey" hidden>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> เปอร์เซ็น <span class="text-danger">*</span></label>
                <input type="number" class="form-control " id="dataSetOT1" name="dataSetOT1" placeholder="กรุณากรอกเปอร์เซ็น">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetOT()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setDayOffModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setDayOffModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🗓️ DayOff/วันหยุดพิเศษ</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetDayOff();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormSetDayOff">
          <input type="text" class="form-control" id="dataSetDayOffKey" name="dataSetDayOffKey" hidden>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> วันหยุด <span class="text-danger">*</span></label>
                <input type="date" class="form-control " id="dataSetDayOff1" name="dataSetDayOff1">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> รายละเอียด <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetDayOff2" name="dataSetDayOff2" placeholder="กรุณากรอกรายละเอียด">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetDayOff()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setWeekEndModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setWeekEndModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">📅 WeekEnd/วันทำงาน</h5>
          <button type="button" class="btn del-button" onclick="clearFormSettWeekEnd();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormWeekEnd">
          <input type="text" class="form-control" id="dataSettWeekEndKey" name="dataSettWeekEndKey" hidden>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> วันทำงาน <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSettWeekEnd1" name="dataSettWeekEnd1" placeholder="กรุณากรอกรายละเอียด">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetWeekEnd()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setSalaryModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setSalaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">💲 Salary/เงินเดือน</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetSalary();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormSalary">
          <input type="text" class="form-control" id="dataSetSalaryKey" name="dataSetSalaryKey" hidden>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> ช่วงวันที่ <span class="text-danger">*</span></label>
                <input type="date" class="form-control " id="dataSetSalary1" name="dataSetSalary1">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-1">
                <label class="control-label"> ถึงวันที่ <span class="text-danger">*</span></label>
                <input type="date" class="form-control " id="dataSetSalary2" name="dataSetSalary2" >
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> งวดที่ <span class="text-danger">*</span></label>
                <input type="number" class="form-control " id="dataSetSalary3" name="dataSetSalary3">
              </div>
            </div>
          </div>
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetSalary()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setBankModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setBankModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5">
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="text-center mt-2" style="color: var(--box3); font-weight: bold;">🏦 Bank/ธนาคารนำส่ง</h5>
          <button type="button" class="btn del-button" onclick="clearFormSetBank();">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form id="addFormBank">
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="d-flex align-items-center justify-content-center">
                  <div style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); border:3px solid white;" class="mb-3">
                    <img id="regictorBankPreview" src="https://img2.pic.in.th/pic/vsvds.png" alt="รูปประจำตัว" style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  <input type="file" name="regictorBankImg" id="regictorBankImg" style="display:none">
                </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> CodeID <span class="text-danger">*</span></label>
                <input type="number" class="form-control " id="dataSetBankKey" name="dataSetBankKey" placeholder="กรุณากรอกCodeID">
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> Bank Name (TH) <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetBank1" name="dataSetBank1" placeholder="กรุณากรอกชื่อภาษาไทย">
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <label class="control-label"> Bank Name (EN) <span class="text-danger">*</span></label>
                <input type="text" class="form-control " id="dataSetBank2" name="dataSetBank2" placeholder="กรุณากรอกชื่อภาษาอังกฤษ">
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <div class="mb-1">
                <div id="reviewdivBankCode"></div>
              </div>
            </div>
          </div>
          
        </form>
        <button type="submit" class="btn set-button w-100 mt-2" onclick="submitFormSetBank()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>
</div>

Page/00_Chatbot.html=
Page/00_Home.html =
<div class="row g-3 mt-2 mb-2">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm" style="background-image: url('https://raw.githubusercontent.com/EPICCODING17/LOGO/main/MapsGPS1.png'); background-size: cover; background-position: center;">
      <div class="card-body rounded-4">
        <div class="row">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <img id="picadmin2" src="https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png" alt="ProFile" class="rounded-circle me-2" width="100px" height="100px">
                <div>
                  <strong>รหัสพนักงาน : </strong><small id="user-show0" style="color: var(--box2);font-weight: bold;"></small><br>
                  <strong>ชื่อ นามสกุล : </strong><small id="user-show1" style="color: var(--box1);font-weight: bold;"></small><br>
                  <strong>ตำแหน่ง : </strong><small id="user-show2" style="color: var(--box3);font-weight: bold;"></small><br>
                  <strong>Level : </strong><small id="user-show3" style="color: var(--box2);font-weight: bold;"></small><br>
                  <span id="user-show4" style="display:none"></span>
                  <span id="user-show5" style="display:none"></span>
                  <a type="button" class="btn set-button me-2 mb-2 mb-md-0" data-bs-target="#NewProfileModal" data-bs-toggle="modal"><i class="fa-solid fa-circle-user"></i> โปรไฟล์</a>
                  <a type="button" class="btn del-button me-2 mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#userChangePwModal"><i class="fa-solid fa-pen-to-square"></i> รหัสผ่าน</a>
                  <a type="button" class="btn edit-button me-2 mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#NewSigModal"><i class="fa-solid fa-signature"></i> ลายเซ็น</a>
                </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex justify-content-end">
              <div class="text-end">
                <h2 id="currentdate" style="color: var(--box1);font-weight: bold;"></h2>
                <h5 id="shiftTimes" style="color: var(--box2);font-weight: bold;"></h5>
                <h5 id="location" style="color: var(--box3);font-weight: bold;"></h5>
                  <a type="button" id="select-branch-button" class="btn upload-button me-2 mb-2 mb-md-0" onclick="openBranchSelectModal()"><i class="fa-solid fa-location-dot"></i> ลงเวลา</a>
                  <button type="button" class="btn set-button me-2 mb-2 mb-md-0" onclick="openLevSelectModal();"><i class="fa-solid fa-truck-plane"></i> ลางาน</button>
                  <button type="button" class="btn edit-button me-2 mb-2 mb-md-0" data-bs-target="#rqtBodyModal" data-bs-toggle="modal"><i class="fa-solid fa-file-signature"></i> รับรอง</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-9">
    <div class="row">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm mb-2">
          <div class="card-header bg-white">
            <div class="row">
              <div class="col-12 col-md-4 mb-2 mb-md-0">📢 ข่าวสาร</div>
            </div>
          </div>
          <div class="card-body rounded-4" style="max-height: 300px; overflow-y: auto;">
            <div id="showTableNewsDB"></div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card border-0 shadow-sm mb-2">
          <div class="card-header bg-white">
            <div class="row">
              <div class="col-12">💹 สถิติการลา</div>
            </div>
          </div>
          <div class="card-body rounded-4" style="max-height: 300px;">
            <div id="chartLev" style="width: 100%; height: 300px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12 col-md-4 mb-2 mb-md-0">🗓️ ตารางวันหยุด</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <select id="yearSelect" class="form-select me-2 mb-2 mb-md-0" style="width: 100px;" onchange="updateCalendarLev()"></select>
            <select id="monthSelect" class="form-select me-2 mb-2 mb-md-0" style="width: 100px;" onchange="updateCalendarLev()"></select>
            <button type="button" class="btn set-button me-2 mb-2 mb-md-0" onclick="showHolidayModal()"><i class="fa-regular fa-calendar-days"></i> ตารางวันหยุด</button>
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="custom-table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th scope="col" rowspan="2" class="text-center">ชื่อ สกุล</th>
                  <th scope="col" id="monthHeaderLev" class="text-center">ประจำเดือน</th>
                </tr>
                <tr id="monthDaysLev">
                  <!-- จุดนี้จะแทรกข้อมูลรายเดือนอิงค์ตามวันที่ปัจจุบัน -->
                </tr>
              </thead>
              <tbody id="tableCalendarLev"></tbody>       
            </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card border-0 shadow-sm mb-1">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12 col-md-4 mb-2 mb-md-0">🗓️ ปฏิติงาน</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <select id="yearTimeAttendance" class="form-select me-2 mb-2 mb-md-0" style="width: 100px;" onchange="updateCountsCheckIN()"></select>
            <select id="monthTimeAttendance" class="form-select me-2 mb-2 mb-md-0" style="width: 100px;" onchange="updateCountsCheckIN()"></select>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="task-list task-list-1">
          <div class="task">
            <div class="icon-task">
              <i class="fa-solid fa-location-dot"></i>
            </div>
            <div class="task-details">
              <span class="task-title">ลงเวลาเข้างาน</span>
            </div>
            <div class="task-badge" id="countingCheckinA">0</div>
          </div>
        </div>

        <div class="task-list task-list-2">
          <div class="task">
            <div class="icon-task">
              <i class="fa-solid fa-check"></i>
            </div>
            <div class="task-details">
              <span class="task-title">เข้างานปกติ</span>
            </div>
            <div class="task-badge" id="countingCheckinB">0</div>
          </div>
        </div>

        <div class="task-list task-list-3">
          <div class="task">
            <div class="icon-task">
              <i class="fa-solid fa-clock"></i>
            </div>
            <div class="task-details">
              <span class="task-title">เข้างานสาย</span>
            </div>
            <div class="task-badge" id="countingCheckinC">0</div>
          </div>
        </div>

        <div class="task-list task-list-4">
          <div class="task">
            <div class="icon-task">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <div class="task-details">
              <span class="task-title">ขาดงาน</span>
            </div>
            <div class="task-badge" id="countingCheckinD">0</div>
          </div>
        </div>
      </div>
    </div>
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12">📝 ภาพรวมการลา</div>
        </div>
      </div>
      <div class="card-body">
        <div id="TableLeaveTypes"></div>
      </div>
    </div>
  </div>
</div>
<script>
const openCamera = async () => {
  try {
    const constraints = {
      video: {
        facingMode: currentFacingMode
      }
    };
    
    if (/Android/i.test(navigator.userAgent)) {
      constraints.video = {
        facingMode: currentFacingMode,
        width: { ideal: 1280, max: 1920 },
        height: { ideal: 720, max: 1080 }
      };
    }

    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById('cameraVideo');
    video.srcObject = cameraStream;

    video.addEventListener('loadedmetadata', () => {
      video.play();
    });
  } catch (err) {
    console.error('Error accessing camera:', err);
    createToast('❌ ไม่สามารถเข้าถึงกล้องได้', 0);
  }
};

const switchCamera = async () => {
  try {
    await navigator.mediaDevices.getUserMedia({ video: true });
    
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
    }

    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';

    const constraints = {
      video: {
        facingMode: { exact: currentFacingMode },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };

    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById('cameraVideo');
    video.srcObject = cameraStream;
    await video.play();
    
  } catch (err) {
    console.error('Error switching camera:', err);
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacingMode }
      });
      const video = document.getElementById('cameraVideo');
      video.srcObject = cameraStream;
      await video.play();
    } catch (fallbackErr) {
      createToast('❌ ไม่สามารถสลับกล้องได้', 0);
    }
  }
};

const stopCamera = () => {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  document.getElementById('cameraVideo').srcObject = null;
  document.getElementById('capturedImage').style.display = 'none';
  document.getElementById('cameraVideo').style.display = 'block';
  document.getElementById('captureBtn').style.display = 'block';
  document.getElementById('recaptureBtn').style.display = 'none';
  document.getElementById('cameraSection').classList.add('d-none');
  capturedImageData = null;
};

const captureImage = () => {
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('cameraCanvas');
  const capturedImage = document.getElementById('capturedImage');

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
  capturedImage.src = capturedImageData;

  video.style.display = 'none';
  capturedImage.style.display = 'block';
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('recaptureBtn').style.display = 'block';
};

const recaptureImage = () => {
  const video = document.getElementById('cameraVideo');
  const capturedImage = document.getElementById('capturedImage');

  video.style.display = 'block';
  capturedImage.style.display = 'none';
  document.getElementById('captureBtn').style.display = 'block';
  document.getElementById('recaptureBtn').style.display = 'none';
  capturedImageData = null;
};

const checkCameras = async () => {
  try {
    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
      document.getElementById('switchCameraBtn').style.display = 'block';
      return;
    }

    const devices = await navigator.mediaDevices.enumerateDevices();
    const cameras = devices.filter(device => device.kind === 'videoinput');
    const switchCameraBtn = document.getElementById('switchCameraBtn');

    if (cameras.length > 1 || /iPhone|iPad|iPod/.test(navigator.userAgent)) {
      switchCameraBtn.style.display = 'block';
    } else {
      switchCameraBtn.style.display = 'none';
    }
  } catch (err) {
    console.error('Error checking cameras:', err);
    document.getElementById('switchCameraBtn').style.display = 'block';
  }
};

let lateTime = null;
let outtime = null;

const loadShiftTimes = () => {
  if (allsetTime && allsetTime.length > 0) {
    allsetTime.forEach(row => {
      if (row[3] === "TRUE") {
        const now = new Date();
        lateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(row[1].split(':')[0]), parseInt(row[1].split(':')[1]), 0);
        outtime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(row[2].split(':')[0]), parseInt(row[2].split(':')[1]), 0);
        const shiftTimesElement = document.getElementById('shiftTimes');
        if (shiftTimesElement) {
          shiftTimesElement.innerHTML = `🕒 <span style="color: ${now >= lateTime ? 'var(--box4)' : 'inherit'};">${row[1]}</span> | 🕒 <span style="color: ${now >= outtime ? 'var(--box4)' : 'inherit'};">${row[2]}</span>`;
        } else {
          console.error("ไม่สามารถดึงข้อมูลเวลาเข้าออกงานได้");
        }
      }
    });
  }
};

const updateDateTime = () => { 
  const now = new Date();
  const options = { day: 'numeric', month: 'long', year: 'numeric' };
  const dateString = now.toLocaleDateString('th-TH', options);
  document.getElementById('currentdate').textContent = dateString;
};
setInterval(updateDateTime, 1000);

let locations = [];
let canCheckIn = false;

const getDataLocation = () => {
  google.script.run.withSuccessHandler((data) => {
    locations = data;
    checkUserLocation();
  }).getLocationCheckIn();
};

const updateLocation = (lat, lng) => {
  document.getElementById('location').textContent = `🌏 ${lat.toFixed(6)} : ${lng.toFixed(6)}`;
};

const checkUserLocation = () => { 
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((position) => {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;

      updateLocation(userLat, userLng);
      const userLatLng = L.latLng(userLat, userLng);

      if (selectedBranch) {
        const branchLatLng = L.latLng(parseFloat(selectedBranch[4]), parseFloat(selectedBranch[5]));
        const distance = userLatLng.distanceTo(branchLatLng);

        if (distance <= 250) {
          canCheckIn = true;
          createToast("✅ คุณสามารถลงเวลาได้", 1);
          document.getElementById('cameraSection').classList.remove('d-none');
          openCamera();
        } else {
          canCheckIn = false;
          const distanceToMove = (distance - 250).toFixed(2);
          createToast(`⚠️ อยู่นอกเขตพื้นที่ (อีก ${distanceToMove} เมตร)`, 3);
          stopCamera();
          document.getElementById('cameraSection').classList.add('d-none');
        }
      }
    }, (error) => {
      console.error("Error getting location: ", error);
      createToast("❌ ไม่สามารถเข้าถึงตำแหน่งของคุณได้", 0);
      stopCamera();
      document.getElementById('cameraSection').classList.add('d-none');
    });
  } else {
    createToast("❌ เบราว์เซอร์ไม่รองรับการระบุตำแหน่ง", 0);
    stopCamera();
    document.getElementById('cameraSection').classList.add('d-none');
  }
};

const isTodayDayOff = () => { 
  const today = new Date();
  const todayDayIndex = today.getDay();

  const isWeeklyDayOff = allSetWeekEnd.some(dayOff => {
    const [id, dayOfWeek, status] = dayOff;
    const dayIndexMapping = {
      'อาทิตย์': 0,
      'จันทร์': 1,
      'อังคาร': 2,
      'พุธ': 3,
      'พฤหัสบดี': 4,
      'ศุกร์': 5,
      'เสาร์': 6
    };
    return status === 'TRUE' && dayIndexMapping[dayOfWeek] === todayDayIndex;
  });

  const day = String(today.getDate()).padStart(2, '0');
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const year = today.getFullYear();
  const todayFormatted = `${day}/${month}/${year}`;
  const isSetDayOff = allSetDayOff.some(dayOff => {
    const [day, month, year] = dayOff[1].split('/');
    const formattedDayOff = `${day}/${month}/${year}`;
    return formattedDayOff === todayFormatted;
  });

  const isDayOff = isWeeklyDayOff || isSetDayOff;
  return isDayOff;
};

const submitCheckInTime = (status) => {
  event.preventDefault();

  if (!selectedBranch) {
    createToast("⚠️ กรุณาเลือกสาขาก่อนลงเวลา", 3);
    return;
  }

  if (!canCheckIn) {
    createToast("❌ คุณอยู่นอกเขตรัศมี ไม่สามารถลงเวลาได้", 0);
    return;
  }

  if (!capturedImageData) {
    createToast("⚠️ กรุณาถ่ายรูปก่อนลงเวลา", 3);
    return;
  }

  const now = new Date();
  if (status === 'เข้างาน' && now > lateTime) {
    status = 'สาย';
  } else if (status === 'ออกงาน' && now < outtime) {
    $('#SetCheckinModal').modal('show');
    $('#branchSelectModal').modal('hide');
    return;
  }

  sendCheckinData(status); 
};

const sendCheckinData = async (status) => {
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  const now = new Date();
  const today = now.toLocaleDateString("en-GB");
  const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

  const checkinuid = document.getElementById('user-show0').innerText;
  const checkinfullname = document.getElementById('user-show1').innerText;

  const obj = {
    checkinuid: checkinuid,
    checkinfullname: checkinfullname,
    checkinTime: timeString,
    status: status,
    branch: selectedBranch[0],
    ipAddress: await getIPAddress(),
    deviceId: localStorage.getItem('deviceId') || generateDeviceId(),
    imageDataUrl: capturedImageData,
    filetype: 'image/jpeg',
    filename: `checkin_${checkinuid}_${today.replace(/\//g, '')}_${timeString.replace(/:/g, '')}.jpg`,
    datacheck: capturedImageData ? "1" : ""
  };

  if (!obj.checkinuid || !obj.checkinfullname) {
    createToast("⚠️ กรุณากรอกข้อมูลให้ครบถ้วน", 3);
    $.LoadingOverlay("hide");
    return;
  }

  if (status === 'ออกงาน') {
    google.script.run.withSuccessHandler(async (res) => {
      $.LoadingOverlay("hide");
      createToast("✅ ลงเวลาออกงานสำเร็จ", 2);
      $('#branchSelectModal').modal('hide');
      stopCamera();
      updateCheckinStatus(status);
    }).userDataCheckin(obj);
    return;
  }

  const isUIDDuplicate = alltimeAttendance.some(row => {
    const [scanDate, uid] = row;
    const dateMatch = scanDate === today;
    const uidMatch = uid === obj.checkinuid;
    return dateMatch && uidMatch;
  });

  if (isUIDDuplicate) {
    $.LoadingOverlay("hide");
    createToast("⚠️ UID นี้ได้ลงเวลาในวันนี้ไปแล้ว ไม่สามารถลงเวลาได้อีก", 0);
    stopCamera();
    return;
  }

  const isDeviceDuplicate = alltimeAttendance.some(row => {
    const [scanDate, , , , , , , deviceId] = row;
    const dateMatch = scanDate === today;
    const deviceIdMatch = deviceId === obj.deviceId;
    return dateMatch && deviceIdMatch;
  });

  if (isDeviceDuplicate) {
    $.LoadingOverlay("hide");
    createToast("⚠️ อุปกรณ์นี้ได้ลงเวลาในวันนี้ไปแล้ว ไม่สามารถลงเวลาได้อีก", 0);
    stopCamera();
    return;
  }

  google.script.run.withSuccessHandler(async (res) => {
    $.LoadingOverlay("hide");
    createToast("✅ ลงเวลาสำเร็จ", 2);
    $('#branchSelectModal').modal('hide');
    stopCamera();
    updateCheckinStatus(status);
  }).userDataCheckin(obj);
};

const updateCheckinStatus = (status) => {
  const isDayOff = isTodayDayOff();
  if (status === 'เข้างาน') {
    document.getElementById('checkin-button').style.display = 'none';
    document.getElementById('ot-button').style.display = 'none';
  } else if (status === 'ออกงาน') {
    if (isDayOff) {
      document.getElementById('checkin-button').style.display = 'none';
      document.getElementById('ot-button').style.display = 'block';
    } else {
      document.getElementById('checkin-button').style.display = 'block';
      document.getElementById('ot-button').style.display = 'none';
    }
  } else if (status === 'OT') {
    document.getElementById('checkin-button').style.display = 'none';
    document.getElementById('ot-button').style.display = 'block';
  }
  document.querySelectorAll('.leavelist-item').forEach(item => item.classList.remove('selected'));
  selectedBranch = null;
  document.getElementById('cameraSection').classList.add('d-none');
  loadCheckinStatus();
};

const confirmSetCheckin = () => {
  $('#SetCheckinModal').modal('hide');
  sendCheckinData('ออกงาน');
};

const closeSetCheckin = () => {
  $('#SetCheckinModal').modal('hide');
  $('#branchSelectModal').modal('show');
};

const loadCheckinStatus = () => { 
  const isDayOff = isTodayDayOff(); 

  const checkinButton = document.getElementById('checkin-button');
  const otButton = document.getElementById('ot-button');

  if (isDayOff) {
    checkinButton.style.display = 'none';
    otButton.style.display = 'block';
  } else {
    checkinButton.style.display = 'block';
    otButton.style.display = 'none';
  }

  document.getElementById('cameraSection').classList.add('d-none');
};

const loadLeaveTypes = () => {
  if (allsetLeave.length === 0) return;

  const leaveContainer = document.getElementById('TableLeaveTypes');
  leaveContainer.innerHTML = '';
  
  allsetLeave.forEach(row => {
    const id = row[0];
    const type = row[1];
    const amount = parseInt(row[2]);
    const status = row[3];

    if (status === 'TRUE') {
      let userLeaves = allleave.filter(leave => leave[3] === leaveUserUID && leave[8] === type && leave[1] === 'อนุมัติ');
      let totalHours = userLeaves.reduce((total, leave) => total + (parseInt(leave[13]) * 24) + parseInt(leave[14]), 0);
      let usedDays = Math.floor(totalHours / 24);
      let remaining = amount - usedDays;
      let percentage = (usedDays / amount) * 100;

      let imgLeaveTypes = '';
      switch (type) {
        case 'ลาป่วยมีใบรับรองแพทย์':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/bed-leave.png';
          break;
        case 'ลาป่วยไม่มีใบรับรองแพทย์':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/fever-leave.png';
          break;
        case 'ลากิจจำเป็น':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/leave.png';
          break;
        case 'ลากิจทั่วไป':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/training-leave.png';
          break;
        case 'ลาพักร้อน':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/beach-chair-leave.png';
          break;
        case 'ลาบวช':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/monk-leave.png';
          break;
        case 'ลาคลอด':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/mother-leave.png';
          break;
        case 'ลารับราชการทหาร':
          imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/soldier-leave.png';
          break;
        default:
          imgLeaveTypes = 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';
      }

      const leaveItem = `
        <div class="user-item-set d-flex align-items-center mb-2" data-leavetype="${type}" onclick="selectLeaveType('${type}', this)">
          <img src="${imgLeaveTypes}" alt="${type}" class="me-2" width="40" height="40">
          <div class="leave-info d-flex flex-column w-100">
            <div class="d-flex justify-content-between align-items-center">
              <strong>${type}</strong>
            </div>
            <small>จำนวนการลา ${usedDays}/${amount} วัน</small>
            <div class="progress-Set mt-1">
              <div class="progress-bar-Set" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>
      `;
      leaveContainer.insertAdjacentHTML('beforeend', leaveItem);
    }
  });
}

const monthsLev = [
  "มกราคม",
  "กุมภาพันธ์",
  "มีนาคม",
  "เมษายน",
  "พฤษภาคม",
  "มิถุนายน",
  "กรกฎาคม",
  "สิงหาคม",
  "กันยายน",
  "ตุลาคม",
  "พฤศจิกายน",
  "ธันวาคม",
];
const daysOfWeekLev = ["อา", "จ", "อ", "พ", "พฤ", "ศ", "ส"];
const currentYear = new Date().getFullYear();
const currentMonth = new Date().getMonth();
const years = [];
for (let i = currentYear; i <= currentYear + 3; i++) {
  years.push(i);
}

document.getElementById("yearSelect").innerHTML = years
  .map((year) => `<option value="${year}" ${year == currentYear ? 'selected' : ''}>${year}</option>`) 
  .join("");

document.getElementById("monthSelect").innerHTML = monthsLev
  .map((month, index) => `<option value="${index}" ${index == currentMonth ? 'selected' : ''}>${month}</option>`) 
  .join("");

document.getElementById("yearTimeAttendance").innerHTML = years
  .map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`)
  .join("");

document.getElementById("monthTimeAttendance").innerHTML = monthsLev
  .map((month, index) => `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${month}</option>`)
  .join("");

const updateCalendarLev = () => {
  const year = document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").value;
  filterAndRenderCalendarLev(year, month);
};

const filterAndRenderCalendarLev = (year, month) => {
  const filteredData = allCalendarLev.filter((row) => {
    const startDateTime = new Date(row[11]);
    const endDateTime = new Date(row[12]);
    const start = new Date(startDateTime.getFullYear(), startDateTime.getMonth(), startDateTime.getDate());
    const end = new Date(endDateTime.getFullYear(), endDateTime.getMonth(), endDateTime.getDate());
    return (start.getFullYear() == year && start.getMonth() == month) || (end.getFullYear() == year && end.getMonth() == month);
  });
  renderCalendarLev(filteredData);
};

// const renderCalendarLev = (data) => {
//   const year = document.getElementById("yearSelect").value;
//   const month = document.getElementById("monthSelect").value;
//   const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();

//   let monthHeaderHtml = `<th id="monthHeaderLev" scope="col" class="text-center" colspan="${daysInMonth + 4}">ประจำเดือน ${monthsLev[month]}</th>`;
//   document.getElementById("monthHeaderLev").outerHTML = monthHeaderHtml;

//   let dayHeadersHtml = "";
//   for (let i = 1; i <= daysInMonth; i++) {
//     const day = new Date(year, month, i).getDay();
//     const isWeekend = day === 0 || day === 6;
//     dayHeadersHtml += `<th scope="col" class="text-center ${isWeekend ? 'bg-danger-subtle' : ''}">${i}<br><span class="text-dark">${daysOfWeekLev[day]}</span></th>`;
//   }
//   document.getElementById("monthDaysLev").innerHTML = dayHeadersHtml;

//   const tableBody = document.getElementById("tableCalendarLev");
//   tableBody.innerHTML = "";

//   if (data.length === 0) {
//     tableBody.innerHTML = `<tr><td colspan='${daysInMonth + 4}' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td></tr>`;
//     return;
//   }

//   data.sort((a, b) => {
//     const numA = parseInt(a[3].replace('USER-', ''));
//     const numB = parseInt(b[3].replace('USER-', ''));
//     return numA - numB;
//   });

//   const uniqueUsers = Array.from(new Set(data.map(row => row[3])));
//   uniqueUsers.forEach((userId, index) => {
//     const userLeaves = data.filter(row => row[3] === userId);
//     const firstRow = userLeaves[0];
//     let user = dataUsers && dataUsers.find(user => user[0] === firstRow[3]);
//     let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';
//     let rowHtml = `
//     <tr>
//       <td>
//         <div style="display: flex; align-items: center;">
//           <img src="${userImage}" alt="ImageUsers" width="30" style="margin-right: 10px;" style="border-radius: 50%;">
//           <div style="font-size: 14px;">
//             <span>UID: ${firstRow[3]}</span><br>
//             <span>ชื่อ: ${firstRow[4]}</span><br>
//             <span>ตำแหน่ง: ${firstRow[5]}</span>
//           </div>
//         </div>
//       </td>
//     `;
//     for (let i = 1; i <= daysInMonth; i++) {
//       const day = new Date(year, month, i);
//       const isWeekend = day.getDay() === 0 || day.getDay() === 6;
//       let leaveStatus = `<span class='badge bg-light text-muted'>-</span>`;
//       userLeaves.forEach((row) => {
//         const startDateTime = new Date(row[11]);
//         const endDateTime = new Date(row[12]);
//         const start = new Date(startDateTime.getFullYear(), startDateTime.getMonth(), startDateTime.getDate());
//         const end = new Date(endDateTime.getFullYear(), endDateTime.getMonth(), endDateTime.getDate());
//         if (day >= start && day <= end) {
//           let currentLeaveStatus = "";
//           switch (row[8]) {
//             case "ลาป่วยมีใบรับรองแพทย์":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ป</span>`;
//               break;
//             case "ลาป่วยไม่มีใบรับรองแพทย์":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ป*</span>`;
//               break;
//             case "ลากิจทั่วไป":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ก</span>`;
//               break;
//             case "ลากิจจำเป็น":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">จ</span>`;
//               break;
//             case "ลาพักร้อน":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">พ</span>`;
//               break;
//             case "ลาบวช":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">บ</span>`;
//               break;
//             case "ลาคลอด":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ค</span>`;
//               break;
//             case "ลารับราชการทหาร":
//               currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ท</span>`;
//               break;
//           }
//           if (leaveStatus.includes('text-muted')) {
//             leaveStatus = currentLeaveStatus;
//           } else {
//             leaveStatus += "<br>" + currentLeaveStatus;
//           }
//         }
//       });
//       rowHtml += `<td class="text-center ${isWeekend ? 'bg-danger-subtle' : ''}">${leaveStatus}</td>`;
//     }
//     rowHtml += `</tr>`;
//     tableBody.innerHTML += rowHtml;
//   });
// };

const renderCalendarLev = (data) => {
  const year = document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").value;
  const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();

  let monthHeaderHtml = `<th id="monthHeaderLev" scope="col" class="text-center" colspan="${daysInMonth + 4}">ประจำเดือน ${monthsLev[month]}</th>`;
  document.getElementById("monthHeaderLev").outerHTML = monthHeaderHtml;

  let dayHeadersHtml = "";
  for (let i = 1; i <= daysInMonth; i++) {
    const day = new Date(year, month, i).getDay();
    const isWeekend = day === 0 || day === 6;
    dayHeadersHtml += `<th scope="col" class="text-center ${isWeekend ? 'bg-danger-subtle' : ''}">${i}<br><span class="text-dark">${daysOfWeekLev[day]}</span></th>`;
  }
  document.getElementById("monthDaysLev").innerHTML = dayHeadersHtml;

  const tableBody = document.getElementById("tableCalendarLev");
  tableBody.innerHTML = "";

  if (data.length === 0) {
    tableBody.innerHTML = `<tr><td colspan='${daysInMonth + 4}' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td></tr>`;
    return;
  }

  data.sort((a, b) => {
    const numA = parseInt(a[3].replace('USER-', ''));
    const numB = parseInt(b[3].replace('USER-', ''));
    return numA - numB;
  });

  const uniqueUsers = Array.from(new Set(data.map(row => row[3])));
  uniqueUsers.forEach((userId, index) => {
    const userLeaves = data.filter(row => row[3] === userId);
    const firstRow = userLeaves[0];
    let user = dataUsers && dataUsers.find(user => user[0] === firstRow[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';
    let rowHtml = `
    <tr>
      <td>
        <div style="display: flex; align-items: center;">
          <img src="${userImage}" alt="ImageUsers" width="30" style="margin-right: 10px;" style="border-radius: 50%;">
          <div style="font-size: 14px;">
            <span>UID: ${firstRow[3]}</span><br>
            <span>ชื่อ: ${firstRow[4]}</span><br>
            <span>ตำแหน่ง: ${firstRow[5]}</span>
          </div>
        </div>
      </td>
    `;
    for (let i = 1; i <= daysInMonth; i++) {
      const day = new Date(year, month, i);
      const isWeekend = day.getDay() === 0 || day.getDay() === 6;
      let leaveStatus = `<span class='badge bg-light text-muted'>-</span>`;
      
      userLeaves.forEach((row) => {
        const startDateTime = new Date(row[11]);
        const totalDays = parseInt(row[13]); // จำนวนวันลารวม
        
        // วนลูปตามจำนวนวันที่ลา
        for(let leaveDay = 0; leaveDay < totalDays; leaveDay++) {
          const currentLeaveDate = new Date(startDateTime);
          currentLeaveDate.setDate(startDateTime.getDate() + leaveDay);
          
          // เปรียบเทียบวันที่
          if (
            day.getFullYear() === currentLeaveDate.getFullYear() &&
            day.getMonth() === currentLeaveDate.getMonth() &&
            day.getDate() === currentLeaveDate.getDate()
          ) {
            let currentLeaveStatus = "";
            switch (row[8]) {
              case "ลาป่วยมีใบรับรองแพทย์":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ป</span>`;
                break;
              case "ลาป่วยไม่มีใบรับรองแพทย์":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ป*</span>`;
                break;
              case "ลากิจทั่วไป":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ก</span>`;
                break;
              case "ลากิจจำเป็น":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">จ</span>`;
                break;
              case "ลาพักร้อน":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">พ</span>`;
                break;
              case "ลาบวช":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">บ</span>`;
                break;
              case "ลาคลอด":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ค</span>`;
                break;
              case "ลารับราชการทหาร":
                currentLeaveStatus = `<span class="badge" style="background-color: ${row[1] === 'อนุมัติ' ? 'var(--box2)' : row[1] === 'รอตรวจสอบ' ? 'var(--box3)' : 'var(--box4)'}">ท</span>`;
                break;
              default:
                currentLeaveStatus = `<span class="badge" style="background-color: var(--box4)">อ</span>`;
                break;
            }
            if (leaveStatus.includes('text-muted')) {
              leaveStatus = currentLeaveStatus;
            } else {
              leaveStatus += "<br>" + currentLeaveStatus;
            }
          }
        }
      });
      rowHtml += `<td class="text-center ${isWeekend ? 'bg-danger-subtle' : ''}">${leaveStatus}</td>`;
    }
    rowHtml += `</tr>`;
    tableBody.innerHTML += rowHtml;
  });
};

const updateCountsCheckIN = () => {
  const selectedYear = parseInt(document.getElementById("yearTimeAttendance").value);
  const selectedMonth = parseInt(document.getElementById("monthTimeAttendance").value);

  const useruid = alltimeAttendance.filter(row => {
    const [day, month, year] = row[0].split("/").map(Number);
    return (
      row[1] === leaveUserUID &&
      year === selectedYear &&
      month - 1 === selectedMonth
    );
  });

  const countingCheckinA = useruid.length;

  const standardTimeEntry = allsetTime.find(row => row[3] === "TRUE");
  const standardCheckinTime = standardTimeEntry ? standardTimeEntry[1] : null;

  if (!standardCheckinTime) {
    console.error("ไม่พบค่าเวลาเช็คอินมาตรฐานใน allsetTime");
    return;
  }

  const isOnTime = (checkInTime, standardTime) => {
    const [checkInHours, checkInMinutes] = checkInTime.split(":").map(Number);
    const [standardHours, standardMinutes] = standardTime.split(":").map(Number);
    return (
      checkInHours < standardHours ||
      (checkInHours === standardHours && checkInMinutes <= standardMinutes)
    );
  };

  const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();

  // สร้างรายการวันที่สำหรับวันหยุดสุดสัปดาห์
  const allSetWeekEndDates = [];
  const startDate = new Date(selectedYear, selectedMonth, 1);
  const endDate = new Date(selectedYear, selectedMonth, daysInMonth);

  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const dayOfWeek = d.getDay();
    const isWeekendDayOff = allSetWeekEnd.some(dayOff => {
      const [id, dayName, status] = dayOff;
      return status === 'TRUE' && dayName === ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'][dayOfWeek];
    });
    if (isWeekendDayOff) allSetWeekEndDates.push(new Date(d));
  }

  // สร้างรายการวันที่สำหรับวันหยุดพิเศษ
  const allSetDayOffDates = allSetDayOff.map(dayOff => new Date(dayOff[1].split("/").reverse().join("-")));

  // ฟังก์ชันตรวจสอบว่าเป็นวันหยุดหรือไม่ (ทั้งวันหยุดสุดสัปดาห์และวันหยุดพิเศษ)
  const isHoliday = date => {
    const isWeekend = allSetWeekEndDates.some(weekendDate => 
      weekendDate.getDate() === date.getDate() &&
      weekendDate.getMonth() === date.getMonth() &&
      weekendDate.getFullYear() === date.getFullYear()
    );
    const isSpecialDayOff = allSetDayOffDates.some(dayOffDate =>
      dayOffDate.getDate() === date.getDate() &&
      dayOffDate.getMonth() === date.getMonth() &&
      dayOffDate.getFullYear() === date.getFullYear()
    );
    return isWeekend || isSpecialDayOff;
  };

  // กำหนดเงื่อนไขให้การเข้างานในวันหยุดนับเป็นการเข้างานปกติ
  const countingCheckinB = useruid.filter(row => {
    const checkInDate = new Date(selectedYear, selectedMonth, parseInt(row[0].split("/")[0]));
    return isHoliday(checkInDate) || isOnTime(row[3], standardCheckinTime);
  }).length;

  // กำหนดการเข้างานสายโดยไม่นับรวมวันหยุด
  const countingCheckinC = useruid.filter(row => {
    const checkInDate = new Date(selectedYear, selectedMonth, parseInt(row[0].split("/")[0]));
    return !isHoliday(checkInDate) && !isOnTime(row[3], standardCheckinTime);
  }).length;

  const today = new Date();
  const absentDays = Array.from({ length: daysInMonth }, (_, i) => i + 1).filter(day => {
    const date = new Date(selectedYear, selectedMonth, day);

    // ถ้าวันที่ในเดือนปัจจุบันยังไม่ถึงวันนี้ ก็ไม่ต้องนับขาดงาน
    if (date > today) return false;

    // ตรวจสอบว่าวันนี้เป็นวันหยุดหรือไม่
    return !isHoliday(date) && !useruid.some(row => parseInt(row[0].split("/")[0]) === day);
  });

  const countingCheckinD = absentDays.length;

  document.getElementById('countingCheckinA').innerText = countingCheckinA;
  document.getElementById('countingCheckinB').innerText = countingCheckinB;
  document.getElementById('countingCheckinC').innerText = countingCheckinC;
  document.getElementById('countingCheckinD').innerText = countingCheckinD;
}

const showHolidayModal = () => {
  $('#holidayModal').modal('show');

  const holidayList = $('#holidayList');
  holidayList.empty();
  const selectedYear = parseInt(document.getElementById("selectYearModal").value);
  const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
  const thaiDays = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];

  const groupedHolidays = {};

  // กรองข้อมูลตามปีที่เลือก
  allSetDayOff.forEach(row => {
    const holidayDateStr = row[1];  // วันที่ในรูปแบบ "DD/MM/YYYY"
    const description = row[2];  // รายละเอียดวันหยุด

    // แยกวัน เดือน ปีจาก holidayDateStr
    const [day, month, year] = holidayDateStr.split('/').map(Number);
    if (!day || !month || !year || year !== selectedYear) return;  // ข้ามถ้าไม่มีข้อมูลครบหรือปีไม่ตรงกับที่เลือก

    // สร้าง Date Object
    const date = new Date(year, month - 1, day);
    const monthIndex = date.getMonth();
    const dayOfWeek = date.getDay();

    if (!groupedHolidays[monthIndex]) {
      groupedHolidays[monthIndex] = [];
    }
    groupedHolidays[monthIndex].push({
      day: day,
      dayName: thaiDays[dayOfWeek],
      name: description,
    });
  });

  let totalHolidays = 0;

  // ตรวจสอบว่ามีวันหยุดหรือไม่
  if (Object.keys(groupedHolidays).length === 0) {
    holidayList.append('<h5 class="text-center mt-2" style="color: var(--box4); font-weight: bold;">❌ ไม่พบข้อมูลวันหยุดพิเศษ</h5>');
  } else {
    // แสดงรายการวันหยุด
    $.each(groupedHolidays, (monthIndex, monthHolidays) => {
      const monthName = thaiMonths[parseInt(monthIndex)];

      const monthGroup = $(`
        <div class="holiday-group">
          <h4>ประจำเดือน${monthName}</h4>
        </div>
      `);

      monthHolidays.forEach(holiday => {
        const holidayItem = $(`
          <div class="holiday-item">
            <div class="holiday-date">${holiday.day}</div>
            <div class="holiday-details">
              <div class="day">${holiday.dayName}</div>
              <div class="name">${holiday.name}</div>
            </div>
          </div>
        `);
        monthGroup.append(holidayItem);
      });

      holidayList.append(monthGroup);
      totalHolidays += monthHolidays.length;
    });
  }

  $('#totalHolidays').text(totalHolidays);
};

const insertChartLev = () => {
  let leaveCounts = new Map([
    ["ลาป่วยมีใบรับรองแพทย์", 0],
    ["ลาป่วยไม่มีใบรับรองแพทย์", 0],
    ["ลากิจจำเป็น", 0],
    ["ลากิจทั่วไป", 0],
    ["ลาพักร้อน", 0],
    ["ลาบวช", 0],
    ["ลาคลอด", 0],
    ["ลารับราชการทหาร", 0]
  ]);

  const colors = ['#3c8cf3', '#05be8a', '#745af2', '#ef5350', '#f39c12', '#00a65a', '#d2d6de', '#d81b60'];

  const userLeaves = allleave.filter(item => item[3] === leaveUserUID);

  userLeaves.forEach((item) => {
    let leaveType = item[8];
    if (leaveCounts.has(leaveType)) {
      leaveCounts.set(leaveType, leaveCounts.get(leaveType) + 1);
    }
  });

  let seriesData = Array.from(leaveCounts.values());
  let categories = Array.from(leaveCounts.keys());

  var options = {
    series: seriesData,
    chart: {
      height: 280,
      type: 'pie'
    },
    labels: categories,
    colors: colors,
    dataLabels: {
      enabled: true
    },
    tooltip: {
      y: {
        formatter: function (val) {
          return val + " ครั้ง";
        }
      }
    },
    fill: {
      colors: colors,
    }
  };

  // ตรวจสอบและลบกราฟเก่าถ้ามี
  const chartElement = document.querySelector("#chartLev");
  if (chartElement.innerHTML) {
    chartElement.innerHTML = "";
  }

  var chart = new ApexCharts(chartElement, options);
  chart.render();
};
</script>

Page/01_leaveReqBody.html =
<div class="row g-3 mt-2">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-4 mb-2 mb-md-0">📝 ข้อมูลการลาพนักงาน</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
          <select class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" onchange="updateItemsLeave(this.value)">
            <option value="10">✅ 10</option>
            <option value="20">✅ 25</option>
            <option value="50">✅ 50</option>
            <option value="100">✅ 100</option>
            <option value="all">✅ ทั้งหมด</option>
          </select>
            <input type="search" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" id="searchLeave" placeholder="🔍ค้นหาข้อมูล..." oninput="filterLeave()">
            <button type="button" class="btn upload-button" id="appLev-button" onclick="openLeaveApprovalModal()" style="display:none"><i class="fa-solid fa-pen-to-square"></i> อนุมัติการลางาน <span class="badge del-button" id="countingLeave">0</span></button>
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">#</th>
                <th scope="col" class="text-center">ชื่อพนักงาน</th>
                <th scope="col" class="text-center" style="width: 400px;">ประเภท</th>
                <th scope="col" class="text-center">วันที่</th>
                <th scope="col" class="text-center" style="width: 350px;">ผู้ตรวจสอบ</th>
                <th scope="col" class="text-center">ไฟล์</th>
                <th scope="col" class="text-center">สถานะ</th>
                <th scope="col" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody id="tableLeave">
              <tr>
                <td colspan='8' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>
              </tr>
            </tbody>       
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationLeaveInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationLeave" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let filteredLeave = [];
let currentLeave = 1;
let itemsPerLeave = 10;

const renderDataLeave = (res) => {
  const table = document.getElementById('tableLeave');
  table.innerHTML = '';

  const uidMember = localStorage.getItem('uiduser');
  const userLevel = localStorage.getItem('level');

  if (userLevel === 'SuperAdmin' || userLevel === 'Admin') {
    filteredLeave = res;
  } else {
    filteredLeave = res.filter(row => row[3] === uidMember);
  }

  filteredLeave.sort((a, b) => {
    if (a[1] === 'รอตรวจสอบ' && b[1] !== 'รอตรวจสอบ') return -1;
    if (a[1] !== 'รอตรวจสอบ' && b[1] === 'รอตรวจสอบ') return 1;

    const numA = parseInt(a[0].replace('LEV', ''));
    const numB = parseInt(b[0].replace('LEV', ''));
    return numB - numA;
  });

  const startIndex = (currentLeave - 1) * itemsPerLeave;
  const endIndex = startIndex + itemsPerLeave;
  const lev = filteredLeave.slice(startIndex, endIndex);

  const startRow = startIndex + 1;
  const endRow = startIndex + lev.length;
  const totalRows = filteredLeave.length;

  document.getElementById('paginationLeaveInfo').innerText = `แสดง ${startRow} ถึง ${endRow} จาก ${totalRows} แถว`;

  if (lev.length === 0) {
    const row = table.insertRow();
    row.innerHTML = `<td colspan='8' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>`;
    return;
  }

  lev.forEach((rowIndex, index) => {
    const checkrowIndex = [rowIndex[15], rowIndex[16], rowIndex[17], rowIndex[18]];
    const filledFields = checkrowIndex.filter(field => field && field.trim() !== '').length;
    const progressbar = Math.round((filledFields / checkrowIndex.length) * 100);
    const progressAngle = progressbar * 3.6;

    let progressColor;
    let buttonClass = 'upload-button';
    if (progressbar <= 25) {
      progressColor = 'var(--box4)';
      buttonClass = 'del-button';
    } else if (progressbar <= 50) {
      progressColor = 'var(--box3)';
      buttonClass = 'edit-button';
    } else if (progressbar <= 75) {
      progressColor = 'var(--box1)';
      buttonClass = 'set-button';
    } else {
      progressColor = 'var(--box2)';
      buttonClass = 'upload-button';
    }

    let leaveMenuItem;
    if (rowIndex[1] === 'อนุมัติ') {
      leaveMenuItem = `<li><a class="dropdown-item hover-highlight" onclick="sendLeave('${rowIndex[0]}')"><i class="fa-regular fa-paper-plane"></i> อนุมัติใบลา</a></li>`;
    } else {
      leaveMenuItem = `<li><a class="dropdown-item hover-highlight" onclick="sendLeave('${rowIndex[0]}')"><i class="fa-regular fa-circle-xmark"></i> ไม่อนุมัติใบลา</a></li>`;
    }

    let statusImage;
    if (rowIndex[10].trim() !== "") {
      statusImage = `<a type="button" href="${rowIndex[10]}" target="_blank" class="btn btn-sm upload-button">✅ ใบรับรอง</a>`;
    } else {
      statusImage = `<a type="button" class="btn btn-sm del-button">❌ ไม่พบไฟล์</a>`;
    }

    let imgLeaveTypes = '';
    switch (rowIndex[8]) {
      case 'ลาป่วยมีใบรับรองแพทย์':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/bed-leave.png';
        break;
      case 'ลาป่วยไม่มีใบรับรองแพทย์':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/fever-leave.png';
        break;
      case 'ลากิจจำเป็น':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/leave.png';
        break;
      case 'ลากิจทั่วไป':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/training-leave.png';
        break;
      case 'ลาพักร้อน':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/beach-chair-leave.png';
        break;
      case 'ลาบวช':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/monk-leave.png';
        break;
      case 'ลาคลอด':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/mother-leave.png';
        break;
      case 'ลารับราชการทหาร':
        imgLeaveTypes = 'https://raw.githubusercontent.com/EPICCODING17/Icons/main/soldier-leave.png';
        break;
      default:
        imgLeaveTypes = 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';
    }

    let user = dataUsers && dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';

    var row = table.insertRow();
    row.innerHTML = `
    <td class="text-center"><span style="font-size: 14px;">${startIndex + index + 1}</span></td>
    <td>
      <div style="display: flex; align-items: center;">
        <img class="rounded-circle" src="${userImage ? userImage : '❌ N/A'}" alt="ImageUsers" width="40" style="margin-right: 10px;">
        <div style="font-size: 14px;">
          <span>ชื่อ สกุล: ${rowIndex[4] ? rowIndex[4] : '❌ N/A'}</span><br>
          <span>ตำแหน่ง: ${rowIndex[5] ? rowIndex[5] : '❌ N/A'}</span><br>
          <span>แผนก: ${rowIndex[6] ? rowIndex[6] : '❌ N/A'}</span>
        </div>
      </div>
    </td>
    <td>
      <div style="display: flex; align-items: center;">
        <img class="rounded-circle" src="${imgLeaveTypes ? imgLeaveTypes : '❌ N/A'}" alt="ImageUsers" width="40" style="margin-right: 10px;">
        <div style="font-size: 14px;">
          <span>การลางาน: ${rowIndex[8] ? rowIndex[8] : '❌ N/A'}</span><br>
          <span>รายละเอียด: ${rowIndex[9] ? rowIndex[9] : '❌ N/A'}</span>
        </div>
      </div>
    </td>
    <td>
      <span style="font-size: 14px;">วันที่เริ่มต้น: ${rowIndex[11] ? rowIndex[11] : '❌ N/A'}</span><br>
      <span style="font-size: 14px;">วันที่สิ้นสุด: ${rowIndex[12] ? rowIndex[12] : '❌ N/A'}</span>
    </td>
    <td>
      <span style="font-size: 14px;">ผู้อนุมัติ: ${rowIndex[15] ? rowIndex[15] : '❌ N/A'}</span><br>
      <span style="font-size: 14px;">ความเห็น: ${rowIndex[16] ? rowIndex[16] : '❌ N/A'} วันที่: ${rowIndex[17] ? rowIndex[17] : '❌ N/A'}</span>
    </td>
    <td class="text-center" style="vertical-align: middle;">
      <div style="display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 14px;">${statusImage}</span>
      </div>
    </td>
    <td class="text-center" style="vertical-align: middle;">
      <div style="display: flex; align-items: center; justify-content: center;">
        <div class="circular-progress" style="--progress-color: ${progressColor}; --progress-angle: ${progressAngle}deg;">
          <span class="progress-value">${progressbar}%</span>
        </div>
      </div>
    </td>
    <td class="text-center" style="vertical-align: middle;">
      <div style="display: flex; align-items: center; justify-content: center;">
        <select class="form-control me-2" style="font-size: 14px; width: auto;" disabled>
          <option value="รอตรวจสอบ" ${rowIndex[1] === 'รอตรวจสอบ' ? 'selected' : ''}>⌛ รอตรวจสอบ</option>
          <option value="ไม่อนุมัติ" ${rowIndex[1] === 'ไม่อนุมัติ' ? 'selected' : ''}>❌ ไม่อนุมัติ</option>
          <option value="ยกเลิก" ${rowIndex[1] === 'ยกเลิก' ? 'selected' : ''}>❌ ยกเลิก</option>
          <option value="อนุมัติ" ${rowIndex[1] === 'อนุมัติ' ? 'selected' : ''}>✅ อนุมัติ</option>
        </select>
        <div class="dropdown">
          <button class="btn btn-sm del-button dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-ellipsis"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item hover-highlight" onclick="editLeave('${rowIndex[0]}')"><i class="fa-solid fa-pen-to-square"></i> แก้ไขรายการ</a></li>
            <li><a class="dropdown-item hover-highlight" onclick="delLeave('${rowIndex[0]}')"><i class="fa-solid fa-trash-can"></i> ลบรายการ</a></li>
            ${leaveMenuItem}
          </ul>
        </div>
      </div>
    </td>
    `;
  });
}

const renderPageDataLeave = () => {
  const totalItems = filteredLeave.length;
  const totalPages = Math.ceil(totalItems / itemsPerLeave);
  const paginationContainer = document.getElementById('paginationLeave');
  paginationContainer.innerHTML = '';

  if (totalPages > 1) {
    const createPageButton = (text, page, isDisabled = false, isActive = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
      const button = document.createElement('button');
      button.className = 'page-link';
      button.innerText = text;
      button.onclick = () => {
        if (!isDisabled) {
          currentLeave = page;
          renderDataLeave(filteredLeave);
          renderPageDataLeave();
        }
      };
      li.appendChild(button);
      return li;
    };

    paginationContainer.appendChild(createPageButton('ย้อนกลับ', currentLeave - 1, currentLeave === 1));

    if (currentLeave > 2) {
      paginationContainer.appendChild(createPageButton(1, 1, false, currentLeave === 1));
      if (currentLeave > 3) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
    }

    paginationContainer.appendChild(createPageButton(currentLeave, currentLeave, false, true));

    if (currentLeave < totalPages - 1) {
      if (currentLeave < totalPages - 2) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
      paginationContainer.appendChild(createPageButton(totalPages, totalPages, false, currentLeave === totalPages));
    }
    paginationContainer.appendChild(createPageButton('ถัดไป', currentLeave + 1, currentLeave === totalPages));
  }
}

const filterLeave = () => {
  const query = document.getElementById('searchLeave').value.toLowerCase();
  const uidMember = localStorage.getItem('uiduser');
  const userLevel = localStorage.getItem('level');

  if (userLevel === 'SuperAdmin' || userLevel === 'Admin') {
    filteredLeave = allleave.filter(row => row.some(column => column.toLowerCase().includes(query)));
  } else {
    filteredLeave = allleave.filter(row => row[3] === uidMember && row.some(column => column.toLowerCase().includes(query)));
  }

  currentLeave = 1;
  renderDataLeave(filteredLeave);
  renderPageDataLeave();
}

const updateItemsLeave = (value) => {
  if (value === "all") {
    itemsPerLeave = filteredLeave.length;
  } else {
    itemsPerLeave = parseInt(value, 10);
  }

  currentLeave = 1;
  renderDataLeave(filteredLeave);
  renderPageDataLeave();
}

const updateCountsLeave = (data) => {
  const countingLeave = data.filter(row => row[1] === "รอตรวจสอบ").length;
  document.getElementById('countingLeave').innerText = countingLeave;
}

const handleLeaveStartDateChange = () => {
  const leaveEndDate = document.getElementById('leaveData4');
  leaveEndDate.value = '';
  calculateLeave();
};

const handleLeaveEndDateChange = () => {
  const fullDaySwitch = document.getElementById('fullDaySwitch');
  if (fullDaySwitch && fullDaySwitch.checked) {
    calculateLeave();
  }
};

const setMinDateLeave = () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('leaveData3').setAttribute('min', today);
  document.getElementById('leaveData4').setAttribute('min', today);
};

const toggleFullDayLeave = () => { 
  const fullDaySwitch = document.getElementById('fullDaySwitch');
  const morningSwitch = document.getElementById('morningHalfDaySwitch');
  const afternoonSwitch = document.getElementById('afternoonHalfDaySwitch');
  const levStartDate = document.getElementById('leaveData3').value;

  if (fullDaySwitch.checked) {
    morningSwitch.checked = false;
    afternoonSwitch.checked = false;
    if (!levStartDate) {
      createToast("⚠️ เกิดข้อผิดพลาด กรุณาเลือกวันที่เริ่มต้น", 3);
      fullDaySwitch.checked = false;
      return;
    }
    const startDate = new Date(levStartDate);

    document.getElementById('leaveData3').value = startDate.toISOString().split('T')[0] + "T00:00";

    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 1);
    document.getElementById('leaveData4').value = endDate.toISOString().split('T')[0] + "T00:00";
  } else {
    document.getElementById('leaveData4').value = '';
  }
  calculateLeave();
};

const toggleMorningHalfDayLeave = () => {
  const morningSwitch = document.getElementById('morningHalfDaySwitch');
  const afternoonSwitch = document.getElementById('afternoonHalfDaySwitch');
  const fullDaySwitch = document.getElementById('fullDaySwitch');
  const levStartDate = document.getElementById('leaveData3').value;

  if (morningSwitch.checked) {
    afternoonSwitch.checked = false;
    fullDaySwitch.checked = false;
    if (!levStartDate) {
      createToast("⚠️ เกิดข้อผิดพลาด กรุณาเลือกวันที่เริ่มต้น", 3);
      morningSwitch.checked = false;
      return;
    }
    document.getElementById('leaveData3').value = levStartDate.split('T')[0] + "T00:00"; // เก็บวันที่และเวลาตอนเช้าไว้
    document.getElementById('leaveData4').value = levStartDate.split('T')[0] + "T12:00";
  } else {
    document.getElementById('leaveData4').value = '';
  }
  calculateLeave();
};

const toggleAfternoonHalfDayLeave = () => {
  const afternoonSwitch = document.getElementById('afternoonHalfDaySwitch');
  const morningSwitch = document.getElementById('morningHalfDaySwitch');
  const fullDaySwitch = document.getElementById('fullDaySwitch');
  const levStartDate = document.getElementById('leaveData3').value;

  if (afternoonSwitch.checked) {
    morningSwitch.checked = false;
    fullDaySwitch.checked = false;
    if (!levStartDate) {
      createToast("⚠️ เกิดข้อผิดพลาด กรุณาเลือกวันที่เริ่มต้น", 3);
      afternoonSwitch.checked = false;
      return;
    }
    // ตั้งค่าเวลาเริ่มต้นบ่าย (12:00) และสิ้นสุดบ่าย (23:59)
    document.getElementById('leaveData3').value = levStartDate.split('T')[0] + "T12:00";
    document.getElementById('leaveData4').value = levStartDate.split('T')[0] + "T23:59";
  } else {
    document.getElementById('leaveData4').value = '';
  }
  calculateLeave();
};

const calculateLeave = () => {
  const fullDaySwitch = document.getElementById('fullDaySwitch');
  const startDate = document.getElementById('leaveData3').value;
  const endDate = document.getElementById('leaveData4').value;

  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);

    const diffMs = end - start; // ความต่างของเวลาในหน่วยมิลลิวินาที
    const diffHours = diffMs / (1000 * 60 * 60); // แปลงเป็นชั่วโมง

    let diffDays = 0;
    let hours = 0;

    if (fullDaySwitch.checked && diffHours >= 24) {
      // กรณีเต็มวัน
      diffDays = Math.ceil(diffHours / 24); // คำนวณจำนวนวัน
    } else if (!fullDaySwitch.checked && diffHours <= 12 && diffHours > 0) {
      // กรณีครึ่งวัน (12 ชั่วโมง)
      hours = 12;
    }

    document.getElementById('leaveData5').value = diffDays; // จำนวนวัน
    document.getElementById('leaveData6').value = hours;   // จำนวนชั่วโมง
  } else {
    document.getElementById('leaveData5').value = 0;
    document.getElementById('leaveData6').value = 0;
  }
};

const submitFormLeave = () => {
  event.preventDefault();
  $.LoadingOverlay("show", { image : "", fontawesome : "fa fa-spinner fa-spin" }); 

  const obj = {
    leaveKey: document.getElementById('leaveDataKey').value,
    leaveA: document.getElementById('user-show0').innerText,
    leaveB: document.getElementById('user-show1').innerText,
    leaveC: document.getElementById('user-show2').innerText,
    leaveD: document.getElementById('user-show5').innerText,
    leaveE: document.getElementById('user-show4').innerText,
    leaveData1: document.getElementById('leaveData1').value,
    leaveData2: document.getElementById('leaveData2').value,
    leaveData3: document.getElementById('leaveData3').value,
    leaveData4: document.getElementById('leaveData4').value,
    leaveData5: document.getElementById('leaveData5').value,
    leaveData6: document.getElementById('leaveData6').value,
  };

  if (!obj.leaveA || !obj.leaveB || !obj.leaveC || !obj.leaveD || !obj.leaveE || !obj.leaveData1 || !obj.leaveData2 || !obj.leaveData3 || !obj.leaveData4 || !obj.leaveData5 || !obj.leaveData6) {
    createToast("⚠️ กรุณากรอกข้อมูลให้ครบถ้วน", 3);
    $.LoadingOverlay("hide");
    return;
  }

  const fileInput = document.getElementById('leaveData7');
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onloadend = function() {
      obj.filetype = file.type;
      obj.imageDataUrl = reader.result;
      
      if (!obj.leaveKey) {
        google.script.run.withSuccessHandler(async (res) => {
          $.LoadingOverlay("hide");
          await updateSpecificLeaveData();
          loadLeaveTypes();
          updateCalendarLev();
          insertChartLev();
          clearFormLeave();
          renderCalendarLev();
          createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
        }).addDataLeave(obj);
      } else {
        google.script.run.withSuccessHandler(async (res) => {
          $.LoadingOverlay("hide");
          await updateSpecificLeaveData();
          loadLeaveTypes();
          updateCalendarLev();
          insertChartLev();
          clearFormLeave();
          renderCalendarLev();
          createToast("✅ แก้ไขข้อมูลสำเร็จ", 1);
        }).upDataLeave(obj);
      }
    };
    reader.readAsDataURL(file);
  } else {
    if (!obj.leaveKey) {
      google.script.run.withSuccessHandler(async (res) => {
        $.LoadingOverlay("hide");
          await updateSpecificLeaveData();
          loadLeaveTypes();
          updateCalendarLev();
          insertChartLev();
        clearFormLeave();
        createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
      }).addDataLeave(obj);
    } else {
      google.script.run.withSuccessHandler(async (res) => {
        $.LoadingOverlay("hide");
          await updateSpecificLeaveData();
          loadLeaveTypes();
          updateCalendarLev();
          insertChartLev();
        clearFormLeave();
        createToast("✅ แก้ไขข้อมูลสำเร็จ", 1);
      }).upDataLeave(obj);
    }
  }
};

const editLeave = (codeID) => {
  const userRole1 = localStorage.getItem('uiduser') || '';
  const userRole2 = localStorage.getItem('level') || '';
  const dataAllLev = allleave.find(row => row[0] === codeID);
  
  if (dataAllLev) {
    if ((userRole2 !== 'SuperAdmin' && userRole2 !== 'Admin' && userRole1 !== dataAllLev[3])) {
      createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
      return;
    }
    if (dataAllLev[1] !== 'รอตรวจสอบ') {
      createToast("⚠️ คำขอนี้ไม่สามารถแก้ไขได้", 3);
      return;
    }
    if (dataAllLev[8] === 'ลาป่วยมีใบรับรองแพทย์') {
      document.getElementById('leaveData7Row').style.display = 'block';
      document.getElementById('leaveData7').style.display = 'block';
    } else {
      document.getElementById('leaveData7Row').style.display = 'none';
      document.getElementById('leaveData7').style.display = 'none';
    }

    $('#RPTLModal').modal('show');
    $('#leaveDataKey').val(dataAllLev[0]);
    $('#leaveData1').val(dataAllLev[8]);
    $('#leaveData2').val(dataAllLev[9]);
    $('#leaveData3').val(dataAllLev[11]);
    $('#leaveData4').val(dataAllLev[12]);
    const startDateTime = new Date(dataAllLev[11]);
    const endDateTime = new Date(dataAllLev[12]);
    const diffTime = endDateTime - startDateTime;
    const diffHours = diffTime / (1000 * 60 * 60);
    const isMorning = (startDateTime.getHours() === 0 && diffHours === 12);
    const isAfternoon = (startDateTime.getHours() === 12 && diffHours === 12);
    const isFullDay = (startDateTime.getHours() === 0 && diffHours >= 24);

    document.getElementById('morningHalfDaySwitch').checked = isMorning;
    document.getElementById('afternoonHalfDaySwitch').checked = isAfternoon;
    document.getElementById('fullDaySwitch').checked = isFullDay;

    $('#leaveData5').val(dataAllLev[13]);
    $('#leaveData6').val(dataAllLev[14]);

    calculateLeave();
  }
};

const delLeave = (codeID) => {
  const userRole1 = localStorage.getItem('uiduser') || '';
  const userRole2 = localStorage.getItem('level') || '';
  let dataAllLev = allleave.find(row => row[0] === codeID);
  if (dataAllLev) {
    if ((userRole2 !== 'SuperAdmin' && userRole2 !== 'Admin' && userRole1 !== dataAllLev[3])) {
      createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
      return;
    }
    if (dataAllLev[1] !== 'รอตรวจสอบ') {
      createToast("⚠️ คำขอนี้ไม่สามารถลบได้", 3);
      return;
    }
    $('#confirmBtnDel').off('click').on('click', function() {
      $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
      $('#DelDataModal').modal('hide');
      google.script.run.withSuccessHandler(async (res) => {
        dataAllLev = allleave.filter(row => row[0] !== codeID);
        $.LoadingOverlay("hide");
        await updateSpecificLeaveData();
        loadLeaveTypes();
        updateCalendarLev();
        insertChartLev();
        clearFormLeave();
        createToast("⛔ ลบข้อมูลสำเร็จ", 0);
      }).delDataLeave(codeID);
    });
    $('#xDelconfirmData').off('click').on('click', function() {
      $('#DelDataModal').modal('hide');
    });
    $('#DelDataModal').modal('show');
  }
}

const clearFormLeave = () => {
  document.getElementById('leaveDataKey').value = '';
  document.getElementById('leaveData1').value = '';
  document.getElementById('leaveData2').value = '';
  document.getElementById('leaveData3').value = '';
  document.getElementById('leaveData4').value = '';
  document.getElementById('leaveData5').value = '';
  document.getElementById('leaveData6').value = '';
  document.getElementById('leaveData7').value = '';
  document.getElementById('leaveData7Row').style.display = 'none';
  document.getElementById('leaveData7').style.display = 'none';
  document.getElementById('morningHalfDaySwitch').checked = false;
  document.getElementById('afternoonHalfDaySwitch').checked = false;
  document.getElementById('fullDaySwitch').checked = false;
  

  $('#RPTLModal').modal('hide');
  $('#levSelectModal').modal('hide');
};

const submitApprovalLeave = (status) => {
  const leavedata = document.getElementById('approveDataLeave').value;
  const fullname = document.getElementById('user-show1').innerText;
  const signame = document.getElementById('user-show4').innerText;
  if (!leavedata || !fullname || !signame) {
    createToast("❌ กรุณากรอกข้อมูลให้ครบถ้วน", 0);
    return;
  }
  const data = {
    codeID: selectedAllleave[0],
    leavedata: leavedata,
    fullname: fullname,
    signame: signame,
    status: status
  };
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  google.script.run.withSuccessHandler(async (res) => {
  $.LoadingOverlay("hide");
    $('#leaveApprovalRequestModal').modal('hide');
    document.getElementById('approveDataLeave').value = '';
    await updateSpecificLeaveData();
    loadLeaveTypes();
    updateCalendarLev();
    insertChartLev();
    createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
  }).approvalLeave(data);
}

const sendLeave = (codeID) => {
  const data = allleave.find(row => row[0] === codeID);
  if (!data) {
    createToast("❌ ไม่พบข้อมูล", 0);
    return;
  }

  // คำนวณประวัติการลา
  const calculateUserLeaveHistory = (data) => {
    const userLeaves = allleave.filter(leave => 
      leave[3] === data[3] && 
      leave[1] === 'อนุมัติ' && 
      leave[0] !== data[0]
    );

    const currentLeave = {
      type: data[8],
      days: parseFloat(data[13]) || 0,
      hours: parseFloat(data[14]) || 0
    };

    let leaveHistory = {
      sick: { count: 0, days: 0 },
      personal: { count: 0, days: 0 },
      vacation: { count: 0, days: 0 },
      other: { count: 0, days: 0 }
    };

    userLeaves.forEach(leave => {
      const days = parseFloat(leave[13]) || 0;
      const hours = parseFloat(leave[14]) || 0;
      const totalDays = days + (hours / 24);

      switch (leave[8]) {
        case 'ลาป่วยมีใบรับรองแพทย์':
        case 'ลาป่วยไม่มีใบรับรองแพทย์':
          leaveHistory.sick.count++;
          leaveHistory.sick.days += totalDays;
          break;
        case 'ลากิจจำเป็น':
        case 'ลากิจทั่วไป':
          leaveHistory.personal.count++;
          leaveHistory.personal.days += totalDays;
          break;
        case 'ลาพักร้อน':
          leaveHistory.vacation.count++;
          leaveHistory.vacation.days += totalDays;
          break;
        default:
          leaveHistory.other.count++;
          leaveHistory.other.days += totalDays;
      }
    });

    const currentDays = currentLeave.days + (currentLeave.hours / 24);

    return [
      ['ลาป่วย', 
        `${leaveHistory.sick.days.toFixed(1)} วัน (${leaveHistory.sick.count} ครั้ง)`,
        (currentLeave.type.includes('ป่วย') ? currentDays.toFixed(1) : '0'),
        (currentLeave.type.includes('ป่วย') ? (leaveHistory.sick.days + currentDays).toFixed(1) : leaveHistory.sick.days.toFixed(1))
      ],
      ['ลากิจ', 
        `${leaveHistory.personal.days.toFixed(1)} วัน (${leaveHistory.personal.count} ครั้ง)`,
        (currentLeave.type.includes('กิจ') ? currentDays.toFixed(1) : '0'),
        (currentLeave.type.includes('กิจ') ? (leaveHistory.personal.days + currentDays).toFixed(1) : leaveHistory.personal.days.toFixed(1))
      ],
      ['ลาพักร้อน', 
        `${leaveHistory.vacation.days.toFixed(1)} วัน (${leaveHistory.vacation.count} ครั้ง)`,
        (currentLeave.type.includes('พักร้อน') ? currentDays.toFixed(1) : '0'),
        (currentLeave.type.includes('พักร้อน') ? (leaveHistory.vacation.days + currentDays).toFixed(1) : leaveHistory.vacation.days.toFixed(1))
      ],
      ['ลาอื่นๆ', 
        `${leaveHistory.other.days.toFixed(1)} วัน (${leaveHistory.other.count} ครั้ง)`,
        (!currentLeave.type.includes('ป่วย') && !currentLeave.type.includes('กิจ') && !currentLeave.type.includes('พักร้อน') ? currentDays.toFixed(1) : '0'),
        (!currentLeave.type.includes('ป่วย') && !currentLeave.type.includes('กิจ') && !currentLeave.type.includes('พักร้อน') ? (leaveHistory.other.days + currentDays).toFixed(1) : leaveHistory.other.days.toFixed(1))
      ]
    ];
  };

  // แปลงวันที่เป็นภาษาไทย
  const thaiMonths = [
    'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
    'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
  ];

  const formatThaiDate1 = (dateStr) => {
    const date = new Date(dateStr);
    return {
      date: date.getDate(),
      month: thaiMonths[date.getMonth()],
      year: date.getFullYear() + 543
    };
  };

  const formatThaiDate2 = (dateStr) => {
    const [day, month, year] = dateStr.split('/').map(num => parseInt(num, 10));
    const thaiMonths = [
      'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
      'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
    ];
    return {
      date: day,
      month: thaiMonths[month - 1],
      year: year + 543
    };
  };

  const writingDate = formatThaiDate2(data[2]);
  const approverDate = formatThaiDate2(data[17]);
  const startDate = formatThaiDate1(data[11]);
  const endDate = formatThaiDate1(data[12]);
  
  let leaveTypeCheckboxes = {
    sick: { text: '£', font: 'Wingdings2' },
    personal: { text: '£', font: 'Wingdings2' },
    vacation: { text: '£', font: 'Wingdings2' },
    other: { text: '£', font: 'Wingdings2' }
  };

  switch (data[8]) {
    case 'ลาป่วยมีใบรับรองแพทย์':
    case 'ลาป่วยไม่มีใบรับรองแพทย์':
      leaveTypeCheckboxes.sick.text = 'R';
      break;
    case 'ลากิจจำเป็น':
    case 'ลากิจทั่วไป':
      leaveTypeCheckboxes.personal.text = 'R';
      break;
    case 'ลาพักร้อน':
      leaveTypeCheckboxes.vacation.text = 'R';
      break;
    default:
      leaveTypeCheckboxes.other.text = 'R';
  }

  Promise.all([
    new Promise((resolve) => loadImagepdfmake(data[7], resolve)),
    new Promise((resolve) => data[18] ? loadImagepdfmake(data[18], resolve) : resolve(null))
  ]).then(([signatureUser, signatureApprover]) => {
    const docDefinition = {
      pageSize: 'A4',
      pageMargins: [30, 20, 30, 20],
      content: [
        {
          text: 'ใบลาป่วย ลาคลอดบุตร ลากิจส่วนตัว',
          style: 'header',
          alignment: 'center'
        },
        {
          columns: [
            { width: '*', text: '' },
            {
              width: 'auto',
              text: [
                { text: 'เขียนที่' },
                { text: ' ' + data[6] }
              ]
            }
          ],
          margin: [0, 15, 0, 0]
        },
        {
          columns: [
            { width: '*', text: '' },
            {
              width: 'auto',
              text: [
                { text: 'วันที่เขียน ' + writingDate.date + ' เดือน ' + writingDate.month + ' พ.ศ. ' + writingDate.year }
              ]
            }
          ],
          margin: [0, 5, 0, 0]
        },
        {
          text: 'เรื่อง  ขออนุญาต' + data[8] + '\n' +
                'เรียน  ผู้บริหาร' + data[6],
          margin: [0, 15, 0, 0]
        },
        {
          text: [
            { text: 'ข้าพเจ้า ' + data[4] + ' ตำแหน่ง ' + data[5] + ' ฝ่าย ' + data[6] 
            ,leadingIndent: 40
            },
            {
              text: [
                { text: ' ข้าพเจ้าได้ลา ' },
                leaveTypeCheckboxes.sick,
                { text: ' ลาป่วย ' },
                leaveTypeCheckboxes.personal,
                { text: ' ลากิจ ' },
                leaveTypeCheckboxes.vacation,
                { text: ' ลาพักร้อน ' },
                leaveTypeCheckboxes.other,
                { text: ' ลาอื่นๆ ' }
              ],
              fontSize: 14
            },
            { text: 'เนื่องจาก ' },
            { text: data[9] },
            { text: ' ตั้งแต่วันที่ ' },
            { text: startDate.date + ' ' },
            { text: 'เดือน ' },
            { text: startDate.month + ' ' },
            { text: 'พ.ศ. ' },
            { text: startDate.year + ' ' },
            { text: 'ถึงวันที่ ' },
            { text: endDate.date + ' ' },
            { text: 'เดือน ' },
            { text: endDate.month + ' ' },
            { text: 'พ.ศ. ' },
            { text: endDate.year + ' ' },
            { text: 'จำนวน ' },
            { text: data[13] + ' ' },
            { text: 'วัน ' },
            { text: data[14] + ' ' },
            { text: 'ชั่วโมง' }
          ],
          alignment: 'justify',
          margin: [0, 15, 0, 0]
        },
        {
          columns: [
            {
              width: '50%',
              stack: [
                {
                  text: 'สถิติการลาในปีงบประมาณนี้',
                  margin: [0, 15, 0, 5]
                },
                {
                  table: {
                    widths: ['*', '*', '*', '*'],
                    body: [
                      ['ประเภทลา', 'ลามาแล้ว', 'ลาครั้งนี้', 'รวมเป็น'],
                      ...calculateUserLeaveHistory(data)
                    ]
                  },
                  style: 'tableStyle'
                }
              ]
            },
            {
              width: '50%',
              stack: [
                signatureUser ? {
                  image: signatureUser,
                  width: 60,
                  alignment: 'center',
                  margin: [30, 0, 0, 0]
                } : {},
                {
                  text: 'ลงชื่อ................................................ผู้ขออนุญาต',
                  margin: [30, signatureUser ? 0 : 0, 0, 0]
                },
                { text: 'ตำแหน่ง ' + data[5], margin: [30, 5, 0, 0] },
                { text: 'วันที่ ' + writingDate.date + ' ' + writingDate.month + ' ' + writingDate.year, margin: [30, 5, 0, 0] },
                signatureApprover ? {
                  image: signatureApprover,
                  width: 60,
                  alignment: 'center',
                  margin: [30, 10, 0, 0]
                } : {},
                {
                  text: 'ลงชื่อ................................................ผู้บังคับบัญชา',
                  margin: [30, signatureApprover ? 0 : 0, 0, 0]
                },
                { text: 'ผู้บริหาร ' + data[6], margin: [30, 5, 0, 0] },
                { text: 'วันที่ ' + approverDate.date + ' ' + approverDate.month + ' ' + approverDate.year, margin: [30, 5, 0, 0] },
                { text: 'คำสั่ง' + data[16] ? data[16] : '', bold: true, margin: [30, 15, 0, 0] },
                {
                  text: [
                    { text: data[1] === 'อนุมัติ' ? 'R' : '£', font: 'Wingdings2' },
                    { text: ' อนุญาต    ', font: 'THSarabunNew' },
                    { text: data[1] === 'อนุมัติ' ? '£' : 'R', font: 'Wingdings2' },
                    { text: ' ไม่อนุญาต', font: 'THSarabunNew' }
                  ],
                  margin: [30, 5, 0, 0]
                }
              ]
            }
          ]
        }
      ],
      defaultStyle: {
        font: 'THSarabunNew',
        fontSize: 16
      },
      styles: {
        header: {
          fontSize: 18,
          bold: true,
          margin: [0, 0, 0, 20]
        },
        tableStyle: {
          fontSize: 14,
          alignment: 'center'
        }
      }
    };

    pdfMake.createPdf(docDefinition).open();
  }).catch(error => {
    console.error('Error:', error);
    createToast("❌ เกิดข้อผิดพลาดในการสร้างเอกสาร", 0);
  });
};
</script>

Page/02_reqListTblBody.html = 
<div class="row g-3 mt-2">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-4 mb-2 mb-md-0">📝 การขอหนังสือรับรอง</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
          <select class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" onchange="updateItemsRequest(this.value)">
            <option value="10">✅ 10</option>
            <option value="20">✅ 25</option>
            <option value="50">✅ 50</option>
            <option value="100">✅ 100</option>
            <option value="all">✅ ทั้งหมด</option>
          </select>
            <input type="search" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" id="searchRequest" placeholder="🔍ค้นหาข้อมูล..." oninput="filterRequest()">
            <button type="button" class="btn upload-button" id="reqList-button" onclick="openRequestApprovalModal()" style="display:none"><i class="fa-solid fa-pen-to-square"></i> อนุมัติคำขอ <span class="badge del-button" id="countingRequest">0</span></button>
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">#</th>
                <th scope="col" class="text-center">ชื่อพนักงาน</th>
                <th scope="col" class="text-center">รายละเอียด</th>
                <th scope="col" class="text-center">ผู้ตรวจสอบ</th>
                <th scope="col" class="text-center">สถานะ</th>
                <th scope="col" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody id="tablereqListTblBody">
              <tr>
                <td colspan='6' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>
              </tr>
            </tbody>       
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationRequestInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationRequest" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let filteredRequest = [];
let currentRequest = 1;
let itemsPerRequest = 10;

const renderDataRequest = (res) => {
  const table = document.getElementById('tablereqListTblBody');
  table.innerHTML = '';

  const uidMember = localStorage.getItem('uiduser');
  const userLevel = localStorage.getItem('level');

  if (userLevel === 'SuperAdmin' || userLevel === 'Admin') {
    filteredRequest = res;
  } else {
    filteredRequest = res.filter(row => row[3] === uidMember);
  }

  filteredRequest.sort((a, b) => {
    if (a[1] === 'รอตรวจสอบ' && b[1] !== 'รอตรวจสอบ') return -1;
    if (a[1] !== 'รอตรวจสอบ' && b[1] === 'รอตรวจสอบ') return 1;

    const numA = parseInt(a[0].replace('REQ', ''));
    const numB = parseInt(b[0].replace('REQ', ''));
    return numB - numA;
  });

  const startIndex = (currentRequest - 1) * itemsPerRequest;
  const endIndex = startIndex + itemsPerRequest;
  const req = filteredRequest.slice(startIndex, endIndex);

  const startRow = startIndex + 1;
  const endRow = startIndex + req.length;
  const totalRows = filteredRequest.length;

  document.getElementById('paginationRequestInfo').innerText = `แสดง ${startRow} ถึง ${endRow} จาก ${totalRows} แถว`;

  if (req.length === 0) {
    const row = table.insertRow();
    row.innerHTML = `<td colspan='6' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>`;
    return;
  }

  req.forEach((rowIndex, index) => {
    const checkrowIndex = [rowIndex[9], rowIndex[10], rowIndex[11], rowIndex[12]];
    const filledFields = checkrowIndex.filter(field => field && field.trim() !== '').length;
    const progressbar = Math.round((filledFields / checkrowIndex.length) * 100);
    const progressAngle = progressbar * 3.6;

    let progressColor;
    let buttonClass = 'upload-button';
    if (progressbar <= 25) {
      progressColor = 'var(--box4)';
      buttonClass = 'del-button';
    } else if (progressbar <= 50) {
      progressColor = 'var(--box3)';
      buttonClass = 'edit-button';
    } else if (progressbar <= 75) {
      progressColor = 'var(--box1)';
      buttonClass = 'set-button';
    } else {
      progressColor = 'var(--box2)';
      buttonClass = 'upload-button';
    }

    let menuRequestItem;
    if (rowIndex[1] === 'อนุมัติ') {
      menuRequestItem = `<li><a class="dropdown-item hover-highlight" onclick="sendRequest('${rowIndex[0]}')"><i class="fa-regular fa-paper-plane"></i> หนังสือรับรอง</a></li>`;
    } else {
      menuRequestItem = `<li><a class="dropdown-item hover-highlight disabled"><i class="fa-regular fa-circle-xmark"></i> ไม่พบหนังสือรับรอง</a></li>`;
    }

    let user = dataUsers && dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';

    var row = table.insertRow();
    row.innerHTML = `
    <td class="text-center"><span style="font-size: 14px;">${startIndex + index + 1}</span></td>
    <td>
      <div style="display: flex; align-items: center;">
        <img class="rounded-circle" src="${userImage ? userImage : '❌ N/A'}" alt="ImageUsers" width="40" style="margin-right: 10px;">
        <div style="font-size: 14px;">
          <span>ชื่อ สกุล: ${rowIndex[4] ? rowIndex[4] : '❌ N/A'}</span><br>
          <span>ตำแหน่ง: ${rowIndex[5] ? rowIndex[5] : '❌ N/A'}</span><br>
          <span>แผนก: ${rowIndex[6] ? rowIndex[6] : '❌ N/A'}</span>
        </div>
      </div>
    </td>
    <td>
      <span style="font-size: 14px;">${rowIndex[8] ? rowIndex[8] : '❌ N/A'}</span>
    </td>
    <td>
      <span style="font-size: 14px;">ผู้อนุมัติ: ${rowIndex[9] ? rowIndex[9] : '❌ N/A'}</span><br>
      <span style="font-size: 14px;">ความเห็น: ${rowIndex[10] ? rowIndex[10] : '❌ N/A'} วันที่: ${rowIndex[11] ? rowIndex[11] : '❌ N/A'}</span>
    </td>
    <td class="text-center" style="vertical-align: middle;">
      <div style="display: flex; align-items: center; justify-content: center;">
        <div class="circular-progress" style="--progress-color: ${progressColor}; --progress-angle: ${progressAngle}deg;">
          <span class="progress-value">${progressbar}%</span>
        </div>
      </div>
    </td>
    <td class="text-center" style="vertical-align: middle;">
      <div style="display: flex; align-items: center; justify-content: center;">
        <select class="form-control me-2" style="font-size: 14px; width: auto;" disabled>
          <option value="รอตรวจสอบ" ${rowIndex[1] === 'รอตรวจสอบ' ? 'selected' : ''}>⌛ รอตรวจสอบ</option>
          <option value="ไม่อนุมัติ" ${rowIndex[1] === 'ไม่อนุมัติ' ? 'selected' : ''}>❌ ไม่อนุมัติ</option>
          <option value="ยกเลิก" ${rowIndex[1] === 'ยกเลิก' ? 'selected' : ''}>❌ ยกเลิก</option>
          <option value="อนุมัติ" ${rowIndex[1] === 'อนุมัติ' ? 'selected' : ''}>✅ อนุมัติ</option>
        </select>
        <div class="dropdown">
          <button class="btn btn-sm del-button dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-ellipsis"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item hover-highlight" onclick="editRequest('${rowIndex[0]}')"><i class="fa-solid fa-pen-to-square"></i> แก้ไขรายการ</a></li>
            <li><a class="dropdown-item hover-highlight" onclick="delRequest('${rowIndex[0]}')"><i class="fa-solid fa-trash-can"></i> ลบรายการ</a></li>
            ${menuRequestItem}
          </ul>
        </div>
      </div>
    </td>
    `;
  });
}

const renderPageDataRequest = () => {
  const totalItems = filteredRequest.length;
  const totalPages = Math.ceil(totalItems / itemsPerRequest);
  const paginationContainer = document.getElementById('paginationRequest');
  paginationContainer.innerHTML = '';

  if (totalPages > 1) {
    const createPageButton = (text, page, isDisabled = false, isActive = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
      const button = document.createElement('button');
      button.className = 'page-link';
      button.innerText = text;
      button.onclick = () => {
        if (!isDisabled) {
          currentRequest = page;
          renderDataRequest(filteredRequest);
          renderPageDataRequest();
        }
      };
      li.appendChild(button);
      return li;
    };

    paginationContainer.appendChild(createPageButton('ย้อนกลับ', currentRequest - 1, currentRequest === 1));

    if (currentRequest > 2) {
      paginationContainer.appendChild(createPageButton(1, 1, false, currentRequest === 1));
      if (currentRequest > 3) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
    }

    paginationContainer.appendChild(createPageButton(currentRequest, currentRequest, false, true));

    if (currentRequest < totalPages - 1) {
      if (currentRequest < totalPages - 2) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
      paginationContainer.appendChild(createPageButton(totalPages, totalPages, false, currentRequest === totalPages));
    }
    paginationContainer.appendChild(createPageButton('ถัดไป', currentRequest + 1, currentRequest === totalPages));
  }
}

const filterRequest = () => {
  const query = document.getElementById('searchRequest').value.toLowerCase();
  const uidMember = localStorage.getItem('uiduser');
  const userLevel = localStorage.getItem('level');

  if (userLevel === 'SuperAdmin' || userLevel === 'Admin') {
    filteredRequest = allRequest.filter(row => row.some(column => column.toLowerCase().includes(query)));
  } else {
    filteredRequest = allRequest.filter(row => row[3] === uidMember && row.some(column => column.toLowerCase().includes(query)));
  }

  currentRequest = 1;
  renderDataRequest(filteredRequest);
  renderPageDataRequest();
}

const updateItemsRequest = (value) => {
  if (value === "all") {
    itemsPerRequest = filteredRequest.length;
  } else {
    itemsPerRequest = parseInt(value, 10);
  }

  currentRequest = 1;
  renderDataRequest(filteredRequest);
  renderPageDataRequest();
}

const updateCountsRequest = (data) => {
  const countingRequest = data.filter(row => row[1] === "รอตรวจสอบ").length;
  document.getElementById('countingRequest').innerText = countingRequest;
}

const submitFormreqList = () => {
  event.preventDefault();
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });

  const obj = {
    rqtKey: document.getElementById('reqListDataKey').value,
    rqtuid: document.getElementById('user-show0').innerText,
    rqtfullname: document.getElementById('user-show1').innerText,
    rqtdpm: document.getElementById('user-show2').innerText,
    rqtgroup: document.getElementById('user-show5').innerText,
    rqtsig: document.getElementById('user-show4').innerText,
    rqtdata1: document.getElementById('reqListData1').value 
  };

  if (!obj.rqtuid || !obj.rqtfullname || !obj.rqtdpm || !obj.rqtgroup || !obj.rqtsig || !obj.rqtdata1) {
    createToast("⚠️ กรุณากรอกข้อมูลให้ครบถ้วน", 3);
    $.LoadingOverlay("hide");
    return;
  }

  if (!obj.rqtKey) {
    google.script.run.withSuccessHandler(async (res) => {
      $.LoadingOverlay("hide");
      await updateSpecificRequestData();
      clearFormreqList();
      createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
    }).addDatareqList(obj);
  } else {
    google.script.run.withSuccessHandler(async (res) => {
      $.LoadingOverlay("hide");
      await updateSpecificRequestData();
      clearFormreqList();
      createToast("✅ แก้ไขข้อมูลสำเร็จ", 1);
    }).upDatareqList(obj);
  }
};

const editRequest = (codeID) => {
  const userRole1 = localStorage.getItem('uiduser') || '';
  const userRole2 = localStorage.getItem('level') || '';
  const dataAllREQ = allRequest.find(row => row[0] === codeID);
  
  if (dataAllREQ) {
    if (dataAllREQ[1] !== 'รอตรวจสอบ') {
      createToast("⚠️ คำขอนี้ไม่สามารถแก้ไขได้", 3);
      return;
    }
    if ((userRole2 !== 'SuperAdmin' && userRole2 !== 'Admin' && userRole1 !== dataAllREQ[3])) {
      createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
      return;
    }

    $('#rqtBodyModal').modal('show');
    $('#reqListDataKey').val(dataAllREQ[0]);
    $('#reqListData1').val(dataAllREQ[8]);
  }
};

const delRequest = (codeID) => {
  const userRole1 = localStorage.getItem('uiduser') || '';
  const userRole2 = localStorage.getItem('level') || '';
  let dataAllREQ = allRequest.find(row => row[0] === codeID);
  if (dataAllREQ) {
    if (dataAllREQ[1] !== 'รอตรวจสอบ') {
      createToast("⚠️ คำขอนี้ไม่สามารถลบได้", 3);
      return;
    }
    if ((userRole2 !== 'SuperAdmin' && userRole2 !== 'Admin' && userRole1 !== dataAllREQ[3])) {
      createToast("⚠️ คุณไม่มีสิทธิ์ในการเข้าถึงรายการนี้", 3);
      return;
    }
    $('#confirmBtnDel').off('click').on('click', function() {
      $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
      $('#DelDataModal').modal('hide');
      google.script.run.withSuccessHandler(async (res) => {
        dataAllREQ = allRequest.filter(row => row[0] !== codeID);
        $.LoadingOverlay("hide");
        await updateSpecificRequestData();
        clearFormreqList();
        createToast("⛔ ลบข้อมูลสำเร็จ", 0);
      }).delDatareqList(codeID);
    });
    $('#xDelconfirmData').off('click').on('click', function() {
      $('#DelDataModal').modal('hide');
    });
    $('#DelDataModal').modal('show');
  }
}

const clearFormreqList = () => {
  document.getElementById('reqListDataKey').value = '';
  document.getElementById('reqListData1').value = '';

  $('#rqtBodyModal').modal('hide');
};

const submitApprovalRequest = (status) => {
  const reqdata = document.getElementById('approveDataRequest').value;
  const fullname = document.getElementById('user-show1').innerText;
  const signame = document.getElementById('user-show4').innerText;
  if (!reqdata || !fullname || !signame) {
    createToast("❌ กรุณากรอกข้อมูลให้ครบถ้วน", 0);
    return;
  }
  const data = {
    codeID: selectedAllRequest[0],
    reqdata: reqdata,
    fullname: fullname,
    signame: signame,
    status: status
  };
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  google.script.run.withSuccessHandler(async (res) => {
  $.LoadingOverlay("hide");
    $('#reqApprovalRequestModal').modal('hide');
    document.getElementById('approveDataRequest').value = '';
    await updateSpecificRequestData();
    createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
  }).approvalRequest(data);
}

const sendRequest = (codeID) => {
  const data = allRequest.find(row => row[0] === codeID);
  if (!data) {
    createToast("❌ ไม่พบข้อมูล", 0);
    return;
  }

  const user = dataUsers.find(user => user[0] === data[3]);
  if (!user) {
    createToast("❌ ไม่พบข้อมูลพนักงาน", 0);
    return;
  }

  // แปลงตัวเลขเป็นคำอ่านภาษาไทย
  const numberToThaiBaht = (number) => {
    const digits = ['ศูนย์', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
    const positions = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];
    
    let numberStr = Math.floor(number).toString();
    let decimals = ((number % 1) || 0).toFixed(2).substring(2);
    
    const readNumber = (num) => {
      let word = '';
      const length = num.length;

      for (let i = 0; i < length; i++) {
        const digit = parseInt(num[i]);
        const position = length - i - 1;

        if (digit !== 0) {
          if (position === 1 && digit === 1) {
            word += positions[position];
          } else if (position === 1 && digit === 2) {
            word += 'ยี่' + positions[position];
          } else if (position === 0 && digit === 1 && length > 1) {
            word += 'เอ็ด';
          } else {
            word += digits[digit] + positions[position];
          }
        }
      }
      return word;
    };

    let result = '';
    
    if (parseInt(numberStr) === 0) {
      return 'ศูนย์บาทถ้วน';
    }

    while (numberStr.length > 6) {
      const millions = numberStr.substring(0, numberStr.length - 6);
      numberStr = numberStr.substring(numberStr.length - 6);
      if (parseInt(millions) > 0) {
        result += readNumber(millions) + 'ล้าน';
      }
    }

    result += readNumber(numberStr);
    result += 'บาท';

    if (decimals === '00') {
      result += 'ถ้วน';
    } else {
      const satang = parseInt(decimals);
      if (satang > 0) {
        result += readNumber(decimals.toString()) + 'สตางค์';
      }
    }

    return result;
  };

  // แปลงวันที่เป็นภาษาไทย
  const thaiMonths = [
    'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
    'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
  ];

  const formatThaiDate = (dateStr) => {
    const [day, month, year] = dateStr.split('/');
    return {
      date: parseInt(day),
      month: thaiMonths[parseInt(month) - 1],
      year: parseInt(year) + 543
    };
  };

  const currentDate = formatThaiDate(data[11]);
  const startDate = formatThaiDate(user[19]);
  const salary = parseFloat(user[20].replace(',', '')).toFixed(2);
  const salaryText = numberToThaiBaht(parseFloat(user[20].replace(',', '')));

  Promise.all([
    new Promise((resolve) => loadImagepdfmake(data[12], resolve))
  ]).then(([signature]) => {
    const docDefinition = {
      pageSize: 'A4',
      pageMargins: [40, 30, 40, 30],
      content: [
        {
          text: 'หนังสือรับรองเงินเดือน',
          style: 'header',
          alignment: 'center'
        },
        '\n',
        {
          text: `บริษัท Epic Coding Channel จำกัด ขอรับรองว่า คุณ${data[4]} ได้ปฏิบัติงานในตำแหน่ง ${data[5]} ${data[6]} รหัสพนักงาน ${data[3]} ตั้งแต่วันที่ ${startDate.date} ${startDate.month} พ.ศ. ${startDate.year} จนถึงปัจจุบัน โดยมีอัตราเงินเดือนประจำเดือนละ ${salary} บาท (${salaryText}) ซึ่งอัตรานี้ไม่รวมค่าล่วงเวลาและเงินพิเศษอื่น ๆ`,
          fontSize: 16,
          alignment: 'justify',
          leadingIndent: 40
        },
        '\n',
        {
          text: `เอกสารนี้ใช้เพื่อ ${data[8]} เท่านั้น`,
          fontSize: 16,
          alignment: 'justify',
          margin: [40, 10, 40, 0]
        },
        '\n',
        {
          text: `ออกให้เมื่อวันที่ ${currentDate.date} ${currentDate.month} พ.ศ. ${currentDate.year}`,
          fontSize: 16,
          alignment: 'justify',
          margin: [40, 10, 40, 0]
        },
        '\n',
        {
          columns: [
            { width: '*', text: '' },
            {
              width: 'auto',
              stack: [
                {
                  text: 'ลงชื่อ .................................................................', 
                  fontSize: 16, 
                  margin: [0, 10, 0, 0]
                },
                signature ? {
                  image: signature,
                  width: 60,
                  alignment: 'center',
                  margin: [0, -35, 0, -10]
                } : {},
                { 
                  text: `(${data[9]})`,
                  fontSize: 16,
                  alignment: 'center',
                  margin: [0, 10, 0, 0]
                },
                { 
                  text: `ผู้บริหาร ${data[6]}`, 
                  fontSize: 16,
                  alignment: 'center',
                  margin: [0, 5, 0, 0]
                }
              ],
              alignment: 'right',
              margin: [0, 0, 40, 0]
            }
          ]
        }
      ],
      defaultStyle: {
        font: 'THSarabunNew',
        fontSize: 14
      },
      styles: {
        header: {
          fontSize: 20,
          bold: true
        }
      }
    };

    pdfMake.createPdf(docDefinition).open();
  }).catch(error => {
    console.error('Error:', error);
    createToast("❌ เกิดข้อผิดพลาดในการสร้างเอกสาร", 0);
  });
};
</script>
Page/03_Salary.html = 
<div class="row g-3 mt-2">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body rounded-4">
          <div class="row">
            <div class="col-md-4">
              <div class="d-flex flex-column">
                <div class="d-flex align-items-center mb-2">
                  <h5 style="color: var(--box1);font-weight: bold;">💸 รายการจ่ายเงิน/ค่าจ้าง</h5>
                </div>

                <div class="d-flex align-items-center mb-2">
                  <label for="dataSalary" class="col-form-label me-2" style="width: 100px;">📅 วันที่จ่าย:</label>
                  <input type="date" class="form-control w-auto" id="dataSalary">
                </div>
                <div class="d-flex align-items-center mb-2" hidden>
                  <input type="input" class="form-control w-auto" id="dataSalaryKey" hidden>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <div class="form-switch-wrapper me-2">
                    <input class="styled-switch" type="checkbox" id="deductLate" checked onchange="updateAllTotals()">
                    <label class="form-check-label" for="deductLate">สาย</label>
                  </div>
                  <div class="form-switch-wrapper me-2">
                    <input class="styled-switch" type="checkbox" id="deductLeave" checked onchange="updateAllTotals()">
                    <label class="form-check-label" for="deductLeave">ลา</label>
                  </div>
                  <div class="form-switch-wrapper me-2">
                    <input class="styled-switch" type="checkbox" id="includeOT" checked onchange="updateAllTotals()">
                    <label class="form-check-label" for="includeOT">โอที</label>
                  </div>
                  <div class="form-switch-wrapper me-2">
                    <input class="styled-switch" type="checkbox" id="includeSSO" checked onchange="updateAllTotals()">
                    <label class="form-check-label" for="includeSSO">ประกัน</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="d-flex flex-column align-items-end">
                <div class="d-flex justify-content-end align-items-center">
                  <div class="text-end flex-fill">
                    <span class="d-block">รวมค่าใช้จ่ายพนักงาน <span style="color: var(--box1);"><i class="fa-solid fa-sack-dollar"></i></span></span>
                    <span style="font-size: 1.5rem;font-weight: bold;color: var(--box1);" id="salaryBefore">0.00</span>
                  </div>

                  <div class="divider"></div>

                  <div class="text-end flex-fill">
                    <span class="d-block">รวมจ่ายสุทธิ <span style="color: var(--box2);"><i class="fa-solid fa-file-invoice-dollar"></i></span></span>
                    <span style="font-size: 1.5rem;font-weight: bold;color: var(--box2);" id="salaryAfter">0.00</span>
                  </div>
                </div>

                <div class="d-flex justify-content-end align-items-center mt-3">
                  <div class="text-end flex-fill">
                    <span class="d-block">รวมปรับเพิ่ม <span style="color: var(--box2);"><i class="fa-solid fa-circle-arrow-up"></i></span></span>
                    <span style="font-size: 1.5rem;font-weight: bold;color: var(--box2);" id="totalAdj">0.00</span>
                  </div>

                  <div class="divider"></div>

                  <div class="text-end flex-fill">
                    <span class="d-block">รวมปรับลด <span style="color: var(--box4);"><i class="fa-solid fa-circle-arrow-down"></i></span></span>
                    <span style="font-size: 1.5rem;font-weight: bold;color: var(--box4);" id="totalDow">0.00</span>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row g-3 mt-1">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12 col-md-4 mb-2 mb-md-0">👨‍💼 จัดการเงินเดือนพนักงาน</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <select id="selectPeriod" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;"></select>
            <button type="button" class="btn set-button me-2 mb-2 mb-md-0" onclick="renderSalaryData()">ดึงข้อมูล</button>
            <button type="button" class="btn upload-button me-2 mb-2 mb-md-0" onclick="actionSummary()">นำส่งข้อมูล</button>
            <button type="button" class="btn del-button me-2 mb-2 mb-md-0" onclick="clearSummaryData()">ยกเลิก</button>
          </div>
        </div>

      </div>
      <div class="card-header bg-white">
        <div class="row">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <button type="button" class="btn upload-button me-2" onclick="selectAllEmployees(true)">
              <i class="fa-solid fa-check"></i> เลือกทั้งหมด
            </button>
            <button type="button" class="btn del-button" onclick="selectAllEmployees(false)">
              <i class="fa-solid fa-xmark"></i> ยกเลิกทั้งหมด
            </button>
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">งวดที่</th>
                <th scope="col" class="text-center">ชื่อ สกุล</th>
                <th scope="col" class="text-center">เงินเดือน</th>
                <th scope="col" class="text-center">เงินพิเศษ</th>
                <th scope="col" class="text-center">สายรวม</th>
                <th scope="col" class="text-center">ลาป่วย</th>
                <th scope="col" class="text-center">ลากิจ</th>
                <th scope="col" class="text-center">ลาพักร้อน</th>
                <th scope="col" class="text-center">ลาอื่นๆ</th>
                <th scope="col" class="text-center">หักสาย</th>
                <th scope="col" class="text-center">หักลา</th>
                <th scope="col" class="text-center">OT</th>
                <th scope="col" class="text-center">รายได้OT</th>
                <th scope="col" class="text-center">รายได้อื่นๆ</th>
                <th scope="col" class="text-center">หักอื่นๆ</th>
                <th scope="col" class="text-center">ประกันสังคม</th>
                <th scope="col" class="text-center">รายได้รวม</th>
              </tr>
            </thead>
            <tbody id="tableDataSalary">
              <tr>
                <td colspan='17' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>
              </tr>
            </tbody>       
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationSalaryInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationSalary" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const renderSalaryData = (editMode = false, codeID = null) => {  
  let salaryBeforeTotal = 0;
  let totalAdj = 0;
  let totalDow = 0;

  const tableData = document.getElementById('tableDataSalary');
  tableData.innerHTML = '';  // เคลียร์ข้อมูลตารางก่อนดึงใหม่

  // กำหนดวันหยุดพิเศษจาก allSetDayOff
  const allSetDayOffDates = allSetDayOff && allSetDayOff.length > 0 
    ? allSetDayOff.map(dayOff => new Date(dayOff[1].split('/').reverse().join('-'))) 
    : [];

  // ตรวจสอบช่วงวันที่งวดที่เลือกและกำหนดวันหยุดสุดสัปดาห์จาก allSetWeekEnd
  const selectedPeriodValue = getSelectedPeriod();
  const selectedPeriod = allsetSalary.find(period => period[0] === selectedPeriodValue);
  if (!selectedPeriod) {
    createToast("⚠️ ไม่พบงวดที่เลือก", 3);
    return;
  }

  const [_, startDateStr, endDateStr, period] = selectedPeriod;
  const startDate = new Date(startDateStr.split('/').reverse().join('-'));
  const endDate = new Date(endDateStr.split('/').reverse().join('-'));

  const allSetWeekEndDates = [];
  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const dayOfWeek = d.getDay();
    const isWeekendDayOff = allSetWeekEnd.some(dayOff => {
      const [id, dayName, status] = dayOff;
      return status === 'TRUE' && dayName === ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'][dayOfWeek];
    });
    if (isWeekendDayOff) allSetWeekEndDates.push(new Date(d));
  }

  // รวมวันหยุดทั้งหมดไว้ในอาเรย์ allSetHolidayDates
  const allSetHolidayDates = [...allSetDayOffDates, ...allSetWeekEndDates];

  if (!editMode) {
    const sortedDataUsers = dataUsers.slice().sort((a, b) => {
      const numA = parseInt(a[0].replace('USER-', ''));
      const numB = parseInt(b[0].replace('USER-', ''));
      return numA - numB;
    });

    let hasData = false;
    sortedDataUsers.forEach(user => {
      if (user[10] === 'TRUE') {  // เฉพาะผู้ใช้ที่ active
        const uidUser = user[0];

        const attendanceRecords = alltimeAttendance.filter(record => {
          const recordDate = new Date(record[0].split('/').reverse().join('-')); 
          return record[1] === uidUser && recordDate >= startDate && recordDate <= endDate;
        });

        const leaveRecords = allleave.filter(leave => {
          const leaveStartDate = new Date(leave[11].split('T')[0]);
          const leaveEndDate = new Date(leave[12].split('T')[0]);
          return leave[3] === uidUser && leave[1] === 'อนุมัติ' && leaveEndDate >= startDate && leaveStartDate <= endDate;
        });

        if (attendanceRecords.length === 0 && leaveRecords.length === 0) return;

        hasData = true;

        const [_, , , fullName, department, group, , userImage, , , , , , , , , , , , , salaryStr, , specialAllowanceStr] = user;
        const salary = parseFloat(salaryStr.replace(/,/g, '')) || 0;
        const specialAllowance = parseFloat(specialAllowanceStr.replace(/,/g, '')) || 0;
        let lateMinutes = 0, otMinutes = 0;

        attendanceRecords.forEach(record => {
          const [_, uid, , checkIn, checkOut] = record;
          const recordDate = new Date(record[0].split('/').reverse().join('-'));
          const timeRule = allsetTime.find(time => time[3] === 'TRUE');

          const isHoliday = allSetHolidayDates.some(dayOffDate => dayOffDate.getTime() === recordDate.getTime());

          if (isHoliday) {
            otMinutes += convertToMinutes(checkOut) - convertToMinutes(checkIn);
          } else {
            if (checkOut && timeRule && checkOut > timeRule[2]) {
              otMinutes += calculateOTMinutes(checkOut, timeRule[2]);
            }
            if (checkIn && timeRule && convertToMinutes(checkIn) > convertToMinutes(timeRule[1])) {
              lateMinutes += calculateLateMinutes(checkIn, timeRule[1]);
            }
          }
        });

        const lateHoursDecimal = (lateMinutes / 60).toFixed(2);
        const otHoursDecimal = (otMinutes / 60).toFixed(2);
        const otPay = calculateOTPay(otMinutes / 60);

        const calculateLeave = (type) => {
          const leaves = leaveRecords.filter(leave => type.includes(leave[8]));
          let totalDays = leaves.reduce((total, leave) => total + parseFloat(leave[13]), 0);
          let totalHours = leaves.reduce((total, leave) => total + parseFloat(leave[14]), 0);
          
          totalDays += Math.floor(totalHours / 24);
          totalHours %= 24;
          
          return (totalDays + (totalHours / 24)).toFixed(2);
        };

        const sickLeave = calculateLeave(['ลาป่วยมีใบรับรองแพทย์', 'ลาป่วยไม่มีใบรับรองแพทย์']);
        const personalLeave = calculateLeave(['ลากิจจำเป็น', 'ลากิจทั่วไป']);
        const vacationLeave = calculateLeave(['ลาพักร้อน']);
        const otherLeave = calculateLeave(['ลาบวช', 'ลาคลอด', 'ลารับราชการทหาร']);

        const socialSecurity = calculateSocialSecurity(salary);
        const daysInPeriod = calculateDaysInPeriod(startDateStr, endDateStr);
        const leaveDeductions = calculateLeaveDeductions(leaveRecords, salary, daysInPeriod);
        const lateDeductions = calculateLateDeductions(lateMinutes, salary, daysInPeriod, 8);

        let totalIncome = (
          salary + specialAllowance + otPay - socialSecurity - leaveDeductions - lateDeductions
        ).toFixed(2);

        salaryBeforeTotal += parseFloat(totalIncome);

        // แสดงข้อมูลในตาราง
        tableData.innerHTML += `
          <tr>
          <td class="text-center">
            <div class="form-check">
              <input class="form-check-input select-employeesalary" type="checkbox" checked id="select-${uidUser}" data-uid="${uidUser}">
              <span style="font-size: 14px;">${period}</span>
            </div>
          </td>
            <td>
              <div style="display: flex; align-items: center;">
                <img src="${userImage}" alt="ImageUsers" width="40px" style="margin-right: 10px;" style="border-radius: 50%;">
                <div style="font-size: 14px;">
                  <span>รหัสพนักงาน: ${uidUser}</span><br>
                  <span>ชื่อ สกุล: ${fullName}</span><br>
                  <span>ตำแหน่ง: ${department}</span><br>
                  <span>แผนก: ${group}</span>
                </div>
              </div>
            </td>
            <td class="text-center"><span style="color: var(--box2);font-size: 14px;">${salary.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-center"><span style="color: var(--box1);font-size: 14px;">${specialAllowance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${lateHoursDecimal}</span></td>
            <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${sickLeave}</span></td>
            <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${personalLeave}</span></td>
            <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${vacationLeave}</span></td>
            <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${otherLeave}</span></td>
            <td class="text-end"><span style="color: var(--box4);font-size: 14px;">${lateDeductions.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-end"><span style="color: var(--box4);font-size: 14px;">${leaveDeductions.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-center"><span style="color: var(--box3);font-size: 14px;">${otHoursDecimal}</span></td>
            <td class="text-end"><span style="color: var(--box1);font-size: 14px;" id="otPay-${uidUser}">${otPay.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-end" style="width: 120px; position: relative;">
              <div style="position: relative; display: inline-block; width: 100%;">
                <input type="number" id="otherIncome-${uidUser}" class="form-control form-control-sm" step="0.01" value="0.00" onchange="updateTotal('${uidUser}')" style="padding-right: 30px;">
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); color: var(--box2);">
                  <i class="fa-solid fa-circle-arrow-up"></i>
                </span>
              </div>
            </td>
            <td class="text-end" style="width: 120px; position: relative;">
              <div style="position: relative; display: inline-block; width: 100%;">
                <input type="number" id="otherDeductions-${uidUser}" class="form-control form-control-sm" step="0.01" value="0.00" onchange="updateTotal('${uidUser}')" style="padding-right: 30px;">
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); color: var(--box4);">
                  <i class="fa-solid fa-circle-arrow-down"></i>
                </span>
              </div>
            </td>
            <td class="text-end"><span style="color: var(--box3);font-size: 14px;" id="socialSecurity-${uidUser}">${socialSecurity.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-end">
              <span id="totalIncome-${uidUser}" data-base-income="${totalIncome}" style="color: var(--box2);font-size: 14px;">${totalIncome.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span>
            </td>
          </tr>
        `;
      }
    });

    if (!hasData) {
      tableData.innerHTML = `
        <tr>
          <td colspan="17" class="fw-bold text-danger text-center p-4">
            <i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓
          </td>
        </tr>
      `;
    }
  document.getElementById('salaryBefore').textContent = salaryBeforeTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('salaryAfter').textContent = salaryBeforeTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalAdj').textContent = totalAdj.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalDow').textContent = totalDow.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  } else {
    // กรณีแก้ไขรายการ: ดึงข้อมูลจาก allSummary โดยใช้ codeID
    const summaryData = allSummary.find(summary => summary[0] === codeID);
    if (!summaryData) {
      createToast("⚠️ ไม่พบข้อมูลที่ต้องการแก้ไข", 3);
      return;
    }

    const details = JSON.parse(summaryData[5]);  // ดึงข้อมูลรายละเอียดพนักงาน
    const period = summaryData[1];  // งวดที่
    hasData = true;

    // แสดงข้อมูลพนักงานในตาราง
    details.forEach((detail, index) => {
      const { uidUser, fullName, department, group, salary, specialAllowance, otHours, otIncome, sickLeave, personalLeave, vacationLeave, otherLeave, lateDeductions, leaveDeductions, otherIncome, otherDeductions, socialSecurity, totalIncome, lateHours } = detail;
      
      // คำนวณค่าใช้จ่ายรวมและการปรับเพิ่ม/ลด
      salaryBeforeTotal += parseFloat(totalIncome);
      totalAdj += parseFloat(otherIncome);
      totalDow += parseFloat(otherDeductions);
      let cleanUidUser = uidUser.replace('รหัสพนักงาน: ', '');
      let user = dataUsers && dataUsers.find(user => user[0] === cleanUidUser);
      let userImage = user ? user[7] : 'https://cdn.jsdelivr.net/gh/EPICCODING17/image/Logo-EicCoding.png';

      tableData.innerHTML += `
        <tr>
          <td class="text-center">
            <div class="form-check">
              <input class="form-check-input select-employeesalary" type="checkbox" checked id="select-${uidUser}" data-uid="${uidUser}">
              <span style="font-size: 14px;">${period}</span>
            </div>
          </td>
          <td>
            <div style="display: flex; align-items: center;">
              <img src="${userImage}" alt="ImageUsers" width="40px" style="margin-right: 10px; border-radius: 50%;">
              <div style="font-size: 14px;">
                <span>${uidUser}</span><br>
                <span>${fullName}</span><br>
                <span>${department}</span><br>
                <span>${group}</span>
              </div>
            </div>
          </td>
          <td class="text-center"><span style="color: var(--box2);font-size: 14px;">${salary.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
          <td class="text-center"><span style="color: var(--box1);font-size: 14px;">${specialAllowance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
          <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${lateHours.toFixed(2)}</span></td>
          <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${sickLeave.toFixed(2)}</span></td>
          <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${personalLeave.toFixed(2)}</span></td>
          <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${vacationLeave.toFixed(2)}</span></td>
          <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${otherLeave.toFixed(2)}</span></td>
          <td class="text-end"><span style="color: var(--box4);font-size: 14px;">${lateDeductions.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
          <td class="text-end"><span style="color: var(--box4);font-size: 14px;">${leaveDeductions.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
          <td class="text-center"><span style="color: var(--box4);font-size: 14px;">${otHours.toFixed(2)}</span></td>
          <td class="text-center"><span style="color: var(--box1);font-size: 14px;">${otIncome.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
          <td class="text-end" style="width: 120px; position: relative;">
            <div style="position: relative; display: inline-block; width: 100%;">
              <input type="number" id="otherIncome-${uidUser}" class="form-control form-control-sm" step="0.01" value="${otherIncome.toFixed(2)}" onchange="updateTotal('${uidUser}')" style="padding-right: 30px;">
              <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); color: var(--box2);">
                <i class="fa-solid fa-circle-arrow-up"></i>
              </span>
            </div>
          </td>
          <td class="text-end" style="width: 120px; position: relative;">
            <div style="position: relative; display: inline-block; width: 100%;">
              <input type="number" id="otherDeductions-${uidUser}" class="form-control form-control-sm" step="0.01" value="${otherDeductions.toFixed(2)}" onchange="updateTotal('${uidUser}')" style="padding-right: 30px;">
              <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); color: var(--box4);">
                <i class="fa-solid fa-circle-arrow-down"></i>
              </span>
            </div>
          </td>
          <td class="text-end"><span style="color: var(--box3);font-size: 14px;">${socialSecurity.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></td>
            <td class="text-end">
              <span id="totalIncome-${uidUser}" data-base-income="${totalIncome}" style="color: var(--box2);font-size: 14px;">${totalIncome.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span>
            </td>
        </tr>
      `;
    });
  }
};

// ฟังก์ชันดึงงวดที่เลือก
const getSelectedPeriod = () => {
  const selectPeriod = document.getElementById('selectPeriod');
  return selectPeriod.value;
};

// ฟังก์ชันคำนวณเวลาสายเป็นนาที
const calculateLateMinutes = (checkInTime, standardInTime) => {
  if (!checkInTime || !standardInTime) return 0;
  const checkInMinutes = convertToMinutes(checkInTime);
  const standardInMinutes = convertToMinutes(standardInTime);
  const lateMinutes = checkInMinutes - standardInMinutes;

  // เริ่มคำนวณเฉพาะเมื่อมาสายเกิน 30 นาที
  return lateMinutes > 0 ? lateMinutes - 0 : 0;
};

// ฟังก์ชันแปลงเวลาเป็นนาที
const convertToMinutes = (timeString) => {
  const [hours, minutes] = timeString.split(':').map(Number);
  return hours * 60 + minutes;
};

// ฟังก์ชันคำนวณ OT เป็นนาที ปรับให้ใช้ convertToMinutes
const calculateOTMinutes = (checkOutTime, standardOutTime) => {
  const checkOutMinutes = convertToMinutes(checkOutTime);
  const standardOutMinutes = convertToMinutes(standardOutTime);
  const otMinutes = checkOutMinutes - standardOutMinutes;
  return otMinutes > 0 ? otMinutes : 0;
};

// ฟังก์ชันคำนวณการหักเงินจากการมาสาย
const calculateLateDeductions = (lateMinutes, salary, daysInPeriod, workHoursPerDay) => {
  const { minuteWage } = calculateHourlyAndMinuteWage(salary, daysInPeriod, workHoursPerDay);
  return lateMinutes * minuteWage;
};

// ฟังก์ชันคำนวณค่าแรงต่อวัน ต่อชั่วโมง และต่อนาที
const calculateHourlyAndMinuteWage = (salary, daysInPeriod, workHoursPerDay) => {
  const dailyWage = salary / daysInPeriod;
  const hourlyWage = dailyWage / workHoursPerDay;
  const minuteWage = hourlyWage / 60;
  return { dailyWage, hourlyWage, minuteWage };
};

// คำนวณประกันสังคมโดยใช้ค่า SSO ที่เปิดใช้งาน
const calculateSocialSecurity = (salary) => {
  const activeSSO = allSetSSO.find(sso => sso[2] === 'TRUE'); // ดึงค่า SSO ที่เปิดใช้งาน
  const ssoRate = activeSSO ? parseFloat(activeSSO[1].replace('%', '')) / 100 : 0.05; // ถ้าไม่มี SSO ที่เปิดใช้งาน ใช้ค่าเริ่มต้น 5%
  const ssoAmount = salary * ssoRate;
  return salary > 15000 ? Math.min(ssoAmount, 750) : ssoAmount;
};

// ฟังก์ชันคำนวณจำนวนวันในงวดเงินเดือน
const calculateDaysInPeriod = (startDateStr, endDateStr) => {
  const startDate = new Date(startDateStr.split('/').reverse().join('-'));
  const endDate = new Date(endDateStr.split('/').reverse().join('-'));
  const differenceInTime = endDate - startDate;
  return Math.ceil(differenceInTime / (1000 * 60 * 60 * 24)); // จำนวนวันในงวด
};

// คำนวณการหักจากวันลา
const calculateLeaveDeductions = (leaveRecords, salary, daysInPeriod) => {
  const dailyWage = salary / daysInPeriod;
  let totalLeaveDays = 0;
  let totalLeaveHours = 0;

  leaveRecords.forEach(leave => {
    totalLeaveDays += parseFloat(leave[13]);
    totalLeaveHours += parseFloat(leave[14]);
  });

  const additionalLeaveDaysFromHours = Math.floor(totalLeaveHours / 24);
  const remainingLeaveHours = totalLeaveHours % 24;
  totalLeaveDays += additionalLeaveDaysFromHours;

  const leaveDeductions = dailyWage * totalLeaveDays + (remainingLeaveHours / 24) * dailyWage;
  return leaveDeductions;
};

const calculateOTPay = (otHours, recordDate, allSetHolidayDates) => {
  const isHoliday = allSetHolidayDates && allSetHolidayDates.length > 0 
    ? allSetHolidayDates.some(dayOffDate => dayOffDate.getTime() === recordDate.getTime())
    : false;  // ถ้าไม่มีข้อมูลวันหยุดถือว่าไม่ใช่วันหยุด

  const activeOTValue = getActiveOTValue();
  const otRate = isHoliday ? 2.0 : activeOTValue; // ถ้าเป็นวันหยุด OT เพิ่มเป็น 2 เท่า

  return otHours * 200 * otRate; // คำนวณรายได้จาก OT
};

// ฟังก์ชันดึงค่า OT ที่เปิดใช้งาน
const getActiveOTValue = () => {
  const activeOT = allSetOT.find(ot => ot[2] === 'TRUE'); // ดึงค่า OT ที่เปิดใช้งาน (status === 'TRUE')
  return activeOT ? parseFloat(activeOT[1]) : 1.0; // ถ้าไม่มี OT ที่เปิดใช้งาน ให้คืนค่าเป็น 1.0
};

// ฟังก์ชันคำนวณรายได้รวมใหม่
const updateTotal = (uid) => {
  // ดึงข้อมูลจากฟิลด์ที่มีการกรอก
  const otherIncomeInput = document.getElementById(`otherIncome-${uid}`);
  const otherDeductionsInput = document.getElementById(`otherDeductions-${uid}`);
  const totalIncomeElement = document.getElementById(`totalIncome-${uid}`);
  
  if (!otherIncomeInput || !otherDeductionsInput || !totalIncomeElement) {
    return;
  }

  const otherIncome = parseFloat(otherIncomeInput.value) || 0;
  const otherDeductions = parseFloat(otherDeductionsInput.value) || 0;
  
  otherIncomeInput.value = otherIncomeInput.value.trim() === '' ? '0.00' : otherIncome.toFixed(2);
  otherDeductionsInput.value = otherDeductionsInput.value.trim() === '' ? '0.00' : otherDeductions.toFixed(2);

  const baseIncome = parseFloat(totalIncomeElement.getAttribute('data-base-income')) || 0;
  const newTotalIncome = (baseIncome + otherIncome - otherDeductions).toFixed(2);

  totalIncomeElement.textContent = newTotalIncome.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

  // ปรับค่า salaryAfter ใหม่
  let salaryAfterTotal = 0;
  let totalAdj = 0;
  let totalDow = 0;

  const totalIncomeElements = document.querySelectorAll('[id^="totalIncome-"]');
  totalIncomeElements.forEach(element => {
    salaryAfterTotal += parseFloat(element.textContent.replace(/,/g, '')) || 0;
  });

  const otherIncomeElements = document.querySelectorAll('[id^="otherIncome-"]');
  otherIncomeElements.forEach(element => {
    if (element) {
      totalAdj += parseFloat(element.value.replace(/,/g, '')) || 0;
    }
  });

  const otherDeductionsElements = document.querySelectorAll('[id^="otherDeductions-"]');
  otherDeductionsElements.forEach(element => {
    if (element) {
      totalDow += parseFloat(element.value.replace(/,/g, '')) || 0;
    }
  });

  document.getElementById('salaryAfter').textContent = salaryAfterTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalAdj').textContent = totalAdj.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalDow').textContent = totalDow.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
};

const updateAllTotals = () => {
  const tableBody = document.getElementById('tableDataSalary');
  if (!tableBody) return;

  const rows = tableBody.querySelectorAll('tr');
  
  const hasNoData = rows.length === 0 || 
    (rows.length === 1 && rows[0].querySelector('td[colspan]')?.textContent.includes('ไม่พบข้อมูล'));

  if (hasNoData) {
    createToast("⚠️ ไม่พบข้อมูลในตาราง", 3);
    return;
  }

  const deductLate = document.getElementById('deductLate').checked;
  const deductLeave = document.getElementById('deductLeave').checked;
  const includeOT = document.getElementById('includeOT').checked;
  const includeSSO = document.getElementById('includeSSO').checked;
  
  let salaryAfterTotal = 0;
  let totalAdj = 0;
  let totalDow = 0;

  // คำนวณยอดรวมจากทุกแถว ไม่ว่าจะถูกเลือกหรือไม่
  rows.forEach(row => {
    const salaryCell = row.querySelector('td:nth-child(3) span');
    if (!salaryCell) return;

    const totalIncomeCell = row.querySelector('[id^="totalIncome-"]');
    const baseIncome = parseFloat(totalIncomeCell.getAttribute('data-base-income').replace(/,/g, '')) || 0;
    salaryAfterTotal += baseIncome;
  });

  // อัพเดทการแสดงผลและคำนวณส่วนที่ปรับเพิ่ม/ลด
  rows.forEach(row => {
    const checkbox = row.querySelector('.select-employeesalary');
    const salaryCell = row.querySelector('td:nth-child(3) span');
    if (!salaryCell) return;

    // ดึงค่าที่ต้องการปรับ
    const lateDeductionsCell = row.querySelector('td:nth-child(10) span');
    const leaveDeductionsCell = row.querySelector('td:nth-child(11) span');
    const otPayCell = row.querySelector('td:nth-child(13) span');
    const ssoCell = row.querySelector('td:nth-child(16) span');
    const totalIncomeCell = row.querySelector('[id^="totalIncome-"]');
    const otherIncomeInput = row.querySelector('[id^="otherIncome-"]');
    const otherDeductionsInput = row.querySelector('[id^="otherDeductions-"]');

    // เก็บค่าดั้งเดิมถ้ายังไม่เคยเก็บ
    if (!lateDeductionsCell.hasAttribute('data-original')) {
      lateDeductionsCell.setAttribute('data-original', lateDeductionsCell.textContent);
    }
    if (!leaveDeductionsCell.hasAttribute('data-original')) {
      leaveDeductionsCell.setAttribute('data-original', leaveDeductionsCell.textContent);
    }
    if (!otPayCell.hasAttribute('data-original')) {
      otPayCell.setAttribute('data-original', otPayCell.textContent);
    }
    if (!ssoCell.hasAttribute('data-original')) {
      ssoCell.setAttribute('data-original', ssoCell.textContent);
    }

    const originalLateDeductions = parseFloat(lateDeductionsCell.getAttribute('data-original').replace(/,/g, '')) || 0;
    const originalLeaveDeductions = parseFloat(leaveDeductionsCell.getAttribute('data-original').replace(/,/g, '')) || 0;
    const originalOtPay = parseFloat(otPayCell.getAttribute('data-original').replace(/,/g, '')) || 0;
    const originalSSO = parseFloat(ssoCell.getAttribute('data-original').replace(/,/g, '')) || 0;
    const otherIncome = parseFloat(otherIncomeInput?.value || 0);
    const otherDeductions = parseFloat(otherDeductionsInput?.value || 0);

    // อัพเดทการแสดงผลและคำนวณการปรับเพิ่ม/ลด
    if (checkbox?.checked) {
      let adjustment = 0;
      
      if (!deductLate) adjustment += originalLateDeductions;
      if (!deductLeave) adjustment += originalLeaveDeductions;
      if (!includeOT) adjustment -= originalOtPay;
      if (!includeSSO) adjustment += originalSSO;

      // แสดงค่าตามการติ๊ก
      lateDeductionsCell.textContent = deductLate ? lateDeductionsCell.getAttribute('data-original') : '0.00';
      leaveDeductionsCell.textContent = deductLeave ? leaveDeductionsCell.getAttribute('data-original') : '0.00';
      otPayCell.textContent = includeOT ? otPayCell.getAttribute('data-original') : '0.00';
      ssoCell.textContent = includeSSO ? ssoCell.getAttribute('data-original') : '0.00';

      // ปรับยอดรวม
      salaryAfterTotal += adjustment;
      totalAdj += otherIncome;
      totalDow += otherDeductions;
    }
  });

  // อัพเดทยอดรวมทั้งหมด
  document.getElementById('salaryAfter').textContent = salaryAfterTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalAdj').textContent = totalAdj.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalDow').textContent = totalDow.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
};

const toggleAllEmployees = (checked) => {
  const checkboxes = document.querySelectorAll('.select-employeesalary');
  checkboxes.forEach(checkbox => {
    checkbox.checked = checked;
  });
  updateAllTotals();
};

document.querySelectorAll('.select-employeesalary').forEach(checkbox => {
  checkbox.addEventListener('change', updateAllTotals);
});

const selectAllEmployees = (select) => {
  const checkboxes = document.querySelectorAll('.select-employeesalary');
  checkboxes.forEach(checkbox => {
    checkbox.checked = select;
  });
  updateAllTotals();
  
  if (checkboxes.length > 0) {
    createToast(select ? "✅ เลือกพนักงานทั้งหมดแล้ว" : "✅ ยกเลิกการเลือกทั้งหมดแล้ว", 1);
  }
};

const actionSummary = () => {
  event.preventDefault();
  const summaryData = [];
  const key = document.getElementById('dataSalaryKey').value;
  const rows = document.querySelectorAll('#tableDataSalary tr');
  let dueDate = document.getElementById('dataSalary').value;

  if (!dueDate) {
    createToast("⚠️ กรุณาเลือกวันที่กำหนดชำระ", 3);
    return;
  }

  if (rows.length === 0) {
    createToast("⚠️ กรุณาดึงข้อมูลก่อนนำส่ง", 3);
    return;
  }

  const details = [];
  let totalLateDeductions = 0;
  let totalLeaveDeductions = 0;
  let totalOTIncome = 0;
  let totalSocialSecurity = 0;
  let totalOtherDeductions = 0;
  let totalOtherIncome = 0;
  let totalRowIncome = 0;

  let salaryBeforeTotal = parseFloat(document.getElementById('salaryBefore').textContent.replace(/,/g, '')) || 0;

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const period = cells[0]?.innerText.trim();
    const [uidUser, fullName, department, group] = cells[1]?.innerText.trim().split('\n') || [];
    const salary = parseFloat(cells[2]?.innerText.replace(/,/g, '') || 0);
    const specialAllowance = parseFloat(cells[3]?.innerText.replace(/,/g, '') || 0);
    const lateHours = parseFloat(cells[4]?.innerText.replace(/,/g, '') || 0);
    const sickLeave = parseFloat(cells[5]?.innerText.replace(/,/g, '') || 0);
    const personalLeave = parseFloat(cells[6]?.innerText.replace(/,/g, '') || 0);
    const vacationLeave = parseFloat(cells[7]?.innerText.replace(/,/g, '') || 0);
    const otherLeave = parseFloat(cells[8]?.innerText.replace(/,/g, '') || 0);
    const lateDeductions = parseFloat(cells[9]?.innerText.replace(/,/g, '') || 0);
    const leaveDeductions = parseFloat(cells[10]?.innerText.replace(/,/g, '') || 0);
    const otHours = parseFloat(cells[11]?.innerText.replace(/,/g, '') || 0);
    const otIncome = parseFloat(cells[12]?.innerText.replace(/,/g, '') || 0);
    const otherIncome = parseFloat(cells[13]?.querySelector('input').value || 0);
    const otherDeductions = parseFloat(cells[14]?.querySelector('input').value || 0);
    const socialSecurity = parseFloat(cells[15]?.innerText.replace(/,/g, '') || 0);
    const totalIncome = parseFloat(cells[16]?.innerText.replace(/,/g, '') || 0);

    totalLateDeductions += lateDeductions;
    totalLeaveDeductions += leaveDeductions;
    totalOTIncome += otIncome;
    totalSocialSecurity += socialSecurity;
    totalOtherDeductions += otherDeductions;
    totalOtherIncome += otherIncome;
    totalRowIncome += totalIncome;

    details.push({
      uidUser,
      fullName,
      department,
      group,
      salary,
      specialAllowance,
      lateHours,
      sickLeave,
      personalLeave,
      vacationLeave,
      otherLeave,
      lateDeductions,
      leaveDeductions,
      otHours,
      otIncome,
      otherIncome,
      otherDeductions,
      socialSecurity,
      totalIncome
    });
  });

  if (rows.length > 0) {
    const period = rows[0].querySelectorAll('td')[0]?.innerText.trim();
    summaryData.push({
      key,
      period,
      status: 'รอดำเนินการ',
      day: new Date().toLocaleDateString('th-TH'),
      dueDate,
      details,
      totalLateDeductions,
      totalLeaveDeductions,
      totalOTIncome,
      totalSocialSecurity,
      totalOtherDeductions,
      totalOtherIncome,
      salaryBeforeTotal,
      totalRowIncome
    });
  }

  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });

  if (!key) {
    google.script.run.withSuccessHandler(async (res) => {
      $.LoadingOverlay("hide");
      await updateSpecificSummaryData();
      clearSummaryData();
      createToast("✅ นำส่งข้อมูลสำเร็จ", 1);
    }).saveSummary(summaryData);
  } else {
    google.script.run.withSuccessHandler(async (res) => {
      $.LoadingOverlay("hide");
      await updateSpecificSummaryData();
      clearSummaryData();
      createToast("✅ แก้ไขข้อมูลนำส่งสำเร็จ", 1);
    }).updateSummary(summaryData);
  }
};

const clearSummaryData = () => { 
  document.getElementById('dataSalary').value = "";
  document.getElementById('dataSalaryKey').value = "";
  const selectPeriod = document.getElementById('selectPeriod');
  selectPeriod.value = '';
  const tableData = document.getElementById('tableDataSalary');
  tableData.innerHTML = '';  
  if (!tableData.innerHTML.trim()) {
    tableData.innerHTML = `
    <tr>
      <td colspan="17" class="fw-bold text-danger text-center p-4">
        <i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓
      </td>
    </tr>`;
  }

  document.getElementById('deductLate').checked = true; 
  document.getElementById('deductLeave').checked = true;
  document.getElementById('includeOT').checked = true; 
  document.getElementById('includeSSO').checked = true;
  document.getElementById('salaryBefore').innerText = "0.00";
  document.getElementById('salaryAfter').innerText = "0.00";
  document.getElementById('totalAdj').innerText = "0.00";
  document.getElementById('totalDow').innerText = "0.00";
  changePage(5);
};
</script>

Page/04_Summary.html = 
<div class="row g-3 mt-2">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm mb-2">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12 col-md-4 mb-2 mb-md-0">💹 Dashboard</div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <ul class="box-info">
          <li>
            <i class="fa-solid fa-sack-dollar"></i>
            <span class="text">
              <p>พนักงาน</p>
              <h3 id="countingSalaryA">0 <span style="font-size: 12px">(บาท)</span></h3>                
            </span>
          </li>
          <li>
            <i class="fa-solid fa-landmark"></i>
            <span class="text">
              <p>รวมจ่ายสุทธิ</p>
              <h3 id="countingSalaryB">0 <span style="font-size: 12px">(บาท)</span></h3>                
            </span>
          </li>
          <li>
            <i class="fa-solid fa-user-doctor"></i>
            <span class="text">
              <p>รวมหักลา</p>
              <h3 id="countingSalaryC">0 <span style="font-size: 12px">(บาท)</span></h3>        
            </span>
          </li>
          <li>
            <i class="fa-solid fa-user-shield"></i>
            <span class="text">
              <p>ประกันสังคม</p>
              <h3 id="countingSalaryD">0 <span style="font-size: 12px">(บาท)</span></h3>               
            </span>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-12 mb-2 mb-md-0">💹 สถิติการจ่ายเงินเดือน</div>
        </div>
      </div>
        <div class="card-body rounded-4">
          <div id="chartSalary" style="width: 100%; height: 200px;"></div>
        </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-12 mb-2 mb-md-0">💹 เปอร์เซ็นการจ่าย</div>
        </div>
      </div>
        <div class="card-body rounded-4">
          <div id="chartSummary" style="width: 100%; height: 200px;"></div>
        </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12 col-md-4 mb-2 mb-md-0">🏛️ รายการนำส่งเงินเดือน</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <select class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" onchange="updateItemsSummary(this.value)">
              <option value="10">✅ 10</option>
              <option value="20">✅ 25</option>
              <option value="50">✅ 50</option>
              <option value="100">✅ 100</option>
              <option value="all">✅ ทั้งหมด</option>
            </select>
            <input type="search" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" id="searchSummary" placeholder="🔍ค้นหาข้อมูล..." oninput="filterSummary()">
          </div>
        </div>

      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">งวดที่</th>
                <th scope="col" class="text-center">วันที่ทำรายการ</th>
                <th scope="col" class="text-center">กำหนดชำระ</th>
                <th scope="col" class="text-center">จำนวนพนักงาน</th>
                <th scope="col" class="text-center">รวมหักสาย</th>
                <th scope="col" class="text-center">รวมหักลา</th>
                <th scope="col" class="text-center">รวมหักประกันสังคม</th>
                <th scope="col" class="text-center">รวมหักอื่น</th>
                <th scope="col" class="text-center">รวมOT</th>
                <th scope="col" class="text-center">รายได้อื่นๆ</th>
                <th scope="col" class="text-center">รวมจ่ายพนักงาน</th>
                <th scope="col" class="text-center">รวมจ่ายสุทธิ</th>
                <th scope="col" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody id="tableDataSummary">
              <tr>
                <td colspan='13' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>
              </tr>
            </tbody>       
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationSummaryInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationSummary" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let filteredSummary = [];
let currentSummary = 1;
let itemsPerSummary = 10;

const renderSummary = (res) => {
  const table = document.getElementById('tableDataSummary');
  table.innerHTML = '';

  res.sort((a, b) => {
    const dateA = new Date(a[4].split('/').reverse().join('/'));
    const dateB = new Date(b[4].split('/').reverse().join('/'));
    return dateB - dateA;
  });

  const startIndex = (currentSummary - 1) * itemsPerSummary;
  const endIndex = startIndex + itemsPerSummary;
  const emp = res.slice(startIndex, endIndex);

  const startRow = startIndex + 1;
  const endRow = startIndex + emp.length;
  const totalRows = res.length;

  document.getElementById('paginationSummaryInfo').innerText = `แสดง ${startRow} ถึง ${endRow} จาก ${totalRows} แถว`;

  if (emp.length === 0) {
    const row = table.insertRow();
    row.innerHTML = `<td colspan='13' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>`;
    return;
  }

  emp.forEach((rowIndex) => {
    const details = JSON.parse(rowIndex[5]);
    const employeeCount = details.length;
    var row = table.insertRow();
    row.innerHTML = `
      <td class="text-center"><span style="font-size: 14px;">${rowIndex[1]}</span></td>
      <td class="text-center"><span style="font-size: 14px;">${rowIndex[3]}</span></td>
      <td class="text-center"><span style="font-size: 14px;">${rowIndex[4]}</span></td>
      <td class="text-center"><span style="font-size: 14px;">🙍‍♂️ <span style="color: var(--box1);">จำนวน ${employeeCount} คน</span></span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box4);"><i class="fa-solid fa-circle-arrow-down"></i> ${rowIndex[6]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box4);"><i class="fa-solid fa-circle-arrow-down"></i> ${rowIndex[7]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box4);"><i class="fa-solid fa-circle-arrow-down"></i> ${rowIndex[9]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box4);"><i class="fa-solid fa-circle-arrow-down"></i> ${rowIndex[10]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box2);"><i class="fa-solid fa-circle-arrow-up"></i> ${rowIndex[8]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box2);""><i class="fa-solid fa-circle-arrow-up"></i> ${rowIndex[11]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box3);"">🙍‍♂️ ${rowIndex[12]} บาท</span></td>
      <td class="text-center"><span style="font-size: 14px;color: var(--box2);""><i class="fa-solid fa-sack-dollar"></i> ${rowIndex[13]} บาท</span></td>
      <td class="text-center">
        <div style="display: flex; justify-content: center;">
          <select class="form-control me-2" style="font-size: 14px; width: auto;" disabled>
            <option value="รอดำเนินการ" ${rowIndex[2] === 'รอดำเนินการ' ? 'selected' : ''}>⌛ รอดำเนินการ</option>
            <option value="ยกเลิกรายการ" ${rowIndex[2] === 'ยกเลิกรายการ' ? 'selected' : ''}>❌ ยกเลิกรายการ</option>
            <option value="ชำระเงินแล้ว" ${rowIndex[2] === 'ชำระเงินแล้ว' ? 'selected' : ''}>✅ ชำระเงินแล้ว</option>
          </select>
          <div class="dropdown">
            <button class="btn btn-sm del-button dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa-solid fa-ellipsis"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item hover-highlight" onclick="editSummary('${rowIndex[0]}')"><i class="fa-solid fa-pen-to-square"></i> แก้ไขรายการ</a></li>
              <li><a class="dropdown-item hover-highlight" onclick="sendSummary('${rowIndex[0]}')"><i class="fa-solid fa-building-columns"></i> นำส่งข้อมูล</a></li>
              <li><a class="dropdown-item hover-highlight" onclick="sendPayslip('${rowIndex[0]}')"><i class="fa-regular fa-paper-plane"></i> ส่งสลีปทั้งหมด</a></li>
              <li><a class="dropdown-item hover-highlight" onclick="sendExcel('${rowIndex[0]}')"><i class="fa-regular fa-file-excel"></i> Download Excel</a></li>
              <li><a class="dropdown-item hover-highlight" onclick="delSummary('${rowIndex[0]}')"><i class="fa-solid fa-trash-can"></i> ลบรายการ</a></li>
            </ul>
          </div>
        </div>
      </td>
    `;
  });
}

const renderPageSummary = (totalItems) => {
  const totalPages = Math.ceil(totalItems / itemsPerSummary);
  const paginationContainer = document.getElementById('paginationSummary');
  paginationContainer.innerHTML = '';
  if (totalPages > 1) {
    const createPageButton = (text, page, isDisabled = false, isActive = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
      const button = document.createElement('button');
      button.className = 'page-link';
      button.innerText = text;
      button.onclick = () => {
        if (!isDisabled) {
        currentSummary = page;
        renderSummary(allSummary);
        renderPageSummary(allSummary.length);
        }
      };
      li.appendChild(button);
      return li;
    };
    paginationContainer.appendChild(createPageButton('ย้อนกลับ', currentSummary - 1, currentSummary === 1));

    if (currentSummary > 2) {
      paginationContainer.appendChild(createPageButton(1, 1, false, currentSummary === 1));
      if (currentSummary > 3) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
    }
    paginationContainer.appendChild(createPageButton(currentSummary, currentSummary, false, true));

    if (currentSummary < totalPages - 1) {
      if (currentSummary < totalPages - 2) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
      paginationContainer.appendChild(createPageButton(totalPages, totalPages, false, currentSummary === totalPages));
    }
    paginationContainer.appendChild(createPageButton('ถัดไป', currentSummary + 1, currentSummary === totalPages));
  }
}

const filterSummary = () => {
  const query = document.getElementById('searchSummary').value.toLowerCase();
  filteredSummary = allSummary.filter(row => {
    return row.some(column => column.toLowerCase().includes(query));
  });

  currentSummary = 1;
  renderSummary(filteredSummary);
  renderPageSummary(filteredSummary.length);
}

const updateItemsSummary = (value) => {
  if (value === "all") {
    itemsPerSummary = filteredSummary.length;
  } else {
    itemsPerSummary = parseInt(value, 10);
  }

  currentSummary = 1;
  renderSummary(filteredSummary);
  renderPageSummary(filteredSummary.length);
}

const editSummary = (codeID) => {
  const summaryData = allSummary.find(summary => summary[0] === codeID);

  if (!summaryData) {
    createToast("⚠️ ไม่พบข้อมูลที่ต้องการแก้ไข", 3);
    return;
  }

  const editMode = true;
  const period = summaryData[1]; // งวดที่
  const paymentDate = summaryData[4]; // กำหนดชำระ
  const totalDow = parseFloat(summaryData[10].replace(/,/g, '')) || 0;  // รวมปรับลด
  const totalAdj = parseFloat(summaryData[11].replace(/,/g, '')) || 0;  // รวมปรับเพิ่ม
  const salaryBefore = parseFloat(summaryData[12].replace(/,/g, '')) || 0;  // รวมจ่ายพนักงาน
  const salaryAfter = parseFloat(summaryData[13].replace(/,/g, '')) || 0;  // รวมจ่ายสุทธิ

  const selectPeriod = document.getElementById('selectPeriod');
  const periodOption = Array.from(selectPeriod.options).find(option => option.text.includes(period));
  if (periodOption) {
    selectPeriod.value = periodOption.value;
  }

  document.getElementById('dataSalary').value = paymentDate.split('/').reverse().join('-');
  document.getElementById('dataSalaryKey').value = codeID;

  document.getElementById('salaryBefore').textContent = salaryBefore.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('salaryAfter').textContent = salaryAfter.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalAdj').textContent = totalAdj.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('totalDow').textContent = totalDow.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

  changePage(4);
  renderSalaryData(editMode, codeID);
};

const delSummary = (codeID) => {
  let rowIndex = allSummary.find(row => row[0] === codeID);
  if (rowIndex) {
    $('#confirmBtnDel').off('click').on('click', function() {
      $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
      $('#DelDataModal').modal('hide');
      google.script.run.withSuccessHandler(async (res) => {
        rowIndex = allSummary.filter(row => row[0] !== codeID);
        $.LoadingOverlay("hide");
        await updateSpecificSummaryData();
        createToast("⛔ ลบข้อมูลสำเร็จ", 0);
      }).delDataSummary(codeID);
    });
    $('#xDelconfirmData').off('click').on('click', function() {
      $('#DelDataModal').modal('hide');
    });
    $('#DelDataModal').modal('show');
  }
}

let selectedBankCodeID = null;

const sendSummary = (codeID) => {
  selectedBankCodeID = codeID;
  openBankSelectModal();
};

const sendSummaryBankCode = (codeID, bankCode) => {
  const summaryData = allSummary.find(summary => summary[0] === codeID);

  if (!summaryData) {
    createToast("⚠️ ไม่พบข้อมูลที่นำส่งข้อมูล", 3);
    return;
  }

  try {
    let employeeDetails = JSON.parse(summaryData[5]);
    let textFileContent = '';

    employeeDetails.forEach(employee => {
      let uidUser = employee.uidUser.replace("รหัสพนักงาน: ", "");
      let userData = dataUsers && dataUsers.find(user => user[0] === uidUser);
      
      if (userData) {
        let bankAccount = userData[25]; // บัญชีธนาคาร
        let citizenId = userData[12]; // เลขบัตรประชาชน
        let fullName = employee["fullName"].replace("ชื่อ สกุล: ", ""); // ชื่อเต็ม
        let totalIncome = employee["totalIncome"]; // รวมเงินได้
        let email = userData[30]; // Email
        let mobile = userData[32]; // เบอร์โทรศัพท์
        textFileContent += `${bankCode} ${bankAccount} ${citizenId} ${fullName} ${totalIncome} ${email} ${mobile}\n`;
      } else {
        createToast("⚠️ ไม่พบข้อมูลพนักงานสำหรับ UID", 0);
      }
    });

    const blob = new Blob([textFileContent], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'HRCloud-Epic Coding Channel.txt';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    createToast("✅ สร้างไฟล์ .txt สำเร็จ!", 1);

    google.script.run
      .withSuccessHandler(async (res) => {
        await updateSpecificSummaryData();
        createToast("✅ ปรับสถานะรายการสำเร็จ!", 1);
      })
      .withFailureHandler(async (res) => {
        await updateSpecificSummaryData();
        createToast("⚠️ เกิดข้อผิดพลาดในการปรับสถานะ", 0);
      })
      .updatebankCode(codeID, "ชำระเงินแล้ว");

  } catch (e) {
    createToast("⚠️ เกิดข้อผิดพลาดในการประมวลผลข้อมูล", 0);
    console.error(e);
  }
};

const sendExcel = (codeID) => {
  const summaryData = allSummary.find(summary => summary[0] === codeID);

  if (!summaryData) {
    createToast("⚠️ ไม่พบข้อมูลที่นำส่งข้อมูล", 0);
    return;
  }

  try {
    let employeeDetails = JSON.parse(summaryData[5]);

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    // แถวผสานที่ด้านบน
    const mergedRow = document.createElement('tr');
    const mergedCell = document.createElement('td');
    mergedCell.colSpan = 20;  // ผสานเซลล์ทั้งหมด (จำนวนคอลัมน์)
    mergedCell.textContent = 'งวดเงินเดือน: ' + summaryData[1] + ' | รวมจ่ายพนักงาน: ' + summaryData[12] + ' | รายได้รวม: ' + summaryData[13];
    mergedCell.style.fontWeight = 'bold';  // ทำให้ข้อความตัวหนา
    mergedRow.appendChild(mergedCell);
    thead.appendChild(mergedRow);  // เพิ่มแถวผสานไปที่ thead

    // สร้างหัวตาราง
    const headers = [
      "รหัสพนักงาน", "ชื่อ สกุล", "ตำแหน่ง", "แผนก", "เลขบัตรประชาชน", 
      "เงินเดือน", "เงินพิเศษ", "สายรวม", "ลาป่วย", "ลากิจ", 
      "ลาพักร้อน", "ลาอื่นๆ", "หักสาย", "หักลา", "จำนวน OT", 
      "รายได้ OT", "รายได้อื่นๆ", "หักอื่นๆ", "ประกันสังคม", "รายได้รวม"
    ];

    const headerRow = document.createElement('tr');
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    // เพิ่มข้อมูลพนักงานแต่ละคนในตาราง
    employeeDetails.forEach(employee => {
      const row = document.createElement('tr');
      let uidUser = employee.uidUser.replace("รหัสพนักงาน: ", "");
      let userData = dataUsers && dataUsers.find(user => user[0] === uidUser);
      let citizenId = userData ? "'" + userData[12].toString() : "ไม่พบข้อมูล";

      const cells = [
        uidUser,
        employee["fullName"].replace("ชื่อ สกุล: ", ""),
        employee["department"].replace("ตำแหน่ง: ", ""),
        employee["group"].replace("แผนก: ", ""),
        citizenId,
        employee["salary"],
        employee["specialAllowance"],
        employee["lateHours"],
        employee["sickLeave"],
        employee["personalLeave"],
        employee["vacationLeave"],
        employee["otherLeave"],
        employee["lateDeductions"],
        employee["leaveDeductions"],
        employee["otHours"],
        employee["otIncome"],
        employee["otherIncome"],
        employee["otherDeductions"],
        employee["socialSecurity"],
        employee["totalIncome"]
      ];
      cells.forEach(cellContent => {
        const td = document.createElement('td');
        td.textContent = cellContent;
        row.appendChild(td);
      });
      tbody.appendChild(row);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    const workbook = XLSX.utils.table_to_book(table, { sheet: "Employee Summary" });
    XLSX.writeFile(workbook, 'HRCloud-Epic Coding Channel.xlsx');

  } catch (e) {
    createToast("⚠️ เกิดข้อผิดพลาดในการประมวลผลข้อมูล", 0);
    console.error(e);
  }
};

const sendPayslip = (codeID) => {
  const summaryData = allSummary.find(summary => summary[0] === codeID);

  if (!summaryData) {
    createToast("⚠️ ไม่พบข้อมูลที่นำส่งข้อมูล", 0);
    return;
  }

  let employeeDetails = JSON.parse(summaryData[5]);
  let totalEmployees = employeeDetails.length; // จำนวนพนักงานทั้งหมด
  let emailsSent = 0; // ตัวนับอีเมลที่ถูกส่งสำเร็จ

  employeeDetails.forEach(employee => {
    let uidUser = employee.uidUser.replace("รหัสพนักงาน: ", "");
    let userData = dataUsers && dataUsers.find(user => user[0] === uidUser);

    if (userData) {
      let email = userData[30];

      // คำนวณเงินได้สะสมและประกันสังคมสะสม
      let retainedIncome = allSummary
        .filter(s => JSON.parse(s[5]).some(e => e.uidUser.includes(uidUser)))
        .reduce((total, s) => total + JSON.parse(s[5])
          .filter(e => e.uidUser.includes(uidUser))
          .reduce((sum, e) => sum + e.totalIncome, 0), 0);

      let retainedSocialSecurity = allSummary
        .filter(s => JSON.parse(s[5]).some(e => e.uidUser.includes(uidUser)))
        .reduce((total, s) => total + JSON.parse(s[5])
          .filter(e => e.uidUser.includes(uidUser))
          .reduce((sum, e) => sum + e.socialSecurity, 0), 0);

      let payrollData = {
        fullname: employee["fullName"].replace("ชื่อ สกุล: ", ""),
        uid: uidUser,
        department: employee["department"].replace("ตำแหน่ง: ", ""),
        group: employee["group"].replace("แผนก: ", ""),
        paymentPeriod: summaryData[1],
        paymentDate: summaryData[4],
        accountbank: userData[25],
        paysalary: employee["salary"],
        payspecial: employee["specialAllowance"],
        overtime: employee["otIncome"],
        socialSecurity: employee["socialSecurity"],
        commission: employee["otherIncome"],
        absentDeduction: employee["lateDeductions"] + employee["leaveDeductions"],
        otherDeduction: employee["otherDeductions"],
        totalpaysalary: employee["totalIncome"],
        adjustments: employee["salary"] + employee["specialAllowance"] + employee["otIncome"] + employee["otherIncome"],
        deductions: employee["lateDeductions"] + employee["leaveDeductions"] + employee["otherDeductions"] + employee["socialSecurity"],
        retainedIncome: retainedIncome,
        retainedSocialSecurity: retainedSocialSecurity
      };

      createPayroll(payrollData, (base64PDF) => {
        google.script.run.withSuccessHandler((res) => {
          emailsSent++; 
          if (emailsSent === totalEmployees) {
            createToast("✅ ส่ง PaySlip สำเร็จ", 1);
          }
        }).sendPayrollEmail(email, { ...payrollData, base64: base64PDF });
      });
    } else {
      createToast(`⚠️ ไม่พบข้อมูลพนักงานสำหรับ UID: ${uidUser}`, 0);
    }
  });
};

const formatCountsSalary = (num) => {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(2) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(2) + 'K';
  } else {
    return num.toLocaleString();
  }
}

const updateCountsSalary = (data) => { 
  const countingSalaryA = data.reduce((sum, item) => 
    sum + (parseFloat(item[12].replace(/,/g, '')) || 0), 0);
  const countingSalaryB = data.reduce((sum, item) => 
    sum + (parseFloat(item[13].replace(/,/g, '')) || 0), 0);
  const countingSalaryC = data.reduce((sum, item) => 
    sum + (parseFloat(item[7].replace(/,/g, '')) || 0), 0);
  const countingSalaryD = data.reduce((sum, item) => 
    sum + (parseFloat(item[9].replace(/,/g, '')) || 0), 0);

  document.getElementById('countingSalaryA').innerText = formatCountsSalary(countingSalaryA.toFixed(2));
  document.getElementById('countingSalaryB').innerText = formatCountsSalary(countingSalaryB.toFixed(2));
  document.getElementById('countingSalaryC').innerText = formatCountsSalary(countingSalaryC.toFixed(2));
  document.getElementById('countingSalaryD').innerText = formatCountsSalary(countingSalaryD.toFixed(2));
}

const insertChartSalary = (data) => { 
  const checkChart1 = document.querySelector("#chartSalary").querySelector('.apexcharts-canvas');
  const checkChart2 = document.querySelector("#chartSummary").querySelector('.apexcharts-canvas');
  if (checkChart1) {
    checkChart1.remove();
  }
  if (checkChart2) {
    checkChart2.remove();
  }

  let monthlyTotalIncome = new Map();
  const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
  const colors = ['#3c8cf3', '#05be8a', '#745af2', '#ef5350', '#ffca28', '#8e44ad', '#3498db', '#1abc9c', '#e74c3c', '#f39c12', '#d35400', '#2ecc71'];

  data.forEach((item) => {
    if (item[4] && item[13]) {
      const parts = item[4].split("/"); // แยกวันที่/เดือน/ปี
      const dueDate = new Date(parts[2], parts[1] - 1, parts[0]); // แปลงวันที่ให้ถูกต้อง
      const month = dueDate.getMonth(); // หาค่าเดือนจากวันที่ที่กำหนด
      const monthName = monthNames[month];

      const totalIncome = parseFloat(item[13].replace(/,/g, '')) || 0; // แปลงรายได้รวมพร้อมจัดการกับเครื่องหมายจุลภาค

      if (monthlyTotalIncome.has(monthName)) {
        monthlyTotalIncome.set(monthName, monthlyTotalIncome.get(monthName) + totalIncome);
      } else {
        monthlyTotalIncome.set(monthName, totalIncome);
      }
    }
  });

  let totalIncomeAllMonths = Array.from(monthlyTotalIncome.values()).reduce((acc, val) => acc + val, 0); // หารายได้รวมของทุกเดือน
  let seriesData = monthNames.map(month => monthlyTotalIncome.get(month) || 0);

  // คำนวณเปอร์เซ็นต์ของแต่ละเดือน
  let percentageData = seriesData.map(val => ((val / totalIncomeAllMonths) * 100).toFixed(2)); // คำนวณเป็น % แต่จะเก็บเป็น string

  // แปลงค่า % เป็นตัวเลขเพื่อให้ Pie Chart แสดงผลได้
  let percentageDataNumbers = percentageData.map(val => parseFloat(val));

  // กราฟ Bar สำหรับรายได้รวม
  var optionsBar = {
    series: [{
      name: 'รายได้รวม',
      data: seriesData.map(val => val.toFixed(2))
    }],
    chart: {
      height: 260,
      type: 'bar',
      events: {
        click: function(chart, w, e) {
          // เมื่อคลิกที่กราฟ
        }
      }
    },
    colors: colors,
    plotOptions: {
      bar: {
        columnWidth: '45%',
        distributed: true,
      }
    },
    dataLabels: {
      enabled: false
    },
    legend: {
      show: false
    },
    xaxis: {
      categories: monthNames,
      labels: {
        style: {
          colors: colors,
          fontSize: '12px',
          fontFamily: 'Prompt, sans-serif'
        }
      }
    }
  };

  const chartBar = new ApexCharts(document.querySelector("#chartSalary"), optionsBar);
  chartBar.render();

  // กราฟ Pie สำหรับเปอร์เซ็นต์รายได้ของแต่ละเดือน
  var optionsPie = {
    series: percentageDataNumbers, // ใช้ค่าตัวเลขที่ถูกแปลง
    chart: {
      height: 270,
      type: 'pie',
    },
    colors: colors, // ใช้สีที่กำหนดไว้
    labels: monthNames, // แสดงชื่อเดือนในกราฟ
    legend: {
      position: 'right',  // ตั้งตำแหน่ง legend ให้ไปทางขวา
      horizontalAlign: 'center', // จัดชิดแนวนอนให้อยู่ตรงกลาง
      floating: false
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return val.toFixed(2) + '%';
      }
    },
    tooltip: {
      y: {
        formatter: function (val) {
          return val.toFixed(2) + '%';
        }
      }
    }
  };

  const chartPie = new ApexCharts(document.querySelector("#chartSummary"), optionsPie);
  chartPie.render();
};
</script>
Page/05_Employee = 
<div class="row g-3 mt-2">
  <div class="col-12 col-lg-12 col-xl-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-4 mb-2 mb-md-0">👦 จัดการข้อมูลพนักงาน</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <input type="search" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" id="searchEmployee" placeholder="🔍ค้นหาพนักงาน..." oninput="filterEmployee()">
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">#</th>
                <th scope="col" class="text-center">ชื่อพนักงาน</th>
                <th scope="col" class="text-center">การจ้างงาน</th>
                <th scope="col" class="text-center">ช่องทำการชำระ</th>
                <th scope="col" class="text-center">ติดต่อ</th>
                <th scope="col" class="text-center">สถานะ</th>
                <th scope="col" class="text-center">สมบูรณ์</th>
                <th scope="col" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody id="tableEmployee">
              <tr>
                <td colspan='8' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>
              </tr>
            </tbody>       
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationEmployeeInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationEmployee" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const renderEmployee = (res) => {
  const table = document.getElementById('tableEmployee');
  table.innerHTML = '';

  res.sort((a, b) => {
    const numA = parseInt(a[0].replace('USER-', ''));
    const numB = parseInt(b[0].replace('USER-', ''));
    return numA - numB;
  });

  if (res.length === 0) {
    const row = table.insertRow();
    row.innerHTML = `<td colspan='8' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ไม่พบข้อมูล! 😓</td>`;
    return;
  }

  res.forEach((rowIndex, index) => {
    let isActive = rowIndex[10] === "TRUE";
    if (rowIndex[10] === 'TRUE') {
      const checkrowIndex = [rowIndex[11], rowIndex[12], rowIndex[13], rowIndex[14], rowIndex[15], rowIndex[16], rowIndex[17], rowIndex[18], rowIndex[19], rowIndex[20], rowIndex[21], rowIndex[22], rowIndex[23], rowIndex[24], rowIndex[25], rowIndex[26], rowIndex[27], rowIndex[28], rowIndex[29], rowIndex[30], rowIndex[31], rowIndex[32]];
      const filledFields = checkrowIndex.filter(field => field && field.trim() !== '').length;
      const progressbar = Math.round((filledFields / checkrowIndex.length) * 100);
      const progressAngle = progressbar * 3.6;

      let progressColor;
      let buttonClass = 'upload-button';
      if (progressbar <= 25) {
        progressColor = 'var(--box4)';
        buttonClass = 'del-button';
      } else if (progressbar <= 50) {
        progressColor = 'var(--box3)';
        buttonClass = 'edit-button';
      } else if (progressbar <= 75) {
        progressColor = 'var(--box1)';
        buttonClass = 'set-button';
      } else {
        progressColor = 'var(--box2)';
        buttonClass = 'upload-button';
      }

      let bankImage = '';
      switch (rowIndex[24]) {
        case 'ธนาคารกรุงเทพ':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-1.png';
          break;
        case 'ธนาคารกสิกรไทย':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-2.png';
          break;
        case 'ธนาคารกรุงไทย':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-3.png';
          break;
        case 'ธนาคารทหารไทย':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-4.png';
          break;
        case 'ธนาคารไทยพาณิชย์':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-5.png';
          break;
        case 'ธนาคารกรุงศรีอยุธยา':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-6.png';
          break;
        case 'ธนาคารเกียรตินาคิน':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-7.png';
          break;
        case 'ธนาคารซีไอเอ็มบีไทย':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-8.png';
          break;
        case 'ธนาคารทิสโก้':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-9.png';
          break;
        case 'ธนาคารธนชาต':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-10.png';
          break;
        case 'ธนาคารยูโอบี':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-11.png';
          break;
        case 'ธนาคารไอซีบีซี(ไทย)':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-12.png';
          break;
        case 'ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-13.png';
          break;
        case 'ธนาคารออมสิน':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-14.png';
          break;
        case 'ธนาคารอาคารสงเคราะห์':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-15.png';
          break;
        case 'ธนาคารอิสลามแห่งประเทศไทย':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-16.png';
          break;
        case 'ธนาคารไทยเครดิตเพื่อรายย่อย':
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/bankThai/main/bank-17.png';
          break;
        default:
          bankImage = 'https://raw.githubusercontent.com/EPICCODING17/image/main/Logo-EicCoding.png';
          break;
      }

      var row = table.insertRow();
      row.innerHTML = `
        <td class="text-center"><span style="font-size: 14px;">${index + 1}</span></td>
        <td>
          <div style="display: flex; align-items: center;">
            <img class="rounded-circle" src="${rowIndex[7] ? rowIndex[7] : '❌ N/A'}" alt="ImageUsers" width="40" style="margin-right: 10px;">
            <div style="font-size: 14px;">
              <span>UID: ${rowIndex[0]}</span><br>
              <span>ชื่อ สกุล: ${rowIndex[3] ? rowIndex[3] : '❌ N/A'}</span><br>
              <span>ตำแหน่ง: ${rowIndex[4] ? rowIndex[4] : '❌ N/A'}</span><br>
              <span>แผนก: ${rowIndex[5] ? rowIndex[5] : '❌ N/A'}</span>
            </div>
          </div>
        </td>
        <td>
          <span style="font-size: 14px;">การจ้างงาน: ${rowIndex[11] ? rowIndex[11] : '❌ N/A'}</span><br>
          <span style="font-size: 14px;">การจ่าย: ${rowIndex[21] ? rowIndex[21] : '❌ N/A'}</span><br>
          <span style="font-size: 14px;">วันที่เริ่มงาน: ${rowIndex[19] ? rowIndex[19] : '❌ N/A'}</span>
        </td>
        <td>
          <div style="display: flex; align-items: center;">
            <img class="rounded-circle" src="${bankImage}" alt="accountbank" width="40" style="margin-right: 10px;">
            <div style="font-size: 14px;">
              <span>ธนาคาร: ${rowIndex[24] ? rowIndex[24] : '❌ N/A'}</span><br>
              <span>เลขที่บัญชี: ${rowIndex[25] ? rowIndex[25] : '❌ N/A'}</span><br>
              <span>ประเภท: ${rowIndex[26] ? rowIndex[26] : '❌ N/A'} สาขา: ${rowIndex[27] ? rowIndex[27] : '❌ N/A'}</span>
            </div>
          </div>
        </td>
        <td>
          <span style="font-size: 14px;">ที่อยู่: ${rowIndex[29] ? rowIndex[29] : '❌ N/A'}</span><br>
          <span style="font-size: 14px;">Email: ${rowIndex[30] ? rowIndex[30] : '❌ N/A'}</span><br>
          <span style="font-size: 14px;">มือถือ: ${rowIndex[32] ? rowIndex[32] : '❌ N/A'}</span>
        </td>
        <td class="text-center" style="vertical-align: middle;">
          <div style="display: flex; align-items: center; justify-content: center;">
            <div class="custom-switch">
              <input type="checkbox" ${isActive ? 'checked' : ''} id="switch-${rowIndex[0]}" class="custom-switch-input" onchange="toggleUserStatus('${rowIndex[0]}', this.checked)">
              <label for="switch-${rowIndex[0]}" class="custom-switch-label"></label>
            </div>
          </div>
        </td>
        <td class="text-center" style="vertical-align: middle;">
          <div style="display: flex; align-items: center; justify-content: center;">
            <div class="circular-progress" style="--progress-color: ${progressColor}; --progress-angle: ${progressAngle}deg;">
              <span class="progress-value">${progressbar}%</span>
            </div>
          </div>
        </td>
        <td class="text-center" style="vertical-align: middle;">
          <div style="display: flex; align-items: center; justify-content: center;">
            <button type='button' class='btn btn-sm me-2 ${buttonClass}' onclick='editEmployee("${rowIndex[0]}");'><i class='fa-solid fa-check'></i> ตรวจสอบ</button>
          </div>
        </td>
      `;
    }
  });
}

const filterEmployee = () => {
  const query = document.getElementById('searchEmployee').value.toLowerCase();
  filteredEmployee = dataUsers.filter(row => {
    return row.some(column => (column || '').toString().toLowerCase().includes(query));
  });

  renderEmployee(filteredEmployee);
}

document.addEventListener('DOMContentLoaded', (ev) => {
  let input = document.querySelector('input[id="employeeImg"]');
  input.addEventListener('change', (ev) => {
      if (input.files[0].type.indexOf("image/") > -1) {
        let img = document.getElementById('employeePreview');
        img.src = window.URL.createObjectURL(input.files[0]);
      }
  });
});

const reverseFormatDate = (dateStr) => {
  if (!dateStr) return '';
  const parts = dateStr.split('/');
  return `${parts[2]}-${parts[1]}-${parts[0]}`;
};

const editEmployee = (codeID) => {
  const rowIndex = dataUsers.find(row => row[0] === codeID);
  if (rowIndex) {
    $('#EmployeeModal').modal('show');
    $('#employeePreview').attr('src', rowIndex[7]); //Img
    $('#empDataKey').val(rowIndex[0]); //UID
    $('#empData1').val(rowIndex[3]); //ชื่อสกุล
    $('#empData2').val(rowIndex[4]); //ตำแหน่ง
    $('#empData3').val(rowIndex[5]); //แผนก
    $('#empData4').val(rowIndex[14]); //เพศ
    $('#empData5').val(rowIndex[15] ? reverseFormatDate(rowIndex[15]) : ''); //วันเกิด
    $('#empData6').val(rowIndex[16]); //สัญชาติ
    $('#empData7').val(rowIndex[17]); //สถานภาพ
    $('#empData8').val(rowIndex[18]); //พิการ/ทุพพลภาพ

    $('#empData9').val(rowIndex[12]); //เลขประจำตัวประชาชน
    $('#empData10').val(rowIndex[13]); //เลขประกันสังคม
    //สิทธิ์ประกันสังคม
    document.querySelectorAll('input[name="empData11"]').forEach(input => {
      input.checked = false;
      input.closest('.Employee-card').classList.remove('selected');
      if (input.value === rowIndex[28]) {
        input.checked = true;
        input.closest('.Employee-card').classList.add('selected');
      }
    });

    $('#empData12').val(rowIndex[29]); //ที่อยู่
    $('#empData13').val(rowIndex[30]); //Email
    $('#empData14').val(rowIndex[31]); //Line
    $('#empData15').val(rowIndex[32]); //Phone

    $('#empData16').val(rowIndex[11]); //การจ้างงาน
    $('#empData17').val(rowIndex[19] ? reverseFormatDate(rowIndex[19]) : ''); //วันที่เริ่มงาน
    $('#empData18').val(rowIndex[21]); //การจ่าย
    $('#empData19').val(rowIndex[20] ? rowIndex[20].replace(/,/g, '') : ''); //ค่าจ้าง
    $('#empData20').val(rowIndex[22] ? rowIndex[22].replace(/,/g, '') : ''); //เงินพิเศษ

    $('#empData21').val(rowIndex[23]); //วิธีจ่าย
    $('#empData22').val(rowIndex[24]); //ธนาคาร
    $('#empData23').val(rowIndex[25]); //เลขที่บัญชี
    //ประเภทบัญชี
    document.querySelectorAll('input[name="empData24"]').forEach(input => {
      input.checked = false;
      input.closest('.Employee-card').classList.remove('selected');
      if (input.value === rowIndex[26]) {
        input.checked = true;
        input.closest('.Employee-card').classList.add('selected');
      }
    });
    $('#empData25').val(rowIndex[27]); //สาขา
  }
}

const submitDataEmployee = () => {
  event.preventDefault();
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  const obj = {
    empCode: document.getElementById("empDataKey").value,
    empData1: document.getElementById("empData1").value,
    empData2: document.getElementById("empData2").value,
    empData3: document.getElementById("empData3").value,
    empData4: document.getElementById("empData4").value,
    empData5: document.getElementById("empData5").value,
    empData6: document.getElementById("empData6").value,
    empData7: document.getElementById("empData7").value,
    empData8: document.getElementById("empData8").value,
    empData9: document.getElementById("empData9").value,
    empData10: document.getElementById("empData10").value,
    empData11: document.querySelector('input[name="empData11"]:checked').value,
    empData12: document.getElementById("empData12").value,
    empData13: document.getElementById("empData13").value,
    empData14: document.getElementById("empData14").value,
    empData15: document.getElementById("empData15").value,
    empData16: document.getElementById("empData16").value,
    empData17: document.getElementById("empData17").value,
    empData18: document.getElementById("empData18").value,
    empData19: document.getElementById("empData19").value,
    empData20: document.getElementById("empData20").value,
    empData21: document.getElementById("empData21").value,
    empData22: document.getElementById("empData22").value,
    empData23: document.getElementById("empData23").value,
    empData24: document.querySelector('input[name="empData24"]:checked').value,
    empData25: document.getElementById("empData25").value
  };

  if ($("#employeeImg").val() === "") {
    obj.profile = $("#employeePreview").attr("src");
  } else {
    const imgElement = document.getElementById("employeePreview");
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.width = imgElement.naturalWidth;
    canvas.height = imgElement.naturalHeight;
    context.drawImage(imgElement, 0, 0, imgElement.naturalWidth, imgElement.naturalHeight);
    obj.imageDataUrl = canvas.toDataURL("image/png");
    obj.filetype = "image/png";
    obj.filename = obj.empData1;
  }

  if (!obj.empCode || !obj.empData1 || !obj.empData2 || !obj.empData3 || !obj.empData4 || !obj.empData5 || !obj.empData6 || !obj.empData7 || !obj.empData8 || !obj.empData9 || !obj.empData10) {
    createToast("⚠️ กรุณากรอกข้อมูลให้ครบถ้วน", 3);
    $.LoadingOverlay("hide");
    return;
  }

  google.script.run.withSuccessHandler(async (res) => {
    $.LoadingOverlay("hide");
    $('#EmployeeModal').modal('hide');
    await updateSpecificDataUsers();
    createToast("✅ บันทึกข้อมูลสำเร็จ", 1);
  }).saveDataEmployee(obj);
};

const selectEmpCard = (selectedId, groupName) => {
  document.querySelectorAll(`.Employee-card input[name='${groupName}']`).forEach(input => {
    input.closest('.Employee-card').classList.remove('selected');
    input.checked = false;
  });
  const selectedCard = document.getElementById(selectedId);
  selectedCard.classList.add('selected');
  selectedCard.querySelector('input').checked = true;
};

const clearDataEmployee = () => {
  $('#EmployeeModal').modal('hide');
  document.getElementById("employeeImg").value = "";
  document.getElementById("employeePreview").src = "https://img2.pic.in.th/pic/vsvds.png";

  document.getElementById("empDataKey").value = "";
  document.getElementById("empData1").value = "";
  document.getElementById("empData2").value = "";
  document.getElementById("empData3").value = "";
  document.getElementById("empData4").value = "";
  document.getElementById("empData5").value = "";
  document.getElementById("empData6").value = "";
  document.getElementById("empData7").value = "";
  document.getElementById("empData8").value = "";
  document.getElementById("empData9").value = "";
  document.getElementById("empData10").value = "";
  document.getElementById("empData12").value = "";
  document.getElementById("empData13").value = "";
  document.getElementById("empData14").value = "";
  document.getElementById("empData15").value = "";
  document.getElementById("empData16").value = "";
  document.getElementById("empData17").value = "";
  document.getElementById("empData18").value = "";
  document.getElementById("empData19").value = "";
  document.getElementById("empData20").value = "";
  document.getElementById("empData21").value = "";
  document.getElementById("empData22").value = "";
  document.getElementById("empData23").value = "";
  document.getElementById("empData25").value = "";

  document.querySelectorAll('.Employee-card').forEach(card => {
    card.classList.remove('selected');
  });

  document.getElementById("radioCheckDataA").checked = true;
  document.getElementById("radioCheckDataC").checked = true;

  document.getElementById("cardCheckDataA").classList.add('selected');
  document.getElementById("cardCheckDataC").classList.add('selected');
};
</script>

